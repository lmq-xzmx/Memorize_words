# 系统角色关系对照表

## 概述
本表汇总了系统中三个核心角色管理表的所有角色信息，展示了它们之间的对应关系和映射逻辑。

## 表格说明
- **UserRole (预定义角色)**: 系统预定义的用户角色枚举
- **Django Groups**: Django 认证系统中的用户组
- **RoleGroupMapping**: 角色与组的映射关系（连接预定义角色与 Django 组）
- **RoleManagement**: 自定义角色管理（支持角色继承和权限管理）

---

## 完整角色对照表

| 序号 | UserRole 角色代码 | UserRole 显示名称 | 用户数量 | Django Groups | 组ID | RoleGroupMapping | RoleManagement | 备注 |
|------|------------------|------------------|----------|---------------|------|------------------|----------------|------|
| 1 | `student` | 学生 | 18 | 学生组 | 1 | ✓ | ✓ | 系统核心角色，最大用户群体 |
| 2 | `parent` | 家长 | 5 | 家长组 | 4 | ✓ | ✓ | 家长角色，关联学生管理 |
| 3 | `teacher` | 自由老师 | 5 | 教师组, 自由老师组 | 3, 9 | ✓ | ✓ | 教学人员，有多个对应组 |
| 4 | `admin` | 管理员 | 6 | 管理员组 | 2 | ✓ | ✓ | 系统管理员，最高权限 |
| 5 | `dean` | 教导主任 | 0 | 教导主任组 | 5 | ✓ | ✓ | 教学管理角色，暂无用户 |
| 6 | `academic_director` | 教务主任 | 0 | 教务主任组 | 6 | ✓ | ✓ | 教务管理角色，暂无用户 |
| 7 | `research_leader` | 教研组长 | 0 | 教研组长组 | 7 | ✓ | ✓ | 教研管理角色，暂无用户 |
| 8 | - | 项目助理a | 0 | 项目助理组 | 17 | ✗ | ✓ | **缺失UserRole预设** |
| 9 | - | 项目管理助理 | 0 | 项目管理助理组 | 18 | ✗ | ✓ | **缺失UserRole预设** |

---

## 额外 Django 组（无对应 UserRole）

| 组ID | 组名称 | 类型 | 说明 |
|------|--------|------|------|
| 8 | 系统管理员组 | 系统组 | 系统级管理组 |
| 10-16 | Role_* 系列组 | 映射组 | 通过 RoleGroupMapping 创建的角色映射组 |
| 17 | 项目助理组 | 自定义组 | 自定义业务角色 |
| 18 | 项目管理助理组 | 自定义组 | 自定义管理角色 |
| 19 | Role_xiangmuzhuli | 映射组 | 自定义角色映射 |
| 20 | Role_项目管理助理 | 映射组 | 自定义角色映射 |
| 21 | 测试角色001组 | 测试组 | 测试用途 |
| 22 | 测试角色002组 | 测试组 | 测试用途 |

---

## 角色层级关系

```
管理员 (admin) - Level 0
├── 教导主任 (dean) - Level 1
│   ├── 教务主任 (academic_director) - Level 2
│   │   └── 自由老师 (teacher) - Level 3
│   ├── 教研组长 (research_leader) - Level 2
│   │   └── 自由老师 (teacher) - Level 3
│   └── 自由老师 (teacher) - Level 3
├── 家长 (parent) - Level 3
│   └── 学生 (student) - Level 4
└── 学生 (student) - Level 4
```

---

## 角色权限映射

### 预定义角色权限

| 角色 | 主要权限 |
|------|----------|
| **管理员** | 用户管理、角色管理、权限管理、系统设置、报表查看、日志管理 |
| **教导主任** | 用户查看/修改、角色管理、报表查看、学术管理 |
| **教务主任** | 用户查看/修改、学术管理、课程管理、报表查看 |
| **教研组长** | 用户查看、研究管理、课程管理、报表查看 |
| **自由老师** | 用户查看、教学管理、学生管理、课程管理 |
| **家长** | 学生进度查看、查看自己的孩子信息 |
| **学生** | 查看/修改个人资料 |

---

## 角色缺失问题分析

### 1. 发现的问题
通过数据分析发现，`RoleManagement` 表中存在 **2个项目管理类角色** 在 `UserRole` 预设角色中缺失：

| 缺失角色代码 | 显示名称 | 状态 | 影响 |
|-------------|----------|------|------|
| 项目助理a | 项目助理 | 仅存在于RoleManagement | 无法通过UserRole预设分配 |
| 项目管理助理 | 项目管理助理 | 仅存在于RoleManagement | 无法通过UserRole预设分配 |

### 2. 问题影响
1. **角色分配不一致**: 这些角色无法通过标准的用户注册流程自动分配
2. **权限管理复杂**: 需要手动在后台管理界面进行角色分配
3. **系统完整性**: 角色体系不完整，可能导致权限管理混乱

### 3. 解决方案建议

#### 方案一：扩展UserRole预设角色（推荐）
```python
# 在 apps/accounts/models.py 中的 UserRole 类添加：
PROJECT_ASSISTANT = 'project_assistant', '项目助理'
PROJECT_MANAGER_ASSISTANT = 'project_manager_assistant', '项目管理助理'
```

#### 方案二：统一角色代码
**实施方法：**
- 将 RoleManagement 中的角色代码从 `项目助理a` 修改为 `project_assistant`
- 将 `项目管理助理` 修改为 `project_manager_assistant`
- 确保所有角色代码遵循英文下划线命名规范

**具体操作：**
```sql
-- 更新 RoleManagement 表中的角色代码
UPDATE permissions_rolemanagement 
SET role = 'project_assistant' 
WHERE role = '项目助理a';

UPDATE permissions_rolemanagement 
SET role = 'project_manager_assistant' 
WHERE role = '项目管理助理';
```

**优点：**
- 保持系统一致性，所有角色代码统一为英文格式
- 无需修改 UserRole 预设角色，减少代码变更
- 符合国际化标准，便于后续扩展

**缺点：**
- 需要更新数据库中的现有数据
- 可能影响已有的权限配置和组映射
- 需要同步更新相关的 Django Groups 名称

**适用场景：**
- 系统处于开发阶段，数据量较小
- 希望保持代码结构不变
- 重视命名规范的统一性

#### 方案三：创建角色映射机制
**实施方法：**
- 创建新的 `RoleMapping` 模型，建立 RoleManagement 到 UserRole 的映射关系
- 实现动态角色解析机制，支持自定义角色名称
- 保持现有数据结构不变，通过映射层解决兼容性问题

**具体实现：**
```python
# 新增 RoleMapping 模型
class RoleMapping(models.Model):
    role_management_code = models.CharField('RoleManagement角色代码', max_length=50)
    user_role_code = models.CharField('UserRole角色代码', max_length=20, choices=UserRole.choices)
    display_name = models.CharField('显示名称', max_length=100)
    is_active = models.BooleanField('是否启用', default=True)
    
    class Meta:
        verbose_name = '角色映射'
        unique_together = ['role_management_code', 'user_role_code']

# 角色解析服务
class RoleResolver:
    @staticmethod
    def get_user_role_from_management(management_role):
        mapping = RoleMapping.objects.filter(
            role_management_code=management_role,
            is_active=True
        ).first()
        return mapping.user_role_code if mapping else None
```

**配置示例：**
```python
# 创建映射关系
RoleMapping.objects.create(
    role_management_code='项目助理a',
    user_role_code='admin',  # 映射到管理员角色
    display_name='项目助理'
)

RoleMapping.objects.create(
    role_management_code='项目管理助理',
    user_role_code='admin',  # 映射到管理员角色
    display_name='项目管理助理'
)
```

**优点：**
- 保持现有数据结构完全不变
- 支持灵活的角色映射和扩展
- 可以将多个自定义角色映射到同一个预设角色
- 便于后续添加新的自定义角色
- 支持角色的动态启用/禁用

**缺点：**
- 增加了系统复杂性，需要额外的映射层
- 需要修改现有的角色检查逻辑
- 可能存在映射关系不明确的风险
- 增加了数据库查询开销

**适用场景：**
- 系统已投入生产，不便修改现有数据
- 需要支持大量自定义角色
- 希望保持最大的灵活性和扩展性
- 有复杂的角色继承和权限需求

---

## 系统集成说明

### 1. 角色匹配机制
- **RoleGroupMapping** 通过 `OneToOneField` 与 Django `Group` 建立一对一映射
- **RoleManagement** 与 **RoleGroupMapping** 通过相同的 `role` 字段关联
- **UserRole** 提供预定义角色枚举，作为角色标识的基础

### 2. 权限同步流程
1. **RoleManagement** 定义角色权限
2. **RoleGroupMapping** 建立角色与 Django 组的映射
3. 系统自动将 **RoleManagement** 中的权限同步到对应的 Django 组
4. 用户通过组成员身份获得相应权限

### 3. 角色分配流程
1. 用户注册时选择 **UserRole** 中的预定义角色
2. 系统通过 **RoleGroupMapping** 找到对应的 Django 组
3. 自动将用户添加到相应的组中
4. 用户获得该角色的所有权限

---

## 数据统计与分析

### 角色分布统计
- **UserRole 预设角色**: 7个
- **RoleManagement 自定义角色**: 9个（包含2个缺失角色）
- **Django Groups**: 22个
- **总用户数**: 34 人
- **角色缺失**: 2个项目管理类角色

### 角色使用情况
- **有用户的角色**: student(18), parent(5), teacher(5), admin(6)
- **无用户的角色**: dean(0), academic_director(0), research_leader(0), 项目助理a(0), 项目管理助理(0)
- **角色覆盖率**: 44.4% (4/9)

### 角色完整性分析
- **完整映射角色**: 7个（UserRole ↔ RoleManagement ↔ Django Groups）
- **部分映射角色**: 2个（仅RoleManagement ↔ Django Groups）
- **系统完整性**: 77.8% (7/9)

---

## 三种方案对比分析

### 从创建新角色角度的全面对比

| 对比维度 | 方案一：扩展UserRole预设 | 方案二：统一角色代码 | 方案三：创建角色映射机制 |
|---------|-----------------------|-------------------|----------------------|
| **扩展性** | ⭐⭐⭐⭐⭐ 优秀 | ⭐⭐⭐ 一般 | ⭐⭐⭐⭐ 良好 |
| **复杂度** | ⭐⭐ 简单 | ⭐⭐⭐⭐ 复杂 | ⭐⭐⭐ 中等 |
| **映射机制** | 直接映射 | 代码统一 | 动态映射 |

### 创建新角色流程对比

**方案一：扩展UserRole预设**
```python
# 1. 修改models.py
class UserRole(models.TextChoices):
    STUDENT = 'student', '学生'
    PARENT = 'parent', '家长'
    # 新增角色
    PROJECT_MANAGER = 'project_manager', '项目经理'
    
# 2. 创建迁移
python manage.py makemigrations
python manage.py migrate

# 3. 在RoleManagement中添加对应记录
# 自动同步，无需额外操作
```

**方案二：统一角色代码**
```sql
-- 1. 更新RoleManagement表
UPDATE permissions_rolemanagement 
SET role_code = 'project_manager' 
WHERE role_name = '项目经理';

-- 2. 更新UserRole预设（如果需要）
-- 需要代码修改和迁移

-- 3. 更新所有相关表的外键引用
UPDATE permissions_rolegroupmapping 
SET role_code = 'project_manager' 
WHERE role_code = 'old_project_manager_code';
```

**方案三：创建角色映射机制**
```python
# 1. 创建映射表
class RoleMapping(models.Model):
    user_role = models.CharField(max_length=50, choices=UserRole.choices)
    role_management = models.ForeignKey(RoleManagement)
    
# 2. 创建映射服务
class RoleMappingService:
    @staticmethod
    def create_role_mapping(user_role_code, role_management_id):
        return RoleMapping.objects.create(
            user_role=user_role_code,
            role_management_id=role_management_id
        )
        
# 3. 在业务逻辑中使用映射
def get_user_permissions(user):
    mappings = RoleMapping.objects.filter(user_role=user.role)
    # 通过映射获取权限
```

### 详细对比分析

#### 扩展性对比

| 方案 | 新角色创建难度 | 系统影响范围 | 未来扩展能力 |
|------|---------------|-------------|-------------|
| 方案一 | 极低 | 最小 | 优秀，预设角色体系完整 |
| 方案二 | 高 | 大 | 一般，需要多表同步更新 |
| 方案三 | 中等 | 中等 | 良好，支持灵活映射 |

#### 复杂度对比

| 方案 | 开发复杂度 | 维护复杂度 | 测试复杂度 |
|------|-----------|-----------|----------|
| 方案一 | 低 | 低 | 低 |
| 方案二 | 高 | 高 | 高 |
| 方案三 | 中 | 中 | 中 |

#### 映射机制对比

| 方案 | 映射方式 | 数据一致性 | 性能影响 |
|------|---------|-----------|----------|
| 方案一 | 直接对应 | 强一致性 | 无影响 |
| 方案二 | 代码统一 | 强一致性 | 轻微影响 |
| 方案三 | 动态映射 | 需要维护 | 中等影响 |

### 推荐策略

1. **短期解决**：采用方案一，快速解决当前问题
2. **中期优化**：如果角色体系复杂化，考虑方案三
3. **长期规划**：避免方案二，维护成本过高

---

## 建议优化

1. **推荐方案一**：扩展 `UserRole` 预设角色，保持系统一致性
2. **数据清理**：定期检查和清理未使用的角色
3. **权限审计**：建立角色权限定期审计机制
4. **文档维护**：保持角色文档的及时更新

---

*生成时间: 2024年1月*  
*数据来源: Django Admin 系统*