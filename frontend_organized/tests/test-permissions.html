<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>权限系统测试</title>
    
</head>
<body>
    <h1>权限系统测试页面</h1>
    
    <div class="test-section">
        <h3>当前状态</h3>
        <p>Token: <span id="token-status">检查中...</span></p>
        <p>用户信息: <span id="user-status">检查中...</span></p>
    </div>
    
    <div class="test-section">
        <h3>API测试</h3>
        <button onclick="testUserAPI()">测试用户API</button>
        <button onclick="testPermissionAPI()">测试权限API</button>
        <button onclick="clearStorage()">清除存储</button>
        <button onclick="mockLogin()">模拟登录</button>
    </div>
    
    <div class="test-section">
        <h3>测试结果</h3>
        <div id="results">等待测试...</div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            results.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
        }

        function updateStatus() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            document.getElementById('token-status').textContent = token ? '已存在' : '未找到';
            document.getElementById('token-status').className = token ? 'success' : 'error';
            
            document.getElementById('user-status').textContent = user ? JSON.parse(user).username || '已存在' : '未找到';
            document.getElementById('user-status').className = user ? 'success' : 'error';
        }

        async function testUserAPI() {
            log('测试用户认证API...');
            try {
                const token = localStorage.getItem('token');
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (token) {
                    headers['Authorization'] = `Token ${token}`;
                }
                
                const response = await fetch('http://127.0.0.1:8000/accounts/api/auth/user/', {
                    headers: headers
                });
                
                log(`用户API响应状态: ${response.status}`);
                const data = await response.text();
                log(`用户API响应内容: ${data}`);
                
                if (response.status === 200) {
                    log('用户API测试成功', 'success');
                } else if (response.status === 401) {
                    log('用户API返回401 - 未认证（正常）', 'info');
                } else {
                    log(`用户API返回异常状态: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`用户API测试失败: ${error.message}`, 'error');
            }
        }

        async function testPermissionAPI() {
            log('测试权限API...');
            try {
                const token = localStorage.getItem('token');
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (token) {
                    headers['Authorization'] = `Token ${token}`;
                }
                
                const response = await fetch('http://127.0.0.1:8000/permissions/api/user-menu-permissions/', {
                    headers: headers
                });
                
                log(`权限API响应状态: ${response.status}`);
                const data = await response.text();
                log(`权限API响应内容: ${data}`);
                
                if (response.status === 200) {
                    log('权限API测试成功', 'success');
                } else if (response.status === 401) {
                    log('权限API返回401 - 未认证（正常）', 'info');
                } else {
                    log(`权限API返回异常状态: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`权限API测试失败: ${error.message}`, 'error');
            }
        }

        function clearStorage() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            log('已清除本地存储', 'info');
            updateStatus();
        }

        function mockLogin() {
            // 模拟一个假的token和用户信息
            localStorage.setItem('token', 'mock_token_12345');
            localStorage.setItem('user', JSON.stringify({
                id: 1,
                username: 'testuser',
                role: 'student',
                email: 'test@example.com'
            }));
            log('已设置模拟登录信息', 'success');
            updateStatus();
        }

        // 页面加载时更新状态
        updateStatus();
        log('权限系统测试页面已加载');
    </script>
</body>
</html>