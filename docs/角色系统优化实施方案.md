# è§’è‰²ç³»ç»Ÿä¼˜åŒ–å®æ–½æ–¹æ¡ˆ

## ğŸ¯ å®æ–½ç›®æ ‡

è§£å†³å½“å‰è§’è‰²ç³»ç»Ÿä¸­æ•°æ®æºä¸ä¸€è‡´ã€ç»„ä»¶ä½¿ç”¨ä¸ç»Ÿä¸€ç­‰é—®é¢˜ï¼Œå®ç°å®Œå…¨è‡ªåŠ¨åŒ–å’Œä¸€è‡´çš„è§’è‰²ç®¡ç†ä½“éªŒã€‚

## ğŸ“‹ å®æ–½æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šç»Ÿä¸€è§’è‰²æ•°æ®æºï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

#### æ­¥éª¤1ï¼šåˆ›å»ºè§’è‰²æœåŠ¡å±‚

**æ–‡ä»¶ï¼š`apps/accounts/services/__init__.py`**
```python
# åˆ›å»ºæœåŠ¡å±‚åŒ…
```

**æ–‡ä»¶ï¼š`apps/accounts/services/role_service.py`**
```python
from django.core.cache import cache
from django.db.models import Q
from typing import List, Dict, Tuple, Optional
from apps.accounts.models import UserRole
from apps.permissions.models import RoleManagement


class RoleService:
    """ç»Ÿä¸€çš„è§’è‰²æ•°æ®æœåŠ¡"""
    
    CACHE_KEY_ALL_ROLES = 'role_service:all_roles'
    CACHE_KEY_ROLE_CHOICES = 'role_service:role_choices'
    CACHE_KEY_ROLE_HIERARCHY = 'role_service:role_hierarchy'
    CACHE_TIMEOUT = 300  # 5åˆ†é’Ÿç¼“å­˜
    
    @classmethod
    def get_all_roles(cls, include_inactive: bool = False) -> List[Dict]:
        """è·å–æ‰€æœ‰è§’è‰²çš„ç»Ÿä¸€æ¥å£"""
        cache_key = f"{cls.CACHE_KEY_ALL_ROLES}:{include_inactive}"
        roles = cache.get(cache_key)
        
        if roles is None:
            roles = []
            
            # 1. æ·»åŠ é¢„å®šä¹‰è§’è‰²
            predefined_roles = {choice[0]: choice[1] for choice in UserRole.choices}
            
            # 2. è·å–è§’è‰²ç®¡ç†ä¸­çš„æ‰€æœ‰è§’è‰²
            query = RoleManagement.objects.all()
            if not include_inactive:
                query = query.filter(is_active=True)
            
            role_management_data = query.values(
                'role', 'display_name', 'description', 'is_active', 'sort_order'
            ).order_by('sort_order', 'role')
            
            # 3. åˆå¹¶è§’è‰²æ•°æ®
            processed_roles = set()
            
            for rm_data in role_management_data:
                role_code = rm_data['role']
                if role_code and role_code not in processed_roles:
                    roles.append({
                        'code': role_code,
                        'display_name': rm_data['display_name'] or predefined_roles.get(role_code, role_code),
                        'description': rm_data['description'] or '',
                        'is_predefined': role_code in predefined_roles,
                        'is_active': rm_data['is_active'],
                        'sort_order': rm_data['sort_order'] or 999
                    })
                    processed_roles.add(role_code)
            
            # 4. æ·»åŠ æœªåœ¨è§’è‰²ç®¡ç†ä¸­çš„é¢„å®šä¹‰è§’è‰²
            for role_code, role_name in UserRole.choices:
                if role_code not in processed_roles:
                    roles.append({
                        'code': role_code,
                        'display_name': role_name,
                        'description': f'ç³»ç»Ÿé¢„å®šä¹‰è§’è‰²ï¼š{role_name}',
                        'is_predefined': True,
                        'is_active': True,
                        'sort_order': 0
                    })
            
            # 5. æ’åº
            roles.sort(key=lambda x: (x['sort_order'], x['code']))
            
            cache.set(cache_key, roles, cls.CACHE_TIMEOUT)
        
        return roles
    
    @classmethod
    def get_role_choices(cls, include_inactive: bool = False) -> List[Tuple[str, str]]:
        """è·å–è§’è‰²é€‰æ‹©é¡¹çš„ç»Ÿä¸€æ¥å£"""
        cache_key = f"{cls.CACHE_KEY_ROLE_CHOICES}:{include_inactive}"
        choices = cache.get(cache_key)
        
        if choices is None:
            choices = [('', '---------')]  # ç©ºé€‰é¡¹
            
            roles = cls.get_all_roles(include_inactive=include_inactive)
            for role in roles:
                if include_inactive or role['is_active']:
                    choices.append((role['code'], role['display_name']))
            
            cache.set(cache_key, choices, cls.CACHE_TIMEOUT)
        
        return choices
    
    @classmethod
    def get_role_hierarchy(cls) -> Dict[str, List[str]]:
        """è·å–è§’è‰²å±‚çº§å…³ç³»"""
        hierarchy = cache.get(cls.CACHE_KEY_ROLE_HIERARCHY)
        
        if hierarchy is None:
            hierarchy = {}
            
            # ä»RoleManagementè·å–çˆ¶å­å…³ç³»
            role_relations = RoleManagement.objects.filter(
                is_active=True,
                parent__isnull=False
            ).values('role', 'parent__role')
            
            for relation in role_relations:
                parent = relation['parent__role']
                child = relation['role']
                
                if parent not in hierarchy:
                    hierarchy[parent] = []
                hierarchy[parent].append(child)
            
            cache.set(cls.CACHE_KEY_ROLE_HIERARCHY, hierarchy, cls.CACHE_TIMEOUT)
        
        return hierarchy
    
    @classmethod
    def get_role_info(cls, role_code: str) -> Optional[Dict]:
        """è·å–å•ä¸ªè§’è‰²çš„è¯¦ç»†ä¿¡æ¯"""
        roles = cls.get_all_roles(include_inactive=True)
        for role in roles:
            if role['code'] == role_code:
                return role
        return None
    
    @classmethod
    def clear_cache(cls):
        """æ¸…é™¤è§’è‰²ç›¸å…³ç¼“å­˜"""
        cache.delete_many([
            f"{cls.CACHE_KEY_ALL_ROLES}:True",
            f"{cls.CACHE_KEY_ALL_ROLES}:False",
            f"{cls.CACHE_KEY_ROLE_CHOICES}:True",
            f"{cls.CACHE_KEY_ROLE_CHOICES}:False",
            cls.CACHE_KEY_ROLE_HIERARCHY
        ])
    
    @classmethod
    def refresh_cache(cls):
        """åˆ·æ–°è§’è‰²ç¼“å­˜"""
        cls.clear_cache()
        # é¢„çƒ­ç¼“å­˜
        cls.get_all_roles(include_inactive=False)
        cls.get_all_roles(include_inactive=True)
        cls.get_role_choices(include_inactive=False)
        cls.get_role_choices(include_inactive=True)
        cls.get_role_hierarchy()
```

#### æ­¥éª¤2ï¼šé‡æ„Widgetä½¿ç”¨ç»Ÿä¸€æ•°æ®æº

**ä¿®æ”¹æ–‡ä»¶ï¼š`apps/permissions/widgets.py`**
```python
from django import forms
from django.utils.html import format_html
from django.urls import reverse
from apps.accounts.services.role_service import RoleService
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from .models import RoleManagement
else:
    try:
        from .models import RoleManagement
    except ImportError:
        RoleManagement = None


class StandardRoleSelectWidget(forms.Select):
    """æ ‡å‡†è§’è‰²é€‰æ‹©å™¨Widget - ä½¿ç”¨ç»Ÿä¸€æ•°æ®æº"""
    
    def __init__(self, attrs=None, choices=(), include_inactive=False):
        self.include_inactive = include_inactive
        default_attrs = {
            'id': 'id_role',
            'class': 'form-control standard-role-selector'
        }
        if attrs:
            default_attrs.update(attrs)
        super().__init__(default_attrs, choices)
    
    def get_role_choices(self):
        """è·å–è§’è‰²é€‰æ‹©é¡¹ - ä½¿ç”¨ç»Ÿä¸€æœåŠ¡"""
        return RoleService.get_role_choices(include_inactive=self.include_inactive)
    
    def render(self, name, value, attrs=None, renderer=None):
        """æ¸²æŸ“Widget"""
        # æ›´æ–°é€‰æ‹©é¡¹
        self.choices = self.get_role_choices()
        
        # æ¸²æŸ“åŸºç¡€é€‰æ‹©å™¨
        html = super().render(name, value, attrs, renderer)
        
        # è¿”å›åŸºç¡€HTMLï¼Œç§»é™¤JavaScriptæ”¯æŒ
        return html
    
    class Media:
        css = {
            'all': ('admin/css/dynamic_role_selector.css',)
        }
        js = ('admin/js/dynamic_role_selector.js',)


class StandardRoleChoiceField(forms.ChoiceField):
    """æ ‡å‡†è§’è‰²é€‰æ‹©å­—æ®µ - ä½¿ç”¨ç»Ÿä¸€æ•°æ®æº"""
    
    def __init__(self, *args, include_inactive=False, **kwargs):
        self.include_inactive = include_inactive
        
        # è®¾ç½®é»˜è®¤widget
        if 'widget' not in kwargs:
            kwargs['widget'] = StandardRoleSelectWidget(include_inactive=include_inactive)
        
        # è®¾ç½®é€‰æ‹©é¡¹
        if 'choices' not in kwargs:
            kwargs['choices'] = self.get_role_choices()
        
        super().__init__(*args, **kwargs)
    
    def get_role_choices(self):
        """è·å–è§’è‰²é€‰æ‹©é¡¹ - ä½¿ç”¨ç»Ÿä¸€æœåŠ¡"""
        return RoleService.get_role_choices(include_inactive=self.include_inactive)
    
    def validate(self, value):
        """éªŒè¯è§’è‰²å€¼"""
        super().validate(value)
        if value and value != '':
            role_info = RoleService.get_role_info(value)
            if not role_info:
                raise forms.ValidationError(f'æ— æ•ˆçš„è§’è‰²ä»£ç : {value}')
            if not self.include_inactive and not role_info['is_active']:
                raise forms.ValidationError(f'è§’è‰² {value} å·²è¢«ç¦ç”¨')


class RoleTextInputWidget(forms.TextInput):
    """è§’è‰²æ–‡æœ¬è¾“å…¥Widget - ç”¨äºåˆ›å»ºæ–°è§’è‰²"""
    
    def __init__(self, attrs=None):
        default_attrs = {
            'id': 'id_role',
            'class': 'form-control role-text-input',
            'placeholder': 'è¯·è¾“å…¥æ–°è§’è‰²æ ‡è¯†ï¼ˆå¦‚ï¼šcustom_roleï¼‰',
            'pattern': '[a-z_][a-z0-9_]*',  # è§’è‰²ä»£ç æ ¼å¼éªŒè¯
            'title': 'è§’è‰²ä»£ç åªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œä¸”å¿…é¡»ä»¥å­—æ¯æˆ–ä¸‹åˆ’çº¿å¼€å¤´'
        }
        if attrs:
            default_attrs.update(attrs)
        super().__init__(default_attrs)
    
    def render(self, name, value, attrs=None, renderer=None):
        """æ¸²æŸ“Widget"""
        html = super().render(name, value, attrs, renderer)
        
        # æ·»åŠ å®æ—¶éªŒè¯JavaScript
        js_code = """
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const roleInput = document.querySelector('.role-text-input');
            if (roleInput && !roleInput.hasAttribute('data-validated')) {
                roleInput.setAttribute('data-validated', 'true');
                
                roleInput.addEventListener('input', function(e) {
                    const value = e.target.value;
                    const isValid = /^[a-z_][a-z0-9_]*$/.test(value);
                    
                    if (value && !isValid) {
                        e.target.style.borderColor = '#dc3545';
                        e.target.style.backgroundColor = '#fff5f5';
                    } else {
                        e.target.style.borderColor = '';
                        e.target.style.backgroundColor = '';
                    }
                });
            }
        });
        </script>
        """
        
        return format_html('{0}{1}', html, js_code)
```

#### æ­¥éª¤3ï¼šåˆ›å»ºç¼“å­˜åˆ·æ–°ä¿¡å·

**æ–‡ä»¶ï¼š`apps/accounts/signals.py`**
```python
from django.db.models.signals import post_save, post_delete
from django.dispatch import receiver
from apps.permissions.models import RoleManagement
from apps.accounts.services.role_service import RoleService


@receiver([post_save, post_delete], sender=RoleManagement)
def refresh_role_cache(sender, **kwargs):
    """è§’è‰²ç®¡ç†æ•°æ®å˜æ›´æ—¶åˆ·æ–°ç¼“å­˜"""
    RoleService.refresh_cache()
    print(f"è§’è‰²ç¼“å­˜å·²åˆ·æ–°: {kwargs.get('instance', 'Unknown')}")
```

**ä¿®æ”¹æ–‡ä»¶ï¼š`apps/accounts/apps.py`**
```python
from django.apps import AppConfig


class AccountsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'apps.accounts'
    verbose_name = 'ç”¨æˆ·è´¦æˆ·ç®¡ç†'
    
    def ready(self):
        # å¯¼å…¥ä¿¡å·å¤„ç†å™¨
        import apps.accounts.signals
```

### ç¬¬äºŒé˜¶æ®µï¼šç»Ÿä¸€Adminç±»å®ç°ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

#### æ­¥éª¤4ï¼šä¿®å¤RoleMenuPermissionAdmin

**ä¿®æ”¹æ–‡ä»¶ï¼š`apps/permissions/admin.py`**
```python
# åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ å¯¼å…¥
from .role_selector_config import StandardRoleAdminMixin

# ä¿®æ”¹RoleMenuPermissionAdminç±»
@admin.register(RoleMenuPermission)
class RoleMenuPermissionAdmin(StandardRoleAdminMixin, admin.ModelAdmin):
    """è§’è‰²èœå•æƒé™Admin - ä½¿ç”¨ç»Ÿä¸€è§’è‰²é€‰æ‹©å™¨"""
    list_display = ['role', 'menu_module', 'get_permission_status', 'created_at']
    list_filter = ['role', 'can_access', 'created_at']
    search_fields = ['menu_module__name', 'menu_module__key']
    ordering = ['role', 'menu_module__name']
    
    def get_permission_status(self, obj):
        """æ˜¾ç¤ºæƒé™çŠ¶æ€"""
        if obj.can_access:
            return format_html(
                '<span style="color: #28a745; background: #d4edda; padding: 2px 6px; border-radius: 3px; font-size: 12px;">'  
                'âœ“ å¯è®¿é—®</span>'
            )
        else:
            return format_html(
                '<span style="color: #dc3545; background: #f8d7da; padding: 2px 6px; border-radius: 3px; font-size: 12px;">'  
                'âœ— ç¦æ­¢è®¿é—®</span>'
            )
    
    get_permission_status.short_description = 'æƒé™çŠ¶æ€'
    
    fieldsets = (
        ('åŸºæœ¬ä¿¡æ¯', {
            'fields': ('role', 'menu_module')
        }),
        ('æƒé™è®¾ç½®', {
            'fields': ('can_access',)
        }),
    )
    
    # è§’è‰²é€‰æ‹©å™¨é…ç½®å·²é€šè¿‡StandardRoleAdminMixinè‡ªåŠ¨å¤„ç†
```

#### æ­¥éª¤5ï¼šåˆ›å»ºAdminç±»éªŒè¯è£…é¥°å™¨

**æ–‡ä»¶ï¼š`apps/permissions/decorators.py`**
```python
from functools import wraps
from django.contrib import admin
from .role_selector_config import StandardRoleAdminMixin, RoleCreationAdminMixin


def ensure_standard_role_selector(admin_class):
    """ç¡®ä¿Adminç±»ä½¿ç”¨æ ‡å‡†è§’è‰²é€‰æ‹©å™¨çš„è£…é¥°å™¨"""
    
    def decorator(cls):
        # æ£€æŸ¥æ˜¯å¦ç»§æ‰¿äº†æ­£ç¡®çš„æ··å…¥ç±»
        has_standard_mixin = issubclass(cls, StandardRoleAdminMixin)
        has_creation_mixin = issubclass(cls, RoleCreationAdminMixin)
        
        if not (has_standard_mixin or has_creation_mixin):
            raise ValueError(
                f"Adminç±» {cls.__name__} å¿…é¡»ç»§æ‰¿ StandardRoleAdminMixin æˆ– RoleCreationAdminMixin "
                f"ä»¥ç¡®ä¿ä½¿ç”¨ç»Ÿä¸€çš„è§’è‰²é€‰æ‹©å™¨"
            )
        
        # æ·»åŠ éªŒè¯æ ‡è®°
        cls._role_selector_validated = True
        
        return cls
    
    return decorator


def validate_all_role_admins():
    """éªŒè¯æ‰€æœ‰æ³¨å†Œçš„Adminç±»æ˜¯å¦æ­£ç¡®ä½¿ç”¨è§’è‰²é€‰æ‹©å™¨"""
    issues = []
    
    for model, admin_class in admin.site._registry.items():
        # æ£€æŸ¥æ˜¯å¦æœ‰roleå­—æ®µ
        if hasattr(model, 'role'):
            # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„æ··å…¥ç±»
            has_standard_mixin = issubclass(admin_class, StandardRoleAdminMixin)
            has_creation_mixin = issubclass(admin_class, RoleCreationAdminMixin)
            
            if not (has_standard_mixin or has_creation_mixin):
                issues.append({
                    'model': model.__name__,
                    'admin_class': admin_class.__name__,
                    'issue': 'æœªä½¿ç”¨æ ‡å‡†è§’è‰²é€‰æ‹©å™¨æ··å…¥ç±»'
                })
    
    return issues
```

### ç¬¬ä¸‰é˜¶æ®µï¼šAPIæ¥å£ç»Ÿä¸€ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

#### æ­¥éª¤6ï¼šåˆ›å»ºç»Ÿä¸€è§’è‰²API

**æ–‡ä»¶ï¼š`apps/accounts/api/role_api.py`**
```python
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from django.core.cache import cache
from apps.accounts.services.role_service import RoleService
from apps.accounts.models import CustomUser
from django.db.models import Count


class RoleAPIViewSet(viewsets.ViewSet):
    """ç»Ÿä¸€è§’è‰²ç®¡ç†API"""
    permission_classes = [IsAuthenticated]
    
    @action(detail=False, methods=['get'])
    def list_roles(self, request):
        """è·å–æ‰€æœ‰è§’è‰²åˆ—è¡¨"""
        include_inactive = request.query_params.get('include_inactive', 'false').lower() == 'true'
        roles = RoleService.get_all_roles(include_inactive=include_inactive)
        
        return Response({
            'success': True,
            'data': roles,
            'total': len(roles)
        })
    
    @action(detail=False, methods=['get'])
    def role_choices(self, request):
        """è·å–è§’è‰²é€‰æ‹©é¡¹"""
        include_inactive = request.query_params.get('include_inactive', 'false').lower() == 'true'
        choices = RoleService.get_role_choices(include_inactive=include_inactive)
        
        # è½¬æ¢ä¸ºAPIå‹å¥½çš„æ ¼å¼
        formatted_choices = [
            {'value': choice[0], 'label': choice[1]} 
            for choice in choices
        ]
        
        return Response({
            'success': True,
            'data': formatted_choices
        })
    
    @action(detail=False, methods=['get'])
    def role_hierarchy(self, request):
        """è·å–è§’è‰²å±‚çº§å…³ç³»"""
        hierarchy = RoleService.get_role_hierarchy()
        
        return Response({
            'success': True,
            'data': hierarchy
        })
    
    @action(detail=True, methods=['get'])
    def role_info(self, request, pk=None):
        """è·å–å•ä¸ªè§’è‰²è¯¦ç»†ä¿¡æ¯"""
        role_info = RoleService.get_role_info(pk)
        
        if not role_info:
            return Response({
                'success': False,
                'error': f'è§’è‰² {pk} ä¸å­˜åœ¨'
            }, status=status.HTTP_404_NOT_FOUND)
        
        # æ·»åŠ ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
        user_count = CustomUser.objects.filter(role=pk, is_active=True).count()
        role_info['user_count'] = user_count
        
        return Response({
            'success': True,
            'data': role_info
        })
    
    @action(detail=False, methods=['get'])
    def role_statistics(self, request):
        """è·å–è§’è‰²ç»Ÿè®¡ä¿¡æ¯"""
        # ä½¿ç”¨ç¼“å­˜æé«˜æ€§èƒ½
        cache_key = 'role_api:statistics'
        stats = cache.get(cache_key)
        
        if stats is None:
            # ç»Ÿè®¡å„è§’è‰²ç”¨æˆ·æ•°é‡
            role_stats = CustomUser.objects.filter(
                is_active=True
            ).values('role').annotate(
                user_count=Count('id')
            ).order_by('role')
            
            # è·å–è§’è‰²æ˜¾ç¤ºåç§°
            roles_info = {role['code']: role for role in RoleService.get_all_roles()}
            
            stats = []
            for stat in role_stats:
                role_code = stat['role']
                role_info = roles_info.get(role_code, {})
                
                stats.append({
                    'role_code': role_code,
                    'role_name': role_info.get('display_name', role_code),
                    'user_count': stat['user_count'],
                    'is_predefined': role_info.get('is_predefined', False),
                    'is_active': role_info.get('is_active', True)
                })
            
            cache.set(cache_key, stats, 300)  # 5åˆ†é’Ÿç¼“å­˜
        
        return Response({
            'success': True,
            'data': stats
        })
    
    @action(detail=False, methods=['post'])
    def refresh_cache(self, request):
        """åˆ·æ–°è§’è‰²ç¼“å­˜"""
        if not request.user.is_staff:
            return Response({
                'success': False,
                'error': 'æƒé™ä¸è¶³'
            }, status=status.HTTP_403_FORBIDDEN)
        
        RoleService.refresh_cache()
        cache.delete('role_api:statistics')
        
        return Response({
            'success': True,
            'message': 'è§’è‰²ç¼“å­˜å·²åˆ·æ–°'
        })
```

#### æ­¥éª¤7ï¼šæ³¨å†ŒAPIè·¯ç”±

**ä¿®æ”¹æ–‡ä»¶ï¼š`apps/accounts/urls.py`**
```python
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .api.role_api import RoleAPIViewSet

# åˆ›å»ºAPIè·¯ç”±
api_router = DefaultRouter()
api_router.register(r'roles', RoleAPIViewSet, basename='role')

urlpatterns = [
    # å…¶ä»–URLæ¨¡å¼...
    path('api/', include(api_router.urls)),
]
```

### ç¬¬å››é˜¶æ®µï¼šå‰ç«¯å¢å¼ºï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

#### æ­¥éª¤8ï¼šå¢å¼ºè§’è‰²é€‰æ‹©å™¨JavaScript

**æ–‡ä»¶ï¼š`static/admin/js/enhanced_role_selector.js`**
```javascript
/**
 * å¢å¼ºè§’è‰²é€‰æ‹©å™¨
 * æä¾›å®æ—¶æ•°æ®åŠ è½½ã€éªŒè¯å’Œäº¤äº’åŠŸèƒ½
 */
class EnhancedRoleSelector {
    constructor(element, options = {}) {
        this.element = element;
        this.options = {
            apiEndpoint: '/accounts/api/roles/',
            enablePreview: true,
            enableValidation: true,
            cacheTimeout: 300000, // 5åˆ†é’Ÿ
            ...options
        };
        
        this.cache = new Map();
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.loadRoles();
        
        if (this.options.enablePreview) {
            this.setupPreview();
        }
        
        if (this.options.enableValidation) {
            this.setupValidation();
        }
    }
    
    setupEventListeners() {
        this.element.addEventListener('change', (e) => {
            this.onRoleChange(e.target.value);
        });
        
        // è§’è‰²å˜æ›´äº‹ä»¶ç›‘å¬å·²ç§»é™¤
    }
    
    async loadRoles(forceRefresh = false) {
        const cacheKey = 'roles_list';
        const cached = this.cache.get(cacheKey);
        
        if (!forceRefresh && cached && (Date.now() - cached.timestamp < this.options.cacheTimeout)) {
            this.updateOptions(cached.data);
            return cached.data;
        }
        
        try {
            const response = await fetch(`${this.options.apiEndpoint}role_choices/`);
            const result = await response.json();
            
            if (result.success) {
                this.cache.set(cacheKey, {
                    data: result.data,
                    timestamp: Date.now()
                });
                
                this.updateOptions(result.data);
                return result.data;
            } else {
                console.error('Failed to load roles:', result.error);
            }
        } catch (error) {
            console.error('Error loading roles:', error);
        }
    }
    
    updateOptions(roles) {
        const currentValue = this.element.value;
        
        // æ¸…ç©ºç°æœ‰é€‰é¡¹
        this.element.innerHTML = '';
        
        // æ·»åŠ ç©ºé€‰é¡¹
        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = '---------';
        this.element.appendChild(emptyOption);
        
        // æ·»åŠ è§’è‰²é€‰é¡¹
        roles.forEach(role => {
            if (role.value) { // è·³è¿‡ç©ºå€¼
                const option = document.createElement('option');
                option.value = role.value;
                option.textContent = role.label;
                this.element.appendChild(option);
            }
        });
        
        // æ¢å¤ä¹‹å‰çš„å€¼
        this.element.value = currentValue;
    }
    
    setupPreview() {
        // åˆ›å»ºé¢„è§ˆå®¹å™¨
        const previewContainer = document.createElement('div');
        previewContainer.className = 'role-preview-container';
        previewContainer.style.cssText = `
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            display: none;
        `;
        
        this.element.parentNode.appendChild(previewContainer);
        this.previewContainer = previewContainer;
    }
    
    async showRolePreview(roleCode) {
        if (!this.previewContainer || !roleCode) {
            if (this.previewContainer) {
                this.previewContainer.style.display = 'none';
            }
            return;
        }
        
        try {
            const response = await fetch(`${this.options.apiEndpoint}${roleCode}/role_info/`);
            const result = await response.json();
            
            if (result.success) {
                const roleInfo = result.data;
                this.previewContainer.innerHTML = `
                    <h4 style="margin: 0 0 8px 0; color: #495057;">è§’è‰²ä¿¡æ¯é¢„è§ˆ</h4>
                    <div><strong>è§’è‰²åç§°ï¼š</strong>${roleInfo.display_name}</div>
                    <div><strong>è§’è‰²ä»£ç ï¼š</strong>${roleInfo.code}</div>
                    <div><strong>æè¿°ï¼š</strong>${roleInfo.description || 'æ— '}</div>
                    <div><strong>ç±»å‹ï¼š</strong>${roleInfo.is_predefined ? 'ç³»ç»Ÿé¢„å®šä¹‰' : 'è‡ªå®šä¹‰è§’è‰²'}</div>
                    <div><strong>ç”¨æˆ·æ•°é‡ï¼š</strong>${roleInfo.user_count || 0}</div>
                    <div><strong>çŠ¶æ€ï¼š</strong><span style="color: ${roleInfo.is_active ? '#28a745' : '#dc3545'}">${roleInfo.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></div>
                `;
                this.previewContainer.style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading role preview:', error);
        }
    }
    
    setupValidation() {
        this.element.addEventListener('change', (e) => {
            this.validateRole(e.target.value);
        });
    }
    
    async validateRole(roleCode) {
        if (!roleCode) return true;
        
        try {
            const response = await fetch(`${this.options.apiEndpoint}${roleCode}/role_info/`);
            const result = await response.json();
            
            if (result.success) {
                const roleInfo = result.data;
                
                // æ£€æŸ¥è§’è‰²æ˜¯å¦å¯ç”¨
                if (!roleInfo.is_active) {
                    this.showValidationError('æ‰€é€‰è§’è‰²å·²è¢«ç¦ç”¨');
                    return false;
                }
                
                this.clearValidationError();
                return true;
            } else {
                this.showValidationError('æ— æ•ˆçš„è§’è‰²é€‰æ‹©');
                return false;
            }
        } catch (error) {
            console.error('Error validating role:', error);
            return false;
        }
    }
    
    showValidationError(message) {
        this.clearValidationError();
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'role-validation-error';
        errorDiv.style.cssText = `
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            padding: 5px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 3px;
        `;
        errorDiv.textContent = message;
        
        this.element.parentNode.appendChild(errorDiv);
        this.element.style.borderColor = '#dc3545';
    }
    
    clearValidationError() {
        const existingError = this.element.parentNode.querySelector('.role-validation-error');
        if (existingError) {
            existingError.remove();
        }
        this.element.style.borderColor = '';
    }
    
    onRoleChange(roleCode) {
        if (this.options.enablePreview) {
            this.showRolePreview(roleCode);
        }
        
        // è‡ªå®šä¹‰äº‹ä»¶è§¦å‘å·²ç§»é™¤
    }
    
    syncWithOtherSelectors(roleCode) {
        // å¯ä»¥åœ¨è¿™é‡Œå®ç°ä¸å…¶ä»–è§’è‰²é€‰æ‹©å™¨çš„åŒæ­¥é€»è¾‘
        console.log('Syncing with other selectors:', roleCode);
    }
    
    async refresh() {
        await this.loadRoles(true);
    }
    
    destroy() {
        if (this.previewContainer) {
            this.previewContainer.remove();
        }
        
        const errorDiv = this.element.parentNode.querySelector('.role-validation-error');
        if (errorDiv) {
            errorDiv.remove();
        }
    }
}

// å…¨å±€åˆå§‹åŒ–å·²ç§»é™¤
// è§’è‰²é€‰æ‹©å™¨è‡ªåŠ¨å¢å¼ºåŠŸèƒ½å·²ç¦ç”¨

// å¯¼å‡ºåˆ°å…¨å±€
window.EnhancedRoleSelector = EnhancedRoleSelector;
```

### ç¬¬äº”é˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

#### æ­¥éª¤9ï¼šæ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

**æ–‡ä»¶ï¼š`apps/accounts/migrations/0010_optimize_role_indexes.py`**
```python
from django.db import migrations, models


class Migration(migrations.Migration):
    
    dependencies = [
        ('accounts', '0009_add_role_template_system'),
    ]
    
    operations = [
        # ä¸ºCustomUser.roleæ·»åŠ ç´¢å¼•
        migrations.RunSQL(
            "CREATE INDEX IF NOT EXISTS accounts_customuser_role_active_idx ON accounts_customuser (role, is_active);",
            reverse_sql="DROP INDEX IF EXISTS accounts_customuser_role_active_idx;"
        ),
        
        # ä¸ºRoleExtensionæ·»åŠ å¤åˆç´¢å¼•
        migrations.RunSQL(
            "CREATE INDEX IF NOT EXISTS accounts_roleextension_role_active_idx ON accounts_roleextension (role, is_active);",
            reverse_sql="DROP INDEX IF EXISTS accounts_roleextension_role_active_idx;"
        ),
        
        # ä¸ºUserExtensionDataæ·»åŠ å¤åˆç´¢å¼•
        migrations.RunSQL(
            "CREATE INDEX IF NOT EXISTS accounts_userextensiondata_user_role_idx ON accounts_userextensiondata (user_id, role_extension_id);",
            reverse_sql="DROP INDEX IF EXISTS accounts_userextensiondata_user_role_idx;"
        ),
    ]
```

#### æ­¥éª¤10ï¼šæŸ¥è¯¢ä¼˜åŒ–

**æ–‡ä»¶ï¼š`apps/accounts/managers.py`**
```python
from django.db import models
from django.db.models import Prefetch


class CustomUserManager(models.Manager):
    """ä¼˜åŒ–çš„ç”¨æˆ·ç®¡ç†å™¨"""
    
    def with_role_data(self):
        """é¢„åŠ è½½è§’è‰²ç›¸å…³æ•°æ®"""
        return self.select_related(
            'role_level'
        ).prefetch_related(
            'groups',
            Prefetch(
                'user_extensions',
                queryset=models.get_model('accounts', 'UserExtensionData').objects.select_related('role_extension')
            )
        )
    
    def by_role(self, role, active_only=True):
        """æŒ‰è§’è‰²ç­›é€‰ç”¨æˆ·"""
        queryset = self.filter(role=role)
        if active_only:
            queryset = queryset.filter(is_active=True)
        return queryset.with_role_data()
    
    def role_statistics(self):
        """è§’è‰²ç»Ÿè®¡æŸ¥è¯¢"""
        return self.filter(
            is_active=True
        ).values('role').annotate(
            user_count=models.Count('id')
        ).order_by('role')


class RoleExtensionManager(models.Manager):
    """è§’è‰²å¢é¡¹ç®¡ç†å™¨"""
    
    def active_for_role(self, role):
        """è·å–æŒ‡å®šè§’è‰²çš„æ´»è·ƒå¢é¡¹"""
        return self.filter(
            role=role,
            is_active=True
        ).order_by('sort_order', 'field_name')
    
    def with_user_data(self, user):
        """é¢„åŠ è½½ç”¨æˆ·å¢é¡¹æ•°æ®"""
        return self.prefetch_related(
            Prefetch(
                'userextensiondata_set',
                queryset=models.get_model('accounts', 'UserExtensionData').objects.filter(user=user)
            )
        )
```

**ä¿®æ”¹æ–‡ä»¶ï¼š`apps/accounts/models.py`**
```python
# åœ¨CustomUseræ¨¡å‹ä¸­æ·»åŠ 
class CustomUser(AbstractUser):
    # ... ç°æœ‰å­—æ®µ ...
    
    objects = CustomUserManager()  # ä½¿ç”¨è‡ªå®šä¹‰ç®¡ç†å™¨
    
    class Meta:
        verbose_name = 'ç”¨æˆ·'
        verbose_name_plural = 'ç”¨æˆ·ç®¡ç†'
        indexes = [
            models.Index(fields=['role', 'is_active']),
            models.Index(fields=['role', 'date_joined']),
        ]

# åœ¨RoleExtensionæ¨¡å‹ä¸­æ·»åŠ 
class RoleExtension(models.Model):
    # ... ç°æœ‰å­—æ®µ ...
    
    objects = RoleExtensionManager()  # ä½¿ç”¨è‡ªå®šä¹‰ç®¡ç†å™¨
    
    class Meta:
        verbose_name = 'è§’è‰²å¢é¡¹é…ç½®'
        verbose_name_plural = 'è§’è‰²å¢é¡¹é…ç½®ç®¡ç†'
        indexes = [
            models.Index(fields=['role', 'is_active']),
            models.Index(fields=['role', 'sort_order']),
        ]
```

## ğŸ§ª æµ‹è¯•æ–¹æ¡ˆ

### å•å…ƒæµ‹è¯•

**æ–‡ä»¶ï¼š`apps/accounts/tests/test_role_service.py`**
```python
from django.test import TestCase
from django.core.cache import cache
from apps.accounts.services.role_service import RoleService
from apps.accounts.models import UserRole
from apps.permissions.models import RoleManagement


class RoleServiceTest(TestCase):
    
    def setUp(self):
        cache.clear()
        
        # åˆ›å»ºæµ‹è¯•è§’è‰²
        self.test_role = RoleManagement.objects.create(
            role='test_role',
            display_name='æµ‹è¯•è§’è‰²',
            description='ç”¨äºæµ‹è¯•çš„è§’è‰²',
            is_active=True,
            sort_order=100
        )
    
    def test_get_all_roles(self):
        """æµ‹è¯•è·å–æ‰€æœ‰è§’è‰²"""
        roles = RoleService.get_all_roles()
        
        # åº”è¯¥åŒ…å«é¢„å®šä¹‰è§’è‰²å’Œè‡ªå®šä¹‰è§’è‰²
        role_codes = [role['code'] for role in roles]
        
        # æ£€æŸ¥é¢„å®šä¹‰è§’è‰²
        for role_code, _ in UserRole.choices:
            self.assertIn(role_code, role_codes)
        
        # æ£€æŸ¥è‡ªå®šä¹‰è§’è‰²
        self.assertIn('test_role', role_codes)
    
    def test_get_role_choices(self):
        """æµ‹è¯•è·å–è§’è‰²é€‰æ‹©é¡¹"""
        choices = RoleService.get_role_choices()
        
        # åº”è¯¥æ˜¯å…ƒç»„åˆ—è¡¨æ ¼å¼
        self.assertIsInstance(choices, list)
        self.assertTrue(all(isinstance(choice, tuple) and len(choice) == 2 for choice in choices))
        
        # åº”è¯¥åŒ…å«ç©ºé€‰é¡¹
        self.assertEqual(choices[0], ('', '---------'))
    
    def test_cache_functionality(self):
        """æµ‹è¯•ç¼“å­˜åŠŸèƒ½"""
        # ç¬¬ä¸€æ¬¡è°ƒç”¨
        roles1 = RoleService.get_all_roles()
        
        # ç¬¬äºŒæ¬¡è°ƒç”¨åº”è¯¥ä½¿ç”¨ç¼“å­˜
        roles2 = RoleService.get_all_roles()
        
        self.assertEqual(roles1, roles2)
        
        # æ¸…é™¤ç¼“å­˜ååº”è¯¥é‡æ–°åŠ è½½
        RoleService.clear_cache()
        roles3 = RoleService.get_all_roles()
        
        self.assertEqual(roles1, roles3)
    
    def test_role_info(self):
        """æµ‹è¯•è·å–è§’è‰²ä¿¡æ¯"""
        role_info = RoleService.get_role_info('test_role')
        
        self.assertIsNotNone(role_info)
        self.assertEqual(role_info['code'], 'test_role')
        self.assertEqual(role_info['display_name'], 'æµ‹è¯•è§’è‰²')
        self.assertFalse(role_info['is_predefined'])
        self.assertTrue(role_info['is_active'])
```

### é›†æˆæµ‹è¯•

**æ–‡ä»¶ï¼š`apps/accounts/tests/test_role_integration.py`**
```python
from django.test import TestCase, Client
from django.contrib.auth import get_user_model
from django.urls import reverse
from apps.accounts.models import UserRole
from apps.permissions.models import RoleManagement

User = get_user_model()


class RoleIntegrationTest(TestCase):
    
    def setUp(self):
        self.client = Client()
        
        # åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
        self.admin_user = User.objects.create_superuser(
            username='admin',
            email='admin@test.com',
            password='testpass123'
        )
        
        # åˆ›å»ºæµ‹è¯•è§’è‰²
        self.test_role = RoleManagement.objects.create(
            role='integration_test_role',
            display_name='é›†æˆæµ‹è¯•è§’è‰²',
            is_active=True
        )
    
    def test_admin_role_selector(self):
        """æµ‹è¯•Adminç•Œé¢è§’è‰²é€‰æ‹©å™¨"""
        self.client.login(username='admin', password='testpass123')
        
        # è®¿é—®ç”¨æˆ·æ·»åŠ é¡µé¢
        response = self.client.get(reverse('admin:accounts_customuser_add'))
        self.assertEqual(response.status_code, 200)
        
        # æ£€æŸ¥è§’è‰²é€‰æ‹©å™¨æ˜¯å¦åŒ…å«æµ‹è¯•è§’è‰²
        self.assertContains(response, 'integration_test_role')
        self.assertContains(response, 'é›†æˆæµ‹è¯•è§’è‰²')
    
    def test_api_role_endpoints(self):
        """æµ‹è¯•è§’è‰²APIç«¯ç‚¹"""
        self.client.login(username='admin', password='testpass123')
        
        # æµ‹è¯•è§’è‰²åˆ—è¡¨API
        response = self.client.get('/accounts/api/roles/list_roles/')
        self.assertEqual(response.status_code, 200)
        
        data = response.json()
        self.assertTrue(data['success'])
        self.assertIsInstance(data['data'], list)
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«æµ‹è¯•è§’è‰²
        role_codes = [role['code'] for role in data['data']]
        self.assertIn('integration_test_role', role_codes)
    
    def test_role_cache_refresh(self):
        """æµ‹è¯•è§’è‰²ç¼“å­˜åˆ·æ–°"""
        self.client.login(username='admin', password='testpass123')
        
        # åˆ·æ–°ç¼“å­˜
        response = self.client.post('/accounts/api/roles/refresh_cache/')
        self.assertEqual(response.status_code, 200)
        
        data = response.json()
        self.assertTrue(data['success'])
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### æ€§èƒ½ç›‘æ§

**æ–‡ä»¶ï¼š`apps/accounts/monitoring.py`**
```python
import time
import logging
from functools import wraps
from django.core.cache import cache
from django.db import connection

logger = logging.getLogger('role_system')


def monitor_role_performance(func):
    """è§’è‰²æ“ä½œæ€§èƒ½ç›‘æ§è£…é¥°å™¨"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        start_time = time.time()
        start_queries = len(connection.queries)
        
        try:
            result = func(*args, **kwargs)
            
            end_time = time.time()
            end_queries = len(connection.queries)
            
            execution_time = end_time - start_time
            query_count = end_queries - start_queries
            
            # è®°å½•æ€§èƒ½æ•°æ®
            logger.info(f"Role operation {func.__name__}: {execution_time:.3f}s, {query_count} queries")
            
            # å¦‚æœæ€§èƒ½è¾ƒå·®ï¼Œè®°å½•è­¦å‘Š
            if execution_time > 1.0 or query_count > 10:
                logger.warning(f"Slow role operation detected: {func.__name__} took {execution_time:.3f}s with {query_count} queries")
            
            return result
            
        except Exception as e:
            logger.error(f"Role operation {func.__name__} failed: {str(e)}")
            raise
    
    return wrapper


class RoleSystemHealthCheck:
    """è§’è‰²ç³»ç»Ÿå¥åº·æ£€æŸ¥"""
    
    @staticmethod
    def check_cache_health():
        """æ£€æŸ¥ç¼“å­˜å¥åº·çŠ¶æ€"""
        try:
            test_key = 'health_check_test'
            cache.set(test_key, 'test_value', 60)
            value = cache.get(test_key)
            cache.delete(test_key)
            
            return value == 'test_value'
        except Exception:
            return False
    
    @staticmethod
    def check_database_health():
        """æ£€æŸ¥æ•°æ®åº“å¥åº·çŠ¶æ€"""
        try:
            from apps.accounts.models import CustomUser
            CustomUser.objects.count()
            return True
        except Exception:
            return False
    
    @staticmethod
    def check_role_data_consistency():
        """æ£€æŸ¥è§’è‰²æ•°æ®ä¸€è‡´æ€§"""
        try:
            from apps.accounts.services.role_service import RoleService
            from apps.permissions.models import RoleManagement
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å­¤ç«‹çš„è§’è‰²æ•°æ®
            service_roles = {role['code'] for role in RoleService.get_all_roles()}
            db_roles = set(RoleManagement.objects.values_list('role', flat=True))
            
            # åº”è¯¥æ²¡æœ‰æ•°æ®åº“ä¸­å­˜åœ¨ä½†æœåŠ¡ä¸­ä¸å­˜åœ¨çš„è§’è‰²
            orphaned_roles = db_roles - service_roles
            
            return len(orphaned_roles) == 0
        except Exception:
            return False
    
    @classmethod
    def run_full_check(cls):
        """è¿è¡Œå®Œæ•´å¥åº·æ£€æŸ¥"""
        results = {
            'cache_health': cls.check_cache_health(),
            'database_health': cls.check_database_health(),
            'data_consistency': cls.check_role_data_consistency(),
        }
        
        results['overall_health'] = all(results.values())
        
        return results
```

## ğŸš€ éƒ¨ç½²æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥

1. **ä»£ç å®¡æŸ¥**
   - [ ] æ‰€æœ‰æ–°æ–‡ä»¶å·²åˆ›å»º
   - [ ] ç°æœ‰æ–‡ä»¶ä¿®æ”¹æ­£ç¡®
   - [ ] å¯¼å…¥è¯­å¥æ­£ç¡®
   - [ ] æ²¡æœ‰è¯­æ³•é”™è¯¯

2. **æ•°æ®åº“è¿ç§»**
   - [ ] è¿è¡Œ `python manage.py makemigrations`
   - [ ] è¿è¡Œ `python manage.py migrate`
   - [ ] æ£€æŸ¥ç´¢å¼•æ˜¯å¦æ­£ç¡®åˆ›å»º

3. **ç¼“å­˜é…ç½®**
   - [ ] ç¡®è®¤ç¼“å­˜åç«¯é…ç½®æ­£ç¡®
   - [ ] æµ‹è¯•ç¼“å­˜è¯»å†™åŠŸèƒ½

4. **é™æ€æ–‡ä»¶**
   - [ ] è¿è¡Œ `python manage.py collectstatic`
   - [ ] ç¡®è®¤JavaScriptå’ŒCSSæ–‡ä»¶æ­£ç¡®åŠ è½½

### éƒ¨ç½²æ­¥éª¤

1. **å¤‡ä»½ç°æœ‰æ•°æ®**
   ```bash
   python manage.py dumpdata accounts permissions > backup_before_role_optimization.json
   ```

2. **åº”ç”¨ä»£ç æ›´æ”¹**
   ```bash
   git add .
   git commit -m "Implement role system optimization"
   ```

3. **è¿è¡Œè¿ç§»**
   ```bash
   python manage.py migrate
   ```

4. **åˆ·æ–°ç¼“å­˜**
   ```bash
   python manage.py shell -c "from apps.accounts.services.role_service import RoleService; RoleService.refresh_cache()"
   ```

5. **è¿è¡Œæµ‹è¯•**
   ```bash
   python manage.py test apps.accounts.tests.test_role_service
   python manage.py test apps.accounts.tests.test_role_integration
   ```

6. **éªŒè¯åŠŸèƒ½**
   - [ ] è®¿é—®Adminç•Œé¢ï¼Œæ£€æŸ¥è§’è‰²é€‰æ‹©å™¨
   - [ ] æµ‹è¯•APIç«¯ç‚¹
   - [ ] éªŒè¯ç¼“å­˜åŠŸèƒ½
   - [ ] æ£€æŸ¥æ€§èƒ½ç›‘æ§

### å›æ»šæ–¹æ¡ˆ

å¦‚æœéƒ¨ç½²å‡ºç°é—®é¢˜ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤å›æ»šï¼š

1. **æ¢å¤ä»£ç **
   ```bash
   git revert HEAD
   ```

2. **æ¢å¤æ•°æ®åº“**
   ```bash
   python manage.py migrate accounts 0009
   python manage.py loaddata backup_before_role_optimization.json
   ```

3. **æ¸…é™¤ç¼“å­˜**
   ```bash
   python manage.py shell -c "from django.core.cache import cache; cache.clear()"
   ```

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

å®æ–½å®Œæˆåï¼Œç³»ç»Ÿå°†å®ç°ï¼š

1. **å®Œå…¨ä¸€è‡´çš„è§’è‰²æ•°æ®æº**ï¼šæ‰€æœ‰é¡µé¢å’ŒAPIä½¿ç”¨ç»Ÿä¸€çš„è§’è‰²æœåŠ¡
2. **è‡ªåŠ¨åŒ–çš„è§’è‰²ç®¡ç†**ï¼šè§’è‰²å˜æ›´è‡ªåŠ¨åŒæ­¥åˆ°æ‰€æœ‰ç›¸å…³ç»„ä»¶
3. **ä¼˜åŒ–çš„æ€§èƒ½**ï¼šç¼“å­˜æœºåˆ¶å’Œæ•°æ®åº“ç´¢å¼•æ˜¾è‘—æå‡æŸ¥è¯¢é€Ÿåº¦
4. **å¢å¼ºçš„ç”¨æˆ·ä½“éªŒ**ï¼šå®æ—¶éªŒè¯ã€é¢„è§ˆåŠŸèƒ½å’Œç»Ÿä¸€çš„äº¤äº’ç•Œé¢
5. **å®Œå–„çš„ç›‘æ§ä½“ç³»**ï¼šæ€§èƒ½ç›‘æ§å’Œå¥åº·æ£€æŸ¥ç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œ

é€šè¿‡è¿™å¥—å®Œæ•´çš„å®æ–½æ–¹æ¡ˆï¼Œå¯ä»¥å½»åº•è§£å†³å½“å‰è§’è‰²ç³»ç»Ÿä¸­å­˜åœ¨çš„é—®é¢˜ï¼Œå®ç°çœŸæ­£çš„ç»Ÿä¸€åŒ–å’Œè‡ªåŠ¨åŒ–ç®¡ç†ã€‚