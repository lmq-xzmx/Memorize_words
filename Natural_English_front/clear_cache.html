<!DOCTYPE html>
<html>
<head>
    <title>清除前端缓存</title>
</head>
<body>
    <h1>清除前端缓存</h1>
    <button onclick="clearCache()">清除缓存</button>
    <button onclick="relogin()">重新登录</button>
    <div id="result"></div>
    
    <script>
        function clearCache() {
            // 清除所有相关的 localStorage 数据
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            localStorage.removeItem('userRole');
            localStorage.removeItem('permissions');
            
            // 清除所有以 permission 开头的缓存
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('permission') || key.startsWith('menu') || key.startsWith('role')) {
                    localStorage.removeItem(key);
                }
            });
            
            document.getElementById('result').innerHTML = '<p style="color: green;">缓存已清除！</p>';
            console.log('前端缓存已清除');
        }
        
        async function relogin() {
            try {
                // 清除缓存
                clearCache();
                
                // 重新登录
                const response = await fetch('/accounts/api/auth/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'xzmx',
                        password: '123456'
                    })
                });
                
                const data = await response.json();
                
                if (data.token) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data));
                    document.getElementById('result').innerHTML = '<p style="color: green;">重新登录成功！用户角色: ' + data.role + '</p>';
                } else {
                    document.getElementById('result').innerHTML = '<p style="color: red;">登录失败: ' + data.message + '</p>';
                }
            } catch (error) {
                document.getElementById('result').innerHTML = '<p style="color: red;">登录错误: ' + error.message + '</p>';
            }
        }
        
        // 页面加载时显示当前状态
        window.onload = function() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                const userData = JSON.parse(user);
                document.getElementById('result').innerHTML = 
                    '<p>当前登录状态: 已登录</p>' +
                    '<p>用户: ' + userData.username + '</p>' +
                    '<p>角色: ' + userData.role + '</p>' +
                    '<p>Token: ' + token.substring(0, 20) + '...</p>';
            } else {
                document.getElementById('result').innerHTML = '<p>当前登录状态: 未登录</p>';
            }
        };
    </script>
</body>
</html>