<!DOCTYPE html>
<html>
<head>
    <title>ç®€å•WebSocketæµ‹è¯•</title>
</head>
<body>
    <h1>ç®€å•WebSocketè¿æ¥æµ‹è¯•</h1>
    <div id="status">çŠ¶æ€: æœªè¿æ¥</div>
    <div id="logs" style="height: 400px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin: 10px 0;"></div>
    <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
    <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>

    <script>
        let ws = null;
        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(status) {
            statusDiv.textContent = `çŠ¶æ€: ${status}`;
        }

        function testConnection() {
            if (ws) {
                log('å…³é—­ç°æœ‰è¿æ¥');
                ws.close();
            }

            const wsUrl = 'ws://localhost:8000/ws/permissions/anonymous/';
            log(`å°è¯•è¿æ¥åˆ°: ${wsUrl}`);
            updateStatus('è¿æ¥ä¸­...');

            try {
                ws = new WebSocket(wsUrl);
                log('WebSocketå¯¹è±¡å·²åˆ›å»º');

                ws.onopen = function(event) {
                    log('<span style="color: green;">âœ“ WebSocketè¿æ¥å·²å»ºç«‹</span>');
                    updateStatus('å·²è¿æ¥');
                    
                    // å‘é€è¿æ¥æ¶ˆæ¯
                    const connectMessage = {
                        type: 'connect',
                        data: {
                            user_id: null,
                            client_info: 'simple-test'
                        },
                        timestamp: Date.now()
                    };
                    
                    try {
                        const messageStr = JSON.stringify(connectMessage);
                        ws.send(messageStr);
                        log('âœ“ å·²å‘é€è¿æ¥æ¶ˆæ¯: ' + messageStr);
                    } catch (e) {
                        log('<span style="color: red;">âœ— å‘é€æ¶ˆæ¯å¤±è´¥: ' + e.message + '</span>');
                    }
                };

                ws.onmessage = function(event) {
                    log('<span style="color: blue;">ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ' + event.data + '</span>');
                    try {
                        const message = JSON.parse(event.data);
                        log('ğŸ“‹ è§£æåçš„æ¶ˆæ¯ç±»å‹: ' + message.type);
                        log('ğŸ“‹ æ¶ˆæ¯æ•°æ®: ' + JSON.stringify(message.data, null, 2));
                        
                        // æ¨¡æ‹Ÿå‰ç«¯å¤„ç†é€»è¾‘
                        if (message.type === 'connection_confirmed') {
                            log('<span style="color: green;">âœ“ æ”¶åˆ°è¿æ¥ç¡®è®¤æ¶ˆæ¯</span>');
                            // ä¸åšä»»ä½•å¯èƒ½å¯¼è‡´é”™è¯¯çš„æ“ä½œ
                        }
                    } catch (e) {
                        log('<span style="color: red;">âœ— æ¶ˆæ¯è§£æå¤±è´¥: ' + e.message + '</span>');
                    }
                };

                ws.onclose = function(event) {
                    const reason = event.reason || 'æ— åŸå› ';
                    log(`<span style="color: orange;">âš  WebSocketè¿æ¥å·²å…³é—­</span>`);
                    log(`å…³é—­ä»£ç : ${event.code}`);
                    log(`å…³é—­åŸå› : ${reason}`);
                    log(`æ˜¯å¦å¹²å‡€å…³é—­: ${event.wasClean}`);
                    updateStatus('å·²æ–­å¼€');
                };

                ws.onerror = function(error) {
                    log('<span style="color: red;">âœ— WebSocketé”™è¯¯å‘ç”Ÿ</span>');
                    log('é”™è¯¯å¯¹è±¡: ' + JSON.stringify(error));
                    log('é”™è¯¯ç±»å‹: ' + error.constructor.name);
                    updateStatus('é”™è¯¯');
                };

            } catch (error) {
                log('<span style="color: red;">âœ— åˆ›å»ºWebSocketæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message + '</span>');
                updateStatus('é”™è¯¯');
            }
        }

        function clearLogs() {
            logsDiv.innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            log('é¡µé¢å·²åŠ è½½ï¼Œå‡†å¤‡æµ‹è¯•WebSocketè¿æ¥');
            setTimeout(testConnection, 1000);
        };
    </script>
</body>
</html>