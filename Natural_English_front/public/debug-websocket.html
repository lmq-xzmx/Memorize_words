<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Debug</title>
</head>
<body>
    <h1>WebSocket连接调试</h1>
    <div id="status">状态: 未连接</div>
    <div id="logs"></div>
    <button onclick="testConnection()">测试连接</button>
    <button onclick="clearLogs()">清除日志</button>

    <script>
        let ws = null;
        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logsDiv.appendChild(logEntry);
            console.log(message);
        }

        function updateStatus(status) {
            statusDiv.textContent = `状态: ${status}`;
        }

        function testConnection() {
            if (ws) {
                ws.close();
            }

            const wsUrl = 'ws://localhost:8000/ws/permissions/anonymous/';
            log(`尝试连接到: ${wsUrl}`);
            updateStatus('连接中...');

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = function(event) {
                    log('WebSocket连接已建立');
                    updateStatus('已连接');
                    
                    // 发送连接消息
                    const connectMessage = {
                        type: 'connect',
                        data: {
                            user_id: null,
                            client_info: 'debug-test'
                        }
                    };
                    ws.send(JSON.stringify(connectMessage));
                    log('已发送连接消息: ' + JSON.stringify(connectMessage));
                };

                ws.onmessage = function(event) {
                    log('收到消息: ' + event.data);
                    try {
                        const message = JSON.parse(event.data);
                        log('解析后的消息: ' + JSON.stringify(message, null, 2));
                    } catch (e) {
                        log('消息解析失败: ' + e.message);
                    }
                };

                ws.onclose = function(event) {
                    log(`WebSocket连接已关闭: 代码=${event.code}, 原因=${event.reason}`);
                    updateStatus('已断开');
                };

                ws.onerror = function(error) {
                    log('WebSocket错误: ' + JSON.stringify(error));
                    log('错误对象: ' + error.toString());
                    updateStatus('错误');
                };

            } catch (error) {
                log('创建WebSocket时发生错误: ' + error.message);
                updateStatus('错误');
            }
        }

        function clearLogs() {
            logsDiv.innerHTML = '';
        }

        // 页面加载时自动测试
        window.onload = function() {
            testConnection();
        };
    </script>
</body>
</html>