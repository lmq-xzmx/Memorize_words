<!DOCTYPE html>
<html>
<head>
    <title>前端WebSocket连接测试</title>
</head>
<body>
    <h1>前端WebSocket连接测试</h1>
    <div id="status">状态: 未连接</div>
    <div id="messages"></div>
    <button onclick="connect()">连接</button>
    <button onclick="disconnect()">断开</button>
    <button onclick="sendHeartbeat()">发送心跳</button>

    <script>
        let ws = null;
        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');

        function log(message) {
            const time = new Date().toLocaleTimeString();
            messagesDiv.innerHTML += `<div>[${time}] ${message}</div>`;
            console.log(message);
        }

        function updateStatus(status) {
            statusDiv.textContent = `状态: ${status}`;
        }

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('WebSocket已经连接');
                return;
            }

            // 使用与前端应用相同的URL构建逻辑
            const baseUrl = 'ws://127.0.0.1:8000/ws/permissions/';
            const wsUrl = baseUrl + 'anonymous/';
            
            log(`尝试连接到: ${wsUrl}`);
            updateStatus('连接中...');

            ws = new WebSocket(wsUrl);

            ws.onopen = function(event) {
                log('WebSocket连接已建立');
                updateStatus('已连接');
                
                // 发送连接消息
                const connectMessage = {
                    type: 'connect',
                    data: {
                        user_id: null,
                        client_info: 'test-frontend'
                    },
                    timestamp: Date.now()
                };
                ws.send(JSON.stringify(connectMessage));
                log('已发送连接消息');
            };

            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    log(`收到消息: ${message.type} - ${JSON.stringify(message.data)}`);
                } catch (e) {
                    log(`收到原始消息: ${event.data}`);
                }
            };

            ws.onclose = function(event) {
                log(`WebSocket连接已关闭，代码: ${event.code}, 原因: ${event.reason}`);
                updateStatus('已断开');
            };

            ws.onerror = function(error) {
                log(`WebSocket错误: ${error}`);
                updateStatus('错误');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
                log('主动断开连接');
                updateStatus('已断开');
            }
        }

        function sendHeartbeat() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const heartbeatMessage = {
                    type: 'heartbeat',
                    data: {
                        timestamp: Date.now()
                    },
                    timestamp: Date.now()
                };
                ws.send(JSON.stringify(heartbeatMessage));
                log('已发送心跳消息');
            } else {
                log('WebSocket未连接，无法发送心跳');
            }
        }

        // 页面加载时自动连接
        window.onload = function() {
            log('页面已加载，准备测试WebSocket连接');
        };
    </script>
</body>
</html>