from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from django.utils.html import format_html
from django.urls import reverse, path
from django.db import models
from django.contrib.auth.models import Group
from django import forms
from django.http import HttpResponseRedirect, JsonResponse
from django.shortcuts import get_object_or_404, render
from django.contrib import messages
from django.contrib.auth.forms import SetPasswordForm
from django.template.response import TemplateResponse
from django.core.exceptions import ObjectDoesNotExist
from typing import TYPE_CHECKING
from .models import CustomUser, UserLoginLog, UserRole, LearningProfile, RoleApproval, RoleExtension, UserExtensionData, RoleUserGroup, RoleLevel, RoleUser, UserExtension
from apps.permissions.widgets import StandardRoleSelectWidget, StandardRoleChoiceField
from apps.permissions.role_selector_config import StandardRoleAdminMixin

if TYPE_CHECKING:
    from django.forms import ModelForm

# è§’è‰²ä¸ç»„æ˜ å°„å…³ç³»
ROLE_GROUP_MAPPING = {
    UserRole.STUDENT: 'å­¦ç”Ÿç»„',
    UserRole.PARENT: 'å®¶é•¿ç»„', 
    UserRole.TEACHER: 'æ•™å¸ˆç»„',
    UserRole.ADMIN: 'ç®¡ç†å‘˜ç»„',
}

def sync_user_role_to_group(user):
    """åŒæ­¥ç”¨æˆ·è§’è‰²åˆ°å¯¹åº”çš„ç»„"""
    if not user.role:
        return False, "ç”¨æˆ·æ²¡æœ‰è®¾ç½®è§’è‰²"
    
    # è·å–ç›®æ ‡ç»„
    target_group_name = ROLE_GROUP_MAPPING.get(user.role)
    if not target_group_name:
        return False, f"è§’è‰² {user.get_role_display()} æ²¡æœ‰å¯¹åº”çš„ç»„"
    
    try:
        target_group = Group.objects.get(name=target_group_name)
    except ObjectDoesNotExist:
        return False, f"ç»„ {target_group_name} ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œåˆå§‹åŒ–å‘½ä»¤"
    
    # ç§»é™¤ç”¨æˆ·ä»æ‰€æœ‰è§’è‰²ç»„
    removed_groups = []
    for group_name in ROLE_GROUP_MAPPING.values():
        try:
            group = Group.objects.get(name=group_name)
            if user.groups.filter(pk=group.pk).exists():
                user.groups.remove(group)
                removed_groups.append(group_name)
        except ObjectDoesNotExist:
            pass
    
    # æ·»åŠ ç”¨æˆ·åˆ°ç›®æ ‡ç»„
    if not user.groups.filter(pk=target_group.pk).exists():
        user.groups.add(target_group)
        return True, f"å·²å°†ç”¨æˆ·åˆ†é…åˆ° {target_group_name}"
    else:
        return True, f"ç”¨æˆ·å·²åœ¨ {target_group_name} ä¸­"


# è‡ªå®šä¹‰è¡¨å•ï¼Œè®©groupså­—æ®µå˜ä¸ºåªè¯»
class CustomUserForm(forms.ModelForm):
    """è‡ªå®šä¹‰ç”¨æˆ·è¡¨å•ï¼Œgroupså­—æ®µåªè¯»"""
    role = StandardRoleChoiceField(widget=StandardRoleSelectWidget())
    
    class Meta:
        model = CustomUser
        fields = '__all__'
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # è®©groupså­—æ®µå˜ä¸ºåªè¯»
        if 'groups' in self.fields:
            self.fields['groups'].widget.attrs.update({
                'readonly': True,
                'disabled': True,
                'style': 'background-color: #f8f9fa; color: #6c757d; cursor: not-allowed;'
            })
            self.fields['groups'].help_text = 'ğŸ’¡ ç»„ä¼šæ ¹æ®è§’è‰²è‡ªåŠ¨åˆ†é…ï¼Œæ— éœ€æ‰‹åŠ¨é€‰æ‹©'


# ä»£ç†æ¨¡å‹å·²ç§»é™¤ï¼Œç»Ÿä¸€ä½¿ç”¨CustomUserè¿›è¡Œç®¡ç†


# åŸºç¡€ç”¨æˆ·Adminç±»
class BaseRoleUserAdmin(UserAdmin):
    """åŸºç¡€è§’è‰²ç”¨æˆ·Adminç±»"""
    form = CustomUserForm
    list_display = ['username', 'real_name', 'role', 'get_role_groups', 'email', 'phone', 'english_level', 'is_active', 'date_joined']
    list_filter = ['role', 'english_level', 'is_active', 'date_joined', 'groups']
    search_fields = ['username', 'real_name', 'email', 'phone']
    ordering = ['-date_joined']
    
    # ä¿®æ”¹fieldsetsï¼Œç§»é™¤passwordå­—æ®µï¼Œå‚è€ƒDjangoæ ‡å‡†UserAdmin
    fieldsets = (
        (None, {'fields': ('username',)}),
        ('ä¸ªäººä¿¡æ¯', {'fields': ('real_name', 'email', 'phone', 'role')}),
        ('æƒé™', {'fields': ('is_active', 'is_staff', 'is_superuser')}),
        ('é‡è¦æ—¥æœŸ', {'fields': ('last_login', 'date_joined')}),
        ('å¤‡æ³¨', {'fields': ('notes',)}),
    )
    
    # åªè¯»å­—æ®µï¼Œé¿å…åœ¨ç¼–è¾‘é¡µé¢æ˜¾ç¤ºæ•æ„Ÿä¿¡æ¯
    readonly_fields = ['last_login', 'date_joined']
    add_fieldsets = (
        (None, {
            'classes': ('wide',),
            'fields': ('username', 'real_name', 'email', 'role', 'password1', 'password2'),
        }),
    )
    
    def get_role_groups(self, obj):
        """æ˜¾ç¤ºè§’è‰²å¯¹åº”çš„ç»„ï¼ˆè”åŠ¨æ˜¾ç¤ºï¼‰"""
        role_group = ROLE_GROUP_MAPPING.get(obj.role)
        user_groups = list(obj.groups.values_list('name', flat=True))
        
        if role_group:
            if role_group in user_groups:
                # å·²åŒæ­¥
                return format_html(
                    '<span style="color: #28a745; background: #d4edda; padding: 2px 6px; border-radius: 3px; font-size: 12px;">'
                    'ğŸ”— {} âœ“</span>',
                    role_group
                )
            else:
                # æœªåŒæ­¥
                return format_html(
                    '<span style="color: #dc3545; background: #f8d7da; padding: 2px 6px; border-radius: 3px; font-size: 12px;">'
                    'âš ï¸ {} (æœªåŒæ­¥)</span>',
                    role_group
                )
        else:
            if user_groups:
                return format_html(
                    '<span style="color: #6c757d;">{}</span>',
                    ', '.join(user_groups)
                )
            return format_html('<span style="color: #6c757d;">æ— ç»„</span>')
    
    get_role_groups.short_description = 'è§’è‰²ç»„ (è‡ªåŠ¨)'  # type: ignore
    
    def get_queryset(self, request):
        """åŸºç¡€æŸ¥è¯¢é›†"""
        return super().get_queryset(request).prefetch_related('groups')
    
    def save_model(self, request, obj, form, change):
        """ä¿å­˜æ¨¡å‹æ—¶è‡ªåŠ¨åŒæ­¥è§’è‰²åˆ°ç»„å¹¶åŒæ­¥å­¦ä¹ ä¿¡æ¯"""
        super().save_model(request, obj, form, change)
        
        # è‡ªåŠ¨åŒæ­¥è§’è‰²åˆ°ç»„
        success, message = sync_user_role_to_group(obj)
        if success:
            self.message_user(request, f'âœ… {message}', level=messages.SUCCESS)
        else:
            self.message_user(request, f'âŒ {message}', level=messages.ERROR)
        
        # åŒæ­¥å­¦ä¹ ä¿¡æ¯åˆ°è§’è‰²å¢é¡¹ç³»ç»Ÿï¼ˆä»…é™å­¦ç”Ÿè§’è‰²ï¼‰
        if obj.role == UserRole.STUDENT:
            self._sync_learning_info_to_extensions(request, obj)
    
    def _sync_learning_info_to_extensions(self, request, user):
        """åŒæ­¥å­¦ä¹ ä¿¡æ¯åˆ°è§’è‰²å¢é¡¹ç³»ç»Ÿ"""
        try:
            # åŒæ­¥å¹´çº§ä¿¡æ¯
            if user.grade_level:
                try:
                    grade_extension = RoleExtension.objects.get(
                        role=UserRole.STUDENT, 
                        field_name='grade_level',
                        is_active=True
                    )
                    UserExtensionData.objects.update_or_create(
                        user=user,
                        role_extension=grade_extension,
                        defaults={'field_value': user.grade_level}
                    )
                except RoleExtension.DoesNotExist:
                    pass
            
            # åŒæ­¥è‹±è¯­æ°´å¹³ä¿¡æ¯
            if user.english_level:
                try:
                    english_extension = RoleExtension.objects.get(
                        role=UserRole.STUDENT, 
                        field_name='english_level',
                        is_active=True
                    )
                    UserExtensionData.objects.update_or_create(
                        user=user,
                        role_extension=english_extension,
                        defaults={'field_value': user.english_level}
                    )
                except RoleExtension.DoesNotExist:
                    pass
                    
        except Exception as e:
            messages.warning(request, f'å­¦ä¹ ä¿¡æ¯åŒæ­¥åˆ°å¢é¡¹ç³»ç»Ÿæ—¶å‡ºç°é—®é¢˜: {str(e)}')


# è§’è‰²ä¸“å±Adminç±»å·²ç§»é™¤ï¼Œç»Ÿä¸€ä½¿ç”¨CustomUserAdminç®¡ç†æ‰€æœ‰è§’è‰²

# è§’è‰²ä¸“å±Adminç±»å·²ç§»é™¤ï¼Œå­¦ä¹ ä¿¡æ¯åŒæ­¥é€»è¾‘å·²é›†æˆåˆ°CustomUserAdminä¸­


# ç»Ÿä¸€ç”¨æˆ·Admin
class CustomUserAdmin(StandardRoleAdminMixin, BaseRoleUserAdmin):
    """ç»Ÿä¸€ç”¨æˆ·ç®¡ç†Admin - æ”¯æŒåŠ¨æ€è§’è‰²å¢é¡¹"""
    list_display = ['username', 'real_name', 'role', 'get_role_groups', 'email', 'phone', 'is_active', 'date_joined', 'get_extension_summary', 'manage_extensions_link', 'change_password_link']
    list_filter = ['role', 'english_level', 'is_active', 'date_joined', 'groups']
    search_fields = ['username', 'real_name', 'email', 'phone']
    ordering = ['-date_joined']
    
    # é‡æ–°å®šä¹‰fieldsetsä»¥åŒ…å«å­¦ä¹ ä¿¡æ¯
    fieldsets = (
        (None, {'fields': ('username',)}),
        ('ä¸ªäººä¿¡æ¯', {'fields': ('real_name', 'email', 'phone', 'role')}),
        ('å­¦ä¹ ä¿¡æ¯', {'fields': ('grade_level', 'english_level')}),
        ('æƒé™', {'fields': ('is_active', 'is_staff', 'is_superuser')}),
        ('é‡è¦æ—¥æœŸ', {'fields': ('last_login', 'date_joined')}),
        ('å¤‡æ³¨', {'fields': ('notes',)}),
    )
    
    add_fieldsets = (
        (None, {
            'classes': ('wide',),
            'fields': ('username', 'real_name', 'email', 'role', 'grade_level', 'english_level', 'password1', 'password2'),
        }),
    )
    
    # æ·»åŠ è§’è‰²å¿«é€Ÿç­›é€‰é“¾æ¥
    def changelist_view(self, request, extra_context=None):
        """è‡ªå®šä¹‰åˆ—è¡¨è§†å›¾ï¼Œæ·»åŠ è§’è‰²å¿«é€Ÿç­›é€‰"""
        extra_context = extra_context or {}
        
        # ç»Ÿè®¡å„è§’è‰²ç”¨æˆ·æ•°é‡
        role_stats = {}
        for role_value, role_label in UserRole.choices:
            count = CustomUser.objects.filter(role=role_value).count()
            role_stats[role_value] = {'label': role_label, 'count': count}
        
        extra_context['role_stats'] = role_stats
        extra_context['current_role_filter'] = request.GET.get('role')
        
        return super().changelist_view(request, extra_context)
    
    # ç»§æ‰¿BaseRoleUserAdminçš„save_modelæ–¹æ³•ï¼Œæ— éœ€é‡å¤å®šä¹‰
    
    def change_password_link(self, obj):
        """å¯†ç ä¿®æ”¹é“¾æ¥"""
        url = reverse('admin:accounts_customuser_change_password', args=[obj.pk])
        return format_html(
            '<a href="{}" class="button" style="background: #007cba; color: white; padding: 4px 8px; '
            'text-decoration: none; border-radius: 3px; font-size: 12px;">ğŸ”‘ ä¿®æ”¹å¯†ç </a>',
            url
        )
    change_password_link.short_description = 'å¯†ç ç®¡ç†'  # type: ignore
    
    def get_extension_summary(self, obj):
        """æ˜¾ç¤ºç”¨æˆ·çš„è§’è‰²å¢é¡¹æ‘˜è¦"""
        # åªæ˜¾ç¤ºä¸ç”¨æˆ·å½“å‰è§’è‰²åŒ¹é…çš„å¢é¡¹æ•°æ®
        extensions = UserExtensionData.objects.filter(  # type: ignore
            user=obj,
            role_extension__role=obj.role
        ).select_related('role_extension')
        if extensions.exists():
            count = extensions.count()
            return format_html(
             '<span style="color: #007cba; background: #e7f3ff; padding: 2px 6px; border-radius: 3px; font-size: 12px;">'  
             'ğŸ“‹ {} é¡¹å¢é¡¹</span>',
             count
         )
        return format_html('<span style="color: #6c757d;">æ— å¢é¡¹</span>')
    get_extension_summary.short_description = 'è§’è‰²å¢é¡¹'  # type: ignore
    
    def manage_extensions_link(self, obj):
        """ç®¡ç†è§’è‰²å¢é¡¹é“¾æ¥"""
        # åªä¸ºæœ‰è§’è‰²å¢é¡¹é…ç½®çš„è§’è‰²æ˜¾ç¤ºç®¡ç†é“¾æ¥
        role_extensions = RoleExtension.objects.filter(role=obj.role, is_active=True)  # type: ignore
        if role_extensions.exists():
            url = reverse('admin:accounts_customuser_extensions', args=[obj.pk])
            return format_html(
                '<a href="{}" class="button" style="background: #28a745; color: white; padding: 4px 8px; '
                'text-decoration: none; border-radius: 3px; font-size: 12px;">ğŸ“ ç®¡ç†å¢é¡¹</a>',
                url
            )
        return format_html('<span style="color: #6c757d;">-</span>')
    manage_extensions_link.short_description = 'å¢é¡¹ç®¡ç†'  # type: ignore
    
    def get_urls(self):
        """æ·»åŠ è‡ªå®šä¹‰URL"""
        urls = super().get_urls()
        custom_urls = [
            path(
                '<int:user_id>/extensions/',
                self.admin_site.admin_view(self.manage_extensions_view),
                name='accounts_customuser_extensions'
            ),
            path(
                '<int:user_id>/change_password/',
                self.admin_site.admin_view(self.change_password_view),
                name='accounts_customuser_change_password'
            ),
        ]
        return custom_urls + urls
    
    def manage_extensions_view(self, request, user_id):
        """ç®¡ç†ç”¨æˆ·è§’è‰²å¢é¡¹è§†å›¾"""
        user = get_object_or_404(CustomUser, pk=user_id)
        
        # è·å–è¯¥è§’è‰²çš„æ‰€æœ‰å¢é¡¹é…ç½®
        role_extensions = RoleExtension.objects.filter(  # type: ignore
            role=user.role, is_active=True
        ).order_by('sort_order', 'field_name')
        
        # è·å–ç”¨æˆ·ç°æœ‰çš„å¢é¡¹æ•°æ®
        user_extensions = {}
        for ext_data in UserExtensionData.objects.filter(user=user):  # type: ignore
            user_extensions[ext_data.role_extension.id] = ext_data.field_value
        
        if request.method == 'POST':
            # ä¿å­˜å¢é¡¹æ•°æ®
            for role_ext in role_extensions:
                field_name = f'extension_{role_ext.pk}'
                field_value = request.POST.get(field_name, '')
                
                # æ›´æ–°æˆ–åˆ›å»ºå¢é¡¹æ•°æ®
                UserExtensionData.objects.update_or_create(  # type: ignore
                    user=user,
                    role_extension=role_ext,
                    defaults={'field_value': field_value}
                )
            
            messages.success(request, f'ç”¨æˆ· {user.username} çš„è§’è‰²å¢é¡¹å·²æ›´æ–°ï¼')
            return HttpResponseRedirect(reverse('admin:accounts_customuser_changelist'))
        
        context = {
            'title': f'ç®¡ç†ç”¨æˆ·è§’è‰²å¢é¡¹: {user.username}',
            'user_obj': user,
            'role_extensions': role_extensions,
            'user_extensions': user_extensions,
            'opts': self.model._meta,
        }
        
        return TemplateResponse(
            request,
            'admin/accounts/manage_extensions.html',
            context
        )
    
    def change_password_view(self, request, user_id):
        """å¯†ç ä¿®æ”¹è§†å›¾"""
        user = get_object_or_404(CustomUser, pk=user_id)
        
        if request.method == 'POST':
            form = SetPasswordForm(user, request.POST)
            if form.is_valid():
                form.save()
                messages.success(request, f'ç”¨æˆ· {user.username} çš„å¯†ç å·²æˆåŠŸä¿®æ”¹ï¼')
                return HttpResponseRedirect(reverse('admin:accounts_customuser_changelist'))
        else:
            form = SetPasswordForm(user)
        
        context = {
            'title': f'ä¿®æ”¹ç”¨æˆ·å¯†ç : {user.username}',
            'form': form,
            'user_obj': user,
            'opts': self.model._meta,
            'original': user,
            'is_popup': False,
            'save_as': False,
            'has_delete_permission': False,
            'has_add_permission': False,
            'has_change_permission': True,
        }
        
        return TemplateResponse(
            request,
            'admin/accounts/change_password.html',
            context
        )


@admin.register(UserLoginLog)
class UserLoginLogAdmin(admin.ModelAdmin):
    """ç”¨æˆ·ç™»å½•æ—¥å¿—Admin"""
    list_display = ['username', 'login_time', 'ip_address', 'login_success']
    list_filter = ['login_success', 'login_time']
    search_fields = ['username', 'ip_address']
    readonly_fields = ['username', 'login_time', 'ip_address', 'user_agent', 'login_success']
    ordering = ['-login_time']


# @admin.register(LearningProfile)
# class LearningProfileAdmin(admin.ModelAdmin):
#     """å­¦ä¹ æ¡£æ¡ˆAdmin - å·²ç§»é™¤"""
#     pass


@admin.register(RoleApproval)
class RoleApprovalAdmin(StandardRoleAdminMixin, admin.ModelAdmin):
    """æ³¨å†Œç®¡ç†å‘˜å®¡æ‰¹Admin"""
    list_display = ['user', 'requested_role', 'current_role', 'status', 'created_at', 'approved_by', 'approval_actions']
    list_filter = ['status', 'requested_role', 'created_at']
    search_fields = ['user__username', 'user__real_name', 'reason']
    readonly_fields = ['user', 'requested_role', 'current_role', 'reason', 'created_at']
    ordering = ['-created_at']
    
    fieldsets = (
        ('ç”³è¯·ä¿¡æ¯', {
            'fields': ('user', 'requested_role', 'current_role', 'reason', 'created_at')
        }),
        ('å®¡æ‰¹ä¿¡æ¯', {
            'fields': ('status', 'admin_comment', 'approved_by')
        }),
    )
    
    def get_queryset(self, request):
        """åªæ˜¾ç¤ºç®¡ç†å‘˜è§’è‰²ç”³è¯·"""
        return super().get_queryset(request).filter(requested_role=UserRole.ADMIN)
    
    def approval_actions(self, obj):
        """å®¡æ‰¹æ“ä½œæŒ‰é’®"""
        if obj.status == 'pending':
            approve_url = reverse('admin:approve_role', args=[obj.pk])
            reject_url = reverse('admin:reject_role', args=[obj.pk])
            return format_html(
                '<a href="{}" class="button" style="background: #28a745; color: white; padding: 4px 8px; '
                'text-decoration: none; border-radius: 3px; font-size: 12px; margin-right: 5px;">âœ… é€šè¿‡</a>'
                '<a href="{}" class="button" style="background: #dc3545; color: white; padding: 4px 8px; '
                'text-decoration: none; border-radius: 3px; font-size: 12px;">âŒ æ‹’ç»</a>',
                approve_url, reject_url
            )
        elif obj.status == 'approved':
            return format_html(
                '<span style="color: #28a745; background: #d4edda; padding: 2px 6px; border-radius: 3px; font-size: 12px;">'
                'âœ… å·²é€šè¿‡</span>'
            )
        else:
            return format_html(
                '<span style="color: #dc3545; background: #f8d7da; padding: 2px 6px; border-radius: 3px; font-size: 12px;">'
                'âŒ å·²æ‹’ç»</span>'
            )
    
    approval_actions.short_description = 'å®¡æ‰¹æ“ä½œ'  # type: ignore
    
    def get_urls(self):
        """æ·»åŠ è‡ªå®šä¹‰å®¡æ‰¹URL"""
        urls = super().get_urls()
        custom_urls = [
            path(
                'approve/<int:approval_id>/',
                self.admin_site.admin_view(self.approve_role_view),
                name='approve_role'
            ),
            path(
                'reject/<int:approval_id>/',
                self.admin_site.admin_view(self.reject_role_view),
                name='reject_role'
            ),
        ]
        return custom_urls + urls
    
    def approve_role_view(self, request, approval_id):
        """æ‰¹å‡†è§’è‰²ç”³è¯·"""
        approval = get_object_or_404(RoleApproval, pk=approval_id, status='pending')
        
        if request.method == 'POST':
            admin_notes = request.POST.get('admin_notes', '')
            
            # æ›´æ–°å®¡æ‰¹è®°å½•
            approval.status = 'approved'
            approval.admin_comment = admin_notes
            approval.approved_by = request.user
            approval.save()
            
            # æ›´æ–°ç”¨æˆ·è§’è‰²å’ŒçŠ¶æ€
            user = approval.user
            user.role = approval.requested_role
            user.admin_approval_status = 'approved'
            user.is_active = True
            user.save()
            
            # åŒæ­¥è§’è‰²åˆ°ç»„
            sync_user_role_to_group(user)
            
            messages.success(request, f'å·²æ‰¹å‡†ç”¨æˆ· {user.username} çš„ç®¡ç†å‘˜è§’è‰²ç”³è¯·ï¼')
            return HttpResponseRedirect(reverse('admin:accounts_roleapproval_changelist'))
        
        context = {
            'title': f'æ‰¹å‡†è§’è‰²ç”³è¯·: {approval.user.username}',
            'approval': approval,
            'opts': self.model._meta,
        }
        
        return TemplateResponse(
            request,
            'admin/accounts/approve_role.html',
            context
        )
    
    def reject_role_view(self, request, approval_id):
        """æ‹’ç»è§’è‰²ç”³è¯·"""
        approval = get_object_or_404(RoleApproval, pk=approval_id, status='pending')
        
        if request.method == 'POST':
            admin_notes = request.POST.get('admin_notes', '')
            
            # æ›´æ–°å®¡æ‰¹è®°å½•
            approval.status = 'rejected'
            approval.admin_comment = admin_notes
            approval.approved_by = request.user
            approval.save()
            
            # æ›´æ–°ç”¨æˆ·çŠ¶æ€
            user = approval.user
            user.admin_approval_status = 'rejected'
            user.is_active = False  # ä¿æŒéæ¿€æ´»çŠ¶æ€
            user.save()
            
            messages.warning(request, f'å·²æ‹’ç»ç”¨æˆ· {user.username} çš„ç®¡ç†å‘˜è§’è‰²ç”³è¯·ï¼')
            return HttpResponseRedirect(reverse('admin:accounts_roleapproval_changelist'))
        
        context = {
            'title': f'æ‹’ç»è§’è‰²ç”³è¯·: {approval.user.username}',
            'approval': approval,
            'opts': self.model._meta,
        }
        
        return TemplateResponse(
            request,
            'admin/accounts/reject_role.html',
            context
        )


@admin.register(RoleExtension)
class RoleExtensionAdmin(StandardRoleAdminMixin, admin.ModelAdmin):
    """è§’è‰²å¢é¡¹é…ç½®Admin"""
    list_display = ['role', 'field_label', 'field_type', 'is_required', 'is_active', 'sort_order']
    list_filter = ['role', 'field_type', 'is_required', 'is_active']
    search_fields = ['role', 'field_label', 'field_name']
    ordering = ['role', 'sort_order', 'field_name']
    
    fieldsets = (
        ('åŸºæœ¬ä¿¡æ¯', {
            'fields': ('role', 'field_name', 'field_label', 'field_type')
        }),
        ('é…ç½®é€‰é¡¹', {
            'fields': ('field_choices', 'is_required', 'help_text', 'sort_order', 'is_active')
        }),
    )
    
    # è§’è‰²é€‰æ‹©å™¨é…ç½®å·²é€šè¿‡StandardRoleAdminMixinè‡ªåŠ¨å¤„ç†
    
    def get_form(self, request, obj=None, change=False, **kwargs):
        """è‡ªå®šä¹‰è¡¨å•"""
        form = super().get_form(request, obj, change, **kwargs)
        # ä¸ºfield_choiceså­—æ®µæ·»åŠ å¸®åŠ©æ–‡æœ¬
        try:
            if hasattr(form, 'base_fields') and 'field_choices' in getattr(form, 'base_fields', {}):
                form.base_fields['field_choices'].help_text = (  # type: ignore
                    'ä»…å½“å­—æ®µç±»å‹ä¸º"é€‰æ‹©å­—æ®µ"æ—¶éœ€è¦å¡«å†™ã€‚æ ¼å¼ï¼š[["value1", "æ˜¾ç¤ºå1"], ["value2", "æ˜¾ç¤ºå2"]]'
                )
            elif hasattr(form, 'fields') and 'field_choices' in getattr(form, 'fields', {}):
                form.fields['field_choices'].help_text = (  # type: ignore
                    'ä»…å½“å­—æ®µç±»å‹ä¸º"é€‰æ‹©å­—æ®µ"æ—¶éœ€è¦å¡«å†™ã€‚æ ¼å¼ï¼š[["value1", "æ˜¾ç¤ºå1"], ["value2", "æ˜¾ç¤ºå2"]]'
                )
        except (AttributeError, TypeError):
            pass  # å¿½ç•¥ç±»å‹é”™è¯¯
        return form


@admin.register(RoleUserGroup)
class RoleUserGroupAdmin(StandardRoleAdminMixin, admin.ModelAdmin):
    """è§’è‰²æ‰€è¾–ç”¨æˆ·Admin"""
    list_display = ['name', 'role', 'get_user_count', 'is_active', 'created_at']
    list_filter = ['role', 'is_active', 'created_at']
    search_fields = ['name', 'description']
    ordering = ['role', 'name']
    filter_horizontal = ['users']  # ä½¿ç”¨æ°´å¹³è¿‡æ»¤å™¨æ˜¾ç¤ºç”¨æˆ·é€‰æ‹©
    
    fieldsets = (
        ('åŸºæœ¬ä¿¡æ¯', {
            'fields': ('name', 'role', 'description', 'is_active')
        }),
        ('ç”¨æˆ·é…ç½®', {
            'fields': ('users',),
            'description': 'é€‰æ‹©è¯¥è§’è‰²ä¸‹çš„ç”¨æˆ·åŠ å…¥æ­¤ç»„ã€‚åªæ˜¾ç¤ºæ¿€æ´»çŠ¶æ€çš„ç”¨æˆ·ã€‚'
        }),
    )
    
    def formfield_for_choice_field(self, db_field, request, **kwargs):
        """ä¸ºè§’è‰²å­—æ®µä½¿ç”¨æ ‡å‡†è§’è‰²é€‰æ‹©å™¨"""
        if db_field.name == 'role':
            kwargs['widget'] = StandardRoleSelectWidget()
        return super().formfield_for_choice_field(db_field, request, **kwargs)
    
    def get_user_count(self, obj):
        """è·å–ç»„å†…ç”¨æˆ·æ•°é‡"""
        return obj.users.count()
    get_user_count.short_description = 'ç”¨æˆ·æ•°é‡'  # type: ignore
    
    def formfield_for_manytomany(self, db_field, request, **kwargs):
        """è‡ªå®šä¹‰å¤šå¯¹å¤šå­—æ®µçš„æŸ¥è¯¢é›†"""
        if db_field.name == "users":
            # æ ¹æ®å½“å‰é€‰æ‹©çš„è§’è‰²è¿‡æ»¤ç”¨æˆ·
            if request.method == 'GET' and 'role' in request.GET:
                role = request.GET['role']
                kwargs["queryset"] = CustomUser.objects.filter(
                    role=role, 
                    is_active=True
                ).order_by('real_name', 'username')
            else:
                kwargs["queryset"] = CustomUser.objects.filter(
                    is_active=True
                ).order_by('role', 'real_name', 'username')
        return super().formfield_for_manytomany(db_field, request, **kwargs)
    
    def save_model(self, request, obj, form, change):
        """ä¿å­˜æ¨¡å‹æ—¶è®¾ç½®åˆ›å»ºè€…"""
        if not change:  # æ–°å»ºæ—¶
            obj.created_by = request.user
        super().save_model(request, obj, form, change)
    
    class Media:
        js = ('admin/js/role_user_group_admin.js',)


@admin.register(UserExtensionData)
class UserExtensionDataAdmin(admin.ModelAdmin):
    """è§’è‰²æ‰€è¾–ç”¨æˆ·å¢é¡¹Admin"""
    list_display = ['user', 'get_role', 'get_field_label', 'field_value', 'updated_at']
    list_filter = ['role_extension__role', 'role_extension__field_type', 'updated_at']
    search_fields = ['user__username', 'user__real_name', 'role_extension__field_label']
    ordering = ['user', 'role_extension__sort_order']
    
    # ç¦ç”¨å¢åˆ æ”¹æ“ä½œï¼Œåªæä¾›æŸ¥çœ‹åŠŸèƒ½
    def has_add_permission(self, request):
        return False
    
    def has_change_permission(self, request, obj=None):
        return False
    
    def has_delete_permission(self, request, obj=None):
        return False
    
    def get_role(self, obj):
        """è·å–è§’è‰²"""
        return obj.role_extension.role
    get_role.short_description = 'è§’è‰²'  # type: ignore
    
    def get_field_label(self, obj):
        """è·å–å­—æ®µæ ‡ç­¾"""
        return obj.role_extension.field_label





# æ³¨å†Œæ¨¡å‹
admin.site.register(CustomUser, CustomUserAdmin)

# æ³¨å†Œè§’è‰²æ‰€è¾–ç”¨æˆ·å¢é¡¹çš„çº§è”æ¨¡å‹
from .admin_role_hierarchy import RoleLevelAdmin, RoleUserAdmin

# ç›´æ¥ä½¿ç”¨admin_role_hierarchyä¸­å®šä¹‰çš„Adminç±»
admin.site.register(RoleLevel, RoleLevelAdmin)
admin.site.register(RoleUser, RoleUserAdmin)
# UserExtensionå·²åœ¨admin_role_hierarchy.pyä¸­é€šè¿‡@admin.registerè£…é¥°å™¨æ³¨å†Œï¼Œæ— éœ€é‡å¤æ³¨å†Œ