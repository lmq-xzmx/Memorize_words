"""æ•´åˆç®¡ç†é¡µé¢é…ç½®

åŸºäºä¸šåŠ¡æ¨¡å‹é‡æ–°è®¾è®¡çš„é«˜å†…èšã€ä½è€¦åˆç®¡ç†ç•Œé¢
æŒ‰ç…§ä¸šåŠ¡é€»è¾‘å°†åˆ†æ•£çš„é¡µé¢è¿›è¡Œæ•´åˆï¼š

1. ç”¨æˆ·ä¸è§’è‰²ç®¡ç†ä¸­å¿ƒ - ç»Ÿä¸€ç®¡ç†ç”¨æˆ·ã€è§’è‰²åˆ†é…ã€æƒé™åŒæ­¥
2. è§’è‰²å¢é¡¹é…ç½®ä¸­å¿ƒ - ç»Ÿä¸€ç®¡ç†è§’è‰²æ¨¡æ¿ã€å¢é¡¹é…ç½®ã€æ•°æ®éªŒè¯
3. æƒé™ä¸èœå•ç®¡ç†ä¸­å¿ƒ - ç»Ÿä¸€ç®¡ç†æƒé™åˆ†é…ã€èœå•é…ç½®ã€ç»„æ˜ å°„
4. æ•°æ®ç»Ÿè®¡ä¸ç›‘æ§ä¸­å¿ƒ - ç»Ÿä¸€ç®¡ç†æ—¥å¿—ã€å®¡æ‰¹ã€æ•°æ®åˆ†æ
"""

from django.contrib import admin
from django.utils.html import format_html
from django.urls import reverse, path
from django.shortcuts import render, redirect
from django.contrib import messages
from django.db import models
from django.http import JsonResponse
from typing import Any, Dict, List

from .models import (
    CustomUser, UserRole, RoleExtension, UserExtensionData, 
    RoleUserGroup, RoleLevel, RoleUser, UserExtension,
    RoleApproval, UserLoginLog
)
from apps.permissions.models import (
    RoleManagement, RoleGroupMapping, RoleMenuPermission
)


class IntegratedAdminMixin:
    """æ•´åˆç®¡ç†é¡µé¢æ··å…¥ç±»"""
    
    def get_dashboard_stats(self) -> Dict[str, Any]:
        """è·å–ä»ªè¡¨æ¿ç»Ÿè®¡æ•°æ®"""
        return {
            'total_users': CustomUser.objects.count(),
            'active_users': CustomUser.objects.filter(is_active=True).count(),
            'role_stats': {
                role[0]: CustomUser.objects.filter(role=role[0]).count()
                for role in UserRole.choices
            },
            'pending_approvals': RoleApproval.objects.filter(status='pending').count(),
            'extension_configs': RoleExtension.objects.filter(is_active=True).count(),
        }
    
    def get_quick_actions(self) -> List[Dict[str, str]]:
        """è·å–å¿«é€Ÿæ“ä½œé“¾æ¥"""
        return [
            {
                'title': 'æ–°å¢ç”¨æˆ·',
                'url': reverse('admin:accounts_customuser_add'),
                'icon': 'ğŸ‘¤',
                'color': '#007cba'
            },
            {
                'title': 'è§’è‰²é…ç½®',
                'url': reverse('admin:accounts_roleextension_changelist'),
                'icon': 'âš™ï¸',
                'color': '#28a745'
            },
            {
                'title': 'æƒé™ç®¡ç†',
                'url': reverse('admin:permissions_rolemanagement_changelist'),
                'icon': 'ğŸ”',
                'color': '#ffc107'
            },
            {
                'title': 'å®¡æ‰¹ç®¡ç†',
                'url': reverse('admin:accounts_roleapproval_changelist'),
                'icon': 'ğŸ“‹',
                'color': '#dc3545'
            },
        ]


@admin.register(CustomUser)
class IntegratedUserAdmin(admin.ModelAdmin):
    """æ•´åˆç”¨æˆ·ç®¡ç†ä¸­å¿ƒ
    
    ç»Ÿä¸€ç®¡ç†ï¼š
    - ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
    - è§’è‰²åˆ†é…ä¸æƒé™åŒæ­¥
    - è§’è‰²å¢é¡¹æ•°æ®
    - ç»„ç»‡æ¶æ„å…³ç³»
    """
    
    list_display = [
        'username', 'real_name', 'role', 'get_role_status', 
        'get_extension_summary', 'get_group_status', 'is_active', 
        'quick_actions'
    ]
    list_filter = ['role', 'is_active', 'date_joined']
    search_fields = ['username', 'real_name', 'email', 'phone']
    ordering = ['-date_joined']
    
    fieldsets = (
        ('åŸºæœ¬ä¿¡æ¯', {
            'fields': ('username', 'real_name', 'email', 'phone')
        }),
        ('è§’è‰²ä¸æƒé™', {
            'fields': ('role', 'is_active', 'is_staff'),
            'description': 'è§’è‰²å˜æ›´å°†è‡ªåŠ¨åŒæ­¥åˆ°æƒé™ç»„å’Œå¢é¡¹é…ç½®'
        }),
        ('å­¦ä¹ ä¿¡æ¯', {
            'fields': ('grade_level', 'english_level'),
            'classes': ('collapse',)
        }),
        ('ç³»ç»Ÿä¿¡æ¯', {
            'fields': ('last_login', 'date_joined'),
            'classes': ('collapse',),
            'description': 'ç³»ç»Ÿè‡ªåŠ¨ç»´æŠ¤çš„æ—¶é—´ä¿¡æ¯'
        }),
    )
    
    readonly_fields = ['last_login', 'date_joined']
    
    def get_role_status(self, obj):
        """è§’è‰²çŠ¶æ€æ˜¾ç¤º"""
        if not obj.role:
            return format_html(
                '<span style="color: #dc3545; background: #f8d7da; padding: 2px 6px; '
                'border-radius: 3px; font-size: 12px;">âŒ æœªè®¾ç½®è§’è‰²</span>'
            )
        
        # æ£€æŸ¥æƒé™ç»„åŒæ­¥çŠ¶æ€
        from .admin import ROLE_GROUP_MAPPING
        target_group = ROLE_GROUP_MAPPING.get(obj.role)
        is_synced = target_group and obj.groups.filter(name=target_group).exists()
        
        if is_synced:
            return format_html(
                '<span style="color: #28a745; background: #d4edda; padding: 2px 6px; '
                'border-radius: 3px; font-size: 12px;">âœ… {} (å·²åŒæ­¥)</span>',
                obj.get_role_display()
            )
        else:
            return format_html(
                '<span style="color: #ffc107; background: #fff3cd; padding: 2px 6px; '
                'border-radius: 3px; font-size: 12px;">âš ï¸ {} (å¾…åŒæ­¥)</span>',
                obj.get_role_display()
            )
    
    get_role_status.short_description = 'è§’è‰²çŠ¶æ€'  # type: ignore
    
    def get_extension_summary(self, obj):
        """å¢é¡¹æ•°æ®æ‘˜è¦"""
        extensions = UserExtensionData.objects.filter(
            user=obj, role_extension__role=obj.role
        ).count()
        
        if extensions > 0:
            return format_html(
                '<span style="color: #007cba; background: #e7f3ff; padding: 2px 6px; '
                'border-radius: 3px; font-size: 12px;">ğŸ“‹ {} é¡¹å¢é¡¹</span>',
                extensions
            )
        return format_html(
            '<span style="color: #6c757d;">æ— å¢é¡¹</span>'
        )
    
    get_extension_summary.short_description = 'å¢é¡¹æ•°æ®'  # type: ignore
    
    def get_group_status(self, obj):
        """ç»„ç»‡çŠ¶æ€æ˜¾ç¤º"""
        groups = obj.groups.all()
        if groups:
            group_names = [g.name for g in groups]
            return format_html(
                '<span style="color: #17a2b8; font-size: 12px;">ğŸ¢ {}</span>',
                ', '.join(group_names)
            )
        return format_html(
            '<span style="color: #6c757d;">æœªåˆ†ç»„</span>'
        )
    
    get_group_status.short_description = 'ç»„ç»‡å…³ç³»'  # type: ignore
    
    def quick_actions(self, obj):
        """å¿«é€Ÿæ“ä½œæŒ‰é’®"""
        actions = []
        
        # å¢é¡¹ç®¡ç†
        if obj.role and RoleExtension.objects.filter(role=obj.role, is_active=True).exists():
            actions.append(
                f'<a href="{reverse("admin:accounts_customuser_extensions", args=[obj.pk])}" '
                f'class="button" style="background: #28a745; color: white; padding: 2px 6px; '
                f'text-decoration: none; border-radius: 3px; font-size: 11px; margin-right: 3px;">'
                f'ğŸ“ å¢é¡¹</a>'
            )
        
        # å¯†ç é‡ç½®
        actions.append(
            f'<a href="{reverse("admin:accounts_customuser_change_password", args=[obj.pk])}" '
            f'class="button" style="background: #ffc107; color: black; padding: 2px 6px; '
            f'text-decoration: none; border-radius: 3px; font-size: 11px; margin-right: 3px;">'
            f'ğŸ”‘ å¯†ç </a>'
        )
        
        # æƒé™åŒæ­¥
        actions.append(
            f'<a href="#" onclick="syncUserRole({obj.pk})" '
            f'class="button" style="background: #007cba; color: white; padding: 2px 6px; '
            f'text-decoration: none; border-radius: 3px; font-size: 11px;">'
            f'ğŸ”„ åŒæ­¥</a>'
        )
        
        return format_html(''.join(actions))
    
    quick_actions.short_description = 'å¿«é€Ÿæ“ä½œ'  # type: ignore
    
    def get_urls(self):
        """æ·»åŠ è‡ªå®šä¹‰URL"""
        urls = super().get_urls()
        custom_urls = [
            path(
                'dashboard/',
                self.admin_site.admin_view(self.dashboard_view),
                name='accounts_user_dashboard'
            ),
            path(
                '<int:user_id>/extensions/',
                self.admin_site.admin_view(self.manage_extensions_view),
                name='accounts_customuser_extensions'
            ),
            path(
                '<int:user_id>/change_password/',
                self.admin_site.admin_view(self.change_password_view),
                name='accounts_customuser_change_password'
            ),
            path(
                'sync-role/<int:user_id>/',
                self.admin_site.admin_view(self.sync_role_view),
                name='accounts_sync_user_role'
            ),
        ]
        return custom_urls + urls
    
    def dashboard_view(self, request):
        """ç”¨æˆ·ç®¡ç†ä»ªè¡¨æ¿"""
        context = {
            'title': 'ç”¨æˆ·ä¸è§’è‰²ç®¡ç†ä¸­å¿ƒ',
            'stats': self.get_dashboard_stats(),
            'quick_actions': self.get_quick_actions(),
            'recent_users': CustomUser.objects.order_by('-date_joined')[:10],
            'pending_approvals': RoleApproval.objects.filter(status='pending')[:5],
        }
        return render(request, 'admin/accounts/user_dashboard.html', context)
    
    def get_dashboard_stats(self):
        """è·å–ä»ªè¡¨æ¿ç»Ÿè®¡"""
        return {
            'total_users': CustomUser.objects.count(),
            'active_users': CustomUser.objects.filter(is_active=True).count(),
            'role_stats': {
                role[1]: CustomUser.objects.filter(role=role[0]).count()
                for role in UserRole.choices
            },
            'extension_data_count': UserExtensionData.objects.count(),
            'unsynced_users': self.get_unsynced_users_count(),
        }
    
    def get_unsynced_users_count(self):
        """è·å–æœªåŒæ­¥ç”¨æˆ·æ•°é‡"""
        from .admin import ROLE_GROUP_MAPPING
        count = 0
        for user in CustomUser.objects.filter(is_active=True):
            if user.role:
                target_group = ROLE_GROUP_MAPPING.get(user.role)
                if target_group and not user.groups.filter(name=target_group).exists():
                    count += 1
        return count
    
    def get_quick_actions(self):
        """è·å–å¿«é€Ÿæ“ä½œ"""
        return [
            {
                'title': 'æ–°å¢ç”¨æˆ·',
                'url': reverse('admin:accounts_customuser_add'),
                'icon': 'ğŸ‘¤',
                'description': 'åˆ›å»ºæ–°ç”¨æˆ·è´¦æˆ·'
            },
            {
                'title': 'æ‰¹é‡å¯¼å…¥',
                'url': '#',
                'icon': 'ğŸ“¥',
                'description': 'æ‰¹é‡å¯¼å…¥ç”¨æˆ·æ•°æ®'
            },
            {
                'title': 'æƒé™åŒæ­¥',
                'url': '#',
                'icon': 'ğŸ”„',
                'description': 'åŒæ­¥æ‰€æœ‰ç”¨æˆ·æƒé™'
            },
            {
                'title': 'æ•°æ®å¯¼å‡º',
                'url': '#',
                'icon': 'ğŸ“¤',
                'description': 'å¯¼å‡ºç”¨æˆ·æ•°æ®æŠ¥è¡¨'
            },
        ]
    
    def manage_extensions_view(self, request, user_id):
        """ç®¡ç†ç”¨æˆ·å¢é¡¹æ•°æ®"""
        # å¤ç”¨åŸæœ‰çš„å¢é¡¹ç®¡ç†é€»è¾‘
        from .admin import CustomUserAdmin
        original_admin = CustomUserAdmin(CustomUser, self.admin_site)
        return original_admin.manage_extensions_view(request, user_id)
    
    def change_password_view(self, request, user_id):
        """ä¿®æ”¹ç”¨æˆ·å¯†ç """
        # å¤ç”¨åŸæœ‰çš„å¯†ç ä¿®æ”¹é€»è¾‘
        from .admin import CustomUserAdmin
        original_admin = CustomUserAdmin(CustomUser, self.admin_site)
        return original_admin.change_password_view(request, user_id)
    
    def sync_role_view(self, request, user_id):
        """åŒæ­¥ç”¨æˆ·è§’è‰²æƒé™"""
        from django.shortcuts import get_object_or_404
        from .admin import sync_user_role_to_group
        
        user = get_object_or_404(CustomUser, pk=user_id)
        success, message = sync_user_role_to_group(user)
        
        return JsonResponse({
            'success': success,
            'message': message
        })
    
    class Media:
        js = ('admin/js/integrated_user_admin.js',)
        css = {
            'all': ('admin/css/integrated_admin.css',)
        }


@admin.register(RoleExtension)
class IntegratedRoleExtensionAdmin(admin.ModelAdmin):
    """è§’è‰²å¢é¡¹é…ç½®ä¸­å¿ƒ
    
    ç»Ÿä¸€ç®¡ç†ï¼š
    - è§’è‰²æ¨¡æ¿é…ç½®
    - å¢é¡¹å­—æ®µå®šä¹‰
    - æ•°æ®éªŒè¯è§„åˆ™
    - æ˜¾ç¤ºæ’åºè®¾ç½®
    """
    
    list_display = [
        'role', 'field_label', 'field_type', 'is_required', 
        'get_usage_count', 'is_active', 'sort_order', 'config_actions'
    ]
    list_filter = ['role', 'field_type', 'is_required', 'is_active']
    search_fields = ['field_label', 'field_name', 'help_text']
    ordering = ['role', 'sort_order', 'field_name']
    
    fieldsets = (
        ('åŸºæœ¬é…ç½®', {
            'fields': ('role', 'field_name', 'field_label', 'field_type')
        }),
        ('é«˜çº§é…ç½®', {
            'fields': ('field_choices', 'is_required', 'help_text'),
            'description': 'å­—æ®µé€‰é¡¹ä»…åœ¨é€‰æ‹©å­—æ®µç±»å‹æ—¶éœ€è¦é…ç½®'
        }),
        ('æ˜¾ç¤ºè®¾ç½®', {
            'fields': ('sort_order', 'is_active'),
            'classes': ('collapse',)
        }),
    )
    
    def get_usage_count(self, obj):
        """è·å–ä½¿ç”¨ç»Ÿè®¡"""
        count = UserExtensionData.objects.filter(role_extension=obj).count()
        if count > 0:
            return format_html(
                '<span style="color: #007cba; font-weight: bold;">{} ä¸ªç”¨æˆ·</span>',
                count
            )
        return format_html('<span style="color: #6c757d;">æœªä½¿ç”¨</span>')
    
    get_usage_count.short_description = 'ä½¿ç”¨ç»Ÿè®¡'  # type: ignore
    
    def config_actions(self, obj):
        """é…ç½®æ“ä½œ"""
        actions = []
        
        # é¢„è§ˆé…ç½®
        actions.append(
            f'<a href="#" onclick="previewConfig({obj.pk})" '
            f'class="button" style="background: #17a2b8; color: white; padding: 2px 6px; '
            f'text-decoration: none; border-radius: 3px; font-size: 11px; margin-right: 3px;">'
            f'ğŸ‘ï¸ é¢„è§ˆ</a>'
        )
        
        # æ•°æ®ç»Ÿè®¡
        if obj.field_type == 'choice':
            actions.append(
                f'<a href="{reverse("admin:accounts_extension_stats", args=[obj.pk])}" '
                f'class="button" style="background: #28a745; color: white; padding: 2px 6px; '
                f'text-decoration: none; border-radius: 3px; font-size: 11px;">'
                f'ğŸ“Š ç»Ÿè®¡</a>'
            )
        
        return format_html(''.join(actions))
    
    config_actions.short_description = 'æ“ä½œ'  # type: ignore
    
    def get_urls(self):
        """æ·»åŠ è‡ªå®šä¹‰URL"""
        urls = super().get_urls()
        custom_urls = [
            path(
                'template-config/',
                self.admin_site.admin_view(self.template_config_view),
                name='accounts_template_config'
            ),
            path(
                'stats/<int:extension_id>/',
                self.admin_site.admin_view(self.extension_stats_view),
                name='accounts_extension_stats'
            ),
        ]
        return custom_urls + urls
    
    def template_config_view(self, request):
        """æ¨¡æ¿é…ç½®è§†å›¾"""
        context = {
            'title': 'è§’è‰²å¢é¡¹æ¨¡æ¿é…ç½®',
            'role_templates': self.get_role_templates(),
        }
        return render(request, 'admin/accounts/template_config.html', context)
    
    def get_role_templates(self):
        """è·å–è§’è‰²æ¨¡æ¿é…ç½®"""
        templates = {}
        for role_code, role_name in UserRole.choices:
            extensions = RoleExtension.objects.filter(
                role=role_code, is_active=True
            ).order_by('sort_order')
            templates[role_name] = {
                'code': role_code,
                'extensions': extensions,
                'user_count': CustomUser.objects.filter(role=role_code).count()
            }
        return templates
    
    def extension_stats_view(self, request, extension_id):
        """å¢é¡¹ç»Ÿè®¡è§†å›¾"""
        from django.shortcuts import get_object_or_404
        
        extension = get_object_or_404(RoleExtension, pk=extension_id)
        stats = self.get_extension_statistics(extension)
        
        context = {
            'title': f'å¢é¡¹ç»Ÿè®¡: {extension.field_label}',
            'extension': extension,
            'stats': stats,
        }
        return render(request, 'admin/accounts/extension_stats.html', context)
    
    def get_extension_statistics(self, extension):
        """è·å–å¢é¡¹ç»Ÿè®¡æ•°æ®"""
        data = UserExtensionData.objects.filter(role_extension=extension)
        
        if extension.field_type == 'choice':
            # é€‰æ‹©å­—æ®µç»Ÿè®¡
            from collections import Counter
            values = data.values_list('field_value', flat=True)
            return {
                'type': 'choice',
                'total_count': data.count(),
                'value_distribution': dict(Counter(values)),
                'choices': extension.get_field_choices() if hasattr(extension, 'get_field_choices') else []
            }
        else:
            # å…¶ä»–å­—æ®µç±»å‹ç»Ÿè®¡
            return {
                'type': 'general',
                'total_count': data.count(),
                'filled_count': data.exclude(field_value='').count(),
                'empty_count': data.filter(field_value='').count(),
            }


# æ³¨é”€åŸæœ‰çš„åˆ†æ•£æ³¨å†Œï¼Œä½¿ç”¨æ–°çš„æ•´åˆç®¡ç†
# admin.site.unregister(CustomUser)
# admin.site.unregister(RoleExtension)

# æ³¨å†Œæ•´åˆç®¡ç†é¡µé¢
# admin.site.register(CustomUser, IntegratedUserAdmin)
# admin.site.register(RoleExtension, IntegratedRoleExtensionAdmin)