"""æƒé™ä¸èœå•ç®¡ç†ä¸­å¿ƒ

ç»Ÿä¸€ç®¡ç†ï¼š
- æƒé™åˆ†é…ä¸åŒæ­¥
- èœå•é…ç½®ä¸è®¿é—®æ§åˆ¶
- è§’è‰²ç»„æ˜ å°„å…³ç³»
- æƒé™ç»§æ‰¿ä¸çº§è”
"""

from django.contrib import admin
from django.utils.html import format_html
from django.urls import reverse, path
from django.shortcuts import render, redirect
from django.contrib import messages
from django.http import JsonResponse
from typing import Any, Dict, List

from apps.permissions.models import (
    RoleManagement, RoleGroupMapping, RoleMenuPermission,
    MenuModuleConfig, PermissionSyncLog
)
from .models import CustomUser, UserRole


@admin.register(RoleManagement)
class IntegratedRoleManagementAdmin(admin.ModelAdmin):
    """æ•´åˆæƒé™ç®¡ç†ä¸­å¿ƒ
    
    ç»Ÿä¸€ç®¡ç†ï¼š
    - è§’è‰²æƒé™é…ç½®
    - æƒé™ç»§æ‰¿å…³ç³»
    - æƒé™åŒæ­¥çŠ¶æ€
    - æ‰¹é‡æƒé™æ“ä½œ
    """
    
    list_display = [
        'role_name', 'role_code', 'get_user_count', 'get_permission_count',
        'get_sync_status', 'is_active', 'permission_actions'
    ]
    list_filter = ['is_active', 'created_at']
    search_fields = ['role_name', 'role_code', 'description']
    ordering = ['role_code']
    
    fieldsets = (
        ('åŸºæœ¬ä¿¡æ¯', {
            'fields': ('role_name', 'role_code', 'description')
        }),
        ('æƒé™é…ç½®', {
            'fields': ('parent_role', 'permissions'),
            'description': 'è®¾ç½®è§’è‰²ç»§æ‰¿å…³ç³»å’Œå…·ä½“æƒé™'
        }),
        ('çŠ¶æ€è®¾ç½®', {
            'fields': ('is_active',),
            'classes': ('collapse',)
        }),
    )
    
    filter_horizontal = ['permissions']
    
    def get_user_count(self, obj):
        """è·å–è§’è‰²ç”¨æˆ·æ•°é‡"""
        count = CustomUser.objects.filter(role=obj.role_code).count()
        if count > 0:
            return format_html(
                '<span style="color: #007cba; font-weight: bold;">{} ä¸ªç”¨æˆ·</span>',
                count
            )
        return format_html('<span style="color: #6c757d;">æ— ç”¨æˆ·</span>')
    
    get_user_count.short_description = 'ç”¨æˆ·æ•°é‡'  # type: ignore
    
    def get_permission_count(self, obj):
        """è·å–æƒé™æ•°é‡"""
        count = obj.permissions.count()
        inherited_count = self.get_inherited_permissions_count(obj)
        
        if count > 0 or inherited_count > 0:
            return format_html(
                '<span style="color: #28a745;">ç›´æ¥: {} | ç»§æ‰¿: {}</span>',
                count, inherited_count
            )
        return format_html('<span style="color: #6c757d;">æ— æƒé™</span>')
    
    get_permission_count.short_description = 'æƒé™ç»Ÿè®¡'  # type: ignore
    
    def get_inherited_permissions_count(self, obj):
        """è·å–ç»§æ‰¿æƒé™æ•°é‡"""
        if obj.parent_role:
            return obj.parent_role.permissions.count()
        return 0
    
    def get_sync_status(self, obj):
        """è·å–åŒæ­¥çŠ¶æ€"""
        try:
            # æ£€æŸ¥æœ€è¿‘çš„åŒæ­¥æ—¥å¿—
            latest_log = PermissionSyncLog.objects.filter(
                target_type='role',
                target_id=obj.role_code
            ).order_by('-created_at').first()
            
            if latest_log:
                if latest_log.success:
                    return format_html(
                        '<span style="color: #28a745; background: #d4edda; padding: 2px 6px; '
                        'border-radius: 3px; font-size: 12px;">âœ… å·²åŒæ­¥</span>'
                    )
                else:
                    return format_html(
                        '<span style="color: #dc3545; background: #f8d7da; padding: 2px 6px; '
                        'border-radius: 3px; font-size: 12px;">âŒ åŒæ­¥å¤±è´¥</span>'
                    )
            return format_html(
                '<span style="color: #ffc107; background: #fff3cd; padding: 2px 6px; '
                'border-radius: 3px; font-size: 12px;">âš ï¸ å¾…åŒæ­¥</span>'
            )
        except Exception as e:
            return f'é”™è¯¯: {str(e)}'
    
    get_sync_status.short_description = 'åŒæ­¥çŠ¶æ€'  # type: ignore
    
    def permission_actions(self, obj):
        """æƒé™æ“ä½œæŒ‰é’®"""
        actions = []
        
        # æƒé™è¯¦æƒ…
        actions.append(
            f'<a href="{reverse("admin:permissions_role_detail", args=[obj.pk])}" '
            f'class="button" style="background: #17a2b8; color: white; padding: 2px 6px; '
            f'text-decoration: none; border-radius: 3px; font-size: 11px; margin-right: 3px;">'
            f'ğŸ‘ï¸ è¯¦æƒ…</a>'
        )
        
        # åŒæ­¥æƒé™
        actions.append(
            f'<a href="#" onclick="syncRolePermissions({obj.pk})" '
            f'class="button" style="background: #28a745; color: white; padding: 2px 6px; '
            f'text-decoration: none; border-radius: 3px; font-size: 11px; margin-right: 3px;">'
            f'ğŸ”„ åŒæ­¥</a>'
        )
        
        # æ‰¹é‡åˆ†é…
        actions.append(
            f'<a href="{reverse("admin:permissions_batch_assign", args=[obj.pk])}" '
            f'class="button" style="background: #ffc107; color: black; padding: 2px 6px; '
            f'text-decoration: none; border-radius: 3px; font-size: 11px;">'
            f'ğŸ“‹ æ‰¹é‡</a>'
        )
        
        return format_html(''.join(actions))
    
    permission_actions.short_description = 'æ“ä½œ'  # type: ignore
    
    def get_urls(self):
        """æ·»åŠ è‡ªå®šä¹‰URL"""
        urls = super().get_urls()
        custom_urls = [
            path(
                'permission-center/',
                self.admin_site.admin_view(self.permission_center_view),
                name='permissions_center'
            ),
            path(
                'role-detail/<int:role_id>/',
                self.admin_site.admin_view(self.role_detail_view),
                name='permissions_role_detail'
            ),
            path(
                'batch-assign/<int:role_id>/',
                self.admin_site.admin_view(self.batch_assign_view),
                name='permissions_batch_assign'
            ),
            path(
                'sync-role/<int:role_id>/',
                self.admin_site.admin_view(self.sync_role_view),
                name='permissions_sync_role'
            ),
        ]
        return custom_urls + urls
    
    def permission_center_view(self, request):
        """æƒé™ç®¡ç†ä¸­å¿ƒè§†å›¾"""
        context = {
            'title': 'æƒé™ä¸èœå•ç®¡ç†ä¸­å¿ƒ',
            'permission_stats': self.get_permission_stats(),
            'role_hierarchy': self.get_role_hierarchy(),
            'recent_sync_logs': PermissionSyncLog.objects.order_by('-sync_time')[:10],
        }
        return render(request, 'admin/permissions/permission_center.html', context)
    
    def get_permission_stats(self):
        """è·å–æƒé™ç»Ÿè®¡"""
        from django.contrib.auth.models import Permission
        
        return {
            'total_roles': RoleManagement.objects.count(),
            'active_roles': RoleManagement.objects.filter(is_active=True).count(),
            'total_permissions': Permission.objects.count(),
            'menu_configs': MenuModuleConfig.objects.count(),
            'role_mappings': RoleGroupMapping.objects.count(),
        }
    
    def get_role_hierarchy(self):
        """è·å–è§’è‰²å±‚çº§ç»“æ„"""
        roles = RoleManagement.objects.filter(is_active=True)
        hierarchy = {}
        
        for role in roles:
            if role.parent:
                if role.parent.display_name not in hierarchy:
                    hierarchy[role.parent.display_name] = []
                hierarchy[role.parent.display_name].append(role)
            else:
                if 'æ ¹è§’è‰²' not in hierarchy:
                    hierarchy['æ ¹è§’è‰²'] = []
                hierarchy['æ ¹è§’è‰²'].append(role)
        
        return hierarchy
    
    def role_detail_view(self, request, role_id):
        """è§’è‰²æƒé™è¯¦æƒ…è§†å›¾"""
        from django.shortcuts import get_object_or_404
        
        role = get_object_or_404(RoleManagement, pk=role_id)
        
        context = {
            'title': f'è§’è‰²æƒé™è¯¦æƒ…: {role.display_name}',
            'role': role,
            'direct_permissions': role.permissions.all(),
            'inherited_permissions': role.parent.permissions.all() if role.parent else [],
            'users': CustomUser.objects.filter(role=role.role),
            'menu_permissions': RoleMenuPermission.objects.filter(role=role.role),
        }
        return render(request, 'admin/permissions/role_detail.html', context)
    
    def batch_assign_view(self, request, role_id):
        """æ‰¹é‡æƒé™åˆ†é…è§†å›¾"""
        from django.shortcuts import get_object_or_404
        from django.contrib.auth.models import Permission
        
        role = get_object_or_404(RoleManagement, pk=role_id)
        
        if request.method == 'POST':
            permission_ids = request.POST.getlist('permissions')
            permissions = Permission.objects.filter(id__in=permission_ids)
            
            if request.POST.get('action') == 'add':
                role.permissions.add(*permissions)
                messages.success(request, f'æˆåŠŸä¸ºè§’è‰² {role.display_name} æ·»åŠ  {len(permissions)} ä¸ªæƒé™')
            elif request.POST.get('action') == 'remove':
                role.permissions.remove(*permissions)
                messages.success(request, f'æˆåŠŸä»è§’è‰² {role.display_name} ç§»é™¤ {len(permissions)} ä¸ªæƒé™')
            
            return redirect('admin:permissions_rolemanagement_changelist')
        
        context = {
            'title': f'æ‰¹é‡æƒé™åˆ†é…: {role.display_name}',
            'role': role,
            'all_permissions': Permission.objects.all().order_by('content_type__app_label', 'codename'),
            'current_permissions': role.permissions.all(),
        }
        return render(request, 'admin/permissions/batch_assign.html', context)
    
    def sync_role_view(self, request, role_id):
        """åŒæ­¥è§’è‰²æƒé™"""
        from django.shortcuts import get_object_or_404
        
        role = get_object_or_404(RoleManagement, pk=role_id)
        
        try:
            # æ‰§è¡Œæƒé™åŒæ­¥é€»è¾‘
            success_count = self.sync_role_permissions(role)
            
            # è®°å½•åŒæ­¥æ—¥å¿—
            PermissionSyncLog.objects.create(
                sync_type='manual',
                target_type='role',
                target_id=role.role,
                action='sync_permissions',
                result=f'æˆåŠŸåŒæ­¥ {success_count} ä¸ªç”¨æˆ·çš„æƒé™',
                success=True
            )
            
            return JsonResponse({
                'success': True,
                'message': f'è§’è‰² {role.display_name} æƒé™åŒæ­¥æˆåŠŸï¼Œå½±å“ {success_count} ä¸ªç”¨æˆ·'
            })
            
        except Exception as e:
            # è®°å½•å¤±è´¥æ—¥å¿—
            PermissionSyncLog.objects.create(
                sync_type='manual',
                target_type='role',
                target_id=role.role,
                action='sync_permissions',
                result=f'åŒæ­¥å¤±è´¥: {str(e)}',
                success=False
            )
            
            return JsonResponse({
                'success': False,
                'message': f'æƒé™åŒæ­¥å¤±è´¥: {str(e)}'
            })
    
    def sync_role_permissions(self, role):
        """æ‰§è¡Œè§’è‰²æƒé™åŒæ­¥"""
        from django.contrib.auth.models import Group
        
        # è·å–æˆ–åˆ›å»ºå¯¹åº”çš„ç»„
        group, created = Group.objects.get_or_create(name=f'{role.display_name}ç»„')
        
        # åŒæ­¥æƒé™åˆ°ç»„
        group.permissions.clear()
        group.permissions.add(*role.permissions.all())
        
        # å¦‚æœæœ‰çˆ¶è§’è‰²ï¼Œç»§æ‰¿çˆ¶è§’è‰²æƒé™
        if role.parent:
            group.permissions.add(*role.parent.permissions.all())
        
        # åŒæ­¥ç”¨æˆ·åˆ°ç»„
        users = CustomUser.objects.filter(role=role.role)
        for user in users:
            user.groups.clear()
            user.groups.add(group)
        
        return users.count()
    
    class Media:
        js = ('admin/js/integrated_permissions_admin.js',)
        css = {
            'all': ('admin/css/integrated_admin.css',)
        }


@admin.register(MenuModuleConfig)
class IntegratedMenuConfigAdmin(admin.ModelAdmin):
    """æ•´åˆèœå•é…ç½®ç®¡ç†
    
    ç»Ÿä¸€ç®¡ç†ï¼š
    - èœå•æ¨¡å—é…ç½®
    - è®¿é—®æƒé™æ§åˆ¶
    - èœå•å±‚çº§ç»“æ„
    - æ˜¾ç¤ºé¡ºåºè®¾ç½®
    """
    
    list_display = [
        'name', 'key', 'get_parent_info', 'get_role_access',
        'is_active', 'sort_order', 'menu_actions'
    ]
    list_filter = ['is_active', 'menu_level']
    search_fields = ['name', 'key', 'description']
    ordering = ['sort_order', 'key']
    
    fieldsets = (
        ('åŸºæœ¬ä¿¡æ¯', {
            'fields': ('name', 'key', 'description')
        }),
        ('å±‚çº§ç»“æ„', {
            'fields': ('menu_level', 'sort_order')
        }),
        ('è®¿é—®æ§åˆ¶', {
            'fields': ('url', 'icon', 'is_active')
        }),
    )
    
    def get_parent_info(self, obj):
        """è·å–çˆ¶æ¨¡å—ä¿¡æ¯"""
        level_display = dict(MenuModuleConfig.MENU_LEVEL_CHOICES).get(obj.menu_level, obj.menu_level)
        return format_html(
            '<span style="color: #007cba;">ğŸ“ {}</span>',
            level_display
        )
    
    get_parent_info.short_description = 'çˆ¶æ¨¡å—'  # type: ignore
    
    def get_role_access(self, obj):
        """è·å–è§’è‰²è®¿é—®æƒé™"""
        try:
            menu_perms = RoleMenuPermission.objects.filter(menu_module=obj)
            if menu_perms.exists():
                roles = [perm.get_role_display() for perm in menu_perms[:3]]
                count = menu_perms.count()
                if count > 3:
                    roles.append(f'ç­‰{count}ä¸ªè§’è‰²')
                return format_html(
                    '<span style="color: #17a2b8; font-size: 12px;">{}</span>',
                    ', '.join(roles)
                )
            return format_html('<span style="color: #6c757d;">æ— é™åˆ¶</span>')
        except Exception as e:
            return f'é”™è¯¯: {str(e)}'
    
    get_role_access.short_description = 'è§’è‰²è®¿é—®'  # type: ignore
    
    def menu_actions(self, obj):
        """èœå•æ“ä½œæŒ‰é’®"""
        actions = []
        
        # æƒé™é…ç½®
        actions.append(
            f'<a href="{reverse("admin:menu_permissions", args=[obj.pk])}" '
            f'class="button" style="background: #28a745; color: white; padding: 2px 6px; '
            f'text-decoration: none; border-radius: 3px; font-size: 11px; margin-right: 3px;">'
            f'ğŸ” æƒé™</a>'
        )
        
        # åŒçº§æ¨¡å—
        same_level_count = MenuModuleConfig.objects.filter(menu_level=obj.menu_level).count()
        if same_level_count > 1:
            actions.append(
                f'<a href="?menu_level__exact={obj.menu_level}" '
                f'class="button" style="background: #17a2b8; color: white; padding: 2px 6px; '
                f'text-decoration: none; border-radius: 3px; font-size: 11px;">'
                f'ğŸ“‚ åŒçº§({same_level_count})</a>'
            )
        
        return format_html(''.join(actions))
    
    menu_actions.short_description = 'æ“ä½œ'  # type: ignore
    
    def get_urls(self):
        """æ·»åŠ è‡ªå®šä¹‰URL"""
        urls = super().get_urls()
        custom_urls = [
            path(
                'menu-permissions/<int:menu_id>/',
                self.admin_site.admin_view(self.menu_permissions_view),
                name='menu_permissions'
            ),
        ]
        return custom_urls + urls
    
    def menu_permissions_view(self, request, menu_id):
        """èœå•æƒé™é…ç½®è§†å›¾"""
        from django.shortcuts import get_object_or_404
        
        menu = get_object_or_404(MenuModuleConfig, pk=menu_id)
        
        if request.method == 'POST':
            # å¤„ç†æƒé™é…ç½®æäº¤
            role_codes = request.POST.getlist('roles')
            
            # æ¸…é™¤ç°æœ‰æƒé™
            RoleMenuPermission.objects.filter(menu_module=menu).delete()
            
            # æ·»åŠ æ–°æƒé™
            for role_code in role_codes:
                RoleMenuPermission.objects.create(
                    role=role_code,
                    menu_module=menu,
                    can_view=True
                )
            
            messages.success(request, f'èœå• {menu.name} çš„æƒé™é…ç½®å·²æ›´æ–°')
            return redirect('admin:permissions_menumoduleconfig_changelist')
        
        context = {
            'title': f'èœå•æƒé™é…ç½®: {menu.name}',
            'menu': menu,
            'all_roles': UserRole.choices,
            'current_roles': RoleMenuPermission.objects.filter(
                menu_module=menu
            ).values_list('role', flat=True),
        }
        return render(request, 'admin/permissions/menu_permissions.html', context)