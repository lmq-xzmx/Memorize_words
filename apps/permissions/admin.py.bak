from django.contrib import admin
from django.utils.html import format_html
from django.contrib import messages
from django.http import HttpResponseRedirect, JsonResponse
from django.urls import path, reverse
from django.forms import ModelForm
from django.core.exceptions import ValidationError
from .models import MenuModuleConfig, RoleMenuPermission, RoleGroupMapping, PermissionSyncLog, RoleManagement
from .signals import sync_all_permissions
from .widgets import StandardRoleSelectWidget, StandardRoleChoiceField, RoleTextInputWidget
from .role_selector_config import StandardRoleAdminMixin, RoleCreationAdminMixin
from apps.accounts.models import UserRole
from typing import TYPE_CHECKING, Any, Tuple, List

if TYPE_CHECKING:
    from django.db.models import QuerySet


@admin.register(MenuModuleConfig)
class MenuModuleConfigAdmin(admin.ModelAdmin):
    """èœå•æ¨¡å—é…ç½®Admin"""
    list_display = ['name', 'key', 'get_menu_level_display', 'icon', 'sort_order', 'is_active', 'created_at']
    list_filter = ['menu_level', 'is_active', 'created_at']
    search_fields = ['name', 'key', 'description']
    ordering = ['menu_level', 'sort_order', 'name']
    
    def get_menu_level_display(self, obj):
        """æ˜¾ç¤ºèœå•çº§åˆ«"""
        level_colors = {
            'root': '#007bff',      # è“è‰² - æ ¹ç›®å½•
            'level1': '#28a745',    # ç»¿è‰² - ä¸€çº§ç›®å½•
            'level2': '#ffc107',    # é»„è‰² - äºŒçº§ç›®å½•
        }
        color = level_colors.get(obj.menu_level, '#6c757d')
        return format_html(
            '<span style="color: {}; background: {}20; padding: 2px 6px; border-radius: 3px; font-size: 12px; font-weight: bold;">{}</span>',
            color, color, obj.get_menu_level_display()
        )
    
    get_menu_level_display.short_description = 'èœå•çº§åˆ«'  # type: ignore
    
    fieldsets = (
        ('åŸºæœ¬ä¿¡æ¯', {
            'fields': ('name', 'key', 'menu_level', 'description')
        }),
        ('æ˜¾ç¤ºè®¾ç½®', {
            'fields': ('icon', 'url', 'sort_order', 'is_active')
        }),
    )


@admin.register(RoleMenuPermission)
class RoleMenuPermissionAdmin(StandardRoleAdminMixin, admin.ModelAdmin):
    """è§’è‰²èœå•æƒé™Admin"""
    list_display = ['role', 'menu_module', 'get_permission_status', 'created_at']
    list_filter = ['role', 'can_access', 'created_at']
    search_fields = ['menu_module__name', 'menu_module__key']
    ordering = ['role', 'menu_module__name']
    
    def get_permission_status(self, obj):
        """æ˜¾ç¤ºæƒé™çŠ¶æ€"""
        if obj.can_access:
            return format_html(
                '<span style="color: #28a745; background: #d4edda; padding: 2px 6px; border-radius: 3px; font-size: 12px;">'  
                'âœ“ å¯è®¿é—®</span>'
            )
        else:
            return format_html(
                '<span style="color: #dc3545; background: #f8d7da; padding: 2px 6px; border-radius: 3px; font-size: 12px;">'  
                'âœ— ç¦æ­¢è®¿é—®</span>'
            )
    
    get_permission_status.short_description = 'æƒé™çŠ¶æ€'  # type: ignore
    
    fieldsets = (
        ('åŸºæœ¬ä¿¡æ¯', {
            'fields': ('role', 'menu_module')
        }),
        ('æƒé™è®¾ç½®', {
            'fields': ('can_access',)
        }),
    )


@admin.register(RoleGroupMapping)
class RoleGroupMappingAdmin(admin.ModelAdmin, StandardRoleAdminMixin):
    """è§’è‰²ç»„æ˜ å°„Admin"""
    list_display = ['role', 'group', 'get_mapping_status', 'created_at']
    list_filter = ['role', 'auto_sync', 'created_at']
    search_fields = ['group__name']
    ordering = ['role', 'group__name']
    change_form_template = 'admin/permissions/rolegroupmapping/change_form.html'
    
    class Media:
        css = {
            'all': ('admin/css/role_group_mapping.css',)
        }
    
    def get_mapping_status(self, obj):
        """æ˜¾ç¤ºæ˜ å°„çŠ¶æ€"""
        if obj.auto_sync:
            return format_html(
                '<span style="color: #28a745; background: #d4edda; padding: 2px 6px; border-radius: 3px; font-size: 12px;">'  
                'ğŸ”— è‡ªåŠ¨åŒæ­¥</span>'
            )
        else:
            return format_html(
                '<span style="color: #dc3545; background: #f8d7da; padding: 2px 6px; border-radius: 3px; font-size: 12px;">'  
                'âŒ æ‰‹åŠ¨åŒæ­¥</span>'
            )
    
    get_mapping_status.short_description = 'åŒæ­¥çŠ¶æ€'  # type: ignore
    
    def formfield_for_foreignkey(self, db_field, request, **kwargs):
        """è‡ªå®šä¹‰å¤–é”®å­—æ®µ"""
        if db_field.name == "group":
            # ä¸ºç»„å­—æ®µæ·»åŠ è‡ªå®šä¹‰widget
            from django import forms
            from django.contrib.auth.models import Group
            
            class GroupSelectWidget(forms.Select):
                def __init__(self, *args, **kwargs):
                    super().__init__(*args, **kwargs)
                    self.attrs.update({
                        'id': 'id_group',
                        'class': 'form-control'
                    })
            
            kwargs['widget'] = GroupSelectWidget
        return super().formfield_for_foreignkey(db_field, request, **kwargs)
    
    # è§’è‰²é€‰æ‹©å™¨é…ç½®å·²é€šè¿‡StandardRoleAdminMixinè‡ªåŠ¨å¤„ç†
    
    def get_urls(self):
        """æ·»åŠ è‡ªå®šä¹‰URL"""
        urls = super().get_urls()
        custom_urls = [
            path('sync-role-groups/', self.admin_site.admin_view(self.sync_role_groups_view), name='sync_role_groups'),
            path('create-group-for-role/', self.admin_site.admin_view(self.create_group_for_role_view), name='create_group_for_role'),
            path('get-group-list/', self.admin_site.admin_view(self.get_group_list_view), name='get_group_list'),
            path('get-role-list/', self.admin_site.admin_view(self.get_role_list_view), name='get_role_list'),
            path('check-sync-status/', self.admin_site.admin_view(self.check_sync_status_view), name='check_sync_status'),
            path('refresh-all-sync/', self.admin_site.admin_view(self.refresh_all_sync_view), name='refresh_all_sync'),
        ]
        return custom_urls + urls
    
    def sync_role_groups_view(self, request):
        """åŒæ­¥è§’è‰²ç»„è§†å›¾"""
        from django.contrib.auth.models import Group
        from apps.accounts.models import UserRole
        import json
        
        if request.method == 'POST':
            try:
                data = json.loads(request.body)
                role = data.get('role')
                
                if role:
                    # è·å–æˆ–åˆ›å»ºå¯¹åº”çš„ç»„
                    role_display = dict(UserRole.choices).get(role, role)
                    group_name = f"{role_display}ç»„"
                    group, created = Group.objects.get_or_create(name=group_name)
                    
                    # æ›´æ–°æˆ–åˆ›å»ºè§’è‰²ç»„æ˜ å°„
                    mapping, mapping_created = RoleGroupMapping.objects.get_or_create(  # type: ignore
                        role=role,
                        defaults={'group': group, 'auto_sync': True}
                    )
                    
                    if not mapping_created:
                        mapping.group = group
                        mapping.save()
                    
                    return JsonResponse({
                        'success': True,
                        'group_id': group.pk,
                        'group_name': group.name,
                        'created': created or mapping_created
                    })
                else:
                    return JsonResponse({'success': False, 'error': 'è§’è‰²å‚æ•°ç¼ºå¤±'})
            except Exception as e:
                return JsonResponse({'success': False, 'error': str(e)})
        
        return JsonResponse({'success': False, 'error': 'ä»…æ”¯æŒPOSTè¯·æ±‚'})
    
    def create_group_for_role_view(self, request):
        """ä¸ºè§’è‰²åˆ›å»ºç»„è§†å›¾"""
        from django.contrib.auth.models import Group
        from apps.accounts.models import UserRole
        import json
        
        if request.method == 'POST':
            try:
                data = json.loads(request.body)
                role = data.get('role')
                group_name = data.get('group_name')
                
                if role and group_name:
                    # åˆ›å»ºæ–°ç»„
                    group = Group.objects.create(name=group_name)
                    
                    # åˆ›å»ºæˆ–æ›´æ–°è§’è‰²ç»„æ˜ å°„
                    mapping, created = RoleGroupMapping.objects.get_or_create(  # type: ignore
                        role=role,
                        defaults={'group': group, 'auto_sync': True}
                    )
                    
                    if not created:
                        mapping.group = group
                        mapping.save()
                    
                    return JsonResponse({
                        'success': True,
                        'group_id': group.pk,
                        'group_name': group.name
                    })
                else:
                    return JsonResponse({'success': False, 'error': 'å‚æ•°ç¼ºå¤±'})
            except Exception as e:
                return JsonResponse({'success': False, 'error': str(e)})
        
        return JsonResponse({'success': False, 'error': 'ä»…æ”¯æŒPOSTè¯·æ±‚'})
    
    def get_group_list_view(self, request):
        """è·å–ç»„åˆ—è¡¨API"""
        from django.contrib.auth.models import Group
        
        if request.method == 'GET':
            try:
                groups = Group.objects.all().order_by('name')
                group_list = [{
                    'id': group.pk,
                    'name': group.name
                } for group in groups]
                
                return JsonResponse({
                    'success': True,
                    'groups': group_list
                })
            except Exception as e:
                return JsonResponse({'success': False, 'error': str(e)})
        
        return JsonResponse({'success': False, 'error': 'ä»…æ”¯æŒGETè¯·æ±‚'})
    
    def get_role_list_view(self, request):
        """è·å–è§’è‰²åˆ—è¡¨API"""
        if request.method == 'GET':
            try:
                from apps.accounts.models import UserRole
                
                # è·å–é¢„å®šä¹‰è§’è‰²
                role_list = [{
                    'value': choice[0],
                    'display_name': str(choice[1])
                } for choice in UserRole.choices]
                
                # è·å–æ‰€æœ‰è‡ªå®šä¹‰è§’è‰²ï¼ˆåŒ…æ‹¬è§’è‰²ç®¡ç†ä¸­çš„æ‰€æœ‰è§’è‰²ï¼‰
                try:
                    all_roles = RoleManagement.objects.filter(is_active=True).values_list('role', 'display_name')  # type: ignore
                    
                    for role, display_name in all_roles:
                        # é¿å…é‡å¤æ·»åŠ é¢„å®šä¹‰è§’è‰²
                        if role not in [choice[0] for choice in UserRole.choices]:
                            role_list.append({
                                'value': role,
                                'display_name': str(display_name)
                            })
                except Exception:
                    pass
                
                return JsonResponse({
                    'success': True,
                    'roles': role_list
                })
            except Exception as e:
                return JsonResponse({'success': False, 'error': str(e)})
        
        return JsonResponse({'success': False, 'error': 'ä»…æ”¯æŒGETè¯·æ±‚'})
    
    def check_sync_status_view(self, request):
        """æ£€æŸ¥è§’è‰²åŒæ­¥çŠ¶æ€API"""
        if request.method == 'GET':
            try:
                role = request.GET.get('role')
                
                if not role:
                    return JsonResponse({'success': False, 'error': 'ç¼ºå°‘è§’è‰²å‚æ•°'})
                
                # è·å–è§’è‰²å¯¹åº”çš„ç»„æ˜ å°„
                try:
                    mapping = RoleGroupMapping.objects.select_related('group').get(role=role)  # type: ignore
                    return JsonResponse({
                        'success': True,
                        'group_id': mapping.group.pk,
                        'group_name': mapping.group.name,
                        'has_mapping': True
                    })
                except RoleGroupMapping.DoesNotExist:  # type: ignore
                    return JsonResponse({
                        'success': True,
                        'group_id': None,
                        'group_name': None,
                        'has_mapping': False
                    })
                
            except Exception as e:
                return JsonResponse({'success': False, 'error': str(e)})
        elif request.method == 'POST':
            try:
                import json
                data = json.loads(request.body)
                role = data.get('role')
                user_id = data.get('user_id')
                
                if not role:
                    return JsonResponse({'success': False, 'error': 'ç¼ºå°‘è§’è‰²å‚æ•°'})
                
                # è·å–è§’è‰²æƒé™æ•°é‡
                try:
                    role_mgmt = RoleManagement.objects.get(role=role)  # type: ignore
                    role_perms = len(role_mgmt.get_all_permissions())
                except RoleManagement.DoesNotExist:  # type: ignore
                    role_perms = 0
                
                # è·å–ç»„æƒé™æ•°é‡å’Œæ˜ å°„çŠ¶æ€
                try:
                    mapping = RoleGroupMapping.objects.select_related('group').get(role=role)  # type: ignore
                    group_perms = mapping.group.permissions.count()
                    has_mapping = True
                except RoleGroupMapping.DoesNotExist:  # type: ignore
                    group_perms = 0
                    has_mapping = False
                
                return JsonResponse({
                    'success': True,
                    'sync_data': {
                        'role': role,
                        'user_id': user_id,
                        'role_perms': role_perms,
                        'group_perms': group_perms,
                        'has_mapping': has_mapping,
                        'is_synced': group_perms == role_perms and role_perms > 0
                    }
                })
                
            except Exception as e:
                return JsonResponse({'success': False, 'error': str(e)})
        
        return JsonResponse({'success': False, 'error': 'ä»…æ”¯æŒGETå’ŒPOSTè¯·æ±‚'})
    
    def refresh_all_sync_view(self, request):
        """åˆ·æ–°æ‰€æœ‰åŒæ­¥æ•°æ®API"""
        if request.method == 'POST':
            try:
                from .utils import PermissionUtils
                
                # è·å–æ‰€æœ‰æ´»è·ƒè§’è‰²
                active_roles = RoleManagement.objects.filter(is_active=True)  # type: ignore
                success_count = 0
                total_count = active_roles.count()
                
                for role in active_roles:
                    try:
                        # åŒæ­¥è§’è‰²æƒé™åˆ°ç»„
                        sync_success = PermissionUtils.sync_role_permissions(role)
                        if sync_success:
                            success_count += 1
                        
                        # è®°å½•æ—¥å¿—
                        PermissionSyncLog.objects.create(  # type: ignore
                            sync_type='auto_refresh',
                            target_type='role',
                            target_id=role.role,
                            action=f'è‡ªåŠ¨åˆ·æ–°åŒæ­¥: {role.display_name}',
                            result=f'è§’è‰² {role.display_name} åŒæ­¥åˆ·æ–°: {"æˆåŠŸ" if sync_success else "å¤±è´¥"}',
                            success=sync_success
                        )
                    except Exception as e:
                        # è®°å½•å¤±è´¥æ—¥å¿—
                        PermissionSyncLog.objects.create(  # type: ignore
                            sync_type='auto_refresh',
                            target_type='role',
                            target_id=role.role,
                            action=f'è‡ªåŠ¨åˆ·æ–°åŒæ­¥å¤±è´¥: {role.display_name}',
                            result=f'é”™è¯¯: {str(e)}',
                            success=False
                        )
                
                return JsonResponse({
                    'success': True,
                    'message': f'åŒæ­¥åˆ·æ–°å®Œæˆï¼š{success_count}/{total_count} ä¸ªè§’è‰²åˆ·æ–°æˆåŠŸ',
                    'success_count': success_count,
                    'total_count': total_count
                })
                
            except Exception as e:
                return JsonResponse({'success': False, 'error': str(e)})
        
        return JsonResponse({'success': False, 'error': 'ä»…æ”¯æŒPOSTè¯·æ±‚'})

    fieldsets = (
        ('åŸºæœ¬ä¿¡æ¯', {
            'fields': ('role', 'group')
        }),
        ('åŒæ­¥è®¾ç½®', {
            'fields': ('auto_sync',)
        }),
    )

    def change_view(self, request, object_id, form_url='', extra_context=None):
        """è‡ªå®šä¹‰ä¿®æ”¹è§†å›¾"""
        extra_context = extra_context or {}
        extra_context['role_choices'] = UserRole.choices
        return super().change_view(request, object_id, form_url, extra_context)

    def add_view(self, request, form_url='', extra_context=None):
        """è‡ªå®šä¹‰æ·»åŠ è§†å›¾"""
        extra_context = extra_context or {}
        extra_context['role_choices'] = UserRole.choices
        return super().add_view(request, form_url, extra_context)


@admin.register(PermissionSyncLog)
class PermissionSyncLogAdmin(admin.ModelAdmin):
    """æƒé™åŒæ­¥æ—¥å¿—Admin"""
    list_display = ['sync_type', 'target_type', 'get_sync_status', 'action', 'created_at']
    list_filter = ['sync_type', 'target_type', 'success', 'created_at']
    search_fields = ['action', 'result']
    readonly_fields = ['sync_type', 'target_type', 'target_id', 'action', 'result', 'success', 'created_at']
    ordering = ['-created_at']
    
    def get_sync_status(self, obj):
        """æ˜¾ç¤ºåŒæ­¥çŠ¶æ€"""
        if obj.success:
            return format_html(
                '<span style="color: #28a745; background: #d4edda; padding: 2px 6px; border-radius: 3px; font-size: 12px;">'  
                'âœ… æˆåŠŸ</span>'
            )
        else:
            return format_html(
                '<span style="color: #dc3545; background: #f8d7da; padding: 2px 6px; border-radius: 3px; font-size: 12px;">'  
                'âŒ å¤±è´¥</span>'
            )
    
    get_sync_status.short_description = 'åŒæ­¥çŠ¶æ€'  # type: ignore
    
    def has_add_permission(self, request):
        """ç¦æ­¢æ‰‹åŠ¨æ·»åŠ æ—¥å¿—"""
        return False
    
    def has_change_permission(self, request, obj=None):
        """ç¦æ­¢ä¿®æ”¹æ—¥å¿—"""
        return False


# è‡ªå®šä¹‰AdminåŠ¨ä½œ
class PermissionManagementAdmin(admin.ModelAdmin):
    """æƒé™ç®¡ç†AdminåŸºç±»"""
    
    def get_urls(self):
        urls = super().get_urls()
        custom_urls = [
            path('sync-permissions/', self.admin_site.admin_view(self.sync_permissions_view), name='sync_permissions'),
        ]
        return custom_urls + urls
    
    def sync_permissions_view(self, request):
        """åŒæ­¥æƒé™è§†å›¾"""
        if request.method == 'POST':
            success = sync_all_permissions()
            if success:
                messages.success(request, 'æƒé™åŒæ­¥æˆåŠŸï¼')
            else:
                messages.error(request, 'æƒé™åŒæ­¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—ã€‚')
        
        return HttpResponseRedirect(reverse('admin:permissions_rolemenuPermission_changelist'))


# ä¸ºRoleMenuPermissionAdminæ·»åŠ è‡ªå®šä¹‰åŠŸèƒ½
class EnhancedRoleMenuPermissionAdmin(RoleMenuPermissionAdmin, PermissionManagementAdmin):
    """å¢å¼ºçš„è§’è‰²èœå•æƒé™Admin"""
    
    def changelist_view(self, request, extra_context=None):
        """è‡ªå®šä¹‰åˆ—è¡¨è§†å›¾"""
        extra_context = extra_context or {}
        extra_context['sync_permissions_url'] = reverse('admin:sync_permissions')
        return super().changelist_view(request, extra_context)


# é‡æ–°æ³¨å†Œå¢å¼ºç‰ˆAdmin
try:
    admin.site.unregister(RoleMenuPermission)
except:
    pass
admin.site.register(RoleMenuPermission, EnhancedRoleMenuPermissionAdmin)


@admin.register(RoleManagement)
class RoleManagementAdmin(StandardRoleAdminMixin, admin.ModelAdmin, RoleCreationAdminMixin):
    """è§’è‰²ç®¡ç†Admin - æ”¯æŒè§’è‰²ç»§æ‰¿"""
    list_display = ['display_name', 'get_role_display_name', 'get_parent_role', 'is_active', 'sort_order', 'get_permissions_count', 'get_inherited_permissions_count', 'created_at']
    list_filter = ['role', 'is_active', 'parent', 'created_at']
    search_fields = ['display_name', 'description']
    ordering = ['sort_order', 'role']
    filter_horizontal = ['permissions']
    
    class Media:
        js = ('admin/js/role_management_auto_fill.js', 'admin/js/dynamic_role_selector.js', 'admin/js/role_permission_sync.js')
        css = {
            'all': ('admin/css/dynamic_role_selector.css',)
        }
    
    def get_urls(self):
        """æ·»åŠ è‡ªå®šä¹‰URL"""
        urls = super().get_urls()
        custom_urls = [
            path('get-role-list/', self.admin_site.admin_view(self.get_role_list_view), name='get_role_list'),
            path('sync-role-to-groups/', self.admin_site.admin_view(self.sync_role_to_groups_view), name='sync_role_to_groups'),
            path('sync-all-roles-to-groups/', self.admin_site.admin_view(self.sync_all_roles_to_groups_view), name='sync_all_roles_to_groups'),
        ]
        return custom_urls + urls
    
    def get_role_list_view(self, request):
        """è·å–è§’è‰²åˆ—è¡¨API"""
        if request.method == 'GET':
            try:
                roles = RoleManagement.objects.filter(is_active=True).order_by('sort_order', 'role')  # type: ignore
                role_list = [{
                    'value': role.role,
                    'display_name': role.get_role_display()
                } for role in roles]
                
                return JsonResponse({
                    'success': True,
                    'roles': role_list
                })
            except Exception as e:
                return JsonResponse({'success': False, 'error': str(e)})
        
        return JsonResponse({'success': False, 'error': 'ä»…æ”¯æŒGETè¯·æ±‚'})
    
    def sync_role_to_groups_view(self, request):
        """åŒæ­¥å•ä¸ªè§’è‰²æƒé™åˆ°ç»„"""
        if request.method == 'POST':
            try:
                import json
                data = json.loads(request.body)
                role_id = data.get('role_id')
                
                if not role_id:
                    return JsonResponse({'success': False, 'error': 'ç¼ºå°‘è§’è‰²ID'})
                
                role = RoleManagement.objects.get(role=role_id)  # type: ignore
                
                # åŒæ­¥æƒé™åˆ°Djangoç»„
                from .utils import PermissionUtils
                sync_success = PermissionUtils.sync_role_permissions(role)
                
                # è®°å½•æ—¥å¿—
                PermissionSyncLog.objects.create(  # type: ignore
                    sync_type='manual',
                    target_type='role',
                    target_id=role.role,
                    action=f'æ‰‹åŠ¨åŒæ­¥è§’è‰²æƒé™: {role.display_name}',
                    result=f'è§’è‰² {role.display_name} æƒé™åŒæ­¥: {"æˆåŠŸ" if sync_success else "å¤±è´¥"}',
                    success=sync_success
                )
                
                return JsonResponse({
                    'success': sync_success,
                    'message': f'è§’è‰² "{role.display_name}" æƒé™åŒæ­¥{"æˆåŠŸ" if sync_success else "å¤±è´¥"}'
                })
                
            except RoleManagement.DoesNotExist:  # type: ignore
                return JsonResponse({'success': False, 'error': 'è§’è‰²ä¸å­˜åœ¨'})
            except Exception as e:
                return JsonResponse({'success': False, 'error': str(e)})
        
        return JsonResponse({'success': False, 'error': 'ä»…æ”¯æŒPOSTè¯·æ±‚'})
    
    def sync_all_roles_to_groups_view(self, request):
        """åŒæ­¥æ‰€æœ‰è§’è‰²æƒé™åˆ°ç»„"""
        if request.method == 'POST':
            try:
                roles = RoleManagement.objects.filter(is_active=True)  # type: ignore
                success_count = 0
                total_count = roles.count()
                
                from .utils import PermissionUtils
                
                for role in roles:
                    sync_success = PermissionUtils.sync_role_permissions(role)
                    if sync_success:
                        success_count += 1
                    
                    # è®°å½•æ—¥å¿—
                    PermissionSyncLog.objects.create(  # type: ignore
                        sync_type='batch',
                        target_type='role',
                        target_id=role.role,
                        action=f'æ‰¹é‡åŒæ­¥è§’è‰²æƒé™: {role.display_name}',
                        result=f'è§’è‰² {role.display_name} æƒé™åŒæ­¥: {"æˆåŠŸ" if sync_success else "å¤±è´¥"}',
                        success=sync_success
                    )
                
                return JsonResponse({
                    'success': True,
                    'message': f'æ‰¹é‡åŒæ­¥å®Œæˆï¼š{success_count}/{total_count} ä¸ªè§’è‰²åŒæ­¥æˆåŠŸ',
                    'success_count': success_count,
                    'total_count': total_count
                })
                
            except Exception as e:
                return JsonResponse({'success': False, 'error': str(e)})
        
        return JsonResponse({'success': False, 'error': 'ä»…æ”¯æŒPOSTè¯·æ±‚'})
    
    fieldsets = (
        ('åŸºæœ¬ä¿¡æ¯', {
            'fields': ('role', 'display_name', 'description', 'is_active', 'sort_order')
        }),
        ('è§’è‰²ç»§æ‰¿', {
            'fields': ('parent',),
            'description': 'é€‰æ‹©çˆ¶è§’è‰²ï¼Œå­è§’è‰²å°†è‡ªåŠ¨ç»§æ‰¿çˆ¶è§’è‰²çš„æ‰€æœ‰æƒé™'
        }),
        ('æƒé™é…ç½® - å•å‘åŒæ­¥åˆ°ç»„', {
            'fields': ('permissions',),
            'classes': ('wide',),
            'description': 'ğŸ”„ <strong>æƒé™å•å‘åŒæ­¥ç‰¹æ€§</strong>ï¼šæ­¤å¤„é…ç½®çš„æƒé™å°†è‡ªåŠ¨åŒæ­¥åˆ°å¯¹åº”çš„Djangoç»„ä¸­ã€‚<br/>'
                          'ğŸ“‹ è§’è‰²ç®¡ç†ä¸­çš„æ‰€æœ‰æƒé™éƒ½ä¼šåœ¨ç»„ç®¡ç†ä¸­åˆ›å»ºå¯¹åº”çš„æƒé™ã€‚<br/>'
                          'ğŸ¯ ç»„ç®¡ç†ä¸­ä¹Ÿå¯ä»¥åˆ›å»ºç‹¬ç«‹äºè§’è‰²ç®¡ç†çš„ç»„ï¼Œç”¨äºç‰¹æ®Šæ§åˆ¶ã€‚<br/>'
                          'âš ï¸ æ³¨æ„ï¼šæƒé™åŒæ­¥æ˜¯å•å‘çš„ï¼ˆè§’è‰²â†’ç»„ï¼‰ï¼Œç»„ä¸­çš„æƒé™ä¿®æ”¹ä¸ä¼šå½±å“è§’è‰²é…ç½®ã€‚'
        }),
    )
    
    # è§’è‰²é€‰æ‹©å™¨é…ç½®å·²é€šè¿‡RoleCreationAdminMixinè‡ªåŠ¨å¤„ç†
    
    def get_role_display_name(self, obj):
        """æ˜¾ç¤ºè§’è‰²åç§°"""
        return obj.get_role_display()
    
    get_role_display_name.short_description = 'è§’è‰²'  # type: ignore
    
    def get_parent_role(self, obj):
        """æ˜¾ç¤ºçˆ¶è§’è‰²"""
        if obj.parent:
            return format_html(
                '<span style="color: #007bff;">ğŸ“ {}</span>',
                obj.parent.display_name
            )
        else:
            return format_html(
                '<span style="color: #6c757d;">ğŸ  æ ¹è§’è‰²</span>'
            )
    
    get_parent_role.short_description = 'çˆ¶è§’è‰²'  # type: ignore
    
    def get_permissions_count(self, obj):
        """æ˜¾ç¤ºç›´æ¥æƒé™æ•°é‡"""
        count = obj.permissions.count()
        if count > 0:
            return format_html(
                '<span style="color: #28a745; font-weight: bold;">{} ä¸ª</span>',
                count
            )
        else:
            return format_html(
                '<span style="color: #6c757d;">0 ä¸ª</span>'
            )
    
    get_permissions_count.short_description = 'ç›´æ¥æƒé™'  # type: ignore
    
    def get_inherited_permissions_count(self, obj):
        """æ˜¾ç¤ºæ€»æƒé™æ•°é‡ï¼ˆåŒ…æ‹¬ç»§æ‰¿ï¼‰"""
        all_perms = obj.get_all_permissions()
        direct_count = obj.permissions.count()
        total_count = len(all_perms)
        inherited_count = total_count - direct_count
        
        if inherited_count > 0:
            return format_html(
                '<span style="color: #17a2b8; font-weight: bold;">{} ä¸ª (ç»§æ‰¿ {})</span>',
                total_count, inherited_count
            )
        else:
            return format_html(
                '<span style="color: #28a745; font-weight: bold;">{} ä¸ª</span>',
                total_count
            )
    
    get_inherited_permissions_count.short_description = 'æ€»æƒé™'  # type: ignore
    
    def clean_model(self, request, obj, form, change):
        """æ¨¡å‹éªŒè¯"""
        try:
            obj.clean()
        except ValidationError as e:
            form.add_error(None, e)
    
    def save_model(self, request, obj, form, change):
        """ä¿å­˜æ¨¡å‹æ—¶çš„å¤„ç†"""
        # å…ˆè¿›è¡Œæ¨¡å‹éªŒè¯
        self.clean_model(request, obj, form, change)
        
        super().save_model(request, obj, form, change)
        
        # åŒæ­¥æƒé™åˆ°Djangoç»„
        from .utils import PermissionUtils
        sync_success = PermissionUtils.sync_role_permissions(obj)
        
        # è®°å½•æ“ä½œæ—¥å¿—
        action = 'æ›´æ–°è§’è‰²' if change else 'åˆ›å»ºè§’è‰²'
        PermissionSyncLog.objects.create(  # type: ignore
            sync_type='manual',
            target_type='role',
            target_id=obj.role,
            action=f'{action}: {obj.display_name}',
            result=f'è§’è‰² {obj.display_name} å·²æˆåŠŸ{action}ï¼Œæƒé™åŒæ­¥: {"æˆåŠŸ" if sync_success else "å¤±è´¥"}',
            success=True
        )
        
        if change:
            messages.success(request, f'è§’è‰² "{obj.display_name}" å·²æˆåŠŸæ›´æ–°ï¼æƒé™åŒæ­¥: {"æˆåŠŸ" if sync_success else "å¤±è´¥"}')
        else:
            messages.success(request, f'è§’è‰² "{obj.display_name}" å·²æˆåŠŸåˆ›å»ºï¼æƒé™åŒæ­¥: {"æˆåŠŸ" if sync_success else "å¤±è´¥"}')
    
    def delete_model(self, request, obj):
        """åˆ é™¤æ¨¡å‹æ—¶çš„å¤„ç†"""
        role_name = obj.display_name
        super().delete_model(request, obj)
        
        # è®°å½•æ“ä½œæ—¥å¿—
        PermissionSyncLog.objects.create(  # type: ignore
            sync_type='manual',
            target_type='role',
            target_id=obj.role,
            action=f'åˆ é™¤è§’è‰²: {role_name}',
            result=f'è§’è‰² {role_name} å·²æˆåŠŸåˆ é™¤',
            success=True
        )
        
        messages.success(request, f'è§’è‰² "{role_name}" å·²æˆåŠŸåˆ é™¤ï¼')
    
    def get_queryset(self, request):
        """ä¼˜åŒ–æŸ¥è¯¢"""
        return super().get_queryset(request).prefetch_related('permissions')