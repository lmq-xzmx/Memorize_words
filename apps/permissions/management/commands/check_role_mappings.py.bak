from django.core.management.base import BaseCommand
from apps.permissions.models import RoleGroupMapping
from apps.accounts.models import UserRole
from django.contrib.auth.models import Group


class Command(BaseCommand):
    help = 'æ£€æŸ¥è§’è‰²ç»„æ˜ å°„çŠ¶æ€'
    
    def handle(self, *args, **options):
        """æ£€æŸ¥è§’è‰²ç»„æ˜ å°„"""
        
        self.stdout.write("ğŸ“Š è§’è‰²ç»„æ˜ å°„çŠ¶æ€æ£€æŸ¥")
        self.stdout.write("=" * 50)
        
        # æ˜¾ç¤ºç°æœ‰æ˜ å°„
        self.stdout.write("\nâœ… ç°æœ‰è§’è‰²ç»„æ˜ å°„:")
        mappings = RoleGroupMapping.objects.all()
        if mappings:
            for mapping in mappings:
                status = "ğŸŸ¢ æ´»è·ƒ" if mapping.auto_sync else "ğŸ”´ éæ´»è·ƒ"
                self.stdout.write(f"  {mapping.get_role_display()} -> {mapping.group.name} ({status})")
        else:
            self.stdout.write("  âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•è§’è‰²ç»„æ˜ å°„")
        
        # æ£€æŸ¥ç¼ºå¤±çš„æ˜ å°„
        self.stdout.write("\nâŒ ç¼ºå¤±çš„è§’è‰²æ˜ å°„:")
        existing_roles = set(RoleGroupMapping.objects.values_list('role', flat=True))
        all_roles = set([choice[0] for choice in UserRole.choices])
        missing_roles = all_roles - existing_roles
        
        if missing_roles:
            for role in missing_roles:
                role_display = dict(UserRole.choices).get(role, role)
                self.stdout.write(f"  âŒ {role_display} ({role})")
        else:
            self.stdout.write("  âœ… æ‰€æœ‰è§’è‰²éƒ½æœ‰å¯¹åº”çš„ç»„æ˜ å°„")
        
        # æ˜¾ç¤ºå¯ç”¨çš„Djangoç»„
        self.stdout.write("\nğŸ“‹ å¯ç”¨çš„Djangoç»„:")
        groups = Group.objects.all()
        if groups:
            for group in groups:
                # æ£€æŸ¥æ˜¯å¦å·²è¢«æ˜ å°„
                mapped = RoleGroupMapping.objects.filter(group=group).exists()
                status = "ğŸ”— å·²æ˜ å°„" if mapped else "ğŸ†“ å¯ç”¨"
                self.stdout.write(f"  {group.name} ({status})")
        else:
            self.stdout.write("  âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•Djangoç»„")
        
        # æä¾›ä¿®å¤å»ºè®®
        if missing_roles:
            self.stdout.write("\nğŸ”§ ä¿®å¤å»ºè®®:")
            self.stdout.write("  1. è¿è¡Œ 'python manage.py create_role_group_mappings' åˆ›å»ºç¼ºå¤±çš„æ˜ å°„")
            self.stdout.write("  2. æˆ–è€…åœ¨Djangoç®¡ç†åå°æ‰‹åŠ¨åˆ›å»ºè§’è‰²ç»„æ˜ å°„")
        
        self.stdout.write("\n" + "=" * 50)
        self.stdout.write("æ£€æŸ¥å®Œæˆï¼")