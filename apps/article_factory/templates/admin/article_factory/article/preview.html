{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block extrahead %}
{{ block.super }}
<script src="{% static 'js/student_selector_unified.js' %}"></script>
{% endblock %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='article_factory' %}">文章解析工厂</a>
    &rsaquo; <a href="{% url 'admin:article_factory_article_changelist' %}">文章</a>
    &rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
{% csrf_token %}
<div id="content-main">
    <div class="module">
        <h2>文章信息</h2>
        <div class="article-info">
            <p><strong>标题:</strong> {{ article.title }}</p>
            <p><strong>用户:</strong> {{ article.user.username }}</p>
            <p><strong>词库来源:</strong> {{ article.vocabulary_source }}</p>
            <p><strong>变体偏好:</strong> {{ article.get_variant_preference_display }}</p>
            <p><strong>解析时间:</strong> {{ article.updated_at }}</p>
            <div class="student-selection">
                <label for="current-student-select"><strong>当前学生:</strong></label>
                <select id="current-student-select" onchange="switchCurrentStudent(this.value)">
                    <option value="">-- 加载中... --</option>
                </select>
                <span id="student-status" class="student-status">请选择学生以显示个性化词汇标记</span>
            </div>
        </div>
    </div>

    {% if article.parsed_content.statistics %}
    <div class="module">
        <h2>解析统计</h2>
        <div class="statistics">
            <div class="stat-item">
                <span class="stat-label">总词数:</span>
                <span class="stat-value">{{ article.parsed_content.statistics.total_words }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">词库词数:</span>
                <span class="stat-value">{{ article.parsed_content.statistics.vocab_words }}</span>
                <span class="stat-percentage">({{ article.parsed_content.statistics.vocab_coverage }}%)</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">熟词数:</span>
                <span class="stat-value">{{ article.parsed_content.statistics.known_words }}</span>
                <span class="stat-percentage">({{ article.parsed_content.statistics.known_coverage }}%)</span>
            </div>
            <div class="stat-item" id="new-word-rate-item" style="display: none;">
                <span class="stat-label">生词率:</span>
                <span class="stat-value" id="new-word-rate-value">--</span>
                <span class="stat-percentage" id="new-word-rate-percentage">(--)</span>
            </div>
        </div>
    </div>
    {% endif %}

    {% if article.paragraph_analysis %}
    <div class="module">
        <h2>段落分析</h2>
        <div class="paragraph-analysis">
            <p><strong>总段落数:</strong> {{ article.paragraph_analysis.total_paragraphs }}</p>
            <div class="type-distribution">
                <h4>段落类型分布:</h4>
                {% for type, count in article.paragraph_analysis.type_distribution.items %}
                <div class="type-item">
                    <span class="type-name">{{ type }}:</span>
                    <span class="type-count">{{ count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="module">
        <h2>预览模式</h2>
        <div class="preview-controls">
            <button type="button" id="highlight-mode-btn" class="btn btn-primary active">高亮模式预览</button>
            <button type="button" id="text-mode-btn" class="btn btn-secondary">文本模式预览</button>
            <button type="button" class="btn btn-info" onclick="showPOSLegend()">词性图例</button>
            <button type="button" class="btn btn-success" onclick="exportAnalysis()">导出分析</button>
            <button type="button" class="btn btn-warning" onclick="refreshHighlighting()">刷新高亮</button>


        </div>

        <!-- 综合配置面板 -->
        <div id="pos-legend" class="comprehensive-config-panel" style="display: none;">
            <div class="config-container">
                <!-- 词库和显示设置 -->
                <div class="config-section display-settings-section">
                    <div class="section-header">
                        <h4>显示设置</h4>
                        <div class="section-actions">
                            <button class="mini-btn" onclick="resetDisplaySettings()">重置</button>
                        </div>
                    </div>
                    <div class="display-settings-grid">
                        <!-- 词库来源设置 -->
                        <div class="setting-group">
                            <label class="setting-label">
                                <span class="label-text">词库来源</span>
                                <span class="label-desc">选择词汇标记的数据来源</span>
                            </label>
                            <select id="vocab-source-select" onchange="switchVocabularySource(this.value)">
                                <option value="default" selected>系统词库</option>
                            </select>
                        </div>

                        <!-- 词性显示设置 -->
                        <div class="setting-group">
                            <label class="setting-label-with-desc">
                                <div class="setting-control">
                                    <input type="checkbox" id="show-pos" checked>
                                    <span class="label-text">显示词性</span>
                                </div>
                                <span class="label-desc">为每个词汇添加词性标记和颜色，帮助理解语法结构</span>
                            </label>
                        </div>

                        <!-- 词库词显示设置 -->
                        <div class="setting-group">
                            <label class="setting-label-with-desc">
                                <div class="setting-control">
                                    <input type="checkbox" id="show-vocab" checked>
                                    <span class="label-text">显示词库词</span>
                                </div>
                                <span class="label-desc">高亮显示词库中的词汇，开启边框功能</span>
                            </label>
                        </div>

                        <!-- 熟词显示设置 -->
                        <div class="setting-group">
                            <label class="setting-label-with-desc">
                                <div class="setting-control">
                                    <input type="checkbox" id="show-known" checked>
                                    <span class="label-text">显示熟词</span>
                                </div>
                                <span class="label-desc" id="known-words-desc">显示当前学生已掌握的熟词（需选择学生）</span>
                            </label>
                        </div>

                        <!-- 生词显示设置 -->
                        <div class="setting-group">
                            <label class="setting-label-with-desc">
                                <div class="setting-control">
                                    <input type="checkbox" id="show-new-words" checked>
                                    <span class="label-text">显示生词</span>
                                </div>
                                <span class="label-desc" id="new-words-desc">显示当前学生需要学习的生词（红字黄底样式）</span>
                            </label>
                        </div>

                        <!-- 鼠标悬停设置 -->
                        <div class="setting-group">
                            <label class="setting-label-with-desc">
                                <div class="setting-control">
                                    <input type="checkbox" id="show-tooltips" checked>
                                    <span class="label-text">鼠标悬停显示</span>
                                </div>
                                <span class="label-desc">开启：鼠标悬停显示详细信息；关闭：需要点击才能取词</span>
                            </label>
                        </div>


                    </div>
                </div>

                <!-- 视觉效果设置 -->
                <div class="config-section visual-effects-section">
                    <div class="section-header">
                        <h4>视觉效果</h4>
                        <div class="section-actions">
                            <button class="mini-btn" onclick="resetVisualEffects()">重置</button>
                        </div>
                    </div>
                    <div class="visual-effects-grid">
                        <div class="setting-group">
                            <label class="setting-label">
                                <input type="checkbox" id="enable-backgrounds">
                                <span class="label-text">启用背景色</span>
                                <span class="label-desc">为词汇添加背景色效果</span>
                            </label>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">
                                <input type="checkbox" id="enable-borders" disabled>
                                <span class="label-text">启用边框</span>
                                <span class="label-desc">为词库词添加边框效果（需开启显示词库词）</span>
                            </label>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">
                                <input type="checkbox" id="enable-gradients">
                                <span class="label-text">启用渐变</span>
                                <span class="label-desc">使用渐变背景色</span>
                            </label>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">
                                <input type="checkbox" id="enable-animations">
                                <span class="label-text">启用动画</span>
                                <span class="label-desc">生词脉冲动画效果</span>
                            </label>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">
                                <input type="checkbox" id="enable-shadows">
                                <span class="label-text">启用阴影</span>
                                <span class="label-desc">添加阴影增强立体感</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 词性图例 -->
                <div class="config-section pos-section">
                    <div class="section-header">
                        <h4>词性图例</h4>
                        <div class="section-actions">
                            <button class="mini-btn" onclick="resetPOSColors()">重置</button>
                        </div>
                    </div>
                    <div class="pos-legend-column">
                        <div class="pos-item-row" data-pos="noun">
                            <div class="pos-color-indicator" style="background: #2196f3;"></div>
                            <span class="pos-label">名词</span>
                            <input type="color" value="#2196f3" onchange="updatePOSColor('noun', this.value)">
                        </div>
                        <div class="pos-item-row" data-pos="verb">
                            <div class="pos-color-indicator" style="background: #4caf50;"></div>
                            <span class="pos-label">动词</span>
                            <input type="color" value="#4caf50" onchange="updatePOSColor('verb', this.value)">
                        </div>
                        <div class="pos-item-row" data-pos="adjective">
                            <div class="pos-color-indicator" style="background: #ff9800;"></div>
                            <span class="pos-label">形容词</span>
                            <input type="color" value="#ff9800" onchange="updatePOSColor('adjective', this.value)">
                        </div>
                        <div class="pos-item-row" data-pos="adverb">
                            <div class="pos-color-indicator" style="background: #9c27b0;"></div>
                            <span class="pos-label">副词</span>
                            <input type="color" value="#9c27b0" onchange="updatePOSColor('adverb', this.value)">
                        </div>
                        <div class="pos-item-row" data-pos="preposition">
                            <div class="pos-color-indicator" style="background: #607d8b;"></div>
                            <span class="pos-label">介词</span>
                            <input type="color" value="#607d8b" onchange="updatePOSColor('preposition', this.value)">
                        </div>
                        <div class="pos-item-row" data-pos="conjunction">
                            <div class="pos-color-indicator" style="background: #795548;"></div>
                            <span class="pos-label">连词</span>
                            <input type="color" value="#795548" onchange="updatePOSColor('conjunction', this.value)">
                        </div>
                        <div class="pos-item-row" data-pos="pronoun">
                            <div class="pos-color-indicator" style="background: #e91e63;"></div>
                            <span class="pos-label">代词</span>
                            <input type="color" value="#e91e63" onchange="updatePOSColor('pronoun', this.value)">
                        </div>
                        <div class="pos-item-row" data-pos="article">
                            <div class="pos-color-indicator" style="background: #009688;"></div>
                            <span class="pos-label">冠词</span>
                            <input type="color" value="#009688" onchange="updatePOSColor('article', this.value)">
                        </div>
                    </div>
                </div>

                <!-- 词汇类型配色 -->
                <div class="config-section vocab-section">
                    <div class="section-header">
                        <h4>词汇类型配色</h4>
                        <div class="section-actions">
                            <button class="mini-btn" onclick="resetVocabColors()">重置</button>
                        </div>
                    </div>
                    <div class="vocab-color-column">
                        <div class="vocab-color-item-row">
                            <div class="vocab-color-sample new-word-sample">生词</div>
                            <input type="color" id="new-word-color" value="#f44336"
                                onchange="updateVocabColor('new-word', this.value)">
                        </div>
                        <div class="vocab-color-item-row">
                            <div class="vocab-color-sample vocab-word-sample">词库词</div>
                            <input type="color" id="vocab-word-color" value="#2196f3"
                                onchange="updateVocabColor('vocab-word', this.value)">
                        </div>
                        <div class="vocab-color-item-row">
                            <div class="vocab-color-sample known-word-sample">熟词</div>
                            <input type="color" id="known-word-color" value="#4caf50"
                                onchange="updateVocabColor('known-word', this.value)">
                        </div>
                    </div>
                </div>

                <!-- 配色预设 -->
                <div class="config-section presets-section">
                    <div class="section-header">
                        <h4>配色预设</h4>
                    </div>
                    <div class="preset-buttons">
                        <button class="preset-btn default" onclick="applyColorPreset('default')">
                            <span class="preset-name">默认</span>
                            <div class="preset-colors">
                                <div style="background: #2196f3;"></div>
                                <div style="background: #4caf50;"></div>
                                <div style="background: #ff9800;"></div>
                            </div>
                        </button>
                        <button class="preset-btn colorblind" onclick="applyColorPreset('colorblind')">
                            <span class="preset-name">色盲友好</span>
                            <div class="preset-colors">
                                <div style="background: #0173b2;"></div>
                                <div style="background: #de8f05;"></div>
                                <div style="background: #029e73;"></div>
                            </div>
                        </button>
                        <button class="preset-btn dark" onclick="applyColorPreset('dark')">
                            <span class="preset-name">深色</span>
                            <div class="preset-colors">
                                <div style="background: #64b5f6;"></div>
                                <div style="background: #81c784;"></div>
                                <div style="background: #ffb74d;"></div>
                            </div>
                        </button>
                        <button class="preset-btn pastel" onclick="applyColorPreset('pastel')">
                            <span class="preset-name">柔和</span>
                            <div class="preset-colors">
                                <div style="background: #bbdefb;"></div>
                                <div style="background: #c8e6c9;"></div>
                                <div style="background: #ffe0b2;"></div>
                            </div>
                        </button>
                    </div>
                </div>


            </div>
        </div>

        <div class="preview-container">
            <div class="paragraph-navigator">
                <h4>段落导航</h4>
                <div id="paragraph-tree">
                    {% for paragraph in article.paragraphs.all %}
                    <div class="paragraph-item" data-paragraph-id="{{ forloop.counter }}" data-type="{{ paragraph.paragraph_type }}">
                        <span class="paragraph-type type-{{ paragraph.paragraph_type }}">{{ paragraph.paragraph_type }}</span>
                        <span class="paragraph-preview">{{ paragraph.original_text|truncatechars:40 }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="article-content" id="article-content">
                {{ article.html_content|safe }}
            </div>

            <div class="text-content" id="text-content" style="display: none;">
                {% for paragraph in article.paragraphs.all %}
                <div class="text-paragraph" data-paragraph-id="{{ forloop.counter }}">
                    {{ paragraph.original_text }}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="submit-row">
        <a href="{% url 'admin:article_factory_article_parse' article.pk %}" class="button">重新解析</a>
        <a href="{% url 'admin:article_factory_article_edit_source' article.pk %}" class="button">源码编辑</a>

        <a href="{% url 'admin:article_factory_article_changelist' %}" class="button cancel-link">返回列表</a>
    </div>
</div>

<!-- 词汇详情弹窗 -->
<div id="word-detail-modal" class="word-detail-modal">
    <div class="word-detail-content">
        <div class="word-detail-header">
            <div class="word-detail-title" id="word-detail-title">词汇详情</div>
            <button class="word-detail-close" onclick="closeWordDetail()">&times;</button>
        </div>
        <div class="word-detail-body" id="word-detail-body">
            <!-- 词汇详情内容将在这里动态填充 -->
        </div>
    </div>
</div>

<style>
    .module h2 {
        background: #f8f8f8;
        color: #666;
        font-size: 11px;
        font-weight: bold;
        margin: 0 0 10px 0;
        padding: 8px 10px;
        text-transform: uppercase;
    }

    .article-info p {
        margin: 5px 0;
        padding: 5px 10px;
    }

    .student-selection {
        margin: 10px 0;
        padding: 10px;
        background: #f0f8ff;
        border: 1px solid #b3d9ff;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .student-selection label {
        font-weight: bold;
        color: #333;
        white-space: nowrap;
    }

    .student-selection select {
        padding: 5px 10px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 13px;
        min-width: 120px;
    }

    .student-status {
        font-size: 12px;
        color: #666;
        font-style: italic;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 5px;
    }

    .student-status.loading {
        color: #007cba;
        font-weight: 500;
    }

    .student-status.success {
        color: #28a745;
    }

    .student-status.error {
        color: #dc3545;
        font-weight: 500;
    }

    .student-status.warning {
        color: #ffc107;
        font-weight: 500;
    }

    .student-status.selected {
        color: #28a745;
        font-weight: 500;
    }

    .retry-btn {
        padding: 2px 8px !important;
        font-size: 11px !important;
        border-radius: 3px !important;
    }

    .statistics {
        padding: 10px;
    }

    .stat-item {
        display: inline-block;
        margin: 5px 20px 5px 0;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 4px;
    }

    .stat-label {
        font-weight: bold;
        color: #666;
    }

    .stat-value {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin: 0 5px;
    }

    .stat-percentage {
        color: #666;
        font-size: 12px;
    }

    .paragraph-analysis {
        padding: 10px;
    }

    .type-distribution {
        margin-top: 10px;
    }

    .type-item {
        display: inline-block;
        margin: 5px 15px 5px 0;
        padding: 5px 10px;
        background: #e8f4fd;
        border-radius: 3px;
    }

    .type-name {
        font-weight: bold;
        color: #0066cc;
    }

    .type-count {
        color: #333;
        margin-left: 5px;
    }

    /* 预览控制样式 */
    .preview-controls {
        padding: 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 8px 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: #fff;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #007cba;
        color: white;
        border-color: #007cba;
    }

    .btn-primary:hover {
        background: #005a87;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
        border-color: #6c757d;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    .btn.active {
        box-shadow: 0 0 0 2px rgba(0, 124, 186, 0.25);
    }

    .view-options {
        display: flex;
        gap: 15px;
        margin-left: auto;
    }

    .view-options label {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 12px;
        cursor: pointer;
    }

    /* 预览容器布局 */
    .preview-container {
        display: flex;
        min-height: 600px;
    }

    .paragraph-navigator {
        width: 250px;
        background: #f8f9fa;
        border-right: 1px solid #dee2e6;
        padding: 15px;
        overflow-y: auto;
    }

    .paragraph-navigator h4 {
        margin: 0 0 15px 0;
        font-size: 14px;
        color: #495057;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 8px;
    }

    .paragraph-item {
        padding: 8px 12px;
        margin: 5px 0;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 3px solid transparent;
    }

    .paragraph-item:hover {
        background: #e9ecef;
    }

    .paragraph-item.active {
        background: #e3f2fd;
        border-left-color: #2196f3;
    }

    .paragraph-type {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
        margin-right: 8px;
    }

    .type-title {
        background: #e3f2fd;
        color: #1976d2;
    }

    .type-normal {
        background: #f3e5f5;
        color: #7b1fa2;
    }

    .type-list_item {
        background: #e8f5e8;
        color: #388e3c;
    }

    .type-quote {
        background: #fff3e0;
        color: #f57c00;
    }

    .type-code {
        background: #fce4ec;
        color: #c2185b;
    }

    .paragraph-preview {
        font-size: 11px;
        color: #6c757d;
        display: block;
        margin-top: 2px;
    }

    .article-content {
        flex: 1;
        padding: 20px;
        background: #fff;
        line-height: 1.6;
        overflow-y: auto;
    }

    .text-content {
        flex: 1;
        padding: 20px;
        background: #fff;
        line-height: 1.8;
        overflow-y: auto;
    }

    .text-paragraph {
        margin: 15px 0;
        padding: 10px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .text-paragraph.highlighted {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
    }

    /* 优化的词汇高亮样式 */
    .word {
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 3px;
        padding: 2px 4px;
        margin: 0 1px;
        display: inline-block;
        position: relative;
        line-height: 1.2;
    }

    .word:hover {
        transform: translateY(-1px);
        z-index: 5;
    }

    /* 词库词样式 - 默认无背景 */
    .vocab-word {
        color: #1565c0;
        border: none;
        background: transparent;
    }

    .vocab-word:hover {
        background: rgba(33, 150, 243, 0.1);
        border-radius: 3px;
    }

    /* 熟词样式 - 默认无背景 */
    .known-word {
        color: #2e7d32;
        border: none;
        background: transparent;
    }

    .known-word:hover {
        background: rgba(76, 175, 80, 0.1);
        border-radius: 3px;
    }

    /* 启用背景色时的样式 */
    .word:not(.no-backgrounds).vocab-word {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 1px solid #90caf9;
        box-shadow: 0 1px 2px rgba(33, 150, 243, 0.1);
    }

    .word:not(.no-backgrounds).vocab-word:hover {
        background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%);
        box-shadow: 0 2px 4px rgba(33, 150, 243, 0.2);
    }

    .word:not(.no-backgrounds).known-word {
        background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
        border: 1px solid #a5d6a7;
        box-shadow: 0 1px 2px rgba(76, 175, 80, 0.1);
    }

    .word:not(.no-backgrounds).known-word:hover {
        background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
        box-shadow: 0 2px 4px rgba(76, 175, 80, 0.2);
    }

    /* 词性标记样式 - 增强版 */
    .pos-noun {
        border-bottom: 2px solid #2196f3;
        background-color: rgba(33, 150, 243, 0.1);
    }

    .pos-verb {
        border-bottom: 2px solid #4caf50;
        background-color: rgba(76, 175, 80, 0.1);
    }

    .pos-adjective {
        border-bottom: 2px solid #ff9800;
        background-color: rgba(255, 152, 0, 0.1);
    }

    .pos-adverb {
        border-bottom: 2px solid #9c27b0;
        background-color: rgba(156, 39, 176, 0.1);
    }

    .pos-preposition {
        border-bottom: 2px solid #607d8b;
        background-color: rgba(96, 125, 139, 0.1);
    }

    .pos-conjunction {
        border-bottom: 2px solid #795548;
        background-color: rgba(121, 85, 72, 0.1);
    }

    .pos-pronoun {
        border-bottom: 2px solid #e91e63;
        background-color: rgba(233, 30, 99, 0.1);
    }

    .pos-article {
        border-bottom: 2px solid #009688;
        background-color: rgba(0, 150, 136, 0.1);
    }

    /* 综合配置面板 - 全宽横排布局 */
    .comprehensive-config-panel {
        margin: 15px 0;
        width: 100%;
        max-width: none;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 8px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .config-container {
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        gap: 1px;
        background: #dee2e6;
    }

    .config-section {
        flex: 1;
        min-width: 280px;
        padding: 12px;
        background: white;
        min-height: 180px;
    }

    .config-section:first-child {
        border-top-left-radius: 8px;
        border-bottom-left-radius: 8px;
    }

    .config-section:last-child {
        border-top-right-radius: 8px;
        border-bottom-right-radius: 8px;
    }

    /* 响应式布局 */
    @media (min-width: 768px) {
        .config-container {
            flex-wrap: wrap;
        }

        .config-section {
            min-width: 250px;
        }
    }

    /* 在大屏幕上强制横排显示 */
    @media (min-width: 1200px) {
        .config-container {
            flex-wrap: nowrap;
        }

        .config-section {
            min-width: 200px;
            flex: 1 1 0;
        }
    }

    /* 超大屏幕优化 */
    @media (min-width: 1600px) {
        .comprehensive-config-panel {
            margin: 20px 0;
        }

        .config-section {
            padding: 15px;
            min-height: 200px;
        }
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 2px solid #007cba;
    }

    .section-header h4 {
        margin: 0;
        color: #007cba;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        white-space: nowrap;
    }

    .mini-btn {
        padding: 3px 8px;
        font-size: 10px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .mini-btn:hover {
        background: #5a6268;
    }

    /* 词性图例列布局 - 一行一项 */
    .pos-legend-column {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .pos-item-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
        background: white;
        border-radius: 4px;
        border: 1px solid #e9ecef;
        transition: all 0.2s;
    }

    .pos-item-row:hover {
        border-color: #007cba;
        box-shadow: 0 1px 3px rgba(0, 124, 186, 0.2);
    }

    .pos-color-indicator {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        flex-shrink: 0;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .pos-label {
        font-size: 13px;
        font-weight: 500;
        color: #495057;
        flex: 1;
        min-width: 40px;
        max-width: 80px;
    }

    .pos-item-row input[type="color"] {
        width: 24px;
        height: 24px;
        border: 1px solid #ddd;
        border-radius: 3px;
        cursor: pointer;
        flex-shrink: 0;
    }

    .pos-item {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 6px 8px;
        background: white;
        border-radius: 4px;
        border: 1px solid #e9ecef;
        transition: all 0.2s;
        min-width: 0;
    }

    .pos-item:hover {
        border-color: #007cba;
        box-shadow: 0 1px 3px rgba(0, 124, 186, 0.2);
    }

    .pos-color-indicator {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        flex-shrink: 0;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .pos-label {
        font-size: 11px;
        font-weight: 500;
        color: #495057;
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .pos-item input[type="color"] {
        width: 18px;
        height: 18px;
        border: none;
        border-radius: 2px;
        cursor: pointer;
        flex-shrink: 0;
    }

    /* 词汇类型配色网格 */
    .vocab-color-grid {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    /* 在大屏幕上横排显示 */
    @media (min-width: 1200px) {
        .vocab-color-grid {
            flex-direction: row;
            gap: 4px;
        }
    }

    /* 词汇类型配色列布局 */
    .vocab-color-column {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .vocab-color-item-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
        background: white;
        border-radius: 4px;
        border: 1px solid #e9ecef;
        transition: all 0.2s;
    }

    .vocab-color-item-row:hover {
        border-color: #007cba;
        box-shadow: 0 1px 3px rgba(0, 124, 186, 0.2);
    }

    .vocab-color-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: white;
        border-radius: 4px;
        border: 1px solid #e9ecef;
        transition: all 0.2s;
    }

    .vocab-color-item:hover {
        border-color: #007cba;
        box-shadow: 0 1px 3px rgba(0, 124, 186, 0.2);
    }

    .vocab-color-sample {
        flex: 1;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: bold;
        text-align: center;
        color: white;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
        min-width: 60px;
        max-width: 100px;
    }

    .new-word-sample {
        background: linear-gradient(135deg, #f44336, #d32f2f);
    }

    .vocab-word-sample {
        background: linear-gradient(135deg, #2196f3, #1976d2);
    }

    .known-word-sample {
        background: linear-gradient(135deg, #4caf50, #388e3c);
    }

    .vocab-color-item input[type="color"] {
        width: 24px;
        height: 24px;
        border: 1px solid #ccc;
        border-radius: 3px;
        cursor: pointer;
    }

    .vocab-color-item-row input[type="color"] {
        width: 24px;
        height: 24px;
        border: 1px solid #ddd;
        border-radius: 3px;
        cursor: pointer;
        flex-shrink: 0;
    }

    /* 配色预设按钮 */
    .preset-buttons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 4px;
    }

    /* 在大屏幕上单列显示以节省空间 */
    @media (min-width: 1200px) {
        .preset-buttons {
            grid-template-columns: 1fr;
            gap: 3px;
        }
    }

    .preset-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 6px;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 11px;
    }

    .preset-btn:hover {
        border-color: #007cba;
        box-shadow: 0 1px 3px rgba(0, 124, 186, 0.2);
        transform: translateY(-1px);
    }

    .preset-name {
        flex: 1;
        font-weight: 500;
        color: #495057;
    }

    .preset-colors {
        display: flex;
        gap: 2px;
    }

    .preset-colors div {
        width: 8px;
        height: 8px;
        border-radius: 1px;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    /* 响应式调整 */
    @media (max-width: 1200px) {
        .legend-container {
            grid-template-columns: 1fr;
            gap: 1px;
        }

        .legend-section {
            border-right: none;
            border-bottom: 1px solid #dee2e6;
        }

        .legend-section:last-child {
            border-bottom: none;
        }

        .pos-row {
            flex-wrap: wrap;
        }

        .pos-item {
            min-width: calc(50% - 4px);
        }
    }

    .vocab-source-control {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-right: 15px;
        padding: 5px 10px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .vocab-source-control label {
        font-size: 12px;
        font-weight: bold;
        color: #666;
    }

    .vocab-source-control select {
        border: none;
        background: transparent;
        font-size: 12px;
        cursor: pointer;
        outline: none;
    }

    /* 学员配置区域样式 */
    .student-config-controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .student-selector,
    .config-name-input {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .student-selector label,
    .config-name-input label {
        font-size: 12px;
        font-weight: bold;
        color: #666;
        min-width: 80px;
    }

    .student-selector select,
    .config-name-input input {
        flex: 1;
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
    }

    /* 显示设置网格 */
    .display-settings-grid,
    .visual-effects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 8px;
    }

    /* 在横排布局中进一步压缩 */
    @media (min-width: 1200px) {

        .display-settings-grid,
        .visual-effects-grid {
            grid-template-columns: 1fr;
            gap: 4px;
        }
    }

    .setting-group {
        padding: 6px 8px;
        background: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #e9ecef;
        transition: all 0.2s;
    }

    .setting-group:hover {
        border-color: #007cba;
        box-shadow: 0 1px 3px rgba(0, 124, 186, 0.1);
    }

    .setting-label {
        display: flex;
        flex-direction: column;
        gap: 4px;
        cursor: pointer;
    }

    .setting-label input[type="checkbox"] {
        align-self: flex-start;
        margin-bottom: 4px;
    }

    /* 内联标签样式 - 复选框和文本在同一行 */
    .setting-label-inline {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

    .setting-label-inline input[type="checkbox"] {
        margin: 0;
        flex-shrink: 0;
    }

    .setting-label-inline .label-text {
        font-size: 12px;
        font-weight: 500;
        color: #333;
        white-space: nowrap;
    }

    /* 带描述的标签样式 */
    .setting-label-with-desc {
        display: flex;
        flex-direction: column;
        gap: 4px;
        cursor: pointer;
    }

    .setting-control {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .setting-control input[type="checkbox"] {
        margin: 0;
        flex-shrink: 0;
    }

    .setting-control .label-text {
        font-size: 12px;
        font-weight: 500;
        color: #333;
    }

    .setting-label-with-desc .label-desc {
        font-size: 10px;
        color: #666;
        line-height: 1.3;
        margin-left: 20px;
    }

    .label-text {
        font-size: 13px;
        font-weight: 600;
        color: #333;
    }

    .label-desc {
        font-size: 11px;
        color: #666;
        line-height: 1.3;
    }

    .setting-group select {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
        background: white;
    }

    /* 视觉效果控制 */
    .visual-effects-grid .setting-group {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        border-color: #ffb74d;
    }

    .visual-effects-grid .setting-group:hover {
        border-color: #ff9800;
        box-shadow: 0 1px 3px rgba(255, 152, 0, 0.2);
    }

    /* 视觉效果设置网格布局 */
    .visual-effects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
    }

    /* 视觉效果开关样式 */
    .word.no-backgrounds {
        background: transparent !important;
    }

    .word.no-borders {
        border: none !important;
    }

    .word.no-gradients {
        background: #f5f5f5 !important;
    }

    .word.no-shadows {
        box-shadow: none !important;
    }

    /* 组合效果样式 */
    .word.no-backgrounds.no-borders {
        background: transparent !important;
        border: none !important;
    }

    .word.no-backgrounds.vocab-word {
        background: transparent !important;
    }

    .word.no-backgrounds.known-word {
        background: transparent !important;
    }

    .word.no-backgrounds.new-word {
        background: transparent !important;
    }

    .word.no-borders.vocab-word {
        background: #e3f2fd !important;
    }

    .word.no-borders.known-word {
        background: #e8f5e8 !important;
    }

    .word.no-borders.new-word {
        background: #ffebee !important;
    }

    .word.no-gradients.vocab-word {
        background: #e3f2fd !important;
    }

    .word.no-gradients.known-word {
        background: #e8f5e8 !important;
    }

    .word.no-gradients.new-word {
        background: #ffebee !important;
    }

    /* 帮助说明区域 */
    .help-section {
        background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
        border-left: 4px solid #4caf50;
    }

    .help-content {
        max-height: 300px;
        overflow-y: auto;
    }

    .help-item {
        padding: 8px 0;
        border-bottom: 1px solid rgba(76, 175, 80, 0.2);
        font-size: 12px;
        line-height: 1.4;
    }

    .help-item:last-child {
        border-bottom: none;
    }

    .help-item strong {
        color: #2e7d32;
        font-weight: 600;
    }

    .help-details {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 2px solid rgba(76, 175, 80, 0.3);
    }

    .help-details .help-item {
        background: rgba(255, 255, 255, 0.5);
        padding: 6px 10px;
        border-radius: 4px;
        margin-bottom: 4px;
        border-bottom: none;
    }

    /* 词汇详情弹窗 */
    .word-detail-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    }

    .word-detail-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        max-width: 400px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .word-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .word-detail-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
    }

    .word-detail-close {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #666;
    }

    .word-detail-body {
        line-height: 1.6;
    }

    .word-detail-section {
        margin-bottom: 15px;
    }

    .word-detail-label {
        font-weight: bold;
        color: #666;
        margin-bottom: 5px;
    }

    .word-detail-value {
        color: #333;
    }

    /* 词汇统计增强 */
    .vocab-stats-enhanced {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 15px 0;
    }

    .stat-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
    }

    .stat-card-value {
        font-size: 24px;
        font-weight: bold;
        color: #007cba;
        margin-bottom: 5px;
    }

    .stat-card-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
    }

    /* 段落类型样式 */
    .paragraph-title {
        font-size: 1.2em;
        font-weight: bold;
        margin: 1em 0;
        color: #333;
    }

    .paragraph-list_item {
        margin-left: 1em;
        list-style-type: disc;
    }

    .paragraph-quote {
        border-left: 4px solid #ccc;
        padding-left: 1em;
        font-style: italic;
        color: #666;
        margin: 1em 0;
    }

    .paragraph-code {
        background-color: #f5f5f5;
        padding: 1em;
        font-family: 'Courier New', monospace;
        border-radius: 4px;
        overflow-x: auto;
    }

    .paragraph-indented {
        margin-left: 2em;
        color: #555;
    }

    .paragraph-normal {
        margin: 0.5em 0;
    }

    /* 工具提示样式 */
    .word[title]:hover {
        background-color: #fff3cd;
        position: relative;
    }

    /* 词汇交互状态 - 专业优化版 */
    .word-selected {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 70%, #fdcb6e 100%) !important;
        color: #2d3436 !important;
        border: 2px solid #fdcb6e !important;
        box-shadow: 0 0 0 3px rgba(253, 203, 110, 0.3), 0 2px 8px rgba(253, 203, 110, 0.4);
        transform: scale(1.05);
        z-index: 10;
        font-weight: 600;
    }

    /* 同词高亮状态 */
    .word-highlighted {
        background: linear-gradient(135deg, #e8f4fd 0%, #b3e5fc 70%, #81d4fa 100%) !important;
        border: 1px solid #29b6f6 !important;
        color: #01579b !important;
        box-shadow: 0 1px 4px rgba(41, 182, 246, 0.3);
        animation: highlightGlow 2s ease-in-out;
    }

    @keyframes highlightGlow {
        0% {
            box-shadow: 0 1px 4px rgba(41, 182, 246, 0.3);
        }

        50% {
            box-shadow: 0 2px 8px rgba(41, 182, 246, 0.5), 0 0 0 2px rgba(41, 182, 246, 0.2);
        }

        100% {
            box-shadow: 0 1px 4px rgba(41, 182, 246, 0.3);
        }
    }

    /* 鼠标悬停临时高亮 */
    .word-hover-highlight {
        background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 70%, #ce93d8 100%) !important;
        border: 1px solid #ba68c8 !important;
        color: #4a148c !important;
        box-shadow: 0 1px 3px rgba(186, 104, 200, 0.3);
        transform: translateY(-1px);
    }

    /* 增强词汇交互 */
    .word {
        position: relative;
        display: inline;
        transition: all 0.2s ease;
    }

    .word:hover {
        transform: scale(1.05);
        z-index: 10;
    }

    /* 词性标记 - 专业优化版 */
    .pos-noun {
        border-bottom: 2px solid #2196f3;
        background: linear-gradient(to bottom, transparent 70%, rgba(33, 150, 243, 0.1) 100%);
        color: #1565c0;
    }

    .pos-verb {
        border-bottom: 2px solid #4caf50;
        background: linear-gradient(to bottom, transparent 70%, rgba(76, 175, 80, 0.1) 100%);
        color: #2e7d32;
    }

    .pos-adjective {
        border-bottom: 2px solid #ff9800;
        background: linear-gradient(to bottom, transparent 70%, rgba(255, 152, 0, 0.1) 100%);
        color: #ef6c00;
    }

    .pos-adverb {
        border-bottom: 2px solid #9c27b0;
        background: linear-gradient(to bottom, transparent 70%, rgba(156, 39, 176, 0.1) 100%);
        color: #6a1b9a;
    }

    .pos-preposition {
        border-bottom: 2px solid #607d8b;
        background: linear-gradient(to bottom, transparent 70%, rgba(96, 125, 139, 0.1) 100%);
        color: #37474f;
    }

    .pos-conjunction {
        border-bottom: 2px solid #795548;
        background: linear-gradient(to bottom, transparent 70%, rgba(121, 85, 72, 0.1) 100%);
        color: #4e342e;
    }

    .pos-pronoun {
        border-bottom: 2px solid #e91e63;
        background: linear-gradient(to bottom, transparent 70%, rgba(233, 30, 99, 0.1) 100%);
        color: #ad1457;
    }

    .pos-article {
        border-bottom: 2px solid #009688;
        background: linear-gradient(to bottom, transparent 70%, rgba(0, 150, 136, 0.1) 100%);
        color: #00695c;
    }

    /* 生词特殊标记 - 默认无背景 */
    .new-word {
        color: #c62828 !important;
        font-weight: 600;
        border: none;
        background: transparent;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .new-word:hover {
        background: rgba(244, 67, 54, 0.1);
        border-radius: 3px;
    }

    /* 启用背景色时的生词样式 */
    .word:not(.no-backgrounds).new-word {
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 70%, #ef5350 100%);
        border: 1px solid #e53935;
        border-radius: 4px;
        padding: 2px 5px;
        box-shadow: 0 2px 4px rgba(244, 67, 54, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .word:not(.no-backgrounds).new-word:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(244, 67, 54, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        background: linear-gradient(135deg, #ffcdd2 0%, #ef5350 70%, #d32f2f 100%);
    }

    .word:not(.no-backgrounds).new-word:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(244, 67, 54, 0.2);
    }

    /* 生词脉冲动画 - 更加微妙 */
    .highlight-new {
        animation: subtlePulse 4s ease-in-out infinite;
    }

    @keyframes subtlePulse {

        0%,
        100% {
            box-shadow: 0 2px 4px rgba(244, 67, 54, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        50% {
            box-shadow: 0 3px 8px rgba(244, 67, 54, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.3), 0 0 0 2px rgba(244, 67, 54, 0.1);
        }
    }

    /* 词库中的未掌握词汇 - 默认无背景 */
    .highlight-vocab-unknown {
        color: #e65100 !important;
        font-weight: 500;
        border: none;
        background: transparent;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .highlight-vocab-unknown:hover {
        background: rgba(255, 152, 0, 0.1);
        border-radius: 3px;
    }

    /* 启用背景色时的未掌握词汇样式 */
    .word:not(.no-backgrounds).highlight-vocab-unknown {
        background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 70%, #ffc107 100%);
        border: 1px solid #ffa000;
        border-radius: 4px;
        padding: 2px 5px;
        box-shadow: 0 1px 3px rgba(255, 152, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .word:not(.no-backgrounds).highlight-vocab-unknown:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(255, 152, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        background: linear-gradient(135deg, #ffecb3 0%, #ffc107 70%, #ff8f00 100%);
    }

    /* 词汇高亮增强动画 */
    @keyframes wordHighlight {
        0% {
            background-color: transparent;
        }

        50% {
            background-color: #fff3cd;
        }

        100% {
            background-color: transparent;
        }
    }

    .word-flash {
        animation: wordHighlight 1s ease-in-out;
    }

    /* 学生特定词汇样式 */
    .student-known-word {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
        border: 1px solid #28a745 !important;
        color: #155724 !important;
        box-shadow: 0 1px 3px rgba(40, 167, 69, 0.2) !important;
        transition: visibility 0.3s ease, opacity 0.3s ease;
    }

    .student-new-word {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%) !important;
        border: 1px solid #dc3545 !important;
        color: #721c24 !important;
        box-shadow: 0 1px 3px rgba(220, 53, 69, 0.2) !important;
        animation: studentNewWordPulse 2s ease-in-out infinite;
        transition: visibility 0.3s ease, opacity 0.3s ease;
    }

    /* 通用词汇隐藏/显示过渡效果 */
    .known-word,
    .new-word {
        transition: visibility 0.3s ease, opacity 0.3s ease;
    }

    @keyframes studentNewWordPulse {

        0%,
        100% {
            box-shadow: 0 1px 3px rgba(220, 53, 69, 0.2), 0 0 0 0 rgba(220, 53, 69, 0.4);
        }

        50% {
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.3), 0 0 0 3px rgba(220, 53, 69, 0.1);
        }
    }

    /* 高频词标记 */
    .high-frequency {
        background: linear-gradient(45deg, #e8f5e8, #c8e6c9);
        border-radius: 3px;
        padding: 1px 2px;
    }

    /* 段落高亮动画 */
    @keyframes paragraphHighlight {
        0% {
            background-color: #fff3cd;
        }

        100% {
            background-color: transparent;
        }
    }

    .paragraph-highlight {
        animation: paragraphHighlight 2s ease-out;
    }

    /* 词库词边框样式 */
    .vocab-word-bordered {
        border: 2px solid #2196f3 !important;
        border-radius: 4px !important;
        padding: 2px 4px !important;
        box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3) !important;
    }

    /* 词库词可见性样式 */
    .vocab-word-visible {
        display: inline !important;
    }

    /* 熟词可见性样式 */
    .known-word-visible {
        display: inline !important;
    }

    /* 工具提示样式 */
    .word-tooltip {
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        max-width: 200px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        pointer-events: auto;
        cursor: pointer;
    }

    .tooltip-content {
        line-height: 1.4;
    }

    /* 视觉效果样式 */
    .word-with-background {
        background-color: rgba(33, 150, 243, 0.1) !important;
    }

    .word-with-gradient {
        background: linear-gradient(45deg, rgba(33, 150, 243, 0.2), rgba(33, 150, 243, 0.1)) !important;
    }

    .word-with-animation {
        animation: wordPulse 2s infinite;
    }

    .word-with-shadow {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
    }

    /* 动画效果 */
    @keyframes wordPulse {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }

        100% {
            opacity: 1;
        }
    }

    /* 禁用状态的视觉效果 */
    .setting-label input[type="checkbox"]:disabled+.label-text {
        opacity: 0.5;
    }

    .setting-label input[type="checkbox"]:disabled {
        cursor: not-allowed;
    }

    /* 生词红字黄底样式 */
    .new-word-highlighted {
        color: #d32f2f !important;
        /* 红色字体 */
        background-color: #fff3e0 !important;
        /* 浅黄色背景 */
        border: 1px solid #ff9800 !important;
        /* 橙色边框 */
        border-radius: 3px !important;
        padding: 1px 3px !important;
        font-weight: bold !important;
        box-shadow: 0 1px 3px rgba(255, 152, 0, 0.3) !important;
    }

    /* 生词可见性样式 */
    .new-word-visible {
        display: inline !important;
    }
</style>

<script>
    // 全局变量 - 当前选中的学生
    let currentStudent = null;
    
    // 预览页面交互功能
    document.addEventListener('DOMContentLoaded', function () {

        // 模拟学生词汇数据
        const studentVocabData = {
            'student1': {
                name: '张三',
                knownWords: ['the', 'is', 'a', 'to', 'and', 'of', 'in', 'it', 'you', 'that', 'he', 'was', 'for', 'on', 'are', 'as', 'with', 'his', 'they', 'i'],
                newWords: ['sophisticated', 'comprehensive', 'implementation', 'methodology', 'infrastructure', 'optimization', 'configuration', 'authentication', 'authorization', 'encryption']
            },
            'student2': {
                name: '李四',
                knownWords: ['the', 'is', 'a', 'to', 'and', 'of', 'in', 'it', 'you', 'that', 'he', 'was', 'for', 'on', 'are', 'as', 'with', 'his', 'they', 'i', 'at', 'be', 'this', 'have', 'from', 'or', 'one', 'had', 'by', 'word'],
                newWords: ['algorithm', 'database', 'framework', 'architecture', 'deployment', 'scalability', 'performance', 'security', 'integration', 'validation']
            },
            'student3': {
                name: '王五',
                knownWords: ['the', 'is', 'a', 'to', 'and', 'of', 'in', 'it', 'you', 'that', 'he', 'was', 'for', 'on', 'are', 'as', 'with', 'his', 'they', 'i', 'at', 'be', 'this', 'have', 'from', 'or', 'one', 'had', 'by', 'word', 'but', 'not', 'what', 'all', 'were', 'we', 'when', 'your', 'can', 'said'],
                newWords: ['paradigm', 'synchronization', 'polymorphism', 'encapsulation', 'abstraction', 'inheritance', 'interface', 'protocol', 'middleware', 'repository']
            },
            'student4': {
                name: '赵六',
                knownWords: ['the', 'is', 'a', 'to', 'and', 'of', 'in', 'it', 'you', 'that', 'he', 'was', 'for', 'on', 'are', 'as', 'with', 'his', 'they', 'i', 'at', 'be', 'this', 'have', 'from', 'or', 'one', 'had', 'by', 'word', 'but', 'not', 'what', 'all', 'were', 'we', 'when', 'your', 'can', 'said', 'there', 'each', 'which', 'she', 'do', 'how', 'their', 'if', 'will', 'up'],
                newWords: ['microservices', 'containerization', 'orchestration', 'virtualization', 'distributed', 'concurrent', 'asynchronous', 'reactive', 'functional', 'declarative']
            }
        };

        // 模式切换
        const highlightModeBtn = document.getElementById('highlight-mode-btn');
        const textModeBtn = document.getElementById('text-mode-btn');
        const articleContent = document.getElementById('article-content');
        const textContent = document.getElementById('text-content');

        // 高亮模式按钮
        highlightModeBtn.addEventListener('click', function () {
            this.classList.add('active');
            this.classList.remove('btn-secondary');
            this.classList.add('btn-primary');

            textModeBtn.classList.remove('active');
            textModeBtn.classList.remove('btn-primary');
            textModeBtn.classList.add('btn-secondary');

            articleContent.style.display = 'block';
            textContent.style.display = 'none';
        });

        // 文本模式按钮
        textModeBtn.addEventListener('click', function () {
            this.classList.add('active');
            this.classList.remove('btn-secondary');
            this.classList.add('btn-primary');

            highlightModeBtn.classList.remove('active');
            highlightModeBtn.classList.remove('btn-primary');
            highlightModeBtn.classList.add('btn-secondary');

            articleContent.style.display = 'none';
            textContent.style.display = 'block';

            // 清除可能重复的内容并重新生成
            clearAndRegenerateTextContent();
        });

        // 段落导航点击事件 - 优化版
        function initParagraphNavigation() {
            const paragraphItems = document.querySelectorAll('.paragraph-item');

            if (paragraphItems.length === 0) {
                console.warn('未找到段落导航项');
                return;
            }

            paragraphItems.forEach(function (item, index) {
                item.addEventListener('click', function () {
                    // 移除其他段落的激活状态
                    paragraphItems.forEach(p => p.classList.remove('active'));
                    // 激活当前段落
                    this.classList.add('active');

                    const paragraphId = this.getAttribute('data-paragraph-id');

                    // 高亮对应段落
                    if (articleContent.style.display !== 'none') {
                        // 高亮模式：查找对应段落
                        let targetParagraph = articleContent.querySelector(`[data-paragraph-id="${paragraphId}"]`);

                        // 如果没找到，尝试通过段落顺序查找
                        if (!targetParagraph) {
                            const allParagraphs = articleContent.querySelectorAll('p, h1, h2, h3, h4, h5, h6, div, li, blockquote, pre');
                            const index = parseInt(paragraphId) - 1;
                            if (index >= 0 && index < allParagraphs.length) {
                                targetParagraph = allParagraphs[index];
                            }
                        }

                        if (targetParagraph) {
                            targetParagraph.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // 临时高亮
                            const originalBackground = targetParagraph.style.background;
                            targetParagraph.style.background = '#fff3cd';
                            targetParagraph.style.transition = 'background-color 0.3s';
                            setTimeout(() => {
                                targetParagraph.style.background = originalBackground;
                            }, 2000);
                        }
                    } else {
                        // 文本模式：高亮对应段落
                        document.querySelectorAll('.text-paragraph').forEach(p => p.classList.remove('highlighted'));
                        const targetTextParagraph = textContent.querySelector(`[data-paragraph-id="${paragraphId}"]`);
                        if (targetTextParagraph) {
                            targetTextParagraph.classList.add('highlighted');
                            targetTextParagraph.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                });
            });

            console.log(`段落导航初始化完成，共 ${paragraphItems.length} 个段落`);
        }

        // 清除并重新生成文本内容
        function clearAndRegenerateTextContent() {
            const textContent = document.getElementById('text-content');
            if (!textContent) {
                console.error('未找到text-content元素');
                return;
            }
            
            // 检查是否已经有内容，如果有则不需要重新生成
            const existingParagraphs = textContent.querySelectorAll('.text-paragraph');
            if (existingParagraphs.length > 0) {
                console.log('文本内容已存在，无需重新生成');
                return;
            }
            
            console.log('文本模式已激活，显示原始文本内容');
        }

        // 初始化段落导航
        initParagraphNavigation();

        // 初始化学员列表和词库数据
        initializeStudentData();

        // 恢复用户设置
        restoreUserSettings();

        // 显示选项控制
        const showPosCheckbox = document.getElementById('show-pos');
        const showVocabCheckbox = document.getElementById('show-vocab');
        const showKnownCheckbox = document.getElementById('show-known');
        const showTooltipsCheckbox = document.getElementById('show-tooltips');

        // 词性显示控制
        if (showPosCheckbox) {
            showPosCheckbox.addEventListener('change', function () {
                const posElements = articleContent.querySelectorAll('[class*="pos-"]');
                posElements.forEach(function (el) {
                    if (this.checked) {
                        el.style.borderBottom = '';
                    } else {
                        el.style.borderBottom = 'none';
                    }
                }.bind(this));
            });
        }

        // 词库词显示控制
        if (showVocabCheckbox) {
            showVocabCheckbox.addEventListener('change', function () {
                const vocabElements = articleContent.querySelectorAll('.vocab-word');
                vocabElements.forEach(function (el) {
                    if (this.checked) {
                        el.style.backgroundColor = '#e3f2fd';
                    } else {
                        el.style.backgroundColor = 'transparent';
                    }
                }.bind(this));
            });
        }

        // 熟词显示控制 - 修改为显示/隐藏功能
        if (showKnownCheckbox) {
            showKnownCheckbox.addEventListener('change', function () {
                const knownElements = articleContent.querySelectorAll('.known-word, .student-known-word');
                knownElements.forEach(function (el) {
                    if (this.checked) {
                        el.style.visibility = 'visible';
                        el.style.opacity = '1';
                    } else {
                        el.style.visibility = 'hidden';
                        el.style.opacity = '0';
                    }
                }.bind(this));
            });
        }

        // 生词显示控制 - 修改为显示/隐藏功能，并添加红字黄底效果
        const showNewWordsCheckbox = document.getElementById('show-new-words');
        if (showNewWordsCheckbox) {
            showNewWordsCheckbox.addEventListener('change', function () {
                const newWordElements = articleContent.querySelectorAll('.new-word, .student-new-word');
                newWordElements.forEach(function (el) {
                    if (this.checked) {
                        el.style.visibility = 'visible';
                        el.style.opacity = '1';
                        // 添加红字黄底样式
                        el.classList.add('new-word-highlighted');
                        el.classList.add('new-word-visible');
                    } else {
                        el.style.visibility = 'hidden';
                        el.style.opacity = '0';
                        // 移除红字黄底样式
                        el.classList.remove('new-word-highlighted');
                        el.classList.remove('new-word-visible');
                    }
                }.bind(this));
            });
        }

        // 视觉效果控制

        const enableBackgroundsCheckbox = document.getElementById('enable-backgrounds');
        if (enableBackgroundsCheckbox) {
            enableBackgroundsCheckbox.addEventListener('change', function () {
                const wordElements = articleContent.querySelectorAll('.word');
                wordElements.forEach(function (el) {
                    if (this.checked) {
                        // 恢复原始背景色
                        el.style.background = '';
                    } else {
                        // 移除背景色
                        el.style.background = 'transparent';
                    }
                }.bind(this));
            });
        }

        const enableBordersCheckbox = document.getElementById('enable-borders');
        if (enableBordersCheckbox) {
            enableBordersCheckbox.addEventListener('change', function () {
                const words = articleContent.querySelectorAll('.word');
                words.forEach(function (word) {
                    if (this.checked) {
                        word.classList.remove('no-borders');
                    } else {
                        word.classList.add('no-borders');
                    }
                }.bind(this));
            });
        }

        const enableGradientsCheckbox = document.getElementById('enable-gradients');
        if (enableGradientsCheckbox) {
            enableGradientsCheckbox.addEventListener('change', function () {
                const words = articleContent.querySelectorAll('.word');
                words.forEach(function (word) {
                    if (this.checked) {
                        word.classList.remove('no-gradients');
                    } else {
                        word.classList.add('no-gradients');
                    }
                }.bind(this));
            });
        }

        const enableAnimationsCheckbox = document.getElementById('enable-animations');
        if (enableAnimationsCheckbox) {
            enableAnimationsCheckbox.addEventListener('change', function () {
                const animatedWords = articleContent.querySelectorAll('.highlight-new');
                animatedWords.forEach(function (word) {
                    if (this.checked) {
                        word.style.animationPlayState = 'running';
                    } else {
                        word.style.animationPlayState = 'paused';
                    }
                }.bind(this));
            });
        }

        const enableShadowsCheckbox = document.getElementById('enable-shadows');
        if (enableShadowsCheckbox) {
            enableShadowsCheckbox.addEventListener('change', function () {
                const words = articleContent.querySelectorAll('.word');
                words.forEach(function (word) {
                    if (this.checked) {
                        word.classList.remove('no-shadows');
                    } else {
                        word.classList.add('no-shadows');
                    }
                }.bind(this));
            });
        }

        // 工具提示控制
        if (showTooltipsCheckbox) {
            showTooltipsCheckbox.addEventListener('change', function () {
                const wordElements = articleContent.querySelectorAll('.word[title]');
                wordElements.forEach(function (el) {
                    if (this.checked) {
                        el.style.cursor = 'pointer';
                    } else {
                        el.style.cursor = 'default';
                        el.removeAttribute('title');
                    }
                }.bind(this));
            });
        }

        // 背景色控制
        const enableBackgroundColorsCheckbox = document.getElementById('enable-background-colors');
        if (enableBackgroundColorsCheckbox) {
            enableBackgroundColorsCheckbox.addEventListener('change', function () {
                const wordElements = articleContent.querySelectorAll('.word');
                wordElements.forEach(function (el) {
                    if (this.checked) {
                        // 恢复原始背景色
                        el.style.background = '';
                    } else {
                        // 移除背景色
                        el.style.background = 'transparent';
                    }
                }.bind(this));
            });
        }

        // 词汇点击事件 - 增强版
        document.querySelectorAll('.word').forEach(function (word) {
            word.addEventListener('click', function () {
                // 高亮点击的词汇
                document.querySelectorAll('.word').forEach(w => w.classList.remove('word-selected'));
                this.classList.add('word-selected');

                // 高亮所有相同的词汇
                const wordText = this.textContent.trim().toLowerCase();
                document.querySelectorAll('.word').forEach(function (w) {
                    if (w.textContent.trim().toLowerCase() === wordText) {
                        w.classList.add('word-highlighted');
                        // 添加闪烁效果
                        w.classList.add('word-flash');
                        setTimeout(() => w.classList.remove('word-flash'), 1000);
                    } else {
                        w.classList.remove('word-highlighted');
                    }
                });

                // 显示词汇详情（可以扩展为弹窗）
                console.log('Clicked word:', this.textContent, 'POS:', this.className);

                // 显示词汇统计信息
                showWordDetail(this);
            });

            // 双击显示详细信息
            word.addEventListener('dblclick', function () {
                const wordText = this.textContent.trim();
                const wordClasses = this.className;
                const title = this.getAttribute('title') || '';

                // 显示详细弹窗
                showWordDetail(this);
            });

            // 右键菜单
            word.addEventListener('contextmenu', function (e) {
                e.preventDefault();
                showWordContextMenu(this, e);
            });

            // 鼠标悬停高亮相同词汇
            word.addEventListener('mouseenter', function () {
                const wordText = this.textContent.trim().toLowerCase();
                document.querySelectorAll('.word').forEach(function (w) {
                    if (w.textContent.trim().toLowerCase() === wordText) {
                        w.classList.add('word-hover-highlight');
                    }
                });
            });

            word.addEventListener('mouseleave', function () {
                document.querySelectorAll('.word').forEach(function (w) {
                    w.classList.remove('word-hover-highlight');
                });
            });
        });

        // 词汇详情显示函数
        function showWordDetail(wordElement) {
            const wordText = wordElement.textContent.trim();
            const wordClasses = wordElement.className;
            const pos = wordClasses.match(/pos-(\w+)/) ? wordClasses.match(/pos-(\w+)/)[1] : 'unknown';
            const isVocab = wordClasses.includes('vocab-word');
            const isKnown = wordClasses.includes('known-word');
            const isNewWord = wordClasses.includes('new-word');
            const definition = wordElement.getAttribute('data-definition') || '';
            const pronunciation = wordElement.getAttribute('data-pronunciation') || '';

            // 词性中文映射
            const posMapping = {
                'noun': '名词', 'verb': '动词', 'adjective': '形容词',
                'adverb': '副词', 'preposition': '介词', 'conjunction': '连词',
                'pronoun': '代词', 'article': '冠词', 'numeral': '数词',
                'interjection': '感叹词', 'unknown': '未知'
            };

            // 统计相同词汇出现次数
            const allWords = document.querySelectorAll('.word');
            const sameWords = Array.from(allWords).filter(w => w.textContent.trim().toLowerCase() === wordText.toLowerCase());

            // 填充词汇详情弹窗
            const modal = document.getElementById('word-detail-modal');
            const title = document.getElementById('word-detail-title');
            const body = document.getElementById('word-detail-body');

            title.textContent = wordText;

            let statusText = '普通词汇';
            let statusColor = '#666';
            if (isNewWord) {
                statusText = '生词';
                statusColor = '#f44336';
            } else if (isKnown) {
                statusText = '熟词';
                statusColor = '#4caf50';
            } else if (isVocab) {
                statusText = '词库词';
                statusColor = '#2196f3';
            }

            body.innerHTML = `
            <div class="word-detail-section">
                <div class="word-detail-label">单词:</div>
                <div class="word-detail-value" style="font-size: 18px; font-weight: bold;">${wordText}</div>
            </div>
            <div class="word-detail-section">
                <div class="word-detail-label">词性:</div>
                <div class="word-detail-value">${posMapping[pos] || pos}</div>
            </div>
            <div class="word-detail-section">
                <div class="word-detail-label">状态:</div>
                <div class="word-detail-value" style="color: ${statusColor}; font-weight: bold;">${statusText}</div>
            </div>
            ${definition ? `
            <div class="word-detail-section">
                <div class="word-detail-label">释义:</div>
                <div class="word-detail-value">${definition}</div>
            </div>
            ` : ''}
            ${pronunciation ? `
            <div class="word-detail-section">
                <div class="word-detail-label">音标:</div>
                <div class="word-detail-value">${pronunciation}</div>
            </div>
            ` : ''}
            <div class="word-detail-section">
                <div class="word-detail-label">出现次数:</div>
                <div class="word-detail-value">${sameWords.length} 次</div>
            </div>
        `;

            // 显示弹窗
            modal.style.display = 'flex';
        }

        // 关闭词汇详情弹窗 - 全局函数
        window.closeWordDetail = function () {
            const modal = document.getElementById('word-detail-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        };

        // 显示词汇右键菜单
        function showWordContextMenu(wordElement, event) {
            console.log('右键菜单:', wordElement.textContent);
            // 这里可以实现自定义右键菜单
        }

        // 显示词性图例 - 全局函数
        window.showPOSLegend = function () {
            const legend = document.getElementById('pos-legend');
            if (legend) {
                legend.style.display = legend.style.display === 'none' ? 'flex' : 'none';
            }
        };

        // 导出分析结果 - 全局函数
        window.exportAnalysis = function () {
            const stats = {
                totalWords: document.querySelectorAll('.word').length,
                vocabWords: document.querySelectorAll('.vocab-word').length,
                knownWords: document.querySelectorAll('.known-word').length,
                posStats: {}
            };

            // 统计各词性数量
            const posClasses = ['noun', 'verb', 'adjective', 'adverb', 'preposition', 'conjunction', 'pronoun', 'article'];
            posClasses.forEach(pos => {
                stats.posStats[pos] = document.querySelectorAll(`.pos-${pos}`).length;
            });

            // 创建下载链接
            const dataStr = JSON.stringify(stats, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'article_analysis.json';
            link.click();
            URL.revokeObjectURL(url);

            console.log('分析结果已导出:', stats);
        };

        // 刷新高亮显示 - 全局函数
        window.refreshHighlighting = function () {
            // 重新应用所有高亮样式
            const words = document.querySelectorAll('.word');
            words.forEach(function (word) {
                // 移除所有临时高亮
                word.classList.remove('word-selected', 'word-highlighted', 'word-hover-highlight');
            });

            // 重新检查显示选项
            const showPosCheckbox = document.getElementById('show-pos');
            const showVocabCheckbox = document.getElementById('show-vocab');
            const showKnownCheckbox = document.getElementById('show-known');
            const showNewWordsCheckbox = document.getElementById('show-new-words');

            if (showPosCheckbox) showPosCheckbox.dispatchEvent(new Event('change'));
            if (showVocabCheckbox) showVocabCheckbox.dispatchEvent(new Event('change'));
            if (showKnownCheckbox) showKnownCheckbox.dispatchEvent(new Event('change'));
            if (showNewWordsCheckbox) showNewWordsCheckbox.dispatchEvent(new Event('change'));

            console.log('高亮显示已刷新');
        };

        // 更新词性颜色 - 全局函数
        window.updatePOSColor = function (pos, color) {
            // 查找或创建样式元素
            let style = document.getElementById(`pos-style-${pos}`);
            if (!style) {
                style = document.createElement('style');
                style.id = `pos-style-${pos}`;
                document.head.appendChild(style);
            }
            
            // 更新CSS变量或直接修改样式
            style.textContent = `
            .pos-${pos} { 
                border-bottom: 2px solid ${color} !important; 
                background-color: ${color}1a !important;
                color: ${color} !important;
            }
        `;

            // 更新图例颜色指示器
            const posLegend = document.getElementById('pos-legend');
            if (posLegend) {
                const posItemRow = posLegend.querySelector(`[data-pos="${pos}"]`);
                if (posItemRow) {
                    const colorIndicator = posItemRow.querySelector('.pos-color-indicator');
                    if (colorIndicator) {
                        colorIndicator.style.background = color;
                    }
                }
            }

            console.log(`${pos} 颜色已更新为: ${color}`);
        };

        // 更新词汇类型颜色 - 全局函数
        window.updateVocabColor = function (type, color) {
            // 查找或创建样式元素
            let style = document.getElementById(`vocab-style-${type}`);
            if (!style) {
                style = document.createElement('style');
                style.id = `vocab-style-${type}`;
                document.head.appendChild(style);
            }
            
            let cssRule = '';

            switch (type) {
                case 'new-word':
                    cssRule = `
                    .new-word { 
                        background: linear-gradient(45deg, ${color}33, ${color}66) !important;
                        border: 1px solid ${color} !important;
                        color: ${color} !important;
                    }
                `;
                    break;
                case 'vocab-word':
                    cssRule = `
                    .vocab-word { 
                        background-color: ${color}33 !important;
                        border: 1px solid ${color}66 !important;
                    }
                `;
                    break;
                case 'known-word':
                    cssRule = `
                    .known-word { 
                        background-color: ${color}33 !important;
                        border: 1px solid ${color}66 !important;
                    }
                `;
                    break;
            }

            style.textContent = cssRule;

            // 更新词汇类型颜色样本
            const vocabLegend = document.getElementById('pos-legend');
            if (vocabLegend) {
                const vocabSection = vocabLegend.querySelector('.vocab-section');
                if (vocabSection) {
                    const colorSample = vocabSection.querySelector(`.${type}-sample`);
                    if (colorSample) {
                        colorSample.style.background = color;
                        colorSample.style.borderColor = color;
                    }
                }
            }

            console.log(`${type} 颜色已更新为: ${color}`);
        };

        // 应用配色预设 - 全局函数
        window.applyColorPreset = function (preset) {
            const presets = {
                'default': {
                    pos: {
                        noun: '#2196f3', verb: '#4caf50', adjective: '#ff9800', adverb: '#9c27b0',
                        preposition: '#607d8b', conjunction: '#795548', pronoun: '#e91e63', article: '#009688'
                    },
                    vocab: { 'new-word': '#f44336', 'vocab-word': '#2196f3', 'known-word': '#4caf50' }
                },
                'colorblind': {
                    pos: {
                        noun: '#0173b2', verb: '#de8f05', adjective: '#cc78bc', adverb: '#029e73',
                        preposition: '#d55e00', conjunction: '#fbafe4', pronoun: '#949494', article: '#ece133'
                    },
                    vocab: { 'new-word': '#d55e00', 'vocab-word': '#0173b2', 'known-word': '#029e73' }
                },
                'dark': {
                    pos: {
                        noun: '#64b5f6', verb: '#81c784', adjective: '#ffb74d', adverb: '#ba68c8',
                        preposition: '#90a4ae', conjunction: '#a1887f', pronoun: '#f06292', article: '#4db6ac'
                    },
                    vocab: { 'new-word': '#ef5350', 'vocab-word': '#42a5f5', 'known-word': '#66bb6a' }
                },
                'pastel': {
                    pos: {
                        noun: '#bbdefb', verb: '#c8e6c9', adjective: '#ffe0b2', adverb: '#e1bee7',
                        preposition: '#cfd8dc', conjunction: '#d7ccc8', pronoun: '#f8bbd9', article: '#b2dfdb'
                    },
                    vocab: { 'new-word': '#ffcdd2', 'vocab-word': '#bbdefb', 'known-word': '#c8e6c9' }
                }
            };

            const selectedPreset = presets[preset];
            if (!selectedPreset) return;

            // 应用词性颜色
            Object.entries(selectedPreset.pos).forEach(([pos, color]) => {
                // 查找对应的颜色选择器并更新
                const posLegend = document.getElementById('pos-legend');
                if (posLegend) {
                    const posItemRow = posLegend.querySelector(`[data-pos="${pos}"]`);
                    if (posItemRow) {
                        const colorPicker = posItemRow.querySelector('input[type="color"]');
                        if (colorPicker) {
                            colorPicker.value = color;
                            updatePOSColor(pos, color);
                        }
                    }
                }
            });

            // 应用词汇类型颜色
            Object.entries(selectedPreset.vocab).forEach(([type, color]) => {
                // 查找对应的颜色选择器并更新
                const vocabLegend = document.getElementById('pos-legend');
                if (vocabLegend) {
                    const vocabSection = vocabLegend.querySelector('.vocab-section');
                    if (vocabSection) {
                        const vocabItemRow = vocabSection.querySelector(`.${type}-sample`).closest('.vocab-color-item-row');
                        if (vocabItemRow) {
                            const colorPicker = vocabItemRow.querySelector('input[type="color"]');
                            if (colorPicker) {
                                colorPicker.value = color;
                                updateVocabColor(type, color);
                            }
                        }
                    }
                }
            });

            console.log(`已应用 ${preset} 配色预设`);
        };

        // 切换词库来源 - 全局函数
        window.switchVocabularySource = function (source) {
            // 显示加载状态
            const articleContent = document.getElementById('article-content');
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'vocab-loading-overlay';
            loadingOverlay.innerHTML = `
            <div style="text-align: center; padding: 50px; font-size: 16px; color: #666;">
                <div style="margin-bottom: 15px;">正在切换词库来源...</div>
                <div style="font-size: 12px; color: #999;">请稍候，正在重新解析文章</div>
            </div>
        `;
            loadingOverlay.style.cssText = 'position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center;';
            articleContent.style.position = 'relative';
            articleContent.appendChild(loadingOverlay);

            // 禁用词库选择器
            const vocabSelect = document.getElementById('vocab-source-select');
            if (vocabSelect) {
                vocabSelect.disabled = true;
            }

            // 发送AJAX请求切换词库
            fetch(`/admin/article_factory/article/{{ article.pk }}/switch_vocabulary/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    vocabulary_source: source
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // 显示成功消息
                        loadingOverlay.innerHTML = `
                    <div style="text-align: center; padding: 50px; font-size: 16px; color: #4caf50;">
                        <div style="margin-bottom: 15px;">✓ 词库切换成功</div>
                        <div style="font-size: 12px; color: #666;">正在刷新页面...</div>
                    </div>
                `;

                        // 延迟刷新页面
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        throw new Error(data.error || '切换失败');
                    }
                })
                .catch(error => {
                    console.error('切换词库时出错:', error);

                    // 显示错误消息
                    loadingOverlay.innerHTML = `
                <div style="text-align: center; padding: 50px; font-size: 16px; color: #f44336;">
                    <div style="margin-bottom: 15px;">✗ 切换失败</div>
                    <div style="font-size: 12px; color: #666;">${error.message}</div>
                    <button onclick="document.getElementById('vocab-loading-overlay').remove(); document.getElementById('vocab-source-select').disabled = false;" 
                            style="margin-top: 15px; padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        关闭
                    </button>
                </div>
            `;
                });

            console.log(`正在切换到词库: ${source}`);
        };

        // 切换当前学生 - 全局函数
        window.switchCurrentStudent = function (studentId) {
            console.log('切换学生:', studentId);

            currentStudent = studentId;
            const statusElement = document.getElementById('student-status');
            const knownWordsDesc = document.getElementById('known-words-desc');
            const newWordsDesc = document.getElementById('new-words-desc');
            const selectElement = document.getElementById('current-student-select');

            if (studentId && studentId !== '') {
                const selectedOption = selectElement.querySelector(`option[value="${studentId}"]`);
                const studentName = selectedOption ? selectedOption.textContent : '未知学生';
                const englishLevel = selectedOption ? selectedOption.dataset.englishLevel : '';
                const gradeLevel = selectedOption ? selectedOption.dataset.gradeLevel : '';

                // 更新状态显示
                let statusText = `当前学生: ${studentName}`;
                if (englishLevel || gradeLevel) {
                    const levelInfo = [];
                    if (gradeLevel) levelInfo.push(`${gradeLevel}年级`);
                    if (englishLevel) levelInfo.push(`英语水平: ${englishLevel}`);
                    statusText += ` (${levelInfo.join(', ')})`;
                }

                statusElement.textContent = statusText;
                statusElement.className = 'student-status selected';

                // 更新描述文本
                if (knownWordsDesc) {
                    knownWordsDesc.textContent = `显示 ${studentName} 已掌握的熟词`;
                }
                if (newWordsDesc) {
                    newWordsDesc.textContent = `显示 ${studentName} 需要学习的生词（红字黄底样式）`;
                }

                // 启用相关的复选框
                const showKnownCheckbox = document.getElementById('show-known');
                const showNewWordsCheckbox = document.getElementById('show-new-words');
                if (showKnownCheckbox) showKnownCheckbox.disabled = false;
                if (showNewWordsCheckbox) showNewWordsCheckbox.disabled = false;

                // 计算并显示生词率
                calculateNewWordRate(studentId);

                // 重新应用词汇标记（如果有旧的数据）
                if (typeof updateWordHighlighting === 'function') {
                    updateWordHighlighting();
                }

                console.log(`已切换到学生: ${studentName} (ID: ${studentId})`);
            } else {
                // 未选择学生
                statusElement.textContent = '请选择学生以显示个性化词汇标记';
                statusElement.className = 'student-status';

                // 恢复默认描述
                if (knownWordsDesc) {
                    knownWordsDesc.textContent = '显示当前学生已掌握的熟词（需选择学生）';
                }
                if (newWordsDesc) {
                    newWordsDesc.textContent = '显示当前学生需要学习的生词（需选择学生）';
                }

                // 清除生词率显示
                calculateNewWordRate(null);

                // 清除个性化标记
                clearPersonalizedHighlighting();
            }
        };

        // 更新词汇高亮
        function updateWordHighlighting() {
            if (!currentStudent || !studentVocabData[currentStudent]) return;

            const studentData = studentVocabData[currentStudent];
            const words = document.querySelectorAll('.word');

            words.forEach(word => {
                const wordText = word.textContent.trim().toLowerCase();

                // 移除之前的学生特定样式
                word.classList.remove('student-known-word', 'student-new-word');

                // 添加学生特定样式
                if (studentData.knownWords.includes(wordText)) {
                    word.classList.add('student-known-word');
                } else if (studentData.newWords.includes(wordText)) {
                    word.classList.add('student-new-word');
                }
            });

            console.log(`已为学生 ${studentData.name} 更新词汇高亮`);
        }

        // 清除个性化高亮
        function clearPersonalizedHighlighting() {
            const words = document.querySelectorAll('.word');
            words.forEach(word => {
                word.classList.remove('student-known-word', 'student-new-word');
            });
        }

        // 计算并显示生词率
        function calculateNewWordRate(studentId) {
            const newWordRateItem = document.getElementById('new-word-rate-item');
            const newWordRateValue = document.getElementById('new-word-rate-value');
            const newWordRatePercentage = document.getElementById('new-word-rate-percentage');
            
            if (!newWordRateItem || !newWordRateValue || !newWordRatePercentage) {
                console.warn('生词率显示元素未找到');
                return;
            }
            
            if (!studentId) {
                // 清除生词率显示
                newWordRateItem.style.display = 'none';
                newWordRateValue.textContent = '--';
                newWordRatePercentage.textContent = '(--)';
                return;
            }
            
            // 获取当前学生的词汇数据
            const studentData = studentVocabData[studentId];
            if (!studentData) {
                console.warn('未找到学生词汇数据:', studentId);
                newWordRateItem.style.display = 'none';
                return;
            }
            
            // 计算文章中的总词数和生词数
            const allWords = document.querySelectorAll('.word');
            let totalWords = 0;
            let newWords = 0;
            
            allWords.forEach(word => {
                const wordText = word.textContent.trim().toLowerCase();
                if (wordText) {
                    totalWords++;
                    // 检查是否为生词（在词库中但不在学生熟词列表中）
                    if (studentData.newWords.includes(wordText)) {
                        newWords++;
                    }
                }
            });
            
            // 计算生词率
            const newWordRate = totalWords > 0 ? ((newWords / totalWords) * 100).toFixed(1) : 0;
            
            // 显示生词率
            newWordRateItem.style.display = 'block';
            newWordRateValue.textContent = newWords;
            newWordRatePercentage.textContent = `(${newWordRate}%)`;
            
            console.log(`学生 ${studentId} 的生词率: ${newWords}/${totalWords} (${newWordRate}%)`);
        }

        // 重置词性颜色 - 全局函数
        window.resetPOSColors = function () {
            const defaultColors = {
                noun: '#2196f3', verb: '#4caf50', adjective: '#ff9800', adverb: '#9c27b0',
                preposition: '#607d8b', conjunction: '#795548', pronoun: '#e91e63', article: '#009688'
            };

            Object.entries(defaultColors).forEach(([pos, color]) => {
                const colorPicker = document.querySelector(`[data-pos="${pos}"] input[type="color"]`);
                const indicator = document.querySelector(`[data-pos="${pos}"] .pos-color-indicator`);
                if (colorPicker && indicator) {
                    colorPicker.value = color;
                    indicator.style.background = color;
                    updatePOSColor(pos, color);
                }
            });

            console.log('词性颜色已重置为默认值');
        };

        // 重置词汇类型颜色 - 全局函数
        window.resetVocabColors = function () {
            const defaultColors = {
                'new-word': '#f44336',
                'vocab-word': '#2196f3',
                'known-word': '#4caf50'
            };

            Object.entries(defaultColors).forEach(([type, color]) => {
                const colorPicker = document.getElementById(`${type}-color`);
                if (colorPicker) {
                    colorPicker.value = color;
                    updateVocabColor(type, color);
                }
            });

            console.log('词汇类型颜色已重置为默认值');
        };

        // 学员配色方案管理
        window.saveStudentConfig = function () {
            const studentId = document.getElementById('student-select').value;
            const configName = document.getElementById('config-name').value;

            if (!configName) {
                alert('请输入配置名称');
                return;
            }

            // 收集当前配置
            const config = {
                name: configName,
                studentId: studentId,
                posColors: {},
                vocabColors: {},
                displaySettings: {},
                visualEffects: {}
            };

            // 收集词性颜色
            document.querySelectorAll('[data-pos]').forEach(item => {
                const pos = item.getAttribute('data-pos');
                const colorInput = item.querySelector('input[type="color"]');
                if (colorInput) {
                    config.posColors[pos] = colorInput.value;
                }
            });

            // 收集词汇类型颜色
            ['new-word', 'vocab-word', 'known-word'].forEach(type => {
                const colorInput = document.getElementById(`${type}-color`);
                if (colorInput) {
                    config.vocabColors[type] = colorInput.value;
                }
            });

            // 收集显示设置
            ['show-pos', 'show-vocab', 'show-known', 'show-new-words', 'show-tooltips'].forEach(setting => {
                const checkbox = document.getElementById(setting);
                if (checkbox) {
                    config.displaySettings[setting] = checkbox.checked;
                }
            });

            // 收集视觉效果设置
            ['enable-backgrounds', 'enable-borders', 'enable-gradients', 'enable-animations', 'enable-shadows'].forEach(effect => {
                const checkbox = document.getElementById(effect);
                if (checkbox) {
                    config.visualEffects[effect] = checkbox.checked;
                }
            });

            // 保存到localStorage（实际项目中应该保存到服务器）
            const savedConfigs = JSON.parse(localStorage.getItem('studentColorConfigs') || '{}');
            const configKey = studentId ? `student_${studentId}` : 'default';
            if (!savedConfigs[configKey]) {
                savedConfigs[configKey] = [];
            }
            savedConfigs[configKey].push(config);
            localStorage.setItem('studentColorConfigs', JSON.stringify(savedConfigs));

            alert(`配置 "${configName}" 已保存`);
            console.log('保存的配置:', config);
        };

        window.loadStudentConfig = function () {
            const studentId = document.getElementById('student-select').value;
            const configKey = studentId ? `student_${studentId}` : 'default';

            const savedConfigs = JSON.parse(localStorage.getItem('studentColorConfigs') || '{}');
            const configs = savedConfigs[configKey] || [];

            if (configs.length === 0) {
                alert('该学员没有保存的配置');
                return;
            }

            // 显示配置选择对话框（简化版）
            const configNames = configs.map((config, index) => `${index + 1}. ${config.name}`).join('\n');
            const selection = prompt(`选择要加载的配置:\n${configNames}\n\n请输入序号:`);

            if (selection && !isNaN(selection)) {
                const configIndex = parseInt(selection) - 1;
                if (configIndex >= 0 && configIndex < configs.length) {
                    applyStudentConfig(configs[configIndex]);
                }
            }
        };

        function applyStudentConfig(config) {
            // 应用词性颜色
            Object.entries(config.posColors || {}).forEach(([pos, color]) => {
                const colorInput = document.querySelector(`[data-pos="${pos}"] input[type="color"]`);
                if (colorInput) {
                    colorInput.value = color;
                    updatePOSColor(pos, color);
                }
            });

            // 应用词汇类型颜色
            Object.entries(config.vocabColors || {}).forEach(([type, color]) => {
                const colorInput = document.getElementById(`${type}-color`);
                if (colorInput) {
                    colorInput.value = color;
                    updateVocabColor(type, color);
                }
            });

            // 应用显示设置
            Object.entries(config.displaySettings || {}).forEach(([setting, checked]) => {
                const checkbox = document.getElementById(setting);
                if (checkbox) {
                    checkbox.checked = checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });

            // 应用视觉效果设置
            Object.entries(config.visualEffects || {}).forEach(([effect, checked]) => {
                const checkbox = document.getElementById(effect);
                if (checkbox) {
                    checkbox.checked = checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });

            console.log('已加载配置:', config);
            alert(`配置 "${config.name}" 已加载`);
        }

        window.loadStudentColorScheme = function (studentId) {
            // 这里可以从服务器加载特定学员的配色方案
            console.log('切换到学员:', studentId);

            // 更新配置名称输入框的占位符
            const configNameInput = document.getElementById('config-name');
            if (configNameInput) {
                configNameInput.placeholder = studentId ? `为 ${studentId} 创建配置` : '输入配置名称';
            }
        };

        // 重置显示设置
        window.resetDisplaySettings = function () {
            ['show-pos', 'show-vocab', 'show-known', 'show-new-words', 'show-tooltips'].forEach(setting => {
                const checkbox = document.getElementById(setting);
                if (checkbox) {
                    checkbox.checked = true;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });

            // 重置词库来源
            const vocabSelect = document.getElementById('vocab-source-select');
            if (vocabSelect) {
                vocabSelect.value = 'default';
            }

            console.log('显示设置已重置');
        };

        // 重置视觉效果
        window.resetVisualEffects = function () {
            ['enable-backgrounds', 'enable-borders', 'enable-gradients', 'enable-animations', 'enable-shadows'].forEach(effect => {
                const checkbox = document.getElementById(effect);
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });

            console.log('视觉效果已重置为默认状态（全部不勾选）');
        };

        // 初始化学员数据
        function initializeStudentData() {
            console.log('开始初始化配置数据...');

            // 加载学员列表
            loadStudentList();

            // 加载词库列表数据
            loadVocabularyData();

            // 初始化完成提示
            setTimeout(() => {
                console.log('配置面板初始化完成');
            }, 500);
        }

        function loadStudentList() {
            // 使用模拟数据，因为Django admin API需要特殊权限
            const studentSelect = document.getElementById('student-select');
            if (studentSelect) {
                // 模拟学员数据
                const mockStudents = [
                    { id: 'student1', name: '张三 (初级学员)' },
                    { id: 'student2', name: '李四 (中级学员)' },
                    { id: 'student3', name: '王五 (高级学员)' },
                    { id: 'student4', name: '赵六 (新学员)' },
                    { id: 'student5', name: '钱七 (VIP学员)' }
                ];

                mockStudents.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    studentSelect.appendChild(option);
                });

                console.log('学员列表加载完成，共', mockStudents.length, '个学员');
            }
        }

        function loadVocabularyData() {
            // 使用AJAX获取词库数据，通过自定义API端点
            fetch(`/admin/article_factory/article/{{ article.pk }}/get_vocabulary_lists/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('词库数据:', data);
                    updateVocabularySourceOptions(data);
                })
                .catch(error => {
                    console.error('加载词库数据失败:', error);
                    // 使用模拟数据作为后备
                    const mockVocabData = {
                        success: true,
                        vocabulary_lists: [
                            { id: 1, name: '小学英语词汇', word_count: 500 },
                            { id: 2, name: '初中英语词汇', word_count: 1200 },
                            { id: 3, name: '高中英语词汇', word_count: 2000 },
                            { id: 4, name: '大学英语词汇', word_count: 3500 },
                            { id: 5, name: '商务英语词汇', word_count: 800 }
                        ]
                    };
                    updateVocabularySourceOptions(mockVocabData);
                });
        }

        function updateVocabularySourceOptions(vocabularyData) {
            const vocabSelect = document.getElementById('vocab-source-select');
            if (vocabSelect && vocabularyData.vocabulary_lists) {
                // 保留现有的标准选项
                const standardOptions = ['default', 'cet4', 'cet6', 'toefl', 'ielts', 'gre'];

                // 添加分隔线
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '--- 系统词库 ---';
                vocabSelect.appendChild(separator);

                // 添加系统词库选项
                vocabularyData.vocabulary_lists.forEach(vocab => {
                    const option = document.createElement('option');
                    option.value = `vocab_${vocab.id}`;
                    option.textContent = `${vocab.name} (${vocab.word_count || 0}词)`;
                    vocabSelect.appendChild(option);
                });

                // 设置默认选择
                if (vocabularyData.default_selection) {
                    const defaultOption = vocabSelect.querySelector(`option[value="vocab_${vocabularyData.default_selection.id}"]`);
                    if (defaultOption) {
                        defaultOption.selected = true;
                        console.log(`已设置默认词库: ${vocabularyData.default_selection.name}`);
                    }
                } else if (vocabularyData.earliest_vocab) {
                    // 如果没有用户上次选择，使用最早创建的词库
                    const earliestOption = vocabSelect.querySelector(`option[value="vocab_${vocabularyData.earliest_vocab.id}"]`);
                    if (earliestOption) {
                        earliestOption.selected = true;
                        console.log(`已设置最早词库为默认: ${vocabularyData.earliest_vocab.name}`);
                    }
                }

                console.log('词库选项更新完成，共添加', vocabularyData.vocabulary_lists.length, '个系统词库');
            }
        }

        // 切换帮助详情显示
        window.toggleHelpDetails = function () {
            const helpDetails = document.getElementById('help-details');
            const toggleBtn = event.target;

            if (helpDetails.style.display === 'none') {
                helpDetails.style.display = 'block';
                toggleBtn.textContent = '收起';
            } else {
                helpDetails.style.display = 'none';
                toggleBtn.textContent = '详细';
            }
        }

        // 恢复用户设置
        function restoreUserSettings() {
            try {
                const savedSettings = localStorage.getItem('articlePreviewSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);

                    // 恢复显示设置
                    Object.entries(settings.displaySettings || {}).forEach(([key, value]) => {
                        const checkbox = document.getElementById(key);
                        if (checkbox && typeof value === 'boolean') {
                            checkbox.checked = value;
                        }
                    });

                    // 恢复视觉效果设置
                    Object.entries(settings.visualEffects || {}).forEach(([key, value]) => {
                        const checkbox = document.getElementById(key);
                        if (checkbox && typeof value === 'boolean') {
                            checkbox.checked = value;
                        }
                    });

                    console.log('用户设置已恢复');
                }
            } catch (error) {
                console.warn('恢复用户设置失败:', error);
            }
        }

        // 保存用户设置
        function saveUserSettings() {
            try {
                const settings = {
                    displaySettings: {},
                    visualEffects: {},
                    timestamp: Date.now()
                };

                // 保存显示设置
                ['show-pos', 'show-vocab', 'show-known', 'show-new-words', 'show-tooltips'].forEach(id => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        settings.displaySettings[id] = checkbox.checked;
                    }
                });

                // 保存视觉效果设置
                ['enable-backgrounds', 'enable-borders', 'enable-gradients', 'enable-animations', 'enable-shadows'].forEach(id => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        settings.visualEffects[id] = checkbox.checked;
                    }
                });

                localStorage.setItem('articlePreviewSettings', JSON.stringify(settings));
            } catch (error) {
                console.warn('保存用户设置失败:', error);
            }
        }

        // 为所有设置复选框添加保存事件
        document.addEventListener('change', function (e) {
            if (e.target.type === 'checkbox' &&
                (e.target.id.startsWith('show-') || e.target.id.startsWith('enable-'))) {
                saveUserSettings();
            }
        });

        // 初始化时应用默认的视觉效果设置（全部不勾选）
        setTimeout(() => {
            const visualEffectIds = ['enable-backgrounds', 'enable-borders', 'enable-gradients', 'enable-animations', 'enable-shadows'];
            visualEffectIds.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox && !checkbox.checked) {
                    checkbox.dispatchEvent(new Event('change'));
                }
            });

            // 默认应用无背景色样式
            const words = document.querySelectorAll('.word');
            words.forEach(function (word) {
                word.classList.add('no-backgrounds');
            });

            // 初始化功能联动
            initializeFeatureLinkage();
        }, 100);

        // 初始化功能联动
        function initializeFeatureLinkage() {
            // 词库词显示与边框功能联动
            const showVocabCheckbox = document.getElementById('show-vocab');
            const enableBordersCheckbox = document.getElementById('enable-borders');

            if (showVocabCheckbox && enableBordersCheckbox) {
                // 初始状态设置
                updateBorderCheckboxState();

                // 监听词库词显示变化
                showVocabCheckbox.addEventListener('change', function () {
                    updateBorderCheckboxState();
                    updateVocabWordDisplay();
                });

                // 监听边框功能变化
                enableBordersCheckbox.addEventListener('change', function () {
                    updateVocabWordBorders();
                });
            }

            // 鼠标悬停功能
            const showTooltipsCheckbox = document.getElementById('show-tooltips');
            if (showTooltipsCheckbox) {
                showTooltipsCheckbox.addEventListener('change', function () {
                    updateTooltipBehavior();
                });
            }

            // 熟词功能
            const showKnownCheckbox = document.getElementById('show-known');
            if (showKnownCheckbox) {
                showKnownCheckbox.addEventListener('change', function () {
                    updateKnownWordDisplay();
                });
            }

            // 视觉效果功能
            const visualEffectIds = ['enable-backgrounds', 'enable-gradients', 'enable-animations', 'enable-shadows'];
            visualEffectIds.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', function () {
                        updateVisualEffects();
                    });
                }
            });
        }

        // 更新边框复选框状态
        function updateBorderCheckboxState() {
            const showVocabCheckbox = document.getElementById('show-vocab');
            const enableBordersCheckbox = document.getElementById('enable-borders');

            if (showVocabCheckbox && enableBordersCheckbox) {
                if (showVocabCheckbox.checked) {
                    enableBordersCheckbox.disabled = false;
                    enableBordersCheckbox.parentElement.style.opacity = '1';
                } else {
                    enableBordersCheckbox.disabled = true;
                    enableBordersCheckbox.checked = false;
                    enableBordersCheckbox.parentElement.style.opacity = '0.5';
                }
            }
        }

        // 更新词库词显示
        function updateVocabWordDisplay() {
            const showVocabCheckbox = document.getElementById('show-vocab');
            const vocabWords = document.querySelectorAll('.vocab-word');

            if (showVocabCheckbox.checked) {
                vocabWords.forEach(word => {
                    word.style.display = 'inline';
                    word.classList.add('vocab-word-visible');
                });
            } else {
                vocabWords.forEach(word => {
                    word.style.display = 'none';
                    word.classList.remove('vocab-word-visible');
                });
            }

            console.log('词库词显示状态已更新:', showVocabCheckbox.checked);
        }

        // 更新词库词边框
        function updateVocabWordBorders() {
            const enableBordersCheckbox = document.getElementById('enable-borders');
            const vocabWords = document.querySelectorAll('.vocab-word');

            if (enableBordersCheckbox.checked) {
                vocabWords.forEach(word => {
                    word.classList.add('vocab-word-bordered');
                });
            } else {
                vocabWords.forEach(word => {
                    word.classList.remove('vocab-word-bordered');
                });
            }

            console.log('词库词边框状态已更新:', enableBordersCheckbox.checked);
        }

        // 更新鼠标悬停行为
        function updateTooltipBehavior() {
            const showTooltipsCheckbox = document.getElementById('show-tooltips');
            const words = document.querySelectorAll('.word');

            words.forEach(word => {
                if (showTooltipsCheckbox.checked) {
                    // 启用鼠标悬停显示
                    word.addEventListener('mouseenter', showWordTooltip);
                    word.addEventListener('mouseleave', hideWordTooltip);
                    word.style.cursor = 'pointer';
                } else {
                    // 禁用鼠标悬停，需要点击才能显示
                    word.removeEventListener('mouseenter', showWordTooltip);
                    word.removeEventListener('mouseleave', hideWordTooltip);
                    word.addEventListener('click', showWordDetail);
                    word.style.cursor = 'default';
                }
            });

            console.log('鼠标悬停行为已更新:', showTooltipsCheckbox.checked);
        }

        // 显示词汇工具提示
        function showWordTooltip(event) {
            const word = event.target;
            const wordText = word.textContent.trim();

            // 创建工具提示
            const tooltip = document.createElement('div');
            tooltip.className = 'word-tooltip';
            tooltip.innerHTML = `
            <div class="tooltip-content">
                <strong>${wordText}</strong><br>
                <span>点击查看详细信息</span>
            </div>
        `;

            // 定位工具提示
            const rect = word.getBoundingClientRect();
            tooltip.style.position = 'absolute';
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.bottom + 5) + 'px';
            tooltip.style.zIndex = '1000';

            document.body.appendChild(tooltip);

            // 添加点击事件
            tooltip.addEventListener('click', () => {
                showWordDetail(word);
                hideWordTooltip();
            });

            word.tooltip = tooltip;
        }

        // 隐藏词汇工具提示
        function hideWordTooltip(event) {
            const word = event.target;
            if (word.tooltip) {
                word.tooltip.remove();
                word.tooltip = null;
            }
        }

        // 更新熟词显示
        function updateKnownWordDisplay() {
            const showKnownCheckbox = document.getElementById('show-known');
            const knownWords = document.querySelectorAll('.known-word');

            if (showKnownCheckbox.checked) {
                knownWords.forEach(word => {
                    word.style.display = 'inline';
                    word.classList.add('known-word-visible');
                });
            } else {
                knownWords.forEach(word => {
                    word.style.display = 'none';
                    word.classList.remove('known-word-visible');
                });
            }

            console.log('熟词显示状态已更新:', showKnownCheckbox.checked);
        }

        // 更新视觉效果
        function updateVisualEffects() {
            const enableBackgrounds = document.getElementById('enable-backgrounds');
            const enableGradients = document.getElementById('enable-gradients');
            const enableAnimations = document.getElementById('enable-animations');
            const enableShadows = document.getElementById('enable-shadows');

            const words = document.querySelectorAll('.word');

            words.forEach(word => {
                // 背景色效果
                if (enableBackgrounds && enableBackgrounds.checked) {
                    word.classList.add('word-with-background');
                } else {
                    word.classList.remove('word-with-background');
                }

                // 渐变效果
                if (enableGradients && enableGradients.checked) {
                    word.classList.add('word-with-gradient');
                } else {
                    word.classList.remove('word-with-gradient');
                }

                // 动画效果
                if (enableAnimations && enableAnimations.checked) {
                    word.classList.add('word-with-animation');
                } else {
                    word.classList.remove('word-with-animation');
                }

                // 阴影效果
                if (enableShadows && enableShadows.checked) {
                    word.classList.add('word-with-shadow');
                } else {
                    word.classList.remove('word-with-shadow');
                }
            });

            console.log('视觉效果已更新');
        }

        // 更新词汇统计信息
        function updateWordStats(wordElement) {
            const wordText = wordElement.textContent.trim();
            const allWords = document.querySelectorAll('.word');
            const sameWords = Array.from(allWords).filter(w => w.textContent.trim() === wordText);

            console.log(`词汇 "${wordText}" 在文章中出现 ${sameWords.length} 次`);

            // 高亮所有相同词汇
            allWords.forEach(w => w.classList.remove('word-highlighted'));
            sameWords.forEach(w => w.classList.add('word-highlighted'));
        }

        // 简化的事件处理 - 仅保留必要功能
        document.addEventListener('keydown', function (e) {
            // ESC键关闭弹窗
            if (e.key === 'Escape') {
                closeWordDetail();
            }
        });





        // 重置显示设置 - 全局函数
        window.resetDisplaySettings = function () {
            document.getElementById('show-pos').checked = true;
            document.getElementById('show-vocab').checked = true;
            document.getElementById('show-known').checked = true;
            document.getElementById('show-new-words').checked = true;
            document.getElementById('show-tooltips').checked = true;
            document.getElementById('enable-background-colors').checked = true;

            // 触发变更事件
            ['show-pos', 'show-vocab', 'show-known', 'show-new-words', 'show-tooltips', 'enable-background-colors'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.dispatchEvent(new Event('change'));
            });
        };

        // 重置视觉效果 - 全局函数
        window.resetVisualEffects = function () {
            document.getElementById('enable-borders').checked = true;
            document.getElementById('enable-gradients').checked = true;
            document.getElementById('enable-animations').checked = true;
            document.getElementById('enable-shadows').checked = true;
        };

        // 重置词性颜色 - 全局函数
        window.resetPOSColors = function () {
            applyColorPreset('default');
        };

        // 重置词汇颜色 - 全局函数
        window.resetVocabColors = function () {
            document.getElementById('new-word-color').value = '#f44336';
            document.getElementById('vocab-word-color').value = '#2196f3';
            document.getElementById('known-word-color').value = '#4caf50';

            updateVocabColor('new-word', '#f44336');
            updateVocabColor('vocab-word', '#2196f3');
            updateVocabColor('known-word', '#4caf50');
        };

        // 切换帮助详情 - 全局函数
        window.toggleHelpDetails = function () {
            const details = document.getElementById('help-details');
            if (details.style.display === 'none') {
                details.style.display = 'block';
            } else {
                details.style.display = 'none';
            }
        };

        // 初始化生词样式
        function initializeNewWordStyles() {
            const showNewWordsCheckbox = document.getElementById('show-new-words');
            if (showNewWordsCheckbox && showNewWordsCheckbox.checked) {
                const newWordElements = document.querySelectorAll('.new-word, .student-new-word');
                newWordElements.forEach(function (el) {
                    el.classList.add('new-word-highlighted');
                    el.classList.add('new-word-visible');
                });
            }
        }

        // 页面加载完成后初始化生词样式
        document.addEventListener('DOMContentLoaded', function () {
            console.log('页面加载完成，开始初始化...');
            initializeNewWordStyles();

            // 延迟加载学生数据，确保页面完全加载
            setTimeout(function () {
                loadStudentData();
            }, 100);

            // 添加全局错误处理
            window.addEventListener('error', function (e) {
                console.error('全局错误:', e.error);
            });

            // 添加未处理的Promise拒绝处理
            window.addEventListener('unhandledrejection', function (e) {
                console.error('未处理的Promise拒绝:', e.reason);
            });

            // 添加学生选择器的change事件监听器
            const studentSelect = document.getElementById('current-student-select');
            if (studentSelect) {
                studentSelect.addEventListener('change', function () {
                    const studentId = this.value;
                    calculateNewWordRate(studentId);
                });
            }
        });

        // 学生数据加载功能已由统一学生选择器模块处理

        // 学生选择器相关功能已由统一学生选择器模块处理

        // 生词率计算功能已由统一学生选择器模块处理

    });

    // 修正权限策略违规警告
    if (typeof window.addEventListener !== 'undefined') {
        // 移除可能导致权限策略违规的事件监听器
        const originalAddEventListener = window.addEventListener;
        window.addEventListener = function (type, listener, options) {
            if (type === 'beforeunload' || type === 'unload') {
                console.warn('跳过可能违反权限策略的事件监听器:', type);
                return;
            }
            return originalAddEventListener.call(this, type, listener, options);
        };
    }

    // 学生选择器修复脚本已移除，现在使用统一的学生选择器模块

</script>
{% endblock %}