# 权限管理系统操作指南

## 目录
1. [系统概述](#系统概述)
2. [核心概念](#核心概念)
3. [快速开始](#快速开始)
4. [权限配置](#权限配置)
5. [角色管理](#角色管理)
6. [用户管理](#用户管理)
7. [权限同步](#权限同步)
8. [监控与审计](#监控与审计)
9. [故障排除](#故障排除)

## 系统概述

### 目标
本权限管理系统旨在为英语学习平台提供细粒度的权限控制，确保不同角色的用户只能访问其被授权的功能和数据。

### 架构特点
- **基于角色的访问控制（RBAC）**：通过角色分配权限，简化权限管理
- **细粒度权限控制**：支持页面级、功能级、数据级权限控制
- **动态权限验证**：实时权限检查，支持权限变更即时生效
- **多层级菜单支持**：支持根菜单、一级菜单、二级菜单的权限控制
- **权限继承机制**：子权限可继承父权限，简化配置

## 核心概念

### 权限（Permission）
权限是系统中最小的访问控制单元，定义了用户可以执行的具体操作。

**权限命名规范：**
```
模块名_操作类型_[子模块]
例如：word_learning_access, class_management_create
```

### 角色（Role）
角色是权限的集合，代表用户在系统中的身份和职责。

### 用户（User）
用户是系统的使用者，通过分配角色获得相应的权限。

### 学习模式（Learning Mode）
不同的学习模式对应不同的权限集合，影响用户可访问的功能。

### 前台功能（Frontend Features）
前台功能权限控制用户在前端界面中可以看到和操作的内容。

## 快速开始

### 1. 系统初始化

```bash
# 运行权限系统初始化命令
python manage.py setup_optimized_permissions

# 设置角色权限
python manage.py setup_role_permissions

# 设置菜单权限
python manage.py setup_role_menu_permissions
```

### 2. 数据导入

```bash
# 导入用户数据
python manage.py import_users --file users.csv

# 导入角色数据
python manage.py import_roles --file roles.csv
```

### 3. 权限监控面板

访问管理后台的权限管理模块：
- URL: `/admin/permissions/`
- 功能：查看权限分配、角色管理、用户权限审计

## 权限配置

### 权限分类

#### 1. 基础访问权限
```python
BASIC_PERMISSIONS = {
    'basic_access': '基础访问权限',
    'dashboard_access': '仪表板访问',
    'profile_access': '个人资料访问',
    'settings_access': '设置访问'
}
```

#### 2. 学习内容权限
```python
LEARNING_PERMISSIONS = {
    'word_learning_access': '单词学习访问',
    'word_challenge_access': '单词挑战访问',
    'word_review_access': '单词复习访问',
    'reading_access': '阅读理解访问',
    'listening_access': '听力练习访问',
    'grammar_access': '语法学习访问',
    'pronunciation_access': '发音练习访问'
}
```

#### 3. 教学管理权限
```python
TEACHING_PERMISSIONS = {
    'class_management_access': '班级管理访问',
    'class_management_create': '班级创建权限',
    'class_management_edit': '班级编辑权限',
    'class_management_delete': '班级删除权限',
    'student_progress_access': '学生进度查看',
    'teaching_resources_access': '教学资源访问',
    'assignment_create': '作业创建权限',
    'assignment_grade': '作业评分权限'
}
```

#### 4. 用户管理权限
```python
USER_MANAGEMENT_PERMISSIONS = {
    'user_management_access': '用户管理访问',
    'user_create': '用户创建权限',
    'user_edit': '用户编辑权限',
    'user_delete': '用户删除权限',
    'role_management_access': '角色管理访问',
    'permission_management_access': '权限管理访问'
}
```

#### 5. 社交互动权限
```python
SOCIAL_PERMISSIONS = {
    'community_access': '社区访问',
    'community_post': '社区发帖权限',
    'community_comment': '社区评论权限',
    'community_moderate': '社区管理权限',
    'friend_system_access': '好友系统访问',
    'message_send': '消息发送权限'
}
```

#### 6. 订阅管理权限
```python
SUBSCRIPTION_PERMISSIONS = {
    'subscription_access': '订阅管理访问',
    'subscription_create': '订阅创建权限',
    'subscription_modify': '订阅修改权限',
    'billing_access': '账单查看权限',
    'payment_process': '支付处理权限'
}
```

#### 7. 系统管理权限
```python
SYSTEM_PERMISSIONS = {
    'system_config_access': '系统配置访问',
    'system_monitor_access': '系统监控访问',
    'data_export': '数据导出权限',
    'data_import': '数据导入权限',
    'backup_create': '备份创建权限',
    'log_access': '日志查看权限'
}
```

### 添加新权限

1. **在代码中定义权限**
```python
# apps/permissions/models.py
class Permission(models.Model):
    code = models.CharField(max_length=100, unique=True)
    name = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    category = models.CharField(max_length=50)
    
    def __str__(self):
        return f"{self.name} ({self.code})"
```

2. **创建权限迁移**
```bash
python manage.py makemigrations permissions
python manage.py migrate
```

3. **在管理命令中添加权限**
```python
# apps/permissions/management/commands/setup_permissions.py
def create_permission(code, name, description, category):
    Permission.objects.get_or_create(
        code=code,
        defaults={
            'name': name,
            'description': description,
            'category': category
        }
    )
```

### 权限依赖配置

```python
PERMISSION_DEPENDENCIES = {
    'class_management_edit': ['class_management_access'],
    'class_management_delete': ['class_management_access', 'class_management_edit'],
    'assignment_grade': ['assignment_create', 'class_management_access']
}
```

### 权限元数据配置

```python
PERMISSION_METADATA = {
    'word_learning_access': {
        'frontend_routes': ['/word-challenge/learning'],
        'api_endpoints': ['/api/words/', '/api/learning-progress/'],
        'menu_items': ['word_learning'],
        'ui_components': ['WordLearningCard', 'ProgressTracker']
    }
}
```

## 角色管理

### 系统预定义角色

#### 1. 学生（Student）
**核心权限：**
- 基础访问权限
- 学习内容权限
- 个人进度查看
- 社交互动权限（受限）

**学习模式：**
- 自主学习模式
- 课程学习模式

**注册方式：**
- 开放注册
- 邀请码注册

#### 2. 教师（Teacher）
**核心权限：**
- 学生权限 + 教学管理权限
- 班级管理
- 学生进度监控
- 教学资源访问
- 作业布置与评分

**学习模式：**
- 教学模式
- 专业发展模式

**注册方式：**
- 管理员审核
- 机构邀请

#### 3. 家长（Parent）
**核心权限：**
- 子女学习进度查看
- 学习报告访问
- 与教师沟通
- 订阅管理

**学习模式：**
- 监督模式

**注册方式：**
- 学生邀请
- 开放注册

#### 4. 学术主管（Academic Supervisor）
**核心权限：**
- 教师权限 + 学术管理权限
- 课程设计
- 教学质量监控
- 教师培训管理

**学习模式：**
- 管理模式
- 学术研究模式

**注册方式：**
- 管理员指定

#### 5. 研究负责人（Research Director）
**核心权限：**
- 数据分析权限
- 研究报告生成
- 学习效果评估
- 系统优化建议

**学习模式：**
- 研究模式

**注册方式：**
- 管理员指定

#### 6. 院长（Dean）
**核心权限：**
- 机构级管理权限
- 财务数据访问
- 战略决策支持
- 全局数据分析

**学习模式：**
- 决策模式

**注册方式：**
- 系统管理员指定

#### 7. 管理员（Administrator）
**核心权限：**
- 所有系统权限
- 用户管理
- 系统配置
- 数据备份与恢复

**学习模式：**
- 管理模式

**注册方式：**
- 超级管理员指定

### 创建自定义角色

#### 1. 基本信息配置
```python
# 在Django管理后台或通过API创建角色
role = Role.objects.create(
    code='custom_teacher',
    name='定制教师',
    description='具有特殊权限的教师角色',
    is_active=True,
    learning_modes=['teaching', 'research']
)
```

#### 2. 权限分配
```python
# 分配权限给角色
permissions = Permission.objects.filter(
    code__in=[
        'basic_access',
        'word_learning_access',
        'class_management_access',
        'data_analysis_access'
    ]
)
role.permissions.set(permissions)
```

#### 3. 继承设置
```python
# 设置角色继承
role.parent_roles.add(teacher_role)
```

## 用户管理

### 用户权限分配

#### 1. 通过角色分配
```python
# 为用户分配角色
user.roles.add(teacher_role)

# 移除用户角色
user.roles.remove(student_role)
```

#### 2. 直接权限分配
```python
# 为用户直接分配权限（特殊情况）
user.user_permissions.add(special_permission)
```

#### 3. 临时权限
```python
# 分配临时权限（有过期时间）
TemporaryPermission.objects.create(
    user=user,
    permission=permission,
    expires_at=timezone.now() + timedelta(days=30)
)
```

### 权限检查

#### 1. 在视图中检查权限
```python
from django.contrib.auth.decorators import permission_required
from apps.permissions.decorators import role_required

@permission_required('word_learning_access')
def word_learning_view(request):
    # 视图逻辑
    pass

@role_required('teacher')
def teacher_dashboard(request):
    # 教师专用视图
    pass
```

#### 2. 在模板中检查权限
```html
{% load permission_tags %}

{% if user|has_permission:'class_management_access' %}
    <a href="{% url 'class_management' %}">班级管理</a>
{% endif %}

{% if user|has_role:'teacher' %}
    <div class="teacher-panel">
        <!-- 教师专用内容 -->
    </div>
{% endif %}
```

#### 3. 在前端检查权限
```javascript
// 使用权限服务检查权限
import { PermissionService } from '@/services/permissionService'

if (PermissionService.hasPermission('word_learning_access')) {
    // 显示单词学习功能
}

if (PermissionService.hasRole('teacher')) {
    // 显示教师功能
}
```

## 权限同步

### 自动同步机制

系统支持权限变更的实时同步，确保用户权限变更后立即生效。

#### 1. WebSocket同步
```python
# apps/permissions/websocket_service.py
class PermissionWebSocketService:
    async def notify_permission_change(self, user_id, permissions):
        await self.channel_layer.group_send(
            f"user_{user_id}",
            {
                "type": "permission_update",
                "permissions": permissions
            }
        )
```

#### 2. 缓存更新
```python
# 权限变更时更新缓存
def update_user_permission_cache(user_id):
    cache_key = f"user_permissions_{user_id}"
    permissions = get_user_permissions(user_id)
    cache.set(cache_key, permissions, timeout=3600)
```

#### 3. 前端权限刷新
```javascript
// 监听权限变更
websocket.onmessage = function(event) {
    const data = JSON.parse(event.data)
    if (data.type === 'permission_update') {
        PermissionService.updatePermissions(data.permissions)
        // 刷新相关UI组件
        EventBus.emit('permissions-updated')
    }
}
```

### 手动同步命令

```bash
# 同步所有用户权限
python manage.py sync_permissions

# 同步特定用户权限
python manage.py sync_permissions --user-id 123

# 同步特定角色权限
python manage.py sync_permissions --role teacher
```

## 监控与审计

### 权限审计日志

系统自动记录所有权限相关操作，包括：
- 权限分配/撤销
- 角色变更
- 权限检查失败
- 敏感操作访问

#### 审计日志格式
```python
class PermissionAuditLog(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    action = models.CharField(max_length=50)  # 'grant', 'revoke', 'check', 'deny'
    permission = models.CharField(max_length=100)
    resource = models.CharField(max_length=200, blank=True)
    ip_address = models.GenericIPAddressField()
    user_agent = models.TextField()
    timestamp = models.DateTimeField(auto_now_add=True)
    success = models.BooleanField()
    details = models.JSONField(default=dict)
```

### 权限监控面板

访问 `/admin/permissions/audit/` 查看：
- 权限使用统计
- 异常访问检测
- 权限分配趋势
- 用户活动分析

### 安全告警

系统会在以下情况发送告警：
- 频繁的权限检查失败
- 异常的权限提升
- 敏感权限的异常使用
- 批量权限变更

## 故障排除

### 常见问题

#### 1. 用户无法访问某个功能

**排查步骤：**
1. 检查用户是否有对应权限
2. 检查权限是否正确配置
3. 检查缓存是否过期
4. 检查前端权限检查逻辑

**解决方案：**
```bash
# 检查用户权限
python manage.py check_user_permissions --user-id 123

# 刷新用户权限缓存
python manage.py refresh_permission_cache --user-id 123
```

#### 2. 权限变更不生效

**可能原因：**
- 缓存未更新
- WebSocket连接断开
- 前端权限服务未刷新

**解决方案：**
```bash
# 强制同步权限
python manage.py sync_permissions --force

# 清除所有权限缓存
python manage.py clear_permission_cache
```

#### 3. 性能问题

**优化建议：**
- 启用权限缓存
- 优化权限检查查询
- 使用权限预加载
- 减少不必要的权限检查

### 调试工具

#### 1. 权限检查调试
```python
# 在settings.py中启用调试
PERMISSION_DEBUG = True

# 查看权限检查日志
python manage.py show_permission_logs --user-id 123
```

#### 2. 权限分析工具
```bash
# 分析用户权限
python manage.py analyze_permissions --user-id 123

# 分析角色权限
python manage.py analyze_permissions --role teacher

# 权限覆盖率分析
python manage.py permission_coverage
```

## 最佳实践

### 1. 权限设计原则
- **最小权限原则**：用户只获得完成工作所需的最小权限
- **职责分离**：敏感操作需要多个权限配合
- **权限继承**：合理使用角色继承减少配置复杂度
- **定期审查**：定期检查和清理不必要的权限

### 2. 性能优化
- **权限缓存**：合理使用缓存减少数据库查询
- **批量操作**：避免在循环中进行权限检查
- **预加载**：在需要时预加载用户权限
- **索引优化**：为权限相关字段添加数据库索引

### 3. 安全建议
- **权限审计**：启用完整的权限审计日志
- **异常监控**：监控异常的权限访问模式
- **定期备份**：定期备份权限配置数据
- **访问控制**：限制权限管理功能的访问

---

**文档版本：** v2.1  
**最后更新：** 2024年1月  
**维护者：** 系统管理团队