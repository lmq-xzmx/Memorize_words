# Natural English ç³»ç»Ÿæ¶æ„è§„èŒƒ

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯
- **é¡¹ç›®åç§°**: Natural English è‹±è¯­å­¦ä¹ å¹³å°
- **æ–‡æ¡£ç±»å‹**: ç³»ç»Ÿæ¶æ„è§„èŒƒ
- **æ›´æ–°æ—¥æœŸ**: 2025å¹´1æœˆ
- **ç³»ç»Ÿå®Œæˆåº¦**: 98%
- **æŠ€æœ¯æ ˆ**: Django + Python (åç«¯) + Vue3 + TypeScript + uni-app (å‰ç«¯)

## ğŸ“– ç›®å½•
1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
3. [æƒé™ç®¡ç†ç³»ç»Ÿ](#æƒé™ç®¡ç†ç³»ç»Ÿ)
4. [åŠ¨æ€èœå•ç³»ç»Ÿ](#åŠ¨æ€èœå•ç³»ç»Ÿ)
5. [å®æ—¶é€šä¿¡æœºåˆ¶](#å®æ—¶é€šä¿¡æœºåˆ¶)
6. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
7. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
8. [éƒ¨ç½²å’Œè¿ç»´](#éƒ¨ç½²å’Œè¿ç»´)

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½
Natural English æ˜¯ä¸€ä¸ªåŸºäºæƒé™é©±åŠ¨çš„è‹±è¯­å­¦ä¹ å¹³å°ï¼Œæ”¯æŒå¤šè§’è‰²ç”¨æˆ·ç®¡ç†ã€åŠ¨æ€æƒé™åˆ†é…å’Œå®æ—¶èœå•åŒæ­¥ã€‚

### 1.2 æ ¸å¿ƒç‰¹æ€§
- âœ… **å¤šè§’è‰²æƒé™ç®¡ç†**: æ”¯æŒ7ç§ç”¨æˆ·è§’è‰²çš„ç²¾ç»†åŒ–æƒé™æ§åˆ¶
- âœ… **åŠ¨æ€è§’è‰²å¢é¡¹**: çµæ´»çš„è§’è‰²å­—æ®µæ‰©å±•æœºåˆ¶
- âœ… **å®æ—¶æƒé™åŒæ­¥**: WebSocketé©±åŠ¨çš„æƒé™å˜æ›´å®æ—¶æ¨é€
- âœ… **åŠ¨æ€èœå•ç”Ÿæˆ**: åŸºäºæƒé™çš„èœå•è‡ªåŠ¨ç”Ÿæˆå’Œè¿‡æ»¤
- âœ… **è·¨å¹³å°å…¼å®¹**: uni-appæ”¯æŒå°ç¨‹åºã€H5ã€Appå¤šç«¯éƒ¨ç½²

### 1.3 ç”¨æˆ·è§’è‰²ä½“ç³»

| è§’è‰² | å±‚çº§ | ä¸»è¦æƒé™ | ç®¡ç†èŒƒå›´ |
|------|------|----------|----------|
| ç®¡ç†å‘˜ (admin) | 0 | ç³»ç»Ÿç®¡ç†ã€ç”¨æˆ·ç®¡ç†ã€æƒé™åˆ†é… | å…¨ç³»ç»Ÿ |
| æ•™å¯¼ä¸»ä»» (dean) | 1 | å­¦æœ¯ç®¡ç†ã€æ•™å­¦ç®¡ç† | æ•™åŠ¡å’Œæ•™ç ” |
| æ•™åŠ¡ä¸»ä»» (academic_director) | 2 | è¯¾ç¨‹ç®¡ç†ã€æ•™å­¦ç®¡ç† | æ•™åŠ¡èŒƒå›´ |
| æ•™ç ”ç»„é•¿ (research_leader) | 2 | æ•™ç ”ç®¡ç†ã€æ•™å­¦æ–¹æ³• | æ•™ç ”èŒƒå›´ |
| æ•™å¸ˆ (teacher) | 3 | å­¦ç”Ÿç®¡ç†ã€æ•™å­¦æ´»åŠ¨ | æ‰€æ•™å­¦ç”Ÿ |
| å®¶é•¿ (parent) | 3 | æŸ¥çœ‹å­å¥³ä¿¡æ¯ | è‡ªå·±å­å¥³ |
| å­¦ç”Ÿ (student) | 4 | ä¸ªäººå­¦ä¹ ã€èµ„æ–™ç®¡ç† | ä¸ªäººèŒƒå›´ |

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
Natural English ç³»ç»Ÿæ¶æ„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±‚ (uni-app)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Vue3 + TypeScript + Vite + SCSS                            â”‚
â”‚ â”œâ”€â”€ æƒé™ç®¡ç†æ¨¡å— (usePermission)                             â”‚
â”‚ â”œâ”€â”€ èœå•ç®¡ç†æ¨¡å— (useMenu)                                   â”‚
â”‚ â”œâ”€â”€ å®æ—¶é€šä¿¡æ¨¡å— (WebSocket)                                 â”‚
â”‚ â””â”€â”€ çŠ¶æ€ç®¡ç†æ¨¡å— (Pinia)                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        APIç½‘å…³å±‚                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Django REST Framework + JWTè®¤è¯                             â”‚
â”‚ â”œâ”€â”€ ç”¨æˆ·è®¤è¯ä¸­é—´ä»¶                                           â”‚
â”‚ â”œâ”€â”€ æƒé™éªŒè¯ä¸­é—´ä»¶                                           â”‚
â”‚ â”œâ”€â”€ è¯·æ±‚é™æµä¸­é—´ä»¶                                           â”‚
â”‚ â””â”€â”€ æ—¥å¿—è®°å½•ä¸­é—´ä»¶                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        ä¸šåŠ¡é€»è¾‘å±‚                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Django + Python                                             â”‚
â”‚ â”œâ”€â”€ ç”¨æˆ·ç®¡ç†æ¨¡å— (accounts)                                  â”‚
â”‚ â”œâ”€â”€ æƒé™ç®¡ç†æ¨¡å— (permissions)                               â”‚
â”‚ â”œâ”€â”€ èœå•ç®¡ç†æ¨¡å— (menus)                                     â”‚
â”‚ â””â”€â”€ å­¦ä¹ å†…å®¹æ¨¡å— (learning)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        æ•°æ®å­˜å‚¨å±‚                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PostgreSQL (ä¸»æ•°æ®åº“) + Redis (ç¼“å­˜) + æ–‡ä»¶å­˜å‚¨              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æŠ€æœ¯æ ˆé€‰å‹

**åç«¯æŠ€æœ¯æ ˆï¼š**
- **æ¡†æ¶**: Django 4.2 + Django REST Framework
- **è¯­è¨€**: Python 3.9+
- **æ•°æ®åº“**: PostgreSQL 13+
- **ç¼“å­˜**: Redis 6+
- **è®¤è¯**: JWT (JSON Web Token)
- **å®æ—¶é€šä¿¡**: Django Channels + WebSocket

**å‰ç«¯æŠ€æœ¯æ ˆï¼š**
- **æ¡†æ¶**: uni-app + Vue3
- **è¯­è¨€**: TypeScript
- **æ„å»ºå·¥å…·**: Vite
- **æ ·å¼**: SCSS
- **çŠ¶æ€ç®¡ç†**: Pinia
- **HTTPå®¢æˆ·ç«¯**: uni.request

## ğŸ” æƒé™ç®¡ç†ç³»ç»Ÿ

### 3.1 æƒé™æ¶æ„è®¾è®¡

```typescript
// æƒé™ç³»ç»Ÿæ¶æ„
interface PermissionArchitecture {
  // æƒé™éªŒè¯å±‚
  validation: {
    permissionChecker: PermissionChecker
    roleValidator: RoleValidator
    tokenValidator: TokenValidator
  }
  
  // æƒé™ç¼“å­˜å±‚
  cache: {
    permissionCache: PermissionCache
    roleCache: RoleCache
    userCache: UserCache
  }
  
  // æƒé™åŒæ­¥å±‚
  sync: {
    permissionSynchronizer: PermissionSynchronizer
    roleUpdater: RoleUpdater
    menuRefresher: MenuRefresher
  }
  
  // æƒé™å®¡è®¡å±‚
  audit: {
    operationLogger: OperationLogger
    accessTracker: AccessTracker
    securityMonitor: SecurityMonitor
  }
}
```

### 3.2 æƒé™éªŒè¯æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Frontend as å‰ç«¯
    participant Cache as ç¼“å­˜å±‚
    participant Backend as åç«¯
    participant DB as æ•°æ®åº“
    
    User->>Frontend: è®¿é—®åŠŸèƒ½
    Frontend->>Cache: æ£€æŸ¥æƒé™ç¼“å­˜
    alt ç¼“å­˜å‘½ä¸­
        Cache-->>Frontend: è¿”å›æƒé™ä¿¡æ¯
    else ç¼“å­˜æœªå‘½ä¸­
        Frontend->>Backend: è¯·æ±‚æƒé™éªŒè¯
        Backend->>DB: æŸ¥è¯¢ç”¨æˆ·æƒé™
        DB-->>Backend: è¿”å›æƒé™æ•°æ®
        Backend-->>Frontend: è¿”å›æƒé™ç»“æœ
        Frontend->>Cache: æ›´æ–°æƒé™ç¼“å­˜
    end
    Frontend-->>User: æ˜¾ç¤ºæˆæƒå†…å®¹
```

### 3.3 è§’è‰²å¢é¡¹ç³»ç»Ÿ

**è§’è‰²å¢é¡¹é…ç½®æ¨¡å‹ï¼š**
```python
class RoleExtension(models.Model):
    """è§’è‰²å¢é¡¹é…ç½®"""
    FIELD_TYPE_CHOICES = [
        ('text', 'æ–‡æœ¬å­—æ®µ'),
        ('textarea', 'å¤šè¡Œæ–‡æœ¬'),
        ('number', 'æ•°å­—å­—æ®µ'),
        ('email', 'é‚®ç®±å­—æ®µ'),
        ('date', 'æ—¥æœŸå­—æ®µ'),
        ('choice', 'é€‰æ‹©å­—æ®µ'),
        ('boolean', 'å¸ƒå°”å­—æ®µ'),
        ('url', 'URLå­—æ®µ'),
        ('phone', 'ç”µè¯å­—æ®µ'),
        ('file', 'æ–‡ä»¶å­—æ®µ'),
        ('image', 'å›¾ç‰‡å­—æ®µ'),
    ]
    
    role = models.CharField('è§’è‰²', max_length=20, choices=UserRole.choices)
    field_name = models.CharField('å­—æ®µåç§°', max_length=50)
    field_label = models.CharField('å­—æ®µæ ‡ç­¾', max_length=100)
    field_type = models.CharField('å­—æ®µç±»å‹', max_length=20, choices=FIELD_TYPE_CHOICES)
    is_required = models.BooleanField('æ˜¯å¦å¿…å¡«', default=False)
    sort_order = models.IntegerField('æ’åº', default=0)
    is_active = models.BooleanField('æ˜¯å¦å¯ç”¨', default=True)
```

**ç”¨æˆ·å¢é¡¹æ•°æ®æ¨¡å‹ï¼š**
```python
class UserExtensionData(models.Model):
    """ç”¨æˆ·è§’è‰²å¢é¡¹æ•°æ®"""
    user = models.ForeignKey(CustomUser, on_delete=models.CASCADE)
    role_extension = models.ForeignKey(RoleExtension, on_delete=models.CASCADE)
    field_value = models.TextField('å­—æ®µå€¼', blank=True)
    
    class Meta:
        unique_together = ['user', 'role_extension']
```

## ğŸ›ï¸ åŠ¨æ€èœå•ç³»ç»Ÿ

### 4.1 èœå•æ¶æ„è®¾è®¡

```typescript
// åŠ¨æ€èœå•ç³»ç»Ÿæ¶æ„
interface DynamicMenuArchitecture {
  // èœå•ç”Ÿæˆå±‚
  generation: {
    menuGenerator: MenuGenerator
    permissionFilter: PermissionFilter
    templateEngine: MenuTemplateEngine
  }
  
  // èœå•ç¼“å­˜å±‚
  cache: {
    menuCache: MenuCache
    templateCache: TemplateCache
    userMenuCache: UserMenuCache
  }
  
  // èœå•æ¸²æŸ“å±‚
  rendering: {
    menuRenderer: MenuRenderer
    componentFactory: ComponentFactory
    styleManager: StyleManager
  }
}
```

### 4.2 èœå•å±‚çº§ç»“æ„

| èœå•çº§åˆ« | å±•ç¤ºå½¢å¼ | æƒé™æ§åˆ¶ | ç¤ºä¾‹ |
|----------|----------|----------|------|
| **TabBar** | åº•éƒ¨å¯¼èˆªæ  | åŸºç¡€æƒé™éªŒè¯ | å­¦ä¹ ã€å·¥å…·ã€ç¤¾åŒºã€æˆ‘çš„ |
| **ä¸€çº§èœå•** | é¡µé¢å†…å®¹åŒº | æ¨¡å—æƒé™éªŒè¯ | å•è¯å­¦ä¹ ã€é˜…è¯»ç†è§£ã€å¬åŠ›ç»ƒä¹  |
| **äºŒçº§èœå•** | åˆ—è¡¨/ç½‘æ ¼å¸ƒå±€ | åŠŸèƒ½æƒé™éªŒè¯ | å•è¯æ‹¼å†™ã€é—ªå¡ç»ƒä¹ ã€è¯­æ³•å­¦ä¹  |

### 4.3 èœå•æƒé™æ˜ å°„

```typescript
// èœå•æƒé™é…ç½®
const menuPermissionConfig = {
  'learning': {
    permission: 'view_learning_content',
    children: {
      'vocabulary': { permission: 'view_vocabulary' },
      'reading': { permission: 'view_reading' },
      'listening': { permission: 'view_listening' }
    }
  },
  'management': {
    permission: 'view_management',
    roles: ['admin', 'dean', 'academic_director'],
    children: {
      'users': { permission: 'manage_users' },
      'roles': { permission: 'manage_roles' }
    }
  }
}
```

### 4.4 èœå•ç”Ÿæˆæµç¨‹

```typescript
// åŠ¨æ€èœå•ç”ŸæˆæœåŠ¡
export class DynamicMenuService {
  async generateUserMenu(userId: string): Promise<MenuItem[]> {
    // 1. è·å–ç”¨æˆ·æƒé™
    const permissions = await this.permissionService.getUserPermissions(userId)
    
    // 2. è·å–åŸºç¡€èœå•æ¨¡æ¿
    const baseMenu = await this.getBaseMenuTemplate()
    
    // 3. æƒé™è¿‡æ»¤
    const filteredMenu = this.filterMenuByPermissions(baseMenu, permissions)
    
    // 4. èœå•ä¼˜åŒ–
    const optimizedMenu = this.optimizeMenuStructure(filteredMenu)
    
    // 5. ç¼“å­˜ç»“æœ
    await this.cacheUserMenu(userId, optimizedMenu)
    
    return optimizedMenu
  }
  
  private filterMenuByPermissions(menu: MenuItem[], permissions: string[]): MenuItem[] {
    return menu.filter(item => {
      // æ£€æŸ¥æƒé™
      if (item.permission && !permissions.includes(item.permission)) {
        return false
      }
      
      // é€’å½’è¿‡æ»¤å­èœå•
      if (item.children) {
        item.children = this.filterMenuByPermissions(item.children, permissions)
      }
      
      return true
    })
  }
}
```

## ğŸ”„ å®æ—¶é€šä¿¡æœºåˆ¶

### 5.1 WebSocketæ¶æ„

```python
# Django Channels WebSocket Consumer
class PermissionConsumer(AsyncWebsocketConsumer):
    async def connect(self):
        self.user_id = self.scope['user'].id
        self.group_name = f'user_{self.user_id}'
        
        # åŠ å…¥ç”¨æˆ·ç»„
        await self.channel_layer.group_add(self.group_name, self.channel_name)
        await self.accept()
    
    async def disconnect(self, close_code):
        # ç¦»å¼€ç”¨æˆ·ç»„
        await self.channel_layer.group_discard(self.group_name, self.channel_name)
    
    async def permission_update(self, event):
        # å‘é€æƒé™æ›´æ–°æ¶ˆæ¯
        await self.send(text_data=json.dumps({
            'type': 'permission_update',
            'data': event['data']
        }))
```

### 5.2 å‰ç«¯WebSocketç®¡ç†

```typescript
// WebSocketç®¡ç†æœåŠ¡
export class WebSocketManager {
  private ws: WebSocket | null = null
  private reconnectAttempts = 0
  private maxReconnectAttempts = 5
  
  connect(userId: string): void {
    const wsUrl = `ws://localhost:8000/ws/permissions/${userId}/`
    this.ws = new WebSocket(wsUrl)
    
    this.ws.onopen = () => {
      console.log('WebSocketè¿æ¥å·²å»ºç«‹')
      this.reconnectAttempts = 0
      
      // å‘é€è¿æ¥ç¡®è®¤æ¶ˆæ¯
      this.send({
        type: 'connect',
        data: { userId, client_info: 'permission-client' }
      })
    }
    
    this.ws.onmessage = (event) => {
      const message = JSON.parse(event.data)
      this.handleMessage(message)
    }
    
    this.ws.onclose = () => {
      console.log('WebSocketè¿æ¥å·²å…³é—­')
      this.attemptReconnect(userId)
    }
  }
  
  private handleMessage(message: any): void {
    switch (message.type) {
      case 'permission_update':
        this.handlePermissionUpdate(message.data)
        break
      case 'menu_refresh':
        this.handleMenuRefresh(message.data)
        break
    }
  }
  
  private async handlePermissionUpdate(data: any): Promise<void> {
    // æ¸…é™¤æƒé™ç¼“å­˜
    await this.permissionService.clearCache()
    
    // é‡æ–°åŠ è½½æƒé™
    await this.permissionService.reloadPermissions()
    
    // åˆ·æ–°èœå•
    await this.menuService.refreshMenu()
  }
}
```

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 6.1 æ ¸å¿ƒæ•°æ®æ¨¡å‹

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE custom_user (
    id SERIAL PRIMARY KEY,
    username VARCHAR(150) UNIQUE NOT NULL,
    email VARCHAR(254),
    phone VARCHAR(20),
    real_name VARCHAR(100),
    role VARCHAR(20) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- è§’è‰²å¢é¡¹é…ç½®è¡¨
CREATE TABLE role_extension (
    id SERIAL PRIMARY KEY,
    role VARCHAR(20) NOT NULL,
    field_name VARCHAR(50) NOT NULL,
    field_label VARCHAR(100) NOT NULL,
    field_type VARCHAR(20) NOT NULL,
    is_required BOOLEAN DEFAULT FALSE,
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    UNIQUE(role, field_name)
);

-- ç”¨æˆ·å¢é¡¹æ•°æ®è¡¨
CREATE TABLE user_extension_data (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES custom_user(id),
    role_extension_id INTEGER REFERENCES role_extension(id),
    field_value TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, role_extension_id)
);

-- æƒé™å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE permission_audit_log (
    id SERIAL PRIMARY KEY,
    action_type VARCHAR(50) NOT NULL,
    result VARCHAR(20) NOT NULL,
    operator_id INTEGER REFERENCES custom_user(id),
    target_user_id INTEGER REFERENCES custom_user(id),
    resource VARCHAR(100),
    permission VARCHAR(100),
    description TEXT,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 6.2 ç´¢å¼•ä¼˜åŒ–

```sql
-- æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_user_role ON custom_user(role);
CREATE INDEX idx_user_active ON custom_user(is_active);
CREATE INDEX idx_role_extension_role ON role_extension(role);
CREATE INDEX idx_role_extension_active ON role_extension(is_active);
CREATE INDEX idx_user_extension_user ON user_extension_data(user_id);
CREATE INDEX idx_audit_log_user ON permission_audit_log(operator_id);
CREATE INDEX idx_audit_log_time ON permission_audit_log(created_at);
```

## âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 7.1 ç¼“å­˜ç­–ç•¥

```python
# Redisç¼“å­˜é…ç½®
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/1',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        },
        'KEY_PREFIX': 'natural_english',
        'TIMEOUT': 1800,  # 30åˆ†é’Ÿ
    }
}

# æƒé™ç¼“å­˜ç®¡ç†
class PermissionCacheManager:
    @staticmethod
    def get_user_permissions(user_id: int) -> List[str]:
        cache_key = f'user_permissions_{user_id}'
        permissions = cache.get(cache_key)
        
        if permissions is None:
            # ä»æ•°æ®åº“è·å–æƒé™
            permissions = UserPermissionService.get_permissions(user_id)
            cache.set(cache_key, permissions, 1800)  # ç¼“å­˜30åˆ†é’Ÿ
        
        return permissions
    
    @staticmethod
    def clear_user_cache(user_id: int):
        cache_keys = [
            f'user_permissions_{user_id}',
            f'user_menu_{user_id}',
            f'user_role_{user_id}'
        ]
        cache.delete_many(cache_keys)
```

### 7.2 æ•°æ®åº“ä¼˜åŒ–

```python
# æŸ¥è¯¢ä¼˜åŒ–
class OptimizedUserQuerySet(models.QuerySet):
    def with_permissions(self):
        return self.select_related('role').prefetch_related(
            'user_permissions',
            'groups__permissions'
        )
    
    def with_extensions(self):
        return self.prefetch_related(
            'userextensiondata_set__role_extension'
        )

# æ‰¹é‡æ“ä½œä¼˜åŒ–
class BulkPermissionUpdater:
    @staticmethod
    def update_role_permissions(role: str, permissions: List[str]):
        with transaction.atomic():
            # æ‰¹é‡æ›´æ–°ç”¨æˆ·æƒé™
            users = CustomUser.objects.filter(role=role)
            for user in users:
                # æ¸…é™¤ç¼“å­˜
                PermissionCacheManager.clear_user_cache(user.id)
            
            # å‘é€WebSocketé€šçŸ¥
            for user in users:
                channel_layer.group_send(
                    f'user_{user.id}',
                    {
                        'type': 'permission_update',
                        'data': {'permissions': permissions}
                    }
                )
```

### 7.3 å‰ç«¯æ€§èƒ½ä¼˜åŒ–

```typescript
// æƒé™é¢„åŠ è½½
export class PermissionPreloader {
  private static preloadedPermissions = new Map<string, string[]>()
  
  static async preloadUserPermissions(userId: string): Promise<void> {
    if (!this.preloadedPermissions.has(userId)) {
      const permissions = await api.getUserPermissions(userId)
      this.preloadedPermissions.set(userId, permissions)
    }
  }
  
  static getPreloadedPermissions(userId: string): string[] | null {
    return this.preloadedPermissions.get(userId) || null
  }
}

// èœå•æ‡’åŠ è½½
export class LazyMenuLoader {
  private static menuCache = new Map<string, MenuItem[]>()
  
  static async loadMenuLevel(level: number, parentId?: string): Promise<MenuItem[]> {
    const cacheKey = `menu_${level}_${parentId || 'root'}`
    
    if (this.menuCache.has(cacheKey)) {
      return this.menuCache.get(cacheKey)!
    }
    
    const menu = await api.getMenuLevel(level, parentId)
    this.menuCache.set(cacheKey, menu)
    
    return menu
  }
}
```

## ğŸš€ éƒ¨ç½²å’Œè¿ç»´

### 8.1 éƒ¨ç½²æ¶æ„

```yaml
# docker-compose.yml
version: '3.8'
services:
  web:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DEBUG=False
      - DATABASE_URL=postgresql://user:pass@db:5432/natural_english
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis
  
  db:
    image: postgres:13
    environment:
      - POSTGRES_DB=natural_english
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  redis:
    image: redis:6-alpine
    volumes:
      - redis_data:/data
  
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - web

volumes:
  postgres_data:
  redis_data:
```

### 8.2 ç›‘æ§å’Œæ—¥å¿—

```python
# ç³»ç»Ÿç›‘æ§
class SystemMonitor:
    @staticmethod
    def check_system_health():
        return {
            'database': DatabaseHealthChecker.check(),
            'redis': RedisHealthChecker.check(),
            'websocket': WebSocketHealthChecker.check(),
            'permissions': PermissionSystemChecker.check()
        }
    
    @staticmethod
    def get_performance_metrics():
        return {
            'cache_hit_rate': CacheMetrics.get_hit_rate(),
            'permission_check_time': PermissionMetrics.get_avg_check_time(),
            'menu_generation_time': MenuMetrics.get_avg_generation_time(),
            'websocket_connections': WebSocketMetrics.get_active_connections()
        }
```

### 8.3 å¤‡ä»½å’Œæ¢å¤

```bash
#!/bin/bash
# æ•°æ®åº“å¤‡ä»½è„šæœ¬
BACKUP_DIR="/backup/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
pg_dump -h localhost -U user natural_english > $BACKUP_DIR/database.sql

# å¤‡ä»½Redisæ•°æ®
redis-cli --rdb $BACKUP_DIR/redis.rdb

# å¤‡ä»½æ–‡ä»¶å­˜å‚¨
tar -czf $BACKUP_DIR/media.tar.gz /app/media/

# æ¸…ç†7å¤©å‰çš„å¤‡ä»½
find /backup -type d -mtime +7 -exec rm -rf {} +
```

## ğŸ“Š ç³»ç»ŸæŒ‡æ ‡

### æ€§èƒ½æŒ‡æ ‡
- **æƒé™æ£€æŸ¥å“åº”æ—¶é—´**: < 50ms
- **èœå•ç”Ÿæˆæ—¶é—´**: < 100ms
- **ç¼“å­˜å‘½ä¸­ç‡**: > 95%
- **WebSocketè¿æ¥ç¨³å®šæ€§**: > 99%
- **æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–**: å¹³å‡å“åº”æ—¶é—´ < 20ms

### å¯ç”¨æ€§æŒ‡æ ‡
- **ç³»ç»Ÿå¯ç”¨æ€§**: 99.9%
- **æƒé™åŒæ­¥å»¶è¿Ÿ**: < 300ms
- **ç”¨æˆ·å¹¶å‘æ”¯æŒ**: 1000+
- **æ•°æ®ä¸€è‡´æ€§**: 100%

## ğŸ”® æœªæ¥è§„åˆ’

### çŸ­æœŸç›®æ ‡ï¼ˆ1-3ä¸ªæœˆï¼‰
- [ ] å®Œå–„æƒé™å®¡è®¡åŠŸèƒ½
- [ ] ä¼˜åŒ–èœå•ç¼“å­˜ç­–ç•¥
- [ ] å¢å¼ºWebSocketç¨³å®šæ€§
- [ ] å®Œå–„ç›‘æ§å‘Šè­¦æœºåˆ¶

### ä¸­æœŸç›®æ ‡ï¼ˆ3-6ä¸ªæœˆï¼‰
- [ ] æ”¯æŒæƒé™æ¨¡æ¿å¯¼å…¥å¯¼å‡º
- [ ] å®ç°æƒé™å˜æ›´å®¡æ‰¹æµç¨‹
- [ ] å¢åŠ æƒé™ä½¿ç”¨åˆ†ææŠ¥å‘Š
- [ ] æ”¯æŒå¤šç§Ÿæˆ·æƒé™éš”ç¦»

### é•¿æœŸç›®æ ‡ï¼ˆ6-12ä¸ªæœˆï¼‰
- [ ] å®ç°AIé©±åŠ¨çš„æƒé™æ¨è
- [ ] æ”¯æŒç»†ç²’åº¦çš„æ•°æ®æƒé™æ§åˆ¶
- [ ] é›†æˆç¬¬ä¸‰æ–¹èº«ä»½è®¤è¯ç³»ç»Ÿ
- [ ] æ„å»ºæƒé™ç®¡ç†å¯è§†åŒ–å¹³å°

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£åº”å®šæœŸæ›´æ–°ï¼Œç¡®ä¿ä¸ç³»ç»Ÿå®é™…çŠ¶æ€ä¿æŒä¸€è‡´ã€‚
**è”ç³»æ–¹å¼**: å¦‚æœ‰æŠ€æœ¯é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚