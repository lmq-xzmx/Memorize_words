# Natural English 权限管理操作手册

## 📋 文档信息
- **文档类型**: 操作手册
- **适用对象**: 系统管理员、开发人员
- **更新日期**: 2025年1月
- **系统版本**: v1.0

## 📖 目录
1. [快速开始](#快速开始)
2. [用户管理](#用户管理)
3. [角色管理](#角色管理)
4. [权限配置](#权限配置)
5. [菜单管理](#菜单管理)
6. [系统监控](#系统监控)
7. [故障排除](#故障排除)
8. [API接口](#api接口)

## 🚀 快速开始

### 1.1 系统登录

**管理员登录流程：**
1. 访问管理后台：`http://your-domain/admin/`
2. 使用超级用户账号登录
3. 进入权限管理模块

**前台用户登录：**
```typescript
// 用户登录API调用
const loginUser = async (credentials: LoginCredentials) => {
  const response = await api.post('/auth/login/', credentials)
  const { access_token, refresh_token, user } = response.data
  
  // 存储token
  uni.setStorageSync('access_token', access_token)
  uni.setStorageSync('refresh_token', refresh_token)
  uni.setStorageSync('user_info', user)
  
  return user
}
```

### 1.2 权限验证

**前端权限检查：**
```typescript
// 权限检查组合式函数
export const usePermission = () => {
  const hasPermission = (permission: string): boolean => {
    const userPermissions = uni.getStorageSync('user_permissions') || []
    return userPermissions.includes(permission)
  }
  
  const hasRole = (role: string): boolean => {
    const userInfo = uni.getStorageSync('user_info')
    return userInfo?.role === role
  }
  
  const canManage = (targetRole: string): boolean => {
    const userInfo = uni.getStorageSync('user_info')
    const userLevel = UserRole.getLevel(userInfo?.role)
    const targetLevel = UserRole.getLevel(targetRole)
    return userLevel < targetLevel
  }
  
  return { hasPermission, hasRole, canManage }
}
```

## 👥 用户管理

### 2.1 创建用户

**后台创建用户：**
1. 进入 Django Admin → 用户管理 → 添加用户
2. 填写基本信息：
   - 用户名（必填）
   - 邮箱
   - 手机号
   - 真实姓名
   - 角色（必选）
3. 设置用户状态：
   - 是否激活
   - 管理员审批状态
4. 保存用户

**API创建用户：**
```python
# 用户创建API
class UserCreateView(APIView):
    permission_classes = [IsAuthenticated, IsAdminUser]
    
    def post(self, request):
        serializer = UserCreateSerializer(data=request.data)
        if serializer.is_valid():
            user = serializer.save()
            
            # 记录操作日志
            PermissionAuditLogger.log_user_creation(
                operator=request.user,
                target_user=user,
                ip_address=get_client_ip(request)
            )
            
            return Response({
                'status': 'success',
                'user_id': user.id,
                'message': '用户创建成功'
            })
        
        return Response({
            'status': 'error',
            'errors': serializer.errors
        }, status=400)
```

### 2.2 用户角色变更

**角色变更流程：**
```python
# 角色变更服务
class RoleChangeService:
    @staticmethod
    def change_user_role(user_id: int, new_role: str, operator_id: int):
        with transaction.atomic():
            user = CustomUser.objects.get(id=user_id)
            old_role = user.role
            
            # 验证权限
            if not RolePermissionChecker.can_change_role(operator_id, old_role, new_role):
                raise PermissionDenied('无权限变更此角色')
            
            # 更新角色
            user.role = new_role
            user.save()
            
            # 清除权限缓存
            PermissionCacheManager.clear_user_cache(user_id)
            
            # 发送WebSocket通知
            WebSocketNotifier.notify_permission_change(user_id)
            
            # 记录审计日志
            PermissionAuditLogger.log_role_change(
                operator_id=operator_id,
                target_user_id=user_id,
                old_role=old_role,
                new_role=new_role
            )
```

### 2.3 用户增项管理

**获取用户增项数据：**
```python
# 用户增项数据获取
class UserExtensionDataView(APIView):
    def get(self, request, user_id):
        user = get_object_or_404(CustomUser, id=user_id)
        
        # 获取角色增项配置
        role_extensions = RoleExtension.objects.filter(
            role=user.role,
            is_active=True
        ).order_by('sort_order')
        
        # 获取用户增项数据
        user_data = UserExtensionData.objects.filter(
            user=user
        ).select_related('role_extension')
        
        # 构建响应数据
        extension_data = []
        for extension in role_extensions:
            user_value = user_data.filter(role_extension=extension).first()
            extension_data.append({
                'field_name': extension.field_name,
                'field_label': extension.field_label,
                'field_type': extension.field_type,
                'is_required': extension.is_required,
                'field_value': user_value.field_value if user_value else ''
            })
        
        return Response(extension_data)
```

## 🎭 角色管理

### 3.1 角色层级体系

**角色层级定义：**
```python
class UserRole(models.TextChoices):
    ADMIN = 'admin', '管理员'
    DEAN = 'dean', '教导主任'
    ACADEMIC_DIRECTOR = 'academic_director', '教务主任'
    RESEARCH_LEADER = 'research_leader', '教研组长'
    TEACHER = 'teacher', '教师'
    PARENT = 'parent', '家长'
    STUDENT = 'student', '学生'
    
    @classmethod
    def get_role_hierarchy(cls):
        return {
            cls.ADMIN: 0,
            cls.DEAN: 1,
            cls.ACADEMIC_DIRECTOR: 2,
            cls.RESEARCH_LEADER: 2,
            cls.TEACHER: 3,
            cls.PARENT: 3,
            cls.STUDENT: 4
        }
    
    @classmethod
    def can_manage(cls, manager_role, target_role):
        hierarchy = cls.get_role_hierarchy()
        return hierarchy.get(manager_role, 999) < hierarchy.get(target_role, 999)
```

### 3.2 角色权限配置

**默认权限分配：**
```python
# 角色默认权限配置
ROLE_DEFAULT_PERMISSIONS = {
    'admin': [
        'view_all_users', 'manage_users', 'manage_roles',
        'manage_permissions', 'view_audit_logs', 'system_settings'
    ],
    'dean': [
        'view_teachers', 'manage_teachers', 'view_students',
        'manage_academic', 'view_reports'
    ],
    'academic_director': [
        'view_teachers', 'manage_courses', 'view_students',
        'manage_academic', 'view_academic_reports'
    ],
    'research_leader': [
        'view_teachers', 'manage_research', 'view_teaching_materials',
        'manage_teaching_methods'
    ],
    'teacher': [
        'view_own_students', 'manage_own_classes', 'view_teaching_materials',
        'submit_reports'
    ],
    'parent': [
        'view_own_children', 'view_children_progress', 'communicate_teachers'
    ],
    'student': [
        'view_own_profile', 'access_learning_materials', 'submit_assignments'
    ]
}

# 权限分配服务
class RolePermissionService:
    @staticmethod
    def assign_default_permissions(role: str):
        permissions = ROLE_DEFAULT_PERMISSIONS.get(role, [])
        users = CustomUser.objects.filter(role=role)
        
        for user in users:
            # 清除现有权限缓存
            PermissionCacheManager.clear_user_cache(user.id)
            
            # 发送权限更新通知
            WebSocketNotifier.notify_permission_change(user.id)
```

### 3.3 角色增项配置

**创建角色增项：**
```python
# 角色增项管理命令
class Command(BaseCommand):
    help = '创建默认角色增项配置'
    
    def handle(self, *args, **options):
        # 基础增项字段（所有角色通用）
        base_extensions = [
            {
                'field_name': 'real_name',
                'field_label': '真实姓名',
                'field_type': 'text',
                'is_required': True,
                'sort_order': 1
            },
            {
                'field_name': 'phone',
                'field_label': '联系电话',
                'field_type': 'phone',
                'is_required': True,
                'sort_order': 2
            },
            {
                'field_name': 'avatar',
                'field_label': '头像',
                'field_type': 'image',
                'is_required': False,
                'sort_order': 3
            }
        ]
        
        # 为每个角色创建基础增项
        for role_choice in UserRole.choices:
            role = role_choice[0]
            for extension_data in base_extensions:
                RoleExtension.objects.get_or_create(
                    role=role,
                    field_name=extension_data['field_name'],
                    defaults=extension_data
                )
        
        # 角色特定增项
        self.create_teacher_extensions()
        self.create_student_extensions()
        self.create_parent_extensions()
    
    def create_teacher_extensions(self):
        teacher_extensions = [
            {
                'field_name': 'subject',
                'field_label': '任教科目',
                'field_type': 'choice',
                'is_required': True,
                'sort_order': 10
            },
            {
                'field_name': 'teaching_experience',
                'field_label': '教学经验（年）',
                'field_type': 'number',
                'is_required': False,
                'sort_order': 11
            }
        ]
        
        for extension_data in teacher_extensions:
            RoleExtension.objects.get_or_create(
                role='teacher',
                field_name=extension_data['field_name'],
                defaults=extension_data
            )
```

## 🔐 权限配置

### 4.1 权限检查机制

**权限验证装饰器：**
```python
# 权限验证装饰器
def permission_required(permission_name):
    def decorator(view_func):
        @wraps(view_func)
        def wrapper(request, *args, **kwargs):
            if not request.user.is_authenticated:
                return JsonResponse({'error': '未登录'}, status=401)
            
            # 检查权限
            if not PermissionChecker.has_permission(request.user, permission_name):
                # 记录权限拒绝日志
                PermissionAuditLogger.log_permission_denied(
                    user=request.user,
                    permission=permission_name,
                    resource=request.path,
                    ip_address=get_client_ip(request)
                )
                return JsonResponse({'error': '权限不足'}, status=403)
            
            return view_func(request, *args, **kwargs)
        return wrapper
    return decorator

# 使用示例
@permission_required('manage_users')
def user_management_view(request):
    # 用户管理逻辑
    pass
```

### 4.2 动态权限更新

**权限更新服务：**
```python
class PermissionUpdateService:
    @staticmethod
    def update_role_permissions(role: str, permissions: List[str], operator_id: int):
        """更新角色权限"""
        with transaction.atomic():
            # 获取该角色的所有用户
            users = CustomUser.objects.filter(role=role)
            
            # 批量清除权限缓存
            for user in users:
                PermissionCacheManager.clear_user_cache(user.id)
            
            # 发送WebSocket通知
            for user in users:
                channel_layer = get_channel_layer()
                async_to_sync(channel_layer.group_send)(
                    f'user_{user.id}',
                    {
                        'type': 'permission_update',
                        'data': {
                            'permissions': permissions,
                            'role': role,
                            'timestamp': timezone.now().isoformat()
                        }
                    }
                )
            
            # 记录权限变更日志
            PermissionAuditLogger.log_permission_update(
                operator_id=operator_id,
                role=role,
                permissions=permissions,
                affected_users=list(users.values_list('id', flat=True))
            )
    
    @staticmethod
    def update_user_permissions(user_id: int, permissions: List[str], operator_id: int):
        """更新单个用户权限"""
        with transaction.atomic():
            # 清除用户权限缓存
            PermissionCacheManager.clear_user_cache(user_id)
            
            # 发送WebSocket通知
            channel_layer = get_channel_layer()
            async_to_sync(channel_layer.group_send)(
                f'user_{user_id}',
                {
                    'type': 'permission_update',
                    'data': {
                        'permissions': permissions,
                        'timestamp': timezone.now().isoformat()
                    }
                }
            )
            
            # 记录权限变更日志
            PermissionAuditLogger.log_user_permission_update(
                operator_id=operator_id,
                target_user_id=user_id,
                permissions=permissions
            )
```

## 🎛️ 菜单管理

### 5.1 菜单配置

**菜单权限映射：**
```typescript
// 菜单权限配置
const MENU_PERMISSION_CONFIG = {
  // 学习模块
  learning: {
    permission: 'access_learning',
    roles: ['student', 'teacher', 'parent'],
    children: {
      vocabulary: { permission: 'view_vocabulary' },
      reading: { permission: 'view_reading' },
      listening: { permission: 'view_listening' },
      speaking: { permission: 'view_speaking' }
    }
  },
  
  // 管理模块
  management: {
    permission: 'access_management',
    roles: ['admin', 'dean', 'academic_director'],
    children: {
      users: { permission: 'manage_users' },
      roles: { permission: 'manage_roles' },
      permissions: { permission: 'manage_permissions' },
      audit: { permission: 'view_audit_logs' }
    }
  },
  
  // 教学模块
  teaching: {
    permission: 'access_teaching',
    roles: ['teacher', 'dean', 'academic_director', 'research_leader'],
    children: {
      classes: { permission: 'manage_classes' },
      students: { permission: 'view_students' },
      materials: { permission: 'manage_materials' },
      reports: { permission: 'view_reports' }
    }
  }
}
```

### 5.2 动态菜单生成

**菜单生成服务：**
```typescript
export class MenuGenerationService {
  static async generateUserMenu(userId: string): Promise<MenuItem[]> {
    // 1. 检查菜单缓存
    const cachedMenu = await this.getCachedMenu(userId)
    if (cachedMenu) {
      return cachedMenu
    }
    
    // 2. 获取用户权限和角色
    const userInfo = await api.getUserInfo(userId)
    const permissions = await api.getUserPermissions(userId)
    
    // 3. 生成基础菜单
    const baseMenu = this.getBaseMenuTemplate()
    
    // 4. 权限过滤
    const filteredMenu = this.filterMenuByPermissions(baseMenu, permissions, userInfo.role)
    
    // 5. 菜单优化
    const optimizedMenu = this.optimizeMenuStructure(filteredMenu)
    
    // 6. 缓存菜单
    await this.cacheUserMenu(userId, optimizedMenu)
    
    return optimizedMenu
  }
  
  private static filterMenuByPermissions(
    menu: MenuItem[], 
    permissions: string[], 
    userRole: string
  ): MenuItem[] {
    return menu.filter(item => {
      const config = MENU_PERMISSION_CONFIG[item.key]
      
      // 检查角色权限
      if (config?.roles && !config.roles.includes(userRole)) {
        return false
      }
      
      // 检查具体权限
      if (config?.permission && !permissions.includes(config.permission)) {
        return false
      }
      
      // 递归过滤子菜单
      if (item.children) {
        item.children = this.filterMenuByPermissions(item.children, permissions, userRole)
        // 如果子菜单为空，隐藏父菜单
        if (item.children.length === 0) {
          return false
        }
      }
      
      return true
    })
  }
  
  private static async cacheUserMenu(userId: string, menu: MenuItem[]): Promise<void> {
    const cacheKey = `user_menu_${userId}`
    await uni.setStorage({
      key: cacheKey,
      data: {
        menu,
        timestamp: Date.now(),
        version: await this.getMenuVersion()
      }
    })
  }
}
```

## 📊 系统监控

### 6.1 权限审计日志

**审计日志记录：**
```python
class PermissionAuditLogger:
    @staticmethod
    def log_permission_check(user, permission, resource, result, ip_address=None):
        """记录权限检查日志"""
        PermissionAuditLog.objects.create(
            action_type='permission_check',
            result='granted' if result else 'denied',
            operator=user,
            permission=permission,
            resource=resource,
            ip_address=ip_address,
            description=f'用户 {user.username} 检查权限 {permission}'
        )
    
    @staticmethod
    def log_role_change(operator_id, target_user_id, old_role, new_role):
        """记录角色变更日志"""
        operator = CustomUser.objects.get(id=operator_id)
        target_user = CustomUser.objects.get(id=target_user_id)
        
        PermissionAuditLog.objects.create(
            action_type='role_change',
            result='success',
            operator=operator,
            target_user=target_user,
            description=f'角色从 {old_role} 变更为 {new_role}'
        )
    
    @staticmethod
    def log_permission_update(operator_id, role, permissions, affected_users):
        """记录权限更新日志"""
        operator = CustomUser.objects.get(id=operator_id)
        
        PermissionAuditLog.objects.create(
            action_type='permission_update',
            result='success',
            operator=operator,
            description=f'更新角色 {role} 权限，影响用户 {len(affected_users)} 人',
            metadata={
                'role': role,
                'permissions': permissions,
                'affected_users': affected_users
            }
        )
```

### 6.2 系统健康检查

**健康检查服务：**
```python
class SystemHealthChecker:
    @staticmethod
    def check_permission_system():
        """检查权限系统健康状态"""
        try:
            # 检查数据库连接
            db_status = DatabaseHealthChecker.check()
            
            # 检查Redis连接
            redis_status = RedisHealthChecker.check()
            
            # 检查WebSocket连接
            websocket_status = WebSocketHealthChecker.check()
            
            # 检查权限缓存
            cache_status = PermissionCacheChecker.check()
            
            return {
                'status': 'healthy',
                'components': {
                    'database': db_status,
                    'redis': redis_status,
                    'websocket': websocket_status,
                    'permission_cache': cache_status
                },
                'timestamp': timezone.now().isoformat()
            }
        except Exception as e:
            return {
                'status': 'unhealthy',
                'error': str(e),
                'timestamp': timezone.now().isoformat()
            }
```

## 🔧 故障排除

### 7.1 常见问题

**问题1：用户权限不生效**
```bash
# 检查步骤
1. 检查用户角色是否正确
2. 检查权限缓存是否过期
3. 检查WebSocket连接状态
4. 清除权限缓存并重新登录

# 解决方案
python manage.py shell
>>> from apps.permissions.cache import PermissionCacheManager
>>> PermissionCacheManager.clear_user_cache(user_id)
```

**问题2：菜单不显示**
```bash
# 检查步骤
1. 检查用户权限配置
2. 检查菜单权限映射
3. 检查前端菜单缓存
4. 检查菜单生成逻辑

# 解决方案
# 清除前端菜单缓存
uni.removeStorageSync('user_menu_' + userId)
```

**问题3：WebSocket连接失败**
```bash
# 检查步骤
1. 检查WebSocket服务状态
2. 检查网络连接
3. 检查认证token
4. 检查防火墙设置

# 解决方案
# 重启WebSocket服务
sudo systemctl restart daphne
```

### 7.2 日志分析

**权限相关日志查看：**
```bash
# 查看权限检查日志
python manage.py shell
>>> from apps.permissions.models import PermissionAuditLog
>>> logs = PermissionAuditLog.objects.filter(
...     action_type='permission_check',
...     result='denied'
... ).order_by('-created_at')[:10]
>>> for log in logs:
...     print(f"{log.created_at}: {log.operator.username} - {log.permission} - {log.result}")

# 查看角色变更日志
>>> role_changes = PermissionAuditLog.objects.filter(
...     action_type='role_change'
... ).order_by('-created_at')[:10]
```

## 🔌 API接口

### 8.1 用户管理API

```python
# 获取用户列表
GET /api/users/
Response: {
    "count": 100,
    "results": [
        {
            "id": 1,
            "username": "admin",
            "email": "admin@example.com",
            "role": "admin",
            "is_active": true,
            "created_at": "2025-01-01T00:00:00Z"
        }
    ]
}

# 创建用户
POST /api/users/
Request: {
    "username": "newuser",
    "email": "newuser@example.com",
    "role": "student",
    "real_name": "新用户",
    "phone": "13800138000"
}

# 更新用户角色
PATCH /api/users/{id}/role/
Request: {
    "role": "teacher"
}
```

### 8.2 权限管理API

```python
# 获取用户权限
GET /api/permissions/user/{user_id}/
Response: {
    "permissions": [
        "view_students",
        "manage_classes",
        "view_reports"
    ],
    "role": "teacher"
}

# 更新角色权限
POST /api/permissions/role/{role}/update/
Request: {
    "permissions": [
        "view_students",
        "manage_classes",
        "submit_reports"
    ]
}
```

### 8.3 菜单管理API

```python
# 获取用户菜单
GET /api/menus/user/{user_id}/
Response: {
    "menus": [
        {
            "key": "learning",
            "title": "学习",
            "icon": "book",
            "children": [
                {
                    "key": "vocabulary",
                    "title": "词汇学习",
                    "path": "/learning/vocabulary"
                }
            ]
        }
    ]
}

# 刷新用户菜单缓存
POST /api/menus/user/{user_id}/refresh/
Response: {
    "status": "success",
    "message": "菜单缓存已刷新"
}
```

---

**注意事项：**
1. 所有权限变更操作都会记录审计日志
2. 权限缓存默认30分钟过期
3. WebSocket连接异常时会自动重连
4. 建议定期备份权限配置数据

**技术支持：**
如遇到问题，请查看系统日志或联系开发团队。