# Natural English æƒé™ç®¡ç†æ“ä½œæ‰‹å†Œ

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯
- **æ–‡æ¡£ç±»å‹**: æ“ä½œæ‰‹å†Œ
- **é€‚ç”¨å¯¹è±¡**: ç³»ç»Ÿç®¡ç†å‘˜ã€å¼€å‘äººå‘˜
- **æ›´æ–°æ—¥æœŸ**: 2025å¹´1æœˆ
- **ç³»ç»Ÿç‰ˆæœ¬**: v1.0

## ğŸ“– ç›®å½•
1. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
2. [ç”¨æˆ·ç®¡ç†](#ç”¨æˆ·ç®¡ç†)
3. [è§’è‰²ç®¡ç†](#è§’è‰²ç®¡ç†)
4. [æƒé™é…ç½®](#æƒé™é…ç½®)
5. [èœå•ç®¡ç†](#èœå•ç®¡ç†)
6. [ç³»ç»Ÿç›‘æ§](#ç³»ç»Ÿç›‘æ§)
7. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
8. [APIæ¥å£](#apiæ¥å£)

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1.1 ç³»ç»Ÿç™»å½•

**ç®¡ç†å‘˜ç™»å½•æµç¨‹ï¼š**
1. è®¿é—®ç®¡ç†åå°ï¼š`http://your-domain/admin/`
2. ä½¿ç”¨è¶…çº§ç”¨æˆ·è´¦å·ç™»å½•
3. è¿›å…¥æƒé™ç®¡ç†æ¨¡å—

**å‰å°ç”¨æˆ·ç™»å½•ï¼š**
```typescript
// ç”¨æˆ·ç™»å½•APIè°ƒç”¨
const loginUser = async (credentials: LoginCredentials) => {
  const response = await api.post('/auth/login/', credentials)
  const { access_token, refresh_token, user } = response.data
  
  // å­˜å‚¨token
  uni.setStorageSync('access_token', access_token)
  uni.setStorageSync('refresh_token', refresh_token)
  uni.setStorageSync('user_info', user)
  
  return user
}
```

### 1.2 æƒé™éªŒè¯

**å‰ç«¯æƒé™æ£€æŸ¥ï¼š**
```typescript
// æƒé™æ£€æŸ¥ç»„åˆå¼å‡½æ•°
export const usePermission = () => {
  const hasPermission = (permission: string): boolean => {
    const userPermissions = uni.getStorageSync('user_permissions') || []
    return userPermissions.includes(permission)
  }
  
  const hasRole = (role: string): boolean => {
    const userInfo = uni.getStorageSync('user_info')
    return userInfo?.role === role
  }
  
  const canManage = (targetRole: string): boolean => {
    const userInfo = uni.getStorageSync('user_info')
    const userLevel = UserRole.getLevel(userInfo?.role)
    const targetLevel = UserRole.getLevel(targetRole)
    return userLevel < targetLevel
  }
  
  return { hasPermission, hasRole, canManage }
}
```

## ğŸ‘¥ ç”¨æˆ·ç®¡ç†

### 2.1 åˆ›å»ºç”¨æˆ·

**åå°åˆ›å»ºç”¨æˆ·ï¼š**
1. è¿›å…¥ Django Admin â†’ ç”¨æˆ·ç®¡ç† â†’ æ·»åŠ ç”¨æˆ·
2. å¡«å†™åŸºæœ¬ä¿¡æ¯ï¼š
   - ç”¨æˆ·åï¼ˆå¿…å¡«ï¼‰
   - é‚®ç®±
   - æ‰‹æœºå·
   - çœŸå®å§“å
   - è§’è‰²ï¼ˆå¿…é€‰ï¼‰
3. è®¾ç½®ç”¨æˆ·çŠ¶æ€ï¼š
   - æ˜¯å¦æ¿€æ´»
   - ç®¡ç†å‘˜å®¡æ‰¹çŠ¶æ€
4. ä¿å­˜ç”¨æˆ·

**APIåˆ›å»ºç”¨æˆ·ï¼š**
```python
# ç”¨æˆ·åˆ›å»ºAPI
class UserCreateView(APIView):
    permission_classes = [IsAuthenticated, IsAdminUser]
    
    def post(self, request):
        serializer = UserCreateSerializer(data=request.data)
        if serializer.is_valid():
            user = serializer.save()
            
            # è®°å½•æ“ä½œæ—¥å¿—
            PermissionAuditLogger.log_user_creation(
                operator=request.user,
                target_user=user,
                ip_address=get_client_ip(request)
            )
            
            return Response({
                'status': 'success',
                'user_id': user.id,
                'message': 'ç”¨æˆ·åˆ›å»ºæˆåŠŸ'
            })
        
        return Response({
            'status': 'error',
            'errors': serializer.errors
        }, status=400)
```

### 2.2 ç”¨æˆ·è§’è‰²å˜æ›´

**è§’è‰²å˜æ›´æµç¨‹ï¼š**
```python
# è§’è‰²å˜æ›´æœåŠ¡
class RoleChangeService:
    @staticmethod
    def change_user_role(user_id: int, new_role: str, operator_id: int):
        with transaction.atomic():
            user = CustomUser.objects.get(id=user_id)
            old_role = user.role
            
            # éªŒè¯æƒé™
            if not RolePermissionChecker.can_change_role(operator_id, old_role, new_role):
                raise PermissionDenied('æ— æƒé™å˜æ›´æ­¤è§’è‰²')
            
            # æ›´æ–°è§’è‰²
            user.role = new_role
            user.save()
            
            # æ¸…é™¤æƒé™ç¼“å­˜
            PermissionCacheManager.clear_user_cache(user_id)
            
            # å‘é€WebSocketé€šçŸ¥
            WebSocketNotifier.notify_permission_change(user_id)
            
            # è®°å½•å®¡è®¡æ—¥å¿—
            PermissionAuditLogger.log_role_change(
                operator_id=operator_id,
                target_user_id=user_id,
                old_role=old_role,
                new_role=new_role
            )
```

### 2.3 ç”¨æˆ·å¢é¡¹ç®¡ç†

**è·å–ç”¨æˆ·å¢é¡¹æ•°æ®ï¼š**
```python
# ç”¨æˆ·å¢é¡¹æ•°æ®è·å–
class UserExtensionDataView(APIView):
    def get(self, request, user_id):
        user = get_object_or_404(CustomUser, id=user_id)
        
        # è·å–è§’è‰²å¢é¡¹é…ç½®
        role_extensions = RoleExtension.objects.filter(
            role=user.role,
            is_active=True
        ).order_by('sort_order')
        
        # è·å–ç”¨æˆ·å¢é¡¹æ•°æ®
        user_data = UserExtensionData.objects.filter(
            user=user
        ).select_related('role_extension')
        
        # æ„å»ºå“åº”æ•°æ®
        extension_data = []
        for extension in role_extensions:
            user_value = user_data.filter(role_extension=extension).first()
            extension_data.append({
                'field_name': extension.field_name,
                'field_label': extension.field_label,
                'field_type': extension.field_type,
                'is_required': extension.is_required,
                'field_value': user_value.field_value if user_value else ''
            })
        
        return Response(extension_data)
```

## ğŸ­ è§’è‰²ç®¡ç†

### 3.1 è§’è‰²å±‚çº§ä½“ç³»

**è§’è‰²å±‚çº§å®šä¹‰ï¼š**
```python
class UserRole(models.TextChoices):
    ADMIN = 'admin', 'ç®¡ç†å‘˜'
    DEAN = 'dean', 'æ•™å¯¼ä¸»ä»»'
    ACADEMIC_DIRECTOR = 'academic_director', 'æ•™åŠ¡ä¸»ä»»'
    RESEARCH_LEADER = 'research_leader', 'æ•™ç ”ç»„é•¿'
    TEACHER = 'teacher', 'æ•™å¸ˆ'
    PARENT = 'parent', 'å®¶é•¿'
    STUDENT = 'student', 'å­¦ç”Ÿ'
    
    @classmethod
    def get_role_hierarchy(cls):
        return {
            cls.ADMIN: 0,
            cls.DEAN: 1,
            cls.ACADEMIC_DIRECTOR: 2,
            cls.RESEARCH_LEADER: 2,
            cls.TEACHER: 3,
            cls.PARENT: 3,
            cls.STUDENT: 4
        }
    
    @classmethod
    def can_manage(cls, manager_role, target_role):
        hierarchy = cls.get_role_hierarchy()
        return hierarchy.get(manager_role, 999) < hierarchy.get(target_role, 999)
```

### 3.2 è§’è‰²æƒé™é…ç½®

**é»˜è®¤æƒé™åˆ†é…ï¼š**
```python
# è§’è‰²é»˜è®¤æƒé™é…ç½®
ROLE_DEFAULT_PERMISSIONS = {
    'admin': [
        'view_all_users', 'manage_users', 'manage_roles',
        'manage_permissions', 'view_audit_logs', 'system_settings'
    ],
    'dean': [
        'view_teachers', 'manage_teachers', 'view_students',
        'manage_academic', 'view_reports'
    ],
    'academic_director': [
        'view_teachers', 'manage_courses', 'view_students',
        'manage_academic', 'view_academic_reports'
    ],
    'research_leader': [
        'view_teachers', 'manage_research', 'view_teaching_materials',
        'manage_teaching_methods'
    ],
    'teacher': [
        'view_own_students', 'manage_own_classes', 'view_teaching_materials',
        'submit_reports'
    ],
    'parent': [
        'view_own_children', 'view_children_progress', 'communicate_teachers'
    ],
    'student': [
        'view_own_profile', 'access_learning_materials', 'submit_assignments'
    ]
}

# æƒé™åˆ†é…æœåŠ¡
class RolePermissionService:
    @staticmethod
    def assign_default_permissions(role: str):
        permissions = ROLE_DEFAULT_PERMISSIONS.get(role, [])
        users = CustomUser.objects.filter(role=role)
        
        for user in users:
            # æ¸…é™¤ç°æœ‰æƒé™ç¼“å­˜
            PermissionCacheManager.clear_user_cache(user.id)
            
            # å‘é€æƒé™æ›´æ–°é€šçŸ¥
            WebSocketNotifier.notify_permission_change(user.id)
```

### 3.3 è§’è‰²å¢é¡¹é…ç½®

**åˆ›å»ºè§’è‰²å¢é¡¹ï¼š**
```python
# è§’è‰²å¢é¡¹ç®¡ç†å‘½ä»¤
class Command(BaseCommand):
    help = 'åˆ›å»ºé»˜è®¤è§’è‰²å¢é¡¹é…ç½®'
    
    def handle(self, *args, **options):
        # åŸºç¡€å¢é¡¹å­—æ®µï¼ˆæ‰€æœ‰è§’è‰²é€šç”¨ï¼‰
        base_extensions = [
            {
                'field_name': 'real_name',
                'field_label': 'çœŸå®å§“å',
                'field_type': 'text',
                'is_required': True,
                'sort_order': 1
            },
            {
                'field_name': 'phone',
                'field_label': 'è”ç³»ç”µè¯',
                'field_type': 'phone',
                'is_required': True,
                'sort_order': 2
            },
            {
                'field_name': 'avatar',
                'field_label': 'å¤´åƒ',
                'field_type': 'image',
                'is_required': False,
                'sort_order': 3
            }
        ]
        
        # ä¸ºæ¯ä¸ªè§’è‰²åˆ›å»ºåŸºç¡€å¢é¡¹
        for role_choice in UserRole.choices:
            role = role_choice[0]
            for extension_data in base_extensions:
                RoleExtension.objects.get_or_create(
                    role=role,
                    field_name=extension_data['field_name'],
                    defaults=extension_data
                )
        
        # è§’è‰²ç‰¹å®šå¢é¡¹
        self.create_teacher_extensions()
        self.create_student_extensions()
        self.create_parent_extensions()
    
    def create_teacher_extensions(self):
        teacher_extensions = [
            {
                'field_name': 'subject',
                'field_label': 'ä»»æ•™ç§‘ç›®',
                'field_type': 'choice',
                'is_required': True,
                'sort_order': 10
            },
            {
                'field_name': 'teaching_experience',
                'field_label': 'æ•™å­¦ç»éªŒï¼ˆå¹´ï¼‰',
                'field_type': 'number',
                'is_required': False,
                'sort_order': 11
            }
        ]
        
        for extension_data in teacher_extensions:
            RoleExtension.objects.get_or_create(
                role='teacher',
                field_name=extension_data['field_name'],
                defaults=extension_data
            )
```

## ğŸ” æƒé™é…ç½®

### 4.1 æƒé™æ£€æŸ¥æœºåˆ¶

**æƒé™éªŒè¯è£…é¥°å™¨ï¼š**
```python
# æƒé™éªŒè¯è£…é¥°å™¨
def permission_required(permission_name):
    def decorator(view_func):
        @wraps(view_func)
        def wrapper(request, *args, **kwargs):
            if not request.user.is_authenticated:
                return JsonResponse({'error': 'æœªç™»å½•'}, status=401)
            
            # æ£€æŸ¥æƒé™
            if not PermissionChecker.has_permission(request.user, permission_name):
                # è®°å½•æƒé™æ‹’ç»æ—¥å¿—
                PermissionAuditLogger.log_permission_denied(
                    user=request.user,
                    permission=permission_name,
                    resource=request.path,
                    ip_address=get_client_ip(request)
                )
                return JsonResponse({'error': 'æƒé™ä¸è¶³'}, status=403)
            
            return view_func(request, *args, **kwargs)
        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@permission_required('manage_users')
def user_management_view(request):
    # ç”¨æˆ·ç®¡ç†é€»è¾‘
    pass
```

### 4.2 åŠ¨æ€æƒé™æ›´æ–°

**æƒé™æ›´æ–°æœåŠ¡ï¼š**
```python
class PermissionUpdateService:
    @staticmethod
    def update_role_permissions(role: str, permissions: List[str], operator_id: int):
        """æ›´æ–°è§’è‰²æƒé™"""
        with transaction.atomic():
            # è·å–è¯¥è§’è‰²çš„æ‰€æœ‰ç”¨æˆ·
            users = CustomUser.objects.filter(role=role)
            
            # æ‰¹é‡æ¸…é™¤æƒé™ç¼“å­˜
            for user in users:
                PermissionCacheManager.clear_user_cache(user.id)
            
            # å‘é€WebSocketé€šçŸ¥
            for user in users:
                channel_layer = get_channel_layer()
                async_to_sync(channel_layer.group_send)(
                    f'user_{user.id}',
                    {
                        'type': 'permission_update',
                        'data': {
                            'permissions': permissions,
                            'role': role,
                            'timestamp': timezone.now().isoformat()
                        }
                    }
                )
            
            # è®°å½•æƒé™å˜æ›´æ—¥å¿—
            PermissionAuditLogger.log_permission_update(
                operator_id=operator_id,
                role=role,
                permissions=permissions,
                affected_users=list(users.values_list('id', flat=True))
            )
    
    @staticmethod
    def update_user_permissions(user_id: int, permissions: List[str], operator_id: int):
        """æ›´æ–°å•ä¸ªç”¨æˆ·æƒé™"""
        with transaction.atomic():
            # æ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜
            PermissionCacheManager.clear_user_cache(user_id)
            
            # å‘é€WebSocketé€šçŸ¥
            channel_layer = get_channel_layer()
            async_to_sync(channel_layer.group_send)(
                f'user_{user_id}',
                {
                    'type': 'permission_update',
                    'data': {
                        'permissions': permissions,
                        'timestamp': timezone.now().isoformat()
                    }
                }
            )
            
            # è®°å½•æƒé™å˜æ›´æ—¥å¿—
            PermissionAuditLogger.log_user_permission_update(
                operator_id=operator_id,
                target_user_id=user_id,
                permissions=permissions
            )
```

## ğŸ›ï¸ èœå•ç®¡ç†

### 5.1 èœå•é…ç½®

**èœå•æƒé™æ˜ å°„ï¼š**
```typescript
// èœå•æƒé™é…ç½®
const MENU_PERMISSION_CONFIG = {
  // å­¦ä¹ æ¨¡å—
  learning: {
    permission: 'access_learning',
    roles: ['student', 'teacher', 'parent'],
    children: {
      vocabulary: { permission: 'view_vocabulary' },
      reading: { permission: 'view_reading' },
      listening: { permission: 'view_listening' },
      speaking: { permission: 'view_speaking' }
    }
  },
  
  // ç®¡ç†æ¨¡å—
  management: {
    permission: 'access_management',
    roles: ['admin', 'dean', 'academic_director'],
    children: {
      users: { permission: 'manage_users' },
      roles: { permission: 'manage_roles' },
      permissions: { permission: 'manage_permissions' },
      audit: { permission: 'view_audit_logs' }
    }
  },
  
  // æ•™å­¦æ¨¡å—
  teaching: {
    permission: 'access_teaching',
    roles: ['teacher', 'dean', 'academic_director', 'research_leader'],
    children: {
      classes: { permission: 'manage_classes' },
      students: { permission: 'view_students' },
      materials: { permission: 'manage_materials' },
      reports: { permission: 'view_reports' }
    }
  }
}
```

### 5.2 åŠ¨æ€èœå•ç”Ÿæˆ

**èœå•ç”ŸæˆæœåŠ¡ï¼š**
```typescript
export class MenuGenerationService {
  static async generateUserMenu(userId: string): Promise<MenuItem[]> {
    // 1. æ£€æŸ¥èœå•ç¼“å­˜
    const cachedMenu = await this.getCachedMenu(userId)
    if (cachedMenu) {
      return cachedMenu
    }
    
    // 2. è·å–ç”¨æˆ·æƒé™å’Œè§’è‰²
    const userInfo = await api.getUserInfo(userId)
    const permissions = await api.getUserPermissions(userId)
    
    // 3. ç”ŸæˆåŸºç¡€èœå•
    const baseMenu = this.getBaseMenuTemplate()
    
    // 4. æƒé™è¿‡æ»¤
    const filteredMenu = this.filterMenuByPermissions(baseMenu, permissions, userInfo.role)
    
    // 5. èœå•ä¼˜åŒ–
    const optimizedMenu = this.optimizeMenuStructure(filteredMenu)
    
    // 6. ç¼“å­˜èœå•
    await this.cacheUserMenu(userId, optimizedMenu)
    
    return optimizedMenu
  }
  
  private static filterMenuByPermissions(
    menu: MenuItem[], 
    permissions: string[], 
    userRole: string
  ): MenuItem[] {
    return menu.filter(item => {
      const config = MENU_PERMISSION_CONFIG[item.key]
      
      // æ£€æŸ¥è§’è‰²æƒé™
      if (config?.roles && !config.roles.includes(userRole)) {
        return false
      }
      
      // æ£€æŸ¥å…·ä½“æƒé™
      if (config?.permission && !permissions.includes(config.permission)) {
        return false
      }
      
      // é€’å½’è¿‡æ»¤å­èœå•
      if (item.children) {
        item.children = this.filterMenuByPermissions(item.children, permissions, userRole)
        // å¦‚æœå­èœå•ä¸ºç©ºï¼Œéšè—çˆ¶èœå•
        if (item.children.length === 0) {
          return false
        }
      }
      
      return true
    })
  }
  
  private static async cacheUserMenu(userId: string, menu: MenuItem[]): Promise<void> {
    const cacheKey = `user_menu_${userId}`
    await uni.setStorage({
      key: cacheKey,
      data: {
        menu,
        timestamp: Date.now(),
        version: await this.getMenuVersion()
      }
    })
  }
}
```

## ğŸ“Š ç³»ç»Ÿç›‘æ§

### 6.1 æƒé™å®¡è®¡æ—¥å¿—

**å®¡è®¡æ—¥å¿—è®°å½•ï¼š**
```python
class PermissionAuditLogger:
    @staticmethod
    def log_permission_check(user, permission, resource, result, ip_address=None):
        """è®°å½•æƒé™æ£€æŸ¥æ—¥å¿—"""
        PermissionAuditLog.objects.create(
            action_type='permission_check',
            result='granted' if result else 'denied',
            operator=user,
            permission=permission,
            resource=resource,
            ip_address=ip_address,
            description=f'ç”¨æˆ· {user.username} æ£€æŸ¥æƒé™ {permission}'
        )
    
    @staticmethod
    def log_role_change(operator_id, target_user_id, old_role, new_role):
        """è®°å½•è§’è‰²å˜æ›´æ—¥å¿—"""
        operator = CustomUser.objects.get(id=operator_id)
        target_user = CustomUser.objects.get(id=target_user_id)
        
        PermissionAuditLog.objects.create(
            action_type='role_change',
            result='success',
            operator=operator,
            target_user=target_user,
            description=f'è§’è‰²ä» {old_role} å˜æ›´ä¸º {new_role}'
        )
    
    @staticmethod
    def log_permission_update(operator_id, role, permissions, affected_users):
        """è®°å½•æƒé™æ›´æ–°æ—¥å¿—"""
        operator = CustomUser.objects.get(id=operator_id)
        
        PermissionAuditLog.objects.create(
            action_type='permission_update',
            result='success',
            operator=operator,
            description=f'æ›´æ–°è§’è‰² {role} æƒé™ï¼Œå½±å“ç”¨æˆ· {len(affected_users)} äºº',
            metadata={
                'role': role,
                'permissions': permissions,
                'affected_users': affected_users
            }
        )
```

### 6.2 ç³»ç»Ÿå¥åº·æ£€æŸ¥

**å¥åº·æ£€æŸ¥æœåŠ¡ï¼š**
```python
class SystemHealthChecker:
    @staticmethod
    def check_permission_system():
        """æ£€æŸ¥æƒé™ç³»ç»Ÿå¥åº·çŠ¶æ€"""
        try:
            # æ£€æŸ¥æ•°æ®åº“è¿æ¥
            db_status = DatabaseHealthChecker.check()
            
            # æ£€æŸ¥Redisè¿æ¥
            redis_status = RedisHealthChecker.check()
            
            # æ£€æŸ¥WebSocketè¿æ¥
            websocket_status = WebSocketHealthChecker.check()
            
            # æ£€æŸ¥æƒé™ç¼“å­˜
            cache_status = PermissionCacheChecker.check()
            
            return {
                'status': 'healthy',
                'components': {
                    'database': db_status,
                    'redis': redis_status,
                    'websocket': websocket_status,
                    'permission_cache': cache_status
                },
                'timestamp': timezone.now().isoformat()
            }
        except Exception as e:
            return {
                'status': 'unhealthy',
                'error': str(e),
                'timestamp': timezone.now().isoformat()
            }
```

## ğŸ”§ æ•…éšœæ’é™¤

### 7.1 å¸¸è§é—®é¢˜

**é—®é¢˜1ï¼šç”¨æˆ·æƒé™ä¸ç”Ÿæ•ˆ**
```bash
# æ£€æŸ¥æ­¥éª¤
1. æ£€æŸ¥ç”¨æˆ·è§’è‰²æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥æƒé™ç¼“å­˜æ˜¯å¦è¿‡æœŸ
3. æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€
4. æ¸…é™¤æƒé™ç¼“å­˜å¹¶é‡æ–°ç™»å½•

# è§£å†³æ–¹æ¡ˆ
python manage.py shell
>>> from apps.permissions.cache import PermissionCacheManager
>>> PermissionCacheManager.clear_user_cache(user_id)
```

**é—®é¢˜2ï¼šèœå•ä¸æ˜¾ç¤º**
```bash
# æ£€æŸ¥æ­¥éª¤
1. æ£€æŸ¥ç”¨æˆ·æƒé™é…ç½®
2. æ£€æŸ¥èœå•æƒé™æ˜ å°„
3. æ£€æŸ¥å‰ç«¯èœå•ç¼“å­˜
4. æ£€æŸ¥èœå•ç”Ÿæˆé€»è¾‘

# è§£å†³æ–¹æ¡ˆ
# æ¸…é™¤å‰ç«¯èœå•ç¼“å­˜
uni.removeStorageSync('user_menu_' + userId)
```

**é—®é¢˜3ï¼šWebSocketè¿æ¥å¤±è´¥**
```bash
# æ£€æŸ¥æ­¥éª¤
1. æ£€æŸ¥WebSocketæœåŠ¡çŠ¶æ€
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. æ£€æŸ¥è®¤è¯token
4. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

# è§£å†³æ–¹æ¡ˆ
# é‡å¯WebSocketæœåŠ¡
sudo systemctl restart daphne
```

### 7.2 æ—¥å¿—åˆ†æ

**æƒé™ç›¸å…³æ—¥å¿—æŸ¥çœ‹ï¼š**
```bash
# æŸ¥çœ‹æƒé™æ£€æŸ¥æ—¥å¿—
python manage.py shell
>>> from apps.permissions.models import PermissionAuditLog
>>> logs = PermissionAuditLog.objects.filter(
...     action_type='permission_check',
...     result='denied'
... ).order_by('-created_at')[:10]
>>> for log in logs:
...     print(f"{log.created_at}: {log.operator.username} - {log.permission} - {log.result}")

# æŸ¥çœ‹è§’è‰²å˜æ›´æ—¥å¿—
>>> role_changes = PermissionAuditLog.objects.filter(
...     action_type='role_change'
... ).order_by('-created_at')[:10]
```

## ğŸ”Œ APIæ¥å£

### 8.1 ç”¨æˆ·ç®¡ç†API

```python
# è·å–ç”¨æˆ·åˆ—è¡¨
GET /api/users/
Response: {
    "count": 100,
    "results": [
        {
            "id": 1,
            "username": "admin",
            "email": "admin@example.com",
            "role": "admin",
            "is_active": true,
            "created_at": "2025-01-01T00:00:00Z"
        }
    ]
}

# åˆ›å»ºç”¨æˆ·
POST /api/users/
Request: {
    "username": "newuser",
    "email": "newuser@example.com",
    "role": "student",
    "real_name": "æ–°ç”¨æˆ·",
    "phone": "13800138000"
}

# æ›´æ–°ç”¨æˆ·è§’è‰²
PATCH /api/users/{id}/role/
Request: {
    "role": "teacher"
}
```

### 8.2 æƒé™ç®¡ç†API

```python
# è·å–ç”¨æˆ·æƒé™
GET /api/permissions/user/{user_id}/
Response: {
    "permissions": [
        "view_students",
        "manage_classes",
        "view_reports"
    ],
    "role": "teacher"
}

# æ›´æ–°è§’è‰²æƒé™
POST /api/permissions/role/{role}/update/
Request: {
    "permissions": [
        "view_students",
        "manage_classes",
        "submit_reports"
    ]
}
```

### 8.3 èœå•ç®¡ç†API

```python
# è·å–ç”¨æˆ·èœå•
GET /api/menus/user/{user_id}/
Response: {
    "menus": [
        {
            "key": "learning",
            "title": "å­¦ä¹ ",
            "icon": "book",
            "children": [
                {
                    "key": "vocabulary",
                    "title": "è¯æ±‡å­¦ä¹ ",
                    "path": "/learning/vocabulary"
                }
            ]
        }
    ]
}

# åˆ·æ–°ç”¨æˆ·èœå•ç¼“å­˜
POST /api/menus/user/{user_id}/refresh/
Response: {
    "status": "success",
    "message": "èœå•ç¼“å­˜å·²åˆ·æ–°"
}
```

---

**æ³¨æ„äº‹é¡¹ï¼š**
1. æ‰€æœ‰æƒé™å˜æ›´æ“ä½œéƒ½ä¼šè®°å½•å®¡è®¡æ—¥å¿—
2. æƒé™ç¼“å­˜é»˜è®¤30åˆ†é’Ÿè¿‡æœŸ
3. WebSocketè¿æ¥å¼‚å¸¸æ—¶ä¼šè‡ªåŠ¨é‡è¿
4. å»ºè®®å®šæœŸå¤‡ä»½æƒé™é…ç½®æ•°æ®

**æŠ€æœ¯æ”¯æŒï¼š**
å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚