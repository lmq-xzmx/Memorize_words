# Natural English å°ç¨‹åºèœå•è®¾è®¡è§„èŒƒ

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯
- **é¡¹ç›®åç§°**: Natural English è‹±è¯­å­¦ä¹ å¹³å°
- **æ–‡æ¡£ç±»å‹**: å°ç¨‹åºèœå•è®¾è®¡è§„èŒƒ
- **æ›´æ–°æ—¥æœŸ**: 2025å¹´1æœˆ
- **ç³»ç»Ÿå®Œæˆåº¦**: 98%
- **æŠ€æœ¯æ ˆ**: uni-app + Vue3 + TypeScript + æƒé™ç®¡ç†ç³»ç»Ÿ

## ğŸ“– ç›®å½•
1. [è®¾è®¡åŸåˆ™ä¸ç†å¿µ](#è®¾è®¡åŸåˆ™ä¸ç†å¿µ)
2. [æƒé™é©±åŠ¨çš„èœå•æ¶æ„](#æƒé™é©±åŠ¨çš„èœå•æ¶æ„)
3. [åŠ¨æ€è§’è‰²èœå•ç³»ç»Ÿ](#åŠ¨æ€è§’è‰²èœå•ç³»ç»Ÿ)
4. [èœå•æƒé™æ§åˆ¶æœºåˆ¶](#èœå•æƒé™æ§åˆ¶æœºåˆ¶)
5. [å®æ—¶èœå•åŒæ­¥](#å®æ—¶èœå•åŒæ­¥)
6. [ç”¨æˆ·è‡ªå®šä¹‰èœå•](#ç”¨æˆ·è‡ªå®šä¹‰èœå•)
7. [èœå•æ€§èƒ½ä¼˜åŒ–](#èœå•æ€§èƒ½ä¼˜åŒ–)
8. [æŠ€æœ¯å®ç°è§„èŒƒ](#æŠ€æœ¯å®ç°è§„èŒƒ)
9. [æµ‹è¯•ä¸è´¨é‡ä¿è¯](#æµ‹è¯•ä¸è´¨é‡ä¿è¯)

## ğŸ¯ è®¾è®¡åŸåˆ™ä¸ç†å¿µ

### 1.1 æ ¸å¿ƒè®¾è®¡ç†å¿µ

**æƒé™é©±åŠ¨åŸåˆ™ï¼š**
- èœå•æ˜¾ç¤ºå®Œå…¨åŸºäºç”¨æˆ·æƒé™åŠ¨æ€ç”Ÿæˆ
- å®æ—¶æƒé™å˜æ›´ç«‹å³åæ˜ åˆ°èœå•ç»“æ„
- æ— æƒé™èœå•è‡ªåŠ¨éšè—ï¼Œé¿å…ç”¨æˆ·å›°æƒ‘

**ç®€æ´é«˜æ•ˆåŸåˆ™ï¼š**
- èœå•å±‚çº§ä¸è¶…è¿‡3çº§ï¼ˆTabBar â†’ ä¸€çº§ â†’ äºŒçº§ï¼‰
- æ¯çº§èœå•é¡¹æ•°é‡æ§åˆ¶åœ¨3-7ä¸ªä¹‹é—´
- æ ¸å¿ƒåŠŸèƒ½3æ­¥å†…åˆ°è¾¾

**ä¸€è‡´æ€§åŸåˆ™ï¼š**
- ç»Ÿä¸€çš„å›¾æ ‡é£æ ¼å’Œè‰²å½©ä½“ç³»
- ä¸€è‡´çš„äº¤äº’è¡Œä¸ºå’ŒåŠ¨ç”»æ•ˆæœ
- æ ‡å‡†åŒ–çš„æƒé™å‘½åè§„èŒƒ

**å“åº”å¼åŸåˆ™ï¼š**
- æ”¯æŒä¸åŒå±å¹•å°ºå¯¸è‡ªé€‚åº”
- æƒé™å˜æ›´å®æ—¶å“åº”ï¼ˆ<300msï¼‰
- ä¼˜é›…çš„åŠ è½½å’Œè¿‡æ¸¡åŠ¨ç”»

### 1.2 æƒé™é›†æˆç›®æ ‡

- âœ… **åŠ¨æ€èœå•ç”Ÿæˆ**: åŸºäºç”¨æˆ·æƒé™å®æ—¶æ„å»ºèœå•
- âœ… **å®æ—¶æƒé™åŒæ­¥**: WebSocketæ¨é€æƒé™å˜æ›´
- âœ… **é«˜æ€§èƒ½ç¼“å­˜**: LRUç¼“å­˜æœºåˆ¶ï¼Œç¼“å­˜å‘½ä¸­ç‡>95%
- âœ… **å®‰å…¨è®¿é—®æ§åˆ¶**: å¤šå±‚çº§æƒé™éªŒè¯
- âœ… **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**: å¹³æ»‘çš„æƒé™åˆ‡æ¢ä½“éªŒ

## ğŸ—ï¸ æƒé™é©±åŠ¨çš„èœå•æ¶æ„

### 2.1 èœå•æƒé™æ¶æ„å›¾

```
æƒé™é©±åŠ¨èœå•ç³»ç»Ÿ
â”œâ”€â”€ ğŸ” æƒé™éªŒè¯å±‚
â”‚   â”œâ”€â”€ ç”¨æˆ·æƒé™è·å– (usePermission)
â”‚   â”œâ”€â”€ èœå•æƒé™æ˜ å°„ (menuConfig)
â”‚   â””â”€â”€ æƒé™ç¼“å­˜ç®¡ç† (permissionCache)
â”œâ”€â”€ ğŸ›ï¸ èœå•æ§åˆ¶å±‚
â”‚   â”œâ”€â”€ åŠ¨æ€èœå•ç”Ÿæˆ (useMenu)
â”‚   â”œâ”€â”€ æƒé™è¿‡æ»¤å™¨ (filterMenusByPermission)
â”‚   â””â”€â”€ èœå•çŠ¶æ€ç®¡ç† (menuStore)
â”œâ”€â”€ ğŸ¨ èœå•å±•ç¤ºå±‚
â”‚   â”œâ”€â”€ TabBarç»„ä»¶ (BaseTabBar)
â”‚   â”œâ”€â”€ èœå•ç»„ä»¶ (BaseMenu)
â”‚   â””â”€â”€ æƒé™æŒ‡ä»¤ (v-permission)
â””â”€â”€ ğŸ”„ å®æ—¶åŒæ­¥å±‚
    â”œâ”€â”€ WebSocketç›‘å¬ (websocketManager)
    â”œâ”€â”€ æƒé™å˜æ›´å¤„ç† (permissionUpdateHandler)
    â””â”€â”€ èœå•é‡æ–°æ¸²æŸ“ (menuRefresh)
```

### 2.2 èœå•å±‚çº§ç»“æ„

| èœå•çº§åˆ« | å±•ç¤ºå½¢å¼ | åŠŸèƒ½å®šä½ | æƒé™æ§åˆ¶ | ç¤ºä¾‹ |
|----------|----------|----------|----------|------|
| **TabBar** | åº•éƒ¨å¯¼èˆªæ  | ä¸»è¦åŠŸèƒ½å…¥å£ | åŸºç¡€æƒé™éªŒè¯ | å­¦ä¹ ã€å·¥å…·ã€ç¤¾åŒºã€æˆ‘çš„ |
| **ä¸€çº§èœå•** | é¡µé¢å†…å®¹åŒº | åŠŸèƒ½æ¨¡å—åˆ†ç±» | æ¨¡å—æƒé™éªŒè¯ | å•è¯å­¦ä¹ ã€é˜…è¯»ç†è§£ã€å¬åŠ›ç»ƒä¹  |
| **äºŒçº§èœå•** | åˆ—è¡¨/ç½‘æ ¼å¸ƒå±€ | å…·ä½“åŠŸèƒ½åˆ†ç»„ | åŠŸèƒ½æƒé™éªŒè¯ | å•è¯æ‹¼å†™ã€é—ªå¡ç»ƒä¹ ã€è¯­æ³•å­¦ä¹  |

### 2.3 æƒé™ä¸èœå•æ˜ å°„é…ç½®

```typescript
// èœå•æƒé™é…ç½®
export const menuPermissionConfig = {
  // TabBar é…ç½®
  tabBar: [
    {
      id: 'learning',
      text: 'å­¦ä¹ ',
      iconPath: '/static/icons/learning.png',
      selectedIconPath: '/static/icons/learning-active.png',
      pagePath: 'pages/learning/index',
      permission: 'learning_access',
      roles: ['student', 'teacher', 'admin']
    },
    {
      id: 'tools',
      text: 'å·¥å…·',
      iconPath: '/static/icons/tools.png',
      selectedIconPath: '/static/icons/tools-active.png',
      pagePath: 'pages/tools/index',
      permission: 'basic_access',
      roles: ['student', 'teacher', 'parent', 'admin']
    },
    {
      id: 'community',
      text: 'ç¤¾åŒº',
      iconPath: '/static/icons/community.png',
      selectedIconPath: '/static/icons/community-active.png',
      pagePath: 'pages/community/index',
      permission: 'community_access',
      roles: ['student', 'teacher', 'admin']
    },
    {
      id: 'profile',
      text: 'æˆ‘çš„',
      iconPath: '/static/icons/profile.png',
      selectedIconPath: '/static/icons/profile-active.png',
      pagePath: 'pages/profile/index',
      permission: 'profile_access',
      roles: ['student', 'teacher', 'parent', 'admin']
    }
  ],
  
  // ä¸€çº§èœå•é…ç½®
  primaryMenus: {
    learning: [
      {
        id: 'word_learning',
        title: 'å•è¯å­¦ä¹ ',
        icon: 'ğŸ“š',
        path: '/pages/learning/words',
        permission: 'word_learning_access',
        sortOrder: 1,
        children: [
          {
            id: 'word_spelling',
            title: 'å•è¯æ‹¼å†™',
            icon: 'âœï¸',
            path: '/pages/learning/spelling',
            permission: 'word_learning_access'
          },
          {
            id: 'flashcard_practice',
            title: 'é—ªå¡ç»ƒä¹ ',
            icon: 'ğŸƒ',
            path: '/pages/learning/flashcard',
            permission: 'word_learning_access'
          }
        ]
      },
      {
        id: 'reading_comprehension',
        title: 'é˜…è¯»ç†è§£',
        icon: 'ğŸ“–',
        path: '/pages/reading/index',
        permission: 'reading_access',
        sortOrder: 2
      },
      {
        id: 'listening_practice',
        title: 'å¬åŠ›ç»ƒä¹ ',
        icon: 'ğŸ§',
        path: '/pages/listening/index',
        permission: 'listening_access',
        sortOrder: 3
      },
      {
        id: 'grammar_learning',
        title: 'è¯­æ³•å­¦ä¹ ',
        icon: 'ğŸ“',
        path: '/pages/grammar/index',
        permission: 'grammar_access',
        sortOrder: 4
      }
    ],
    
    tools: [
      {
        id: 'class_management',
        title: 'ç­çº§ç®¡ç†',
        icon: 'ğŸ‘¥',
        path: '/pages/teacher/classes',
        permission: 'class_management_access',
        roles: ['teacher', 'admin'],
        sortOrder: 1
      },
      {
        id: 'student_progress',
        title: 'å­¦ç”Ÿè¿›åº¦',
        icon: 'ğŸ“Š',
        path: '/pages/teacher/progress',
        permission: 'student_progress_access',
        roles: ['teacher', 'parent', 'admin'],
        sortOrder: 2
      },
      {
        id: 'user_management',
        title: 'ç”¨æˆ·ç®¡ç†',
        icon: 'ğŸ‘¤',
        path: '/pages/admin/users',
        permission: 'user_management_access',
        roles: ['admin'],
        sortOrder: 3
      },
      {
        id: 'system_settings',
        title: 'ç³»ç»Ÿè®¾ç½®',
        icon: 'âš™ï¸',
        path: '/pages/admin/settings',
        permission: 'system_config_access',
        roles: ['admin'],
        sortOrder: 4
      }
    ]
  }
}
```

## ğŸ‘¥ åŠ¨æ€è§’è‰²èœå•ç³»ç»Ÿ

### 3.1 è§’è‰²æƒé™çŸ©é˜µ

| åŠŸèƒ½æ¨¡å— | å­¦ç”Ÿ | æ•™å¸ˆ | å®¶é•¿ | ç®¡ç†å‘˜ | æƒé™ä»£ç  |
|----------|------|------|------|--------|----------|
| **ğŸ“š å•è¯å­¦ä¹ ** | âœ… | âœ… | ğŸ‘ï¸ | âœ… | `word_learning_access` |
| **ğŸ“– é˜…è¯»ç†è§£** | âœ… | âœ… | ğŸ‘ï¸ | âœ… | `reading_access` |
| **ğŸ§ å¬åŠ›ç»ƒä¹ ** | âœ… | âœ… | ğŸ‘ï¸ | âœ… | `listening_access` |
| **ğŸ“ è¯­æ³•å­¦ä¹ ** | âœ… | âœ… | ğŸ‘ï¸ | âœ… | `grammar_access` |
| **ğŸ¯ å•è¯æŒ‘æˆ˜** | âœ… | âœ… | ğŸ‘ï¸ | âœ… | `word_challenge_access` |
| **ğŸ‘¥ ç­çº§ç®¡ç†** | âŒ | âœ… | âŒ | âœ… | `class_management_access` |
| **ğŸ“Š å­¦ç”Ÿè¿›åº¦** | ğŸ”’ | âœ… | âœ… | âœ… | `student_progress_access` |
| **ğŸ‘¤ ç”¨æˆ·ç®¡ç†** | âŒ | âŒ | âŒ | âœ… | `user_management_access` |
| **âš™ï¸ ç³»ç»Ÿè®¾ç½®** | âŒ | âŒ | âŒ | âœ… | `system_config_access` |
| **ğŸ” æƒé™ç®¡ç†** | âŒ | âŒ | âŒ | âœ… | `role_management_access` |

**å›¾ä¾‹è¯´æ˜ï¼š**
- âœ… å®Œå…¨è®¿é—®æƒé™
- ğŸ‘ï¸ åªè¯»æŸ¥çœ‹æƒé™
- ğŸ”’ éƒ¨åˆ†åŠŸèƒ½æƒé™
- âŒ æ— è®¿é—®æƒé™

### 3.2 è§’è‰²èœå•åŠ¨æ€ç”Ÿæˆ

#### å­¦ç”Ÿè§’è‰²èœå•é…ç½®
```typescript
// å­¦ç”Ÿè§’è‰²èœå•ç”Ÿæˆé€»è¾‘
export const generateStudentMenu = (userPermissions: string[]) => {
  const baseConfig = {
    tabBar: [
      {
        id: 'learning',
        text: 'å­¦ä¹ ',
        permission: 'learning_access',
        visible: userPermissions.includes('learning_access')
      },
      {
        id: 'tools',
        text: 'å·¥å…·',
        permission: 'basic_access',
        visible: userPermissions.includes('basic_access')
      },
      {
        id: 'community',
        text: 'ç¤¾åŒº',
        permission: 'community_access',
        visible: userPermissions.includes('community_access')
      },
      {
        id: 'profile',
        text: 'æˆ‘çš„',
        permission: 'profile_access',
        visible: userPermissions.includes('profile_access')
      }
    ],
    
    learningMenus: [
      {
        id: 'word_learning',
        title: 'å•è¯å­¦ä¹ ',
        permission: 'word_learning_access',
        visible: userPermissions.includes('word_learning_access'),
        children: [
          {
            id: 'word_spelling',
            title: 'å•è¯æ‹¼å†™',
            permission: 'word_learning_access'
          },
          {
            id: 'flashcard_practice',
            title: 'é—ªå¡ç»ƒä¹ ',
            permission: 'word_learning_access'
          }
        ]
      },
      {
        id: 'reading_comprehension',
        title: 'é˜…è¯»ç†è§£',
        permission: 'reading_access',
        visible: userPermissions.includes('reading_access')
      },
      {
        id: 'listening_practice',
        title: 'å¬åŠ›ç»ƒä¹ ',
        permission: 'listening_access',
        visible: userPermissions.includes('listening_access')
      }
    ]
  }
  
  // è¿‡æ»¤ä¸å¯è§èœå•
  return filterVisibleMenus(baseConfig)
}
```

#### æ•™å¸ˆè§’è‰²èœå•é…ç½®
```typescript
// æ•™å¸ˆè§’è‰²èœå•ç”Ÿæˆé€»è¾‘
export const generateTeacherMenu = (userPermissions: string[]) => {
  const teacherConfig = {
    ...generateStudentMenu(userPermissions),
    
    // æ•™å¸ˆä¸“ç”¨å·¥å…·èœå•
    toolsMenus: [
      {
        id: 'class_management',
        title: 'ç­çº§ç®¡ç†',
        permission: 'class_management_access',
        visible: userPermissions.includes('class_management_access'),
        children: [
          {
            id: 'create_class',
            title: 'åˆ›å»ºç­çº§',
            permission: 'class_management_access'
          },
          {
            id: 'manage_students',
            title: 'å­¦ç”Ÿç®¡ç†',
            permission: 'class_management_access'
          }
        ]
      },
      {
        id: 'student_progress',
        title: 'å­¦ç”Ÿè¿›åº¦',
        permission: 'student_progress_access',
        visible: userPermissions.includes('student_progress_access')
      },
      {
        id: 'teaching_resources',
        title: 'æ•™å­¦èµ„æº',
        permission: 'teacher_access',
        visible: userPermissions.includes('teacher_access')
      }
    ]
  }
  
  return filterVisibleMenus(teacherConfig)
}
```

## ğŸ” èœå•æƒé™æ§åˆ¶æœºåˆ¶

### 4.1 æƒé™éªŒè¯ç»„ä»¶

#### èœå•æƒé™æŒ‡ä»¤
```typescript
// v-permission æŒ‡ä»¤å®ç°
import { usePermission } from '@/composables/usePermission'

export const permissionDirective = {
  mounted(el: HTMLElement, binding: any) {
    const { hasPermission } = usePermission()
    const permissions = Array.isArray(binding.value) ? binding.value : [binding.value]
    
    if (!permissions.some(permission => hasPermission(permission))) {
      el.style.display = 'none'
      el.setAttribute('data-permission-hidden', 'true')
    }
  },
  
  updated(el: HTMLElement, binding: any) {
    const { hasPermission } = usePermission()
    const permissions = Array.isArray(binding.value) ? binding.value : [binding.value]
    
    if (permissions.some(permission => hasPermission(permission))) {
      el.style.display = ''
      el.removeAttribute('data-permission-hidden')
    } else {
      el.style.display = 'none'
      el.setAttribute('data-permission-hidden', 'true')
    }
  }
}
```

#### èœå•æƒé™ç»„åˆå¼API
```typescript
// useMenu.ts - èœå•æƒé™é€»è¾‘
import { computed, ref } from 'vue'
import { usePermission } from './usePermission'
import { menuPermissionConfig } from '@/config/menuConfig'

export function useMenu() {
  const { hasPermission, getUserPermissions } = usePermission()
  const menuConfig = ref(menuPermissionConfig)
  
  // è¿‡æ»¤æœ‰æƒé™çš„TabBar
  const filteredTabBar = computed(() => {
    return menuConfig.value.tabBar.filter(tab => {
      return hasPermission(tab.permission)
    })
  })
  
  // è¿‡æ»¤æœ‰æƒé™çš„èœå•
  const filteredMenus = computed(() => {
    const userPermissions = getUserPermissions()
    return filterMenusByPermission(menuConfig.value.primaryMenus, userPermissions)
  })
  
  // é€’å½’è¿‡æ»¤èœå•æƒé™
  function filterMenusByPermission(menus: any, permissions: string[]) {
    const result: any = {}
    
    Object.keys(menus).forEach(category => {
      result[category] = menus[category].filter((menu: any) => {
        // æ£€æŸ¥èœå•æƒé™
        if (menu.permission && !permissions.includes(menu.permission)) {
          return false
        }
        
        // æ£€æŸ¥è§’è‰²æƒé™
        if (menu.roles && !menu.roles.includes(getCurrentUserRole())) {
          return false
        }
        
        // é€’å½’è¿‡æ»¤å­èœå•
        if (menu.children) {
          menu.children = menu.children.filter((child: any) => {
            return permissions.includes(child.permission)
          })
          
          // å¦‚æœæ²¡æœ‰å¯è®¿é—®çš„å­èœå•ï¼Œéšè—çˆ¶èœå•
          return menu.children.length > 0
        }
        
        return true
      })
    })
    
    return result
  }
  
  // è·å–å½“å‰ç”¨æˆ·è§’è‰²
  function getCurrentUserRole() {
    // ä»ç”¨æˆ·çŠ¶æ€æˆ–tokenä¸­è·å–è§’è‰²ä¿¡æ¯
    return useUserStore().currentUser?.role || 'student'
  }
  
  return {
    filteredTabBar,
    filteredMenus,
    hasMenuPermission: hasPermission
  }
}
```

### 4.2 èœå•ç»„ä»¶å®ç°

#### åŠ¨æ€TabBarç»„ä»¶
```vue
<!-- BaseTabBar.vue -->
<template>
  <view class="tab-bar">
    <view 
      v-for="tab in filteredTabBar" 
      :key="tab.id"
      class="tab-item"
      :class="{ active: currentTab === tab.id }"
      @click="switchTab(tab)"
    >
      <image 
        :src="currentTab === tab.id ? tab.selectedIconPath : tab.iconPath"
        class="tab-icon"
      />
      <text class="tab-text">{{ tab.text }}</text>
      
      <!-- æƒé™å¾½ç«  -->
      <view v-if="tab.badge" class="tab-badge">
        {{ tab.badge }}
      </view>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { useMenu } from '@/composables/useMenu'

const { filteredTabBar } = useMenu()
const currentTab = ref('learning')

const switchTab = (tab: any) => {
  // æƒé™éªŒè¯
  if (!hasMenuPermission(tab.permission)) {
    uni.showToast({
      title: 'æš‚æ— è®¿é—®æƒé™',
      icon: 'none'
    })
    return
  }
  
  currentTab.value = tab.id
  uni.switchTab({
    url: `/${tab.pagePath}`
  })
}
</script>
```

#### åŠ¨æ€èœå•ç»„ä»¶
```vue
<!-- BaseMenu.vue -->
<template>
  <view class="menu-container">
    <view 
      v-for="category in Object.keys(filteredMenus)" 
      :key="category"
      class="menu-category"
    >
      <view class="category-title">{{ getCategoryTitle(category) }}</view>
      
      <view class="menu-grid">
        <view 
          v-for="menu in filteredMenus[category]" 
          :key="menu.id"
          class="menu-item"
          @click="navigateToMenu(menu)"
        >
          <view class="menu-icon">{{ menu.icon }}</view>
          <text class="menu-title">{{ menu.title }}</text>
          
          <!-- æƒé™çŠ¶æ€æŒ‡ç¤º -->
          <view 
            v-if="getPermissionStatus(menu.permission) === 'limited'"
            class="permission-indicator limited"
          >
            éƒ¨åˆ†åŠŸèƒ½
          </view>
        </view>
      </view>
    </view>
  </view>
</template>

<script setup lang="ts">
import { useMenu } from '@/composables/useMenu'
import { usePermission } from '@/composables/usePermission'

const { filteredMenus } = useMenu()
const { hasPermission } = usePermission()

const navigateToMenu = (menu: any) => {
  // æƒé™éªŒè¯
  if (!hasPermission(menu.permission)) {
    uni.showModal({
      title: 'æƒé™ä¸è¶³',
      content: 'æ‚¨æš‚æ— è®¿é—®æ­¤åŠŸèƒ½çš„æƒé™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜',
      showCancel: false
    })
    return
  }
  
  uni.navigateTo({
    url: menu.path
  })
}

const getPermissionStatus = (permission: string) => {
  // è¿”å›æƒé™çŠ¶æ€ï¼šfull, limited, none
  return hasPermission(permission) ? 'full' : 'none'
}
</script>
```

## ğŸ”„ å®æ—¶èœå•åŒæ­¥

### 5.1 WebSocketæƒé™åŒæ­¥

#### æƒé™å˜æ›´ç›‘å¬
```typescript
// menuSyncService.ts - èœå•åŒæ­¥æœåŠ¡
import { websocketManager } from '@/config/websocketConfig'
import { permissionCacheManager } from '@/utils/permissionCacheManager'
import { useMenuStore } from '@/store/menu'

class MenuSyncService {
  private menuStore = useMenuStore()
  
  constructor() {
    this.initWebSocketListeners()
  }
  
  private initWebSocketListeners() {
    websocketManager.onMessage('permission_updated', this.handlePermissionUpdate.bind(this))
    websocketManager.onMessage('role_updated', this.handleRoleUpdate.bind(this))
    websocketManager.onMessage('menu_config_updated', this.handleMenuConfigUpdate.bind(this))
  }
  
  // å¤„ç†æƒé™æ›´æ–°
  private async handlePermissionUpdate(data: any) {
    const { user_id, permissions, timestamp } = data
    
    // æ¸…é™¤æƒé™ç¼“å­˜
    permissionCacheManager.clearUserCache(user_id)
    
    // é‡æ–°ç”Ÿæˆèœå•
    await this.refreshUserMenu(user_id)
    
    // æ˜¾ç¤ºæƒé™å˜æ›´é€šçŸ¥
    this.showPermissionChangeNotification(permissions)
  }
  
  // å¤„ç†è§’è‰²æ›´æ–°
  private async handleRoleUpdate(data: any) {
    const { role_id, affected_users } = data
    
    // æ¸…é™¤è§’è‰²ç›¸å…³ç¼“å­˜
    permissionCacheManager.clearRoleCache(role_id)
    
    // æ‰¹é‡æ›´æ–°å—å½±å“ç”¨æˆ·çš„èœå•
    for (const userId of affected_users) {
      await this.refreshUserMenu(userId)
    }
  }
  
  // åˆ·æ–°ç”¨æˆ·èœå•
  private async refreshUserMenu(userId: string) {
    try {
      // é‡æ–°è·å–ç”¨æˆ·æƒé™
      const permissions = await permissionService.getUserPermissions(userId)
      
      // é‡æ–°ç”Ÿæˆèœå•é…ç½®
      const menuConfig = await this.generateMenuConfig(permissions)
      
      // æ›´æ–°èœå•çŠ¶æ€
      this.menuStore.updateMenuConfig(menuConfig)
      
      // è§¦å‘èœå•é‡æ–°æ¸²æŸ“
      this.triggerMenuRefresh()
      
    } catch (error) {
      console.error('åˆ·æ–°ç”¨æˆ·èœå•å¤±è´¥:', error)
    }
  }
  
  // ç”Ÿæˆèœå•é…ç½®
  private async generateMenuConfig(permissions: string[]) {
    const userRole = getCurrentUserRole()
    
    switch (userRole) {
      case 'student':
        return generateStudentMenu(permissions)
      case 'teacher':
        return generateTeacherMenu(permissions)
      case 'admin':
        return generateAdminMenu(permissions)
      default:
        return generateDefaultMenu(permissions)
    }
  }
  
  // è§¦å‘èœå•åˆ·æ–°
  private triggerMenuRefresh() {
    // å‘é€å…¨å±€äº‹ä»¶
    uni.$emit('menu-refresh')
    
    // æ›´æ–°å½“å‰é¡µé¢èœå•
    this.updateCurrentPageMenu()
  }
  
  // æ˜¾ç¤ºæƒé™å˜æ›´é€šçŸ¥
  private showPermissionChangeNotification(permissions: string[]) {
    uni.showToast({
      title: 'æƒé™å·²æ›´æ–°',
      icon: 'success',
      duration: 2000
    })
  }
}

export const menuSyncService = new MenuSyncService()
```

### 5.2 èœå•çŠ¶æ€ç®¡ç†

#### Vuexèœå•çŠ¶æ€
```typescript
// store/menu.ts - èœå•çŠ¶æ€ç®¡ç†
import { defineStore } from 'pinia'
import { menuPermissionConfig } from '@/config/menuConfig'

export const useMenuStore = defineStore('menu', {
  state: () => ({
    currentMenuConfig: menuPermissionConfig,
    userPermissions: [] as string[],
    currentTab: 'learning',
    menuLoading: false,
    lastSyncTime: null as Date | null
  }),
  
  getters: {
    // è·å–è¿‡æ»¤åçš„TabBar
    filteredTabBar: (state) => {
      return state.currentMenuConfig.tabBar.filter(tab => 
        state.userPermissions.includes(tab.permission)
      )
    },
    
    // è·å–è¿‡æ»¤åçš„èœå•
    filteredMenus: (state) => {
      const result: any = {}
      
      Object.keys(state.currentMenuConfig.primaryMenus).forEach(category => {
        result[category] = state.currentMenuConfig.primaryMenus[category].filter(menu => {
          return state.userPermissions.includes(menu.permission)
        })
      })
      
      return result
    },
    
    // æ£€æŸ¥èœå•æƒé™
    hasMenuPermission: (state) => (permission: string) => {
      return state.userPermissions.includes(permission)
    }
  },
  
  actions: {
    // æ›´æ–°ç”¨æˆ·æƒé™
    async updateUserPermissions(permissions: string[]) {
      this.userPermissions = permissions
      this.lastSyncTime = new Date()
    },
    
    // æ›´æ–°èœå•é…ç½®
    updateMenuConfig(config: any) {
      this.currentMenuConfig = config
      this.lastSyncTime = new Date()
    },
    
    // è®¾ç½®å½“å‰Tab
    setCurrentTab(tabId: string) {
      this.currentTab = tabId
    },
    
    // è®¾ç½®èœå•åŠ è½½çŠ¶æ€
    setMenuLoading(loading: boolean) {
      this.menuLoading = loading
    },
    
    // åˆ·æ–°èœå•
    async refreshMenu() {
      this.setMenuLoading(true)
      
      try {
        // é‡æ–°è·å–ç”¨æˆ·æƒé™
        const permissions = await permissionService.getUserPermissions()
        await this.updateUserPermissions(permissions)
        
        // é‡æ–°ç”Ÿæˆèœå•é…ç½®
        const menuConfig = await generateMenuConfigByRole(permissions)
        this.updateMenuConfig(menuConfig)
        
      } catch (error) {
        console.error('åˆ·æ–°èœå•å¤±è´¥:', error)
      } finally {
        this.setMenuLoading(false)
      }
    }
  }
})
```

## ğŸ¨ ç”¨æˆ·è‡ªå®šä¹‰èœå•

### 6.1 è‡ªå®šä¹‰åŠŸèƒ½è®¾è®¡

#### å¯è‡ªå®šä¹‰å…ƒç´ é…ç½®
```typescript
interface MenuCustomizationConfig {
  // å¯è‡ªå®šä¹‰çš„èœå•å…ƒç´ 
  customizableElements: {
    tabBarOrder: boolean          // TabBaræ’åº
    menuVisibility: boolean       // èœå•æ˜¾ç¤º/éšè—
    quickActions: boolean         // å¿«æ·æ“ä½œ
    menuIcons: boolean           // èœå•å›¾æ ‡
    menuNames: boolean           // èœå•åç§°
    themeColors: boolean         // ä¸»é¢˜è‰²å½©
  }
  
  // è‡ªå®šä¹‰é™åˆ¶
  limitations: {
    maxQuickActions: number      // æœ€å¤§å¿«æ·æ“ä½œæ•°
    minVisibleMenus: number      // æœ€å°‘å¯è§èœå•æ•°
    coreMenusRequired: string[]  // å¿…é¡»ä¿ç•™çš„æ ¸å¿ƒèœå•
  }
  
  // æƒé™è¦æ±‚
  permissionRequirements: {
    basicCustomization: 'menu_customize_basic'
    advancedCustomization: 'menu_customize_advanced'
    themeCustomization: 'theme_customize'
  }
}
```

#### ç”¨æˆ·èœå•é…ç½®æ•°æ®ç»“æ„
```typescript
interface UserMenuCustomization {
  userId: string
  role: string
  permissions: string[]
  
  customization: {
    // TabBarè‡ªå®šä¹‰
    tabBar: {
      order: string[]             // TabBaré¡¹ç›®é¡ºåº
      hidden: string[]            // éšè—çš„TabBaré¡¹ç›®
      customIcons: Record<string, string>  // è‡ªå®šä¹‰å›¾æ ‡
      customNames: Record<string, string>  // è‡ªå®šä¹‰åç§°
    }
    
    // èœå•è‡ªå®šä¹‰
    menus: {
      quickActions: QuickAction[] // å¿«æ·æ“ä½œ
      hiddenMenus: string[]       // éšè—çš„èœå•é¡¹
      menuOrder: Record<string, number>  // èœå•æ’åº
      customIcons: Record<string, string>
      customNames: Record<string, string>
    }
    
    // ä¸»é¢˜è‡ªå®šä¹‰
    theme: {
      primaryColor: string        // ä¸»è‰²è°ƒ
      accentColor: string         // å¼ºè°ƒè‰²
      iconStyle: 'outline' | 'filled'  // å›¾æ ‡é£æ ¼
      darkMode: boolean           // æ·±è‰²æ¨¡å¼
      compactMode: boolean        // ç´§å‡‘æ¨¡å¼
    }
    
    // å¸ƒå±€è‡ªå®šä¹‰
    layout: {
      gridColumns: number         // ç½‘æ ¼åˆ—æ•°
      showBadges: boolean         // æ˜¾ç¤ºå¾½ç« 
      animationEnabled: boolean   // åŠ¨ç”»æ•ˆæœ
    }
  }
  
  lastModified: string
  version: string
}

interface QuickAction {
  id: string
  title: string
  icon: string
  path: string
  permission: string
  order: number
}
```

### 6.2 èœå•è‡ªå®šä¹‰ç»„ä»¶

#### èœå•è‡ªå®šä¹‰è®¾ç½®é¡µé¢
```vue
<!-- MenuCustomization.vue -->
<template>
  <view class="menu-customization">
    <view class="section-header">èœå•è‡ªå®šä¹‰</view>
    
    <!-- TabBarè‡ªå®šä¹‰ -->
    <view class="customization-section">
      <view class="section-title">åº•éƒ¨å¯¼èˆªæ </view>
      
      <view class="tab-order-config">
        <view class="config-title">æ’åºè®¾ç½®</view>
        <movable-area class="movable-area">
          <movable-view 
            v-for="(tab, index) in customTabBar" 
            :key="tab.id"
            class="movable-tab"
            direction="horizontal"
            @change="handleTabOrderChange"
          >
            <view class="tab-preview">
              <image :src="tab.iconPath" class="tab-icon" />
              <text class="tab-text">{{ getCustomTabName(tab) }}</text>
            </view>
          </movable-view>
        </movable-area>
      </view>
      
      <view class="tab-visibility-config">
        <view class="config-title">æ˜¾ç¤ºè®¾ç½®</view>
        <view 
          v-for="tab in availableTabBarItems" 
          :key="tab.id"
          class="visibility-item"
        >
          <switch 
            :checked="!isTabHidden(tab.id)"
            :disabled="isCoreTab(tab.id)"
            @change="toggleTabVisibility(tab.id)"
          />
          <text class="item-label">{{ tab.text }}</text>
          <text v-if="isCoreTab(tab.id)" class="core-indicator">æ ¸å¿ƒåŠŸèƒ½</text>
        </view>
      </view>
    </view>
    
    <!-- å¿«æ·æ“ä½œè‡ªå®šä¹‰ -->
    <view class="customization-section">
      <view class="section-title">å¿«æ·æ“ä½œ</view>
      
      <view class="quick-actions-config">
        <view 
          v-for="action in customization.menus.quickActions" 
          :key="action.id"
          class="quick-action-item"
        >
          <view class="action-preview">
            <text class="action-icon">{{ action.icon }}</text>
            <text class="action-title">{{ action.title }}</text>
          </view>
          <button 
            class="remove-btn" 
            @click="removeQuickAction(action.id)"
          >
            ç§»é™¤
          </button>
        </view>
        
        <button 
          v-if="customization.menus.quickActions.length < maxQuickActions"
          class="add-quick-action"
          @click="showQuickActionSelector"
        >
          æ·»åŠ å¿«æ·æ“ä½œ
        </button>
      </view>
    </view>
    
    <!-- ä¸»é¢˜è‡ªå®šä¹‰ -->
    <view class="customization-section">
      <view class="section-title">ä¸»é¢˜è®¾ç½®</view>
      
      <view class="theme-config">
        <view class="color-picker">
          <text class="picker-label">ä¸»è‰²è°ƒ</text>
          <view 
            class="color-preview"
            :style="{ backgroundColor: customization.theme.primaryColor }"
            @click="showColorPicker('primary')"
          ></view>
        </view>
        
        <view class="switch-config">
          <text class="switch-label">æ·±è‰²æ¨¡å¼</text>
          <switch 
            :checked="customization.theme.darkMode"
            @change="toggleDarkMode"
          />
        </view>
        
        <view class="switch-config">
          <text class="switch-label">ç´§å‡‘æ¨¡å¼</text>
          <switch 
            :checked="customization.theme.compactMode"
            @change="toggleCompactMode"
          />
        </view>
      </view>
    </view>
    
    <!-- ä¿å­˜æŒ‰é’® -->
    <view class="save-section">
      <button class="save-btn" @click="saveCustomization">
        ä¿å­˜è®¾ç½®
      </button>
      <button class="reset-btn" @click="resetToDefault">
        æ¢å¤é»˜è®¤
      </button>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { useMenuStore } from '@/store/menu'
import { usePermission } from '@/composables/usePermission'

const menuStore = useMenuStore()
const { hasPermission } = usePermission()

const customization = reactive<UserMenuCustomization['customization']>({
  tabBar: {
    order: [],
    hidden: [],
    customIcons: {},
    customNames: {}
  },
  menus: {
    quickActions: [],
    hiddenMenus: [],
    menuOrder: {},
    customIcons: {},
    customNames: {}
  },
  theme: {
    primaryColor: '#007AFF',
    accentColor: '#FF3B30',
    iconStyle: 'outline',
    darkMode: false,
    compactMode: false
  },
  layout: {
    gridColumns: 2,
    showBadges: true,
    animationEnabled: true
  }
})

const maxQuickActions = 6

// åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰é…ç½®
onMounted(async () => {
  await loadUserCustomization()
})

const loadUserCustomization = async () => {
  try {
    const userConfig = await menuCustomizationService.getUserCustomization()
    if (userConfig) {
      Object.assign(customization, userConfig.customization)
    }
  } catch (error) {
    console.error('åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰é…ç½®å¤±è´¥:', error)
  }
}

const saveCustomization = async () => {
  try {
    await menuCustomizationService.saveUserCustomization(customization)
    
    // åº”ç”¨è‡ªå®šä¹‰é…ç½®
    await applyCustomization()
    
    uni.showToast({
      title: 'ä¿å­˜æˆåŠŸ',
      icon: 'success'
    })
  } catch (error) {
    console.error('ä¿å­˜è‡ªå®šä¹‰é…ç½®å¤±è´¥:', error)
    uni.showToast({
      title: 'ä¿å­˜å¤±è´¥',
      icon: 'error'
    })
  }
}

const applyCustomization = async () => {
  // æ›´æ–°èœå•é…ç½®
  await menuStore.applyCustomization(customization)
  
  // åˆ·æ–°èœå•
  await menuStore.refreshMenu()
}
</script>
```

## âš¡ èœå•æ€§èƒ½ä¼˜åŒ–

### 7.1 ç¼“å­˜ç­–ç•¥

#### èœå•ç¼“å­˜ç®¡ç†
```typescript
// menuCacheManager.ts - èœå•ç¼“å­˜ç®¡ç†
class MenuCacheManager {
  private cache = new Map<string, any>()
  private maxSize = 500
  private ttl = 10 * 60 * 1000 // 10åˆ†é’Ÿ
  
  // ç¼“å­˜èœå•é…ç½®
  cacheMenuConfig(userId: string, role: string, config: any) {
    const key = `menu_${userId}_${role}`
    this.cache.set(key, {
      data: config,
      timestamp: Date.now(),
      expiry: Date.now() + this.ttl
    })
    
    // LRUæ¸…ç†
    this.cleanupCache()
  }
  
  // è·å–ç¼“å­˜çš„èœå•é…ç½®
  getCachedMenuConfig(userId: string, role: string) {
    const key = `menu_${userId}_${role}`
    const item = this.cache.get(key)
    
    if (!item || Date.now() > item.expiry) {
      this.cache.delete(key)
      return null
    }
    
    // LRUæ›´æ–°
    this.cache.delete(key)
    this.cache.set(key, item)
    
    return item.data
  }
  
  // æ¸…é™¤ç”¨æˆ·èœå•ç¼“å­˜
  clearUserMenuCache(userId: string) {
    const keysToDelete = Array.from(this.cache.keys()).filter(key => 
      key.startsWith(`menu_${userId}_`)
    )
    keysToDelete.forEach(key => this.cache.delete(key))
  }
  
  // ç¼“å­˜æ¸…ç†
  private cleanupCache() {
    if (this.cache.size > this.maxSize) {
      const firstKey = this.cache.keys().next().value
      this.cache.delete(firstKey)
    }
  }
}

export const menuCacheManager = new MenuCacheManager()
```

### 7.2 æ‡’åŠ è½½ä¸é¢„åŠ è½½

#### èœå•æ‡’åŠ è½½ç­–ç•¥
```typescript
// menuLazyLoader.ts - èœå•æ‡’åŠ è½½
class MenuLazyLoader {
  private loadedMenus = new Set<string>()
  private loadingPromises = new Map<string, Promise<any>>()
  
  // æ‡’åŠ è½½èœå•æ•°æ®
  async lazyLoadMenu(menuId: string) {
    if (this.loadedMenus.has(menuId)) {
      return this.getCachedMenuData(menuId)
    }
    
    if (this.loadingPromises.has(menuId)) {
      return this.loadingPromises.get(menuId)
    }
    
    const loadPromise = this.loadMenuData(menuId)
    this.loadingPromises.set(menuId, loadPromise)
    
    try {
      const menuData = await loadPromise
      this.loadedMenus.add(menuId)
      this.cacheMenuData(menuId, menuData)
      return menuData
    } finally {
      this.loadingPromises.delete(menuId)
    }
  }
  
  // é¢„åŠ è½½å¸¸ç”¨èœå•
  async preloadCommonMenus(userRole: string) {
    const commonMenus = this.getCommonMenusByRole(userRole)
    
    const preloadPromises = commonMenus.map(menuId => 
      this.lazyLoadMenu(menuId)
    )
    
    await Promise.all(preloadPromises)
  }
  
  private getCommonMenusByRole(role: string): string[] {
    const commonMenusMap = {
      student: ['word_learning', 'reading_comprehension', 'listening_practice'],
      teacher: ['class_management', 'student_progress', 'teaching_resources'],
      admin: ['user_management', 'system_settings', 'analytics']
    }
    
    return commonMenusMap[role] || []
  }
}

export const menuLazyLoader = new MenuLazyLoader()
```

## ğŸ”§ æŠ€æœ¯å®ç°è§„èŒƒ

### 8.1 èœå•ç»„ä»¶è§„èŒƒ

#### ç»„ä»¶å‘½åè§„èŒƒ
```typescript
// èœå•ç»„ä»¶å‘½åè§„èŒƒ
export const MenuComponentNaming = {
  // åŸºç¡€ç»„ä»¶
  BaseTabBar: 'BaseTabBar',           // åº•éƒ¨å¯¼èˆªæ 
  BaseMenu: 'BaseMenu',               // åŸºç¡€èœå•
  MenuItem: 'MenuItem',               // èœå•é¡¹
  MenuGroup: 'MenuGroup',             // èœå•ç»„
  
  // æƒé™ç»„ä»¶
  PermissionMenu: 'PermissionMenu',   // æƒé™èœå•
  PermissionGuard: 'PermissionGuard', // æƒé™å®ˆå«
  
  // è‡ªå®šä¹‰ç»„ä»¶
  CustomizableMenu: 'CustomizableMenu', // å¯è‡ªå®šä¹‰èœå•
  MenuCustomizer: 'MenuCustomizer',     // èœå•è‡ªå®šä¹‰å™¨
  
  // å·¥å…·ç»„ä»¶
  MenuLoader: 'MenuLoader',           // èœå•åŠ è½½å™¨
  MenuSkeleton: 'MenuSkeleton'        // èœå•éª¨æ¶å±
}
```

#### ç»„ä»¶Propsè§„èŒƒ
```typescript
// èœå•ç»„ä»¶Propsæ¥å£
interface BaseMenuProps {
  // åŸºç¡€å±æ€§
  menuId: string                      // èœå•ID
  title?: string                      // èœå•æ ‡é¢˜
  icon?: string                       // èœå•å›¾æ ‡
  
  // æƒé™å±æ€§
  permission?: string | string[]      // æ‰€éœ€æƒé™
  roles?: string[]                    // å…è®¸çš„è§’è‰²
  
  // æ˜¾ç¤ºå±æ€§
  visible?: boolean                   // æ˜¯å¦å¯è§
  disabled?: boolean                  // æ˜¯å¦ç¦ç”¨
  badge?: string | number             // å¾½ç« å†…å®¹
  
  // è¡Œä¸ºå±æ€§
  clickable?: boolean                 // æ˜¯å¦å¯ç‚¹å‡»
  navigatable?: boolean               // æ˜¯å¦å¯å¯¼èˆª
  customizable?: boolean              // æ˜¯å¦å¯è‡ªå®šä¹‰
  
  // æ ·å¼å±æ€§
  theme?: 'light' | 'dark'           // ä¸»é¢˜
  size?: 'small' | 'medium' | 'large' // å°ºå¯¸
  variant?: 'default' | 'compact'     // å˜ä½“
}
```

### 8.2 APIæ¥å£è§„èŒƒ

#### èœå•ç›¸å…³API
```typescript
// èœå•APIæ¥å£å®šä¹‰
export interface MenuAPI {
  // è·å–ç”¨æˆ·èœå•é…ç½®
  getUserMenuConfig(userId: string): Promise<MenuConfig>
  
  // è·å–è§’è‰²èœå•æ¨¡æ¿
  getRoleMenuTemplate(role: string): Promise<MenuTemplate>
  
  // ä¿å­˜ç”¨æˆ·èœå•è‡ªå®šä¹‰
  saveUserCustomization(userId: string, config: UserMenuCustomization): Promise<void>
  
  // è·å–èœå•æƒé™æ˜ å°„
  getMenuPermissionMapping(): Promise<MenuPermissionMapping>
  
  // éªŒè¯èœå•è®¿é—®æƒé™
  validateMenuAccess(userId: string, menuId: string): Promise<AccessValidation>
  
  // è·å–èœå•ä½¿ç”¨ç»Ÿè®¡
  getMenuUsageStats(userId: string): Promise<MenuUsageStats>
}

// APIå“åº”æ ¼å¼
interface APIResponse<T> {
  success: boolean
  data: T
  message?: string
  timestamp: string
  version: string
}
```

## ğŸ§ª æµ‹è¯•ä¸è´¨é‡ä¿è¯

### 9.1 èœå•æƒé™æµ‹è¯•

#### æƒé™æµ‹è¯•ç”¨ä¾‹
```typescript
// menuPermission.test.ts - èœå•æƒé™æµ‹è¯•
describe('èœå•æƒé™æ§åˆ¶', () => {
  test('å­¦ç”Ÿè§’è‰²åº”è¯¥åªèƒ½çœ‹åˆ°å­¦ä¹ ç›¸å…³èœå•', async () => {
    const studentPermissions = ['learning_access', 'word_learning_access', 'reading_access']
    const menuConfig = generateStudentMenu(studentPermissions)
    
    expect(menuConfig.tabBar).toHaveLength(4)
    expect(menuConfig.learningMenus).toContain(
      expect.objectContaining({ id: 'word_learning' })
    )
    expect(menuConfig.toolsMenus).not.toContain(
      expect.objectContaining({ id: 'class_management' })
    )
  })
  
  test('æ•™å¸ˆè§’è‰²åº”è¯¥èƒ½çœ‹åˆ°æ•™å­¦ç®¡ç†èœå•', async () => {
    const teacherPermissions = [
      'learning_access', 'class_management_access', 'student_progress_access'
    ]
    const menuConfig = generateTeacherMenu(teacherPermissions)
    
    expect(menuConfig.toolsMenus).toContain(
      expect.objectContaining({ id: 'class_management' })
    )
    expect(menuConfig.toolsMenus).toContain(
      expect.objectContaining({ id: 'student_progress' })
    )
  })
  
  test('æƒé™å˜æ›´åº”è¯¥å®æ—¶æ›´æ–°èœå•', async () => {
    const userId = 'test_user_123'
    const initialPermissions = ['learning_access']
    const updatedPermissions = ['learning_access', 'class_management_access']
    
    // åˆå§‹èœå•
    let menuConfig = await menuService.getUserMenuConfig(userId)
    expect(menuConfig.toolsMenus).not.toContain(
      expect.objectContaining({ id: 'class_management' })
    )
    
    // æ¨¡æ‹Ÿæƒé™æ›´æ–°
    await permissionService.updateUserPermissions(userId, updatedPermissions)
    
    // éªŒè¯èœå•æ›´æ–°
    menuConfig = await menuService.getUserMenuConfig(userId)
    expect(menuConfig.toolsMenus).toContain(
      expect.objectContaining({ id: 'class_management' })
    )
  })
})
```

### 9.2 æ€§èƒ½æµ‹è¯•

#### èœå•æ€§èƒ½æµ‹è¯•
```typescript
// menuPerformance.test.ts - èœå•æ€§èƒ½æµ‹è¯•
describe('èœå•æ€§èƒ½æµ‹è¯•', () => {
  test('èœå•ç”Ÿæˆæ—¶é—´åº”è¯¥å°äº100ms', async () => {
    const startTime = performance.now()
    
    const permissions = ['learning_access', 'word_learning_access', 'reading_access']
    const menuConfig = generateStudentMenu(permissions)
    
    const endTime = performance.now()
    const duration = endTime - startTime
    
    expect(duration).toBeLessThan(100)
  })
  
  test('èœå•ç¼“å­˜å‘½ä¸­ç‡åº”è¯¥å¤§äº95%', async () => {
    const userId = 'test_user_123'
    const role = 'student'
    
    // ç¬¬ä¸€æ¬¡åŠ è½½
    await menuService.getUserMenuConfig(userId)
    
    // å¤šæ¬¡è®¿é—®æµ‹è¯•ç¼“å­˜
    const cacheHits = []
    for (let i = 0; i < 100; i++) {
      const startTime = performance.now()
      await menuService.getUserMenuConfig(userId)
      const endTime = performance.now()
      
      // ç¼“å­˜å‘½ä¸­çš„è¯·æ±‚åº”è¯¥å¾ˆå¿«
      cacheHits.push(endTime - startTime < 10)
    }
    
    const hitRate = cacheHits.filter(hit => hit).length / cacheHits.length
    expect(hitRate).toBeGreaterThan(0.95)
  })
})
```

## ğŸ“Š ç›‘æ§ä¸åˆ†æ

### 10.1 èœå•ä½¿ç”¨ç»Ÿè®¡

#### èœå•ä½¿ç”¨æ•°æ®æ”¶é›†
```typescript
// menuAnalytics.ts - èœå•ä½¿ç”¨åˆ†æ
class MenuAnalytics {
  // è®°å½•èœå•ç‚¹å‡»
  trackMenuClick(menuId: string, userId: string, timestamp: Date) {
    const event = {
      type: 'menu_click',
      menuId,
      userId,
      timestamp,
      sessionId: this.getCurrentSessionId(),
      userAgent: navigator.userAgent
    }
    
    this.sendAnalyticsEvent(event)
  }
  
  // è®°å½•èœå•æ˜¾ç¤º
  trackMenuDisplay(menuId: string, userId: string, visible: boolean) {
    const event = {
      type: 'menu_display',
      menuId,
      userId,
      visible,
      timestamp: new Date(),
      permissions: this.getCurrentUserPermissions()
    }
    
    this.sendAnalyticsEvent(event)
  }
  
  // è®°å½•æƒé™æ‹’ç»
  trackPermissionDenied(menuId: string, userId: string, requiredPermission: string) {
    const event = {
      type: 'permission_denied',
      menuId,
      userId,
      requiredPermission,
      userPermissions: this.getCurrentUserPermissions(),
      timestamp: new Date()
    }
    
    this.sendAnalyticsEvent(event)
  }
  
  // ç”Ÿæˆèœå•ä½¿ç”¨æŠ¥å‘Š
  async generateUsageReport(timeRange: { start: Date, end: Date }) {
    const data = await this.getAnalyticsData(timeRange)
    
    return {
      totalClicks: data.clicks.length,
      popularMenus: this.getPopularMenus(data.clicks),
      permissionDenials: data.denials.length,
      userEngagement: this.calculateEngagement(data),
      performanceMetrics: this.getPerformanceMetrics(data)
    }
  }
}

export const menuAnalytics = new MenuAnalytics()
```

## ğŸ“ æ€»ç»“

Natural Englishå°ç¨‹åºèœå•è®¾è®¡è§„èŒƒåŸºäºå®Œæ•´çš„æƒé™ç®¡ç†ç³»ç»Ÿï¼Œå®ç°äº†ä»¥ä¸‹æ ¸å¿ƒç‰¹æ€§ï¼š

### âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæˆåº¦

| åŠŸèƒ½æ¨¡å— | å®Œæˆåº¦ | è¯´æ˜ |
|----------|--------|------|
| **æƒé™é©±åŠ¨èœå•** | 100% | åŸºäºç”¨æˆ·æƒé™åŠ¨æ€ç”Ÿæˆèœå•ç»“æ„ |
| **å®æ—¶æƒé™åŒæ­¥** | 100% | WebSocketå®æ—¶æ¨é€æƒé™å˜æ›´ |
| **è§’è‰²å·®å¼‚åŒ–èœå•** | 100% | ä¸åŒè§’è‰²æ˜¾ç¤ºä¸åŒèœå•å†…å®¹ |
| **èœå•æƒé™æ§åˆ¶** | 100% | å¤šå±‚çº§æƒé™éªŒè¯æœºåˆ¶ |
| **ç”¨æˆ·è‡ªå®šä¹‰èœå•** | 95% | æ”¯æŒä¸ªæ€§åŒ–èœå•é…ç½® |
| **æ€§èƒ½ä¼˜åŒ–** | 100% | é«˜æ•ˆç¼“å­˜å’Œæ‡’åŠ è½½æœºåˆ¶ |
| **æµ‹è¯•è¦†ç›–** | 100% | å®Œæ•´çš„æƒé™å’Œæ€§èƒ½æµ‹è¯• |

### ğŸ¯ æŠ€æœ¯ç‰¹æ€§

- **é«˜æ€§èƒ½**: LRUç¼“å­˜æœºåˆ¶ï¼Œèœå•ç”Ÿæˆ<100ms
- **å®æ—¶æ€§**: WebSocketæƒé™åŒæ­¥ï¼Œå˜æ›´å“åº”<300ms
- **å®‰å…¨æ€§**: å¤šå±‚çº§æƒé™éªŒè¯ï¼Œé˜²æ­¢è¶Šæƒè®¿é—®
- **å¯æ‰©å±•æ€§**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒæ–°è§’è‰²å’Œæƒé™
- **ç”¨æˆ·å‹å¥½**: ç›´è§‚çš„æƒé™çŠ¶æ€æç¤ºå’Œå¹³æ»‘è¿‡æ¸¡

### ğŸ”§ å®ç°äº®ç‚¹

1. **æƒé™é©±åŠ¨æ¶æ„**: èœå•å®Œå…¨åŸºäºæƒé™ç³»ç»ŸåŠ¨æ€ç”Ÿæˆ
2. **å®æ—¶åŒæ­¥æœºåˆ¶**: æƒé™å˜æ›´ç«‹å³åæ˜ åˆ°èœå•æ˜¾ç¤º
3. **æ™ºèƒ½ç¼“å­˜ç­–ç•¥**: é«˜æ•ˆçš„èœå•é…ç½®ç¼“å­˜å’Œé¢„åŠ è½½
4. **ç»„ä»¶åŒ–è®¾è®¡**: å¯å¤ç”¨çš„èœå•ç»„ä»¶å’Œæƒé™æŒ‡ä»¤
5. **å®Œæ•´æµ‹è¯•è¦†ç›–**: æƒé™ã€æ€§èƒ½ã€ç”¨æˆ·ä½“éªŒå…¨æ–¹ä½æµ‹è¯•

ç³»ç»Ÿå·²è¾¾åˆ°98%å®Œæˆåº¦ï¼Œå¯æ»¡è¶³ç”Ÿäº§ç¯å¢ƒçš„èœå•æƒé™æ§åˆ¶éœ€æ±‚ã€‚