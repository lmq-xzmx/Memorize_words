<!DOCTYPE html>
<html>
<head>
    <title>ç®€å•WebSocketæµ‹è¯•</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>ç®€å•WebSocketè¿æ¥æµ‹è¯•</h1>
    <div id="status">æœªè¿æ¥</div>
    <div id="log"></div>
    
    <script>
        const log = document.getElementById('log');
        const status = document.getElementById('status');
        
        function addLog(message) {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            log.appendChild(div);
            console.log(message);
        }
        
        function updateStatus(text) {
            status.textContent = text;
        }
        
        // æµ‹è¯•WebSocketè¿æ¥
        addLog('å¼€å§‹WebSocketè¿æ¥æµ‹è¯•...');
        updateStatus('è¿æ¥ä¸­...');
        
        const ws = new WebSocket('ws://127.0.0.1:8000/ws/permissions/anonymous/');
        
        ws.onopen = function(event) {
            addLog('âœ… WebSocketè¿æ¥å·²å»ºç«‹');
            updateStatus('å·²è¿æ¥');
            
            // ç«‹å³å‘é€è¿æ¥æ¶ˆæ¯
            const connectMessage = {
                type: 'connect',
                data: {
                    user_id: null,
                    client_info: 'simple-test'
                },
                timestamp: Date.now()
            };
            
            addLog('ğŸ“¤ å‘é€è¿æ¥æ¶ˆæ¯: ' + JSON.stringify(connectMessage));
            ws.send(JSON.stringify(connectMessage));
        };
        
        ws.onmessage = function(event) {
            addLog('ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯: ' + event.data);
            
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'connection_confirmed') {
                    addLog('âœ… è¿æ¥ç¡®è®¤æˆåŠŸ');
                    
                    // å‘é€å¿ƒè·³æµ‹è¯•
                    setTimeout(() => {
                        const heartbeat = {
                            type: 'heartbeat',
                            timestamp: Date.now()
                        };
                        addLog('ğŸ’“ å‘é€å¿ƒè·³: ' + JSON.stringify(heartbeat));
                        ws.send(JSON.stringify(heartbeat));
                    }, 1000);
                }
            } catch (error) {
                addLog('âŒ è§£ææ¶ˆæ¯å¤±è´¥: ' + error.message);
            }
        };
        
        ws.onclose = function(event) {
            addLog(`ğŸ”Œ WebSocketè¿æ¥å·²å…³é—­ - ä»£ç : ${event.code}, åŸå› : ${event.reason || 'æ— '}`);
            updateStatus('å·²æ–­å¼€');
            
            // æ˜¾ç¤ºè¯¦ç»†çš„å…³é—­ä¿¡æ¯
            addLog(`å…³é—­è¯¦æƒ…: wasClean=${event.wasClean}, code=${event.code}`);
        };
        
        ws.onerror = function(error) {
            addLog('âŒ WebSocketé”™è¯¯: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            updateStatus('é”™è¯¯');
            console.error('WebSocket error:', error);
        };
        
        // 5ç§’åä¸»åŠ¨å…³é—­è¿æ¥
        setTimeout(() => {
            if (ws.readyState === WebSocket.OPEN) {
                addLog('â° 5ç§’æµ‹è¯•å®Œæˆï¼Œä¸»åŠ¨å…³é—­è¿æ¥');
                ws.close(1000, 'Test completed');
            }
        }, 5000);
    </script>
</body>
</html>