<!DOCTYPE html>
<html>
<head>
    <title>简单WebSocket测试</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>简单WebSocket连接测试</h1>
    <div id="status">未连接</div>
    <div id="log"></div>
    
    <script>
        const log = document.getElementById('log');
        const status = document.getElementById('status');
        
        function addLog(message) {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            log.appendChild(div);
            console.log(message);
        }
        
        function updateStatus(text) {
            status.textContent = text;
        }
        
        // 测试WebSocket连接
        addLog('开始WebSocket连接测试...');
        updateStatus('连接中...');
        
        const ws = new WebSocket('ws://127.0.0.1:8000/ws/permissions/anonymous/');
        
        ws.onopen = function(event) {
            addLog('✅ WebSocket连接已建立');
            updateStatus('已连接');
            
            // 立即发送连接消息
            const connectMessage = {
                type: 'connect',
                data: {
                    user_id: null,
                    client_info: 'simple-test'
                },
                timestamp: Date.now()
            };
            
            addLog('📤 发送连接消息: ' + JSON.stringify(connectMessage));
            ws.send(JSON.stringify(connectMessage));
        };
        
        ws.onmessage = function(event) {
            addLog('📥 收到消息: ' + event.data);
            
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'connection_confirmed') {
                    addLog('✅ 连接确认成功');
                    
                    // 发送心跳测试
                    setTimeout(() => {
                        const heartbeat = {
                            type: 'heartbeat',
                            timestamp: Date.now()
                        };
                        addLog('💓 发送心跳: ' + JSON.stringify(heartbeat));
                        ws.send(JSON.stringify(heartbeat));
                    }, 1000);
                }
            } catch (error) {
                addLog('❌ 解析消息失败: ' + error.message);
            }
        };
        
        ws.onclose = function(event) {
            addLog(`🔌 WebSocket连接已关闭 - 代码: ${event.code}, 原因: ${event.reason || '无'}`);
            updateStatus('已断开');
            
            // 显示详细的关闭信息
            addLog(`关闭详情: wasClean=${event.wasClean}, code=${event.code}`);
        };
        
        ws.onerror = function(error) {
            addLog('❌ WebSocket错误: ' + (error.message || '未知错误'));
            updateStatus('错误');
            console.error('WebSocket error:', error);
        };
        
        // 5秒后主动关闭连接
        setTimeout(() => {
            if (ws.readyState === WebSocket.OPEN) {
                addLog('⏰ 5秒测试完成，主动关闭连接');
                ws.close(1000, 'Test completed');
            }
        }, 5000);
    </script>
</body>
</html>