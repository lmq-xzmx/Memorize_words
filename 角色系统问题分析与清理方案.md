# è§’è‰²ç³»ç»Ÿé—®é¢˜åˆ†æä¸æ¸…ç†æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

åŸºäºå¯¹ç³»ç»Ÿçš„å…¨é¢åˆ†æï¼Œå‘ç°äº†å¤šä¸ªä¸ç¬¦åˆ"é€šç”¨ç”¨æˆ·ä¿¡æ¯ç»Ÿä¸€ç®¡ç†ï¼Œè§’è‰²å…³è”å¢é¡¹é…ç½®ç®¡ç†"ç›®æ ‡çš„é—®é¢˜ã€‚è¿™äº›é—®é¢˜ä¸»è¦æºäºå†å²é—ç•™çš„åˆ†æ•£è§’è‰²ç®¡ç†æ–¹æ¡ˆå’Œä¸å®Œæ•´çš„ä¼˜åŒ–å®æ–½ã€‚

## ğŸ” å‘ç°çš„ä¸»è¦é—®é¢˜

### 1. æ—§çš„ Proxy æ¨¡å‹é—ç•™é—®é¢˜

#### é—®é¢˜æè¿°
- ç³»ç»Ÿä¸­ä»å­˜åœ¨ `StudentUserProxy`ã€`TeacherUserProxy`ã€`ParentUserProxy`ã€`AdminUserProxy` ç­‰ Proxy æ¨¡å‹çš„æ•°æ®åº“è¿ç§»è®°å½•
- æ—¥å¿—æ˜¾ç¤ºè¿™äº› Proxy æ¨¡å‹çš„ URL ä»åœ¨è¢«è®¿é—®ï¼Œä½†ç°åœ¨è¿”å› 404 é”™è¯¯
- è¿™äº›æ¨¡å‹è¿èƒŒäº†ç»Ÿä¸€ç”¨æˆ·ç®¡ç†çš„ç›®æ ‡

#### å½±å“èŒƒå›´
```
/admin/accounts/studentuserproxy/  -> 404
/admin/accounts/teacheruserproxy/  -> 404  
/admin/accounts/parentuserproxy/   -> 404
```

#### æ¶‰åŠæ–‡ä»¶
- `apps/accounts/migrations/0001_initial.py` - åŒ…å« Proxy æ¨¡å‹å®šä¹‰
- `apps/accounts/migrations/0011_fix_verbose_names.py` - åŒ…å« Proxy æ¨¡å‹åç§°ä¿®å¤
- æ—¥å¿—æ–‡ä»¶æ˜¾ç¤ºå¤§é‡ 404 è®¿é—®è®°å½•

### 2. RoleUserAdmin å­—æ®µé…ç½®é”™è¯¯

#### é—®é¢˜æè¿°
- `RoleUserAdmin` çš„ `list_display` ä¸­é…ç½®äº†ä¸å­˜åœ¨çš„å­—æ®µ `view_extensions_link`
- å¯¼è‡´è®¿é—® `/admin/accounts/roleuser/` æ—¶å‡ºç° `FieldDoesNotExist` é”™è¯¯
- è¿™ä¸ªé—®é¢˜é˜»æ­¢äº†è§’è‰²ç”¨æˆ·ç®¡ç†é¡µé¢çš„æ­£å¸¸ä½¿ç”¨

#### é”™è¯¯ä¿¡æ¯
```
django.core.exceptions.FieldDoesNotExist: RoleUser has no field named 'view_extensions_link'
```

#### æ¶‰åŠæ–‡ä»¶
- `apps/accounts/admin_role_hierarchy.py` - RoleUserAdmin ç±»å®šä¹‰

### 3. è§’è‰²ç®¡ç†æ–¹æ¡ˆä¸ç»Ÿä¸€

#### é—®é¢˜æè¿°
- ç³»ç»Ÿä¸­åŒæ—¶å­˜åœ¨å¤šç§è§’è‰²ç®¡ç†å®ç°ï¼š
  - ç»Ÿä¸€çš„ `CustomUserAdmin` (ç¬¦åˆç›®æ ‡)
  - åˆ†æ•£çš„ `RoleUserAdmin` (éƒ¨åˆ†ç¬¦åˆç›®æ ‡)
  - æ—§çš„ Proxy æ¨¡å‹æ–¹æ¡ˆ (ä¸ç¬¦åˆç›®æ ‡)
- URL è·¯ç”± `http://127.0.0.1:8001/admin/accounts/roleuser/add/` ä½¿ç”¨çš„ä¸æ˜¯æœ€æ–°çš„è§’è‰²æ¨¡å‹

### 4. æ•°æ®åº“è¡¨ä¸ä¸€è‡´é—®é¢˜

#### é—®é¢˜æè¿°
- æŸäº›ç¯å¢ƒä¸­ `accounts_roleusergroup` è¡¨ä¸å­˜åœ¨
- å¯¼è‡´ç›¸å…³åŠŸèƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨

#### é”™è¯¯ä¿¡æ¯
```
sqlite3.OperationalError: no such table: accounts_roleusergroup
```

## ğŸ§¹ æ¸…ç†æ–¹æ¡ˆ

### é˜¶æ®µä¸€ï¼šä¿®å¤ RoleUserAdmin å­—æ®µé”™è¯¯

#### 1.1 ä¿®å¤å­—æ®µé…ç½®
```python
# åœ¨ apps/accounts/admin_role_hierarchy.py ä¸­
class RoleUserAdmin(StandardRoleAdminMixin, admin.ModelAdmin):
    list_display = [
        'user', 'get_user_real_name', 'role_level', 'get_extension_count', 
        'is_active', 'joined_at'  # ç§»é™¤ 'view_extensions_link'
    ]
```

#### 1.2 æ·»åŠ è‡ªå®šä¹‰æ“ä½œæ–¹æ³•
```python
def get_urls(self):
    """æ·»åŠ è‡ªå®šä¹‰URL"""
    urls = super().get_urls()
    custom_urls = [
        path('<int:role_user_id>/extensions/', 
             self.admin_site.admin_view(self.extensions_view), 
             name='roleuser_extensions'),
    ]
    return custom_urls + urls

def extensions_view(self, request, role_user_id):
    """æŸ¥çœ‹ç”¨æˆ·å¢é¡¹"""
    # å®ç°å¢é¡¹æŸ¥çœ‹é€»è¾‘
    pass
```

### é˜¶æ®µäºŒï¼šæ¸…ç† Proxy æ¨¡å‹é—ç•™

#### 2.1 åˆ›å»ºæ¸…ç†è¿ç§»
```python
# åˆ›å»ºæ–°è¿ç§»æ–‡ä»¶æ¸…ç† Proxy æ¨¡å‹
from django.db import migrations

class Migration(migrations.Migration):
    dependencies = [
        ('accounts', '0013_alter_customuser_options_alter_roleextension_options_and_more'),
    ]
    
    operations = [
        # åˆ é™¤ Proxy æ¨¡å‹ï¼ˆè¿™äº›æ“ä½œåœ¨æ•°æ®åº“å±‚é¢æ˜¯æ— æ“ä½œçš„ï¼Œä½†ä¼šæ¸…ç†è¿ç§»å†å²ï¼‰
        migrations.DeleteModel(name='StudentUserProxy'),
        migrations.DeleteModel(name='TeacherUserProxy'), 
        migrations.DeleteModel(name='ParentUserProxy'),
        migrations.DeleteModel(name='AdminUserProxy'),
    ]
```

#### 2.2 æ›´æ–°æ–‡æ¡£å’Œæ³¨é‡Š
- æ›´æ–°æ‰€æœ‰æ–‡æ¡£ï¼Œç§»é™¤å¯¹ Proxy æ¨¡å‹çš„å¼•ç”¨
- æ·»åŠ è¯´æ˜ï¼Œå¼ºè°ƒä½¿ç”¨ç»Ÿä¸€çš„ `CustomUserAdmin` ç®¡ç†æ‰€æœ‰è§’è‰²

### é˜¶æ®µä¸‰ï¼šç»Ÿä¸€è§’è‰²ç®¡ç†æ–¹æ¡ˆ

#### 3.1 é‡æ–°è¯„ä¼° RoleUser æ¨¡å‹çš„å¿…è¦æ€§

**å½“å‰æ¶æ„åˆ†æï¼š**
- `CustomUser` - ä¸»ç”¨æˆ·æ¨¡å‹ï¼ˆåŒ…å« role å­—æ®µï¼‰
- `RoleUser` - è§’è‰²ç”¨æˆ·å…³è”æ¨¡å‹ï¼ˆä¼¼ä¹é‡å¤ï¼‰
- `UserExtension` - ç”¨æˆ·å¢é¡¹æ¨¡å‹

**å»ºè®®ä¼˜åŒ–ï¼š**
1. **ä¿ç•™æ–¹æ¡ˆ**ï¼šå¦‚æœ `RoleUser` æä¾›äº†é¢å¤–çš„è§’è‰²ç®¡ç†åŠŸèƒ½ï¼Œä¿ç•™ä½†ä¼˜åŒ–
2. **ç®€åŒ–æ–¹æ¡ˆ**ï¼šç›´æ¥ä½¿ç”¨ `CustomUser.role` + `UserExtensionData`ï¼Œç§»é™¤ `RoleUser` ä¸­é—´å±‚

#### 3.2 ç»Ÿä¸€å…¥å£ç‚¹

**æ¨èæ–¹æ¡ˆï¼š**
- ä¸»è¦å…¥å£ï¼š`/admin/accounts/customuser/` (CustomUserAdmin)
- å¢é¡¹ç®¡ç†ï¼šé€šè¿‡ CustomUserAdmin çš„å†…è”æˆ–è‡ªå®šä¹‰è§†å›¾
- è§’è‰²é…ç½®ï¼š`/admin/accounts/roleextension/` (RoleExtensionAdmin)

### é˜¶æ®µå››ï¼šæ•°æ®åº“ä¸€è‡´æ€§ä¿®å¤

#### 4.1 ç¡®ä¿æ‰€æœ‰è¿ç§»å·²åº”ç”¨
```bash
python manage.py makemigrations
python manage.py migrate
```

#### 4.2 éªŒè¯è¡¨ç»“æ„
```bash
python manage.py dbshell
.tables  # æ£€æŸ¥æ‰€æœ‰è¡¨æ˜¯å¦å­˜åœ¨
```

## ğŸ¯ ç¬¦åˆç³»ç»Ÿç›®æ ‡çš„æœ€ç»ˆæ¶æ„

### æ ¸å¿ƒåŸåˆ™
1. **å•ä¸€ç”¨æˆ·ç®¡ç†å…¥å£**ï¼šæ‰€æœ‰ç”¨æˆ·é€šè¿‡ `CustomUserAdmin` ç»Ÿä¸€ç®¡ç†
2. **è§’è‰²å­—æ®µé©±åŠ¨**ï¼šåŸºäº `CustomUser.role` å­—æ®µè¿›è¡Œè§’è‰²åŒºåˆ†
3. **å¢é¡¹ç³»ç»Ÿè§£è€¦**ï¼šè§’è‰²å¢é¡¹é€šè¿‡ç‹¬ç«‹çš„é…ç½®ç³»ç»Ÿç®¡ç†
4. **æƒé™ç»§æ‰¿ç®€åŒ–**ï¼šåŸºäºè§’è‰²çš„æƒé™è‡ªåŠ¨åˆ†é…

### æ¨èçš„é¡µé¢ç»“æ„
```
ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
â”œâ”€â”€ ç”¨æˆ·ç®¡ç† (/admin/accounts/customuser/)
â”‚   â”œâ”€â”€ æ‰€æœ‰è§’è‰²ç”¨æˆ·ç»Ÿä¸€åˆ—è¡¨
â”‚   â”œâ”€â”€ æŒ‰è§’è‰²ç­›é€‰åŠŸèƒ½
â”‚   â””â”€â”€ è§’è‰²å¢é¡¹å†…è”ç¼–è¾‘
â”œâ”€â”€ è§’è‰²é…ç½® (/admin/accounts/roleextension/)
â”‚   â”œâ”€â”€ è§’è‰²å¢é¡¹å­—æ®µå®šä¹‰
â”‚   â””â”€â”€ è§’è‰²æ¨¡æ¿ç®¡ç†
â””â”€â”€ æƒé™ç®¡ç† (/admin/permissions/)
    â”œâ”€â”€ è§’è‰²æƒé™æ˜ å°„
    â””â”€â”€ ç”¨æˆ·ç»„ç®¡ç†
```

## ğŸ“ å®æ–½ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰
1. âœ… ä¿®å¤ `RoleUserAdmin` å­—æ®µé…ç½®é”™è¯¯
2. âœ… ç¡®ä¿æ•°æ®åº“è¿ç§»å®Œæ•´æ€§
3. âœ… éªŒè¯ `/admin/accounts/roleuser/` é¡µé¢å¯æ­£å¸¸è®¿é—®

### ä¸­ä¼˜å…ˆçº§ï¼ˆæœ¬å‘¨å®Œæˆï¼‰
1. ğŸ”„ åˆ›å»º Proxy æ¨¡å‹æ¸…ç†è¿ç§»
2. ğŸ”„ æ›´æ–°ç›¸å…³æ–‡æ¡£å’Œæ³¨é‡Š
3. ğŸ”„ ç»Ÿä¸€è§’è‰²ç®¡ç†å…¥å£ç‚¹

### ä½ä¼˜å…ˆçº§ï¼ˆåç»­ä¼˜åŒ–ï¼‰
1. â³ è¯„ä¼° RoleUser æ¨¡å‹æ¶æ„åˆç†æ€§
2. â³ ä¼˜åŒ–ç”¨æˆ·ç•Œé¢å’Œç”¨æˆ·ä½“éªŒ
3. â³ å®Œå–„æƒé™ç®¡ç†ç³»ç»Ÿ

## ğŸ”§ éªŒè¯æ¸…å•

### åŠŸèƒ½éªŒè¯
- [ ] `/admin/accounts/customuser/` å¯æ­£å¸¸è®¿é—®å’Œæ“ä½œ
- [ ] `/admin/accounts/roleuser/` å¯æ­£å¸¸è®¿é—®ï¼ˆå¦‚æœä¿ç•™ï¼‰
- [ ] `/admin/accounts/roleextension/` å¯æ­£å¸¸è®¿é—®
- [ ] è§’è‰²ç­›é€‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] ç”¨æˆ·å¢é¡¹æ•°æ®æ­£ç¡®æ˜¾ç¤º

### æ•°æ®ä¸€è‡´æ€§éªŒè¯
- [ ] æ‰€æœ‰ç”¨æˆ·çš„è§’è‰²å­—æ®µæ­£ç¡®
- [ ] è§’è‰²å¢é¡¹æ•°æ®å®Œæ•´
- [ ] æƒé™åˆ†é…æ­£ç¡®
- [ ] æ— å­¤ç«‹æ•°æ®è®°å½•

### æ€§èƒ½éªŒè¯
- [ ] é¡µé¢åŠ è½½é€Ÿåº¦æ­£å¸¸
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- [ ] æ— é‡å¤æˆ–å†—ä½™æ“ä½œ

## ğŸ“Š é¢„æœŸæ”¶ç›Š

1. **ç³»ç»Ÿä¸€è‡´æ€§**ï¼šæ¶ˆé™¤åˆ†æ•£çš„è§’è‰²ç®¡ç†æ–¹æ¡ˆï¼Œå®ç°çœŸæ­£çš„ç»Ÿä¸€ç®¡ç†
2. **ç»´æŠ¤æ•ˆç‡**ï¼šå‡å°‘ä»£ç é‡å¤ï¼Œç®€åŒ–ç»´æŠ¤å·¥ä½œ
3. **ç”¨æˆ·ä½“éªŒ**ï¼šæä¾›æ¸…æ™°ã€ä¸€è‡´çš„ç®¡ç†ç•Œé¢
4. **æ‰©å±•æ€§**ï¼šä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•æä¾›è‰¯å¥½çš„æ¶æ„åŸºç¡€
5. **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿è§’è‰²å’Œå¢é¡¹æ•°æ®çš„ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§

---

**æ³¨æ„**ï¼šæœ¬æ–¹æ¡ˆéœ€è¦åœ¨æµ‹è¯•ç¯å¢ƒä¸­å……åˆ†éªŒè¯åå†åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒã€‚å»ºè®®åˆ†é˜¶æ®µå®æ–½ï¼Œæ¯ä¸ªé˜¶æ®µå®Œæˆåè¿›è¡Œå……åˆ†æµ‹è¯•ã€‚