<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPathè¡¨è¾¾å¼ä¼˜åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007cba;
            padding-bottom: 10px;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        .original-xpath {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .optimized-xpath {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .test-form {
            border: 2px solid #007cba;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .fieldset {
            border: 1px solid #ccc;
            margin: 15px 0;
            padding: 15px;
            border-radius: 3px;
        }
        .fieldset h2 {
            margin: 0 0 15px 0;
            color: #666;
            font-size: 16px;
        }
        .form-row {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #eee;
            background: white;
        }
        .test-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #005a8b;
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        code {
            background: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .strategy-list {
            list-style-type: none;
            padding: 0;
        }
        .strategy-list li {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-left: 4px solid #007cba;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ XPathè¡¨è¾¾å¼ä¼˜åŒ–æµ‹è¯•</h1>
        
        <div class="section">
            <h2>ğŸ“‹ åŸå§‹é—®é¢˜åˆ†æ</h2>
            <div class="original-xpath">
                <h3>âš ï¸ åŸå§‹XPathè¡¨è¾¾å¼:</h3>
                <code>//*[@id="customuser_form"]/div/fieldset/div[4]/div/div/text()</code>
                
                <h4>å­˜åœ¨çš„é—®é¢˜:</h4>
                <ul>
                    <li>ğŸ”´ ä½¿ç”¨ç¡¬ç¼–ç ä½ç½®ç´¢å¼• <code>[4]</code>ï¼ŒDOMç»“æ„å˜åŒ–æ—¶å®¹æ˜“å¤±æ•ˆ</li>
                    <li>ğŸ”´ ç›´æ¥è·å– <code>text()</code> èŠ‚ç‚¹ï¼Œå¯èƒ½è·å–ä¸åˆ°å®Œæ•´å†…å®¹</li>
                    <li>ğŸ”´ è·¯å¾„è¿‡äºå…·ä½“ï¼Œç¼ºä¹çµæ´»æ€§</li>
                    <li>ğŸ”´ æ²¡æœ‰å®¹é”™æœºåˆ¶ï¼Œä¸€æ—¦å¤±è´¥å°±å®Œå…¨æ— æ³•å®šä½</li>
                </ul>
            </div>
        </div>
        
        <div class="section">
            <h2>âœ… ä¼˜åŒ–æ–¹æ¡ˆ</h2>
            <div class="optimized-xpath">
                <h3>ğŸ¯ å¤šé‡å®šä½ç­–ç•¥:</h3>
                <ul class="strategy-list">
                    <li><strong>ç­–ç•¥1 - åŸºäºå­—æ®µå:</strong> <code>//div[contains(@class, "field-is_active")]</code></li>
                    <li><strong>ç­–ç•¥2 - åŸºäºfieldsetæ ‡é¢˜:</strong> <code>//fieldset[contains(.//h2, "æƒé™")]//div[@class="form-row"]</code></li>
                    <li><strong>ç­–ç•¥3 - CSSé€‰æ‹©å™¨:</strong> <code>#customuser_form .fieldset:nth-child(4) .form-row</code></li>
                    <li><strong>ç­–ç•¥4 - æ··åˆå®šä½:</strong> <code>#customuser_form fieldset:has(h2:contains("æƒé™")) .form-row</code></li>
                </ul>
            </div>
        </div>
        
        <!-- æ¨¡æ‹ŸDjango Adminè¡¨å•ç»“æ„ -->
        <div class="test-form" id="customuser_form">
            <h2>ğŸ§ª æ¨¡æ‹ŸCustomUserè¡¨å•</h2>
            
            <div class="fieldset">
                <h2>åŸºæœ¬ä¿¡æ¯</h2>
                <div class="form-row field-username">ç”¨æˆ·åå­—æ®µ</div>
            </div>
            
            <div class="fieldset">
                <h2>ä¸ªäººä¿¡æ¯</h2>
                <div class="form-row field-real_name">çœŸå®å§“åå­—æ®µ</div>
                <div class="form-row field-email">é‚®ç®±å­—æ®µ</div>
            </div>
            
            <div class="fieldset">
                <h2>å­¦ä¹ ä¿¡æ¯</h2>
                <div class="form-row field-grade_level">å¹´çº§å­—æ®µ</div>
                <div class="form-row field-english_level">è‹±è¯­æ°´å¹³å­—æ®µ</div>
            </div>
            
            <div class="fieldset">
                <h2>æƒé™</h2>
                <div class="form-row field-is_active">æ¿€æ´»çŠ¶æ€: ç”¨æˆ·è´¦æˆ·æ˜¯å¦æ¿€æ´»</div>
                <div class="form-row field-is_staff">å‘˜å·¥çŠ¶æ€: æ˜¯å¦å¯ä»¥è®¿é—®ç®¡ç†ç«™ç‚¹</div>
                <div class="form-row field-is_superuser">è¶…çº§ç”¨æˆ·çŠ¶æ€: æ‹¥æœ‰æ‰€æœ‰æƒé™</div>
            </div>
            
            <div class="fieldset">
                <h2>é‡è¦æ—¥æœŸ</h2>
                <div class="form-row field-last_login">æœ€åç™»å½•æ—¶é—´</div>
                <div class="form-row field-date_joined">æ³¨å†Œæ—¶é—´</div>
            </div>
        </div>
        
        <div class="section">
            <h2>ğŸ§ª æµ‹è¯•åŠŸèƒ½</h2>
            <button class="test-button" onclick="testOriginalXPath()">æµ‹è¯•åŸå§‹XPath</button>
            <button class="test-button" onclick="testOptimizedSelectors()">æµ‹è¯•ä¼˜åŒ–é€‰æ‹©å™¨</button>
            <button class="test-button" onclick="testPermissionsText()">è·å–æƒé™å­—æ®µæ–‡æœ¬</button>
            <button class="test-button" onclick="analyzeXPathIssues()">åˆ†æXPathé—®é¢˜</button>
            <button class="test-button" onclick="demonstrateRobustness()">æ¼”ç¤ºå¥å£®æ€§</button>
            
            <div id="test-results"></div>
        </div>
        
        <div class="section">
            <h2>ğŸ“– ä½¿ç”¨æŒ‡å—</h2>
            <div class="info">
                <h3>åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨:</h3>
                <pre><code>// 1. å¼•å…¥ä¼˜åŒ–å™¨
&lt;script src="/static/admin/js/xpath_optimizer.js"&gt;&lt;/script&gt;

// 2. è·å–æƒé™å­—æ®µæ–‡æœ¬
const permissionsText = getPermissionsText();

// 3. åˆ†æç°æœ‰XPath
const analysis = analyzeXPath('//*[@id="customuser_form"]/div/fieldset/div[4]/div/div/text()');

// 4. ä½¿ç”¨ä¼˜åŒ–å™¨å®ä¾‹
const optimizer = window.XPathOptimizer;
const selectors = optimizer.getOptimizedSelectors('customUserForm', 'permissions');
const element = optimizer.findElementWithFallback(selectors);</code></pre>
            </div>
        </div>
    </div>
    
    <script src="/static/admin/js/xpath_optimizer.js"></script>
    <script>
        function testOriginalXPath() {
            const resultsDiv = document.getElementById('test-results');
            try {
                // å°è¯•ä½¿ç”¨åŸå§‹XPath
                const result = document.evaluate(
                    '//*[@id="customuser_form"]/div/fieldset/div[4]/div/div/text()',
                    document,
                    null,
                    XPathResult.FIRST_ORDERED_NODE_TYPE,
                    null
                );
                
                if (result.singleNodeValue) {
                    resultsDiv.innerHTML = '<div class="result success">âœ… åŸå§‹XPathæˆåŠŸ: ' + result.singleNodeValue.textContent + '</div>';
                } else {
                    resultsDiv.innerHTML = '<div class="result error">âŒ åŸå§‹XPathå¤±è´¥: æœªæ‰¾åˆ°å…ƒç´ </div>';
                }
            } catch (error) {
                resultsDiv.innerHTML = '<div class="result error">âŒ åŸå§‹XPathé”™è¯¯: ' + error.message + '</div>';
            }
        }
        
        function testOptimizedSelectors() {
            const resultsDiv = document.getElementById('test-results');
            const optimizer = window.XPathOptimizer;
            const selectors = optimizer.getOptimizedSelectors('customUserForm', 'permissions');
            
            if (selectors) {
                const element = optimizer.findElementWithFallback(selectors);
                if (element) {
                    resultsDiv.innerHTML = '<div class="result success">âœ… ä¼˜åŒ–é€‰æ‹©å™¨æˆåŠŸæ‰¾åˆ°å…ƒç´ : ' + element.textContent + '</div>';
                } else {
                    resultsDiv.innerHTML = '<div class="result error">âŒ ä¼˜åŒ–é€‰æ‹©å™¨å¤±è´¥: æœªæ‰¾åˆ°å…ƒç´ </div>';
                }
            } else {
                resultsDiv.innerHTML = '<div class="result error">âŒ æœªæ‰¾åˆ°å¯¹åº”çš„é€‰æ‹©å™¨é…ç½®</div>';
            }
        }
        
        function testPermissionsText() {
            const resultsDiv = document.getElementById('test-results');
            const text = getPermissionsText();
            
            if (text) {
                resultsDiv.innerHTML = '<div class="result success">âœ… æƒé™å­—æ®µæ–‡æœ¬: ' + text + '</div>';
            } else {
                resultsDiv.innerHTML = '<div class="result error">âŒ æ— æ³•è·å–æƒé™å­—æ®µæ–‡æœ¬</div>';
            }
        }
        
        function analyzeXPathIssues() {
            const resultsDiv = document.getElementById('test-results');
            const analysis = analyzeXPath('//*[@id="customuser_form"]/div/fieldset/div[4]/div/div/text()');
            
            let html = '<div class="result info">';
            html += '<h4>ğŸ“Š XPathåˆ†æç»“æœ:</h4>';
            html += '<p><strong>åŸå§‹è¡¨è¾¾å¼:</strong> ' + analysis.original + '</p>';
            
            if (analysis.issues.length > 0) {
                html += '<p><strong>å‘ç°çš„é—®é¢˜:</strong></p><ul>';
                analysis.issues.forEach(issue => {
                    html += '<li>âš ï¸ ' + issue + '</li>';
                });
                html += '</ul>';
            }
            
            if (analysis.recommendations.length > 0) {
                html += '<p><strong>ä¼˜åŒ–å»ºè®®:</strong></p><ul>';
                analysis.recommendations.forEach(rec => {
                    html += '<li>ğŸ’¡ ' + rec + '</li>';
                });
                html += '</ul>';
            }
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }
        
        function demonstrateRobustness() {
            const resultsDiv = document.getElementById('test-results');
            
            // æ¨¡æ‹ŸDOMç»“æ„å˜åŒ–
            const form = document.getElementById('customuser_form');
            const newFieldset = document.createElement('div');
            newFieldset.className = 'fieldset';
            newFieldset.innerHTML = '<h2>æ–°å¢å­—æ®µ</h2><div class="form-row">åŠ¨æ€æ·»åŠ çš„å­—æ®µ</div>';
            
            // åœ¨æƒé™å­—æ®µå‰æ’å…¥æ–°å­—æ®µï¼Œæ”¹å˜åŸæœ‰çš„ä½ç½®ç´¢å¼•
            const permissionsFieldset = form.children[3]; // æƒé™å­—æ®µé›†
            form.insertBefore(newFieldset, permissionsFieldset);
            
            // æµ‹è¯•åŸå§‹XPathæ˜¯å¦è¿˜èƒ½å·¥ä½œ
            setTimeout(() => {
                const originalResult = document.evaluate(
                    '//*[@id="customuser_form"]/div/fieldset/div[4]/div/div/text()',
                    document,
                    null,
                    XPathResult.FIRST_ORDERED_NODE_TYPE,
                    null
                );
                
                // æµ‹è¯•ä¼˜åŒ–åçš„é€‰æ‹©å™¨
                const optimizedText = getPermissionsText();
                
                let html = '<div class="result info">';
                html += '<h4>ğŸ”„ å¥å£®æ€§æµ‹è¯•ç»“æœ (DOMç»“æ„å·²æ”¹å˜):</h4>';
                
                if (originalResult.singleNodeValue) {
                    html += '<p>âŒ åŸå§‹XPath: ä»ç„¶æœ‰æ•ˆï¼Œä½†å¯èƒ½å®šä½åˆ°é”™è¯¯å…ƒç´ </p>';
                } else {
                    html += '<p>âŒ åŸå§‹XPath: å¤±æ•ˆï¼Œæ— æ³•æ‰¾åˆ°å…ƒç´ </p>';
                }
                
                if (optimizedText) {
                    html += '<p>âœ… ä¼˜åŒ–é€‰æ‹©å™¨: ä»ç„¶æœ‰æ•ˆï¼Œæ­£ç¡®å®šä½åˆ°æƒé™å­—æ®µ</p>';
                } else {
                    html += '<p>âŒ ä¼˜åŒ–é€‰æ‹©å™¨: å¤±æ•ˆ</p>';
                }
                
                html += '<p><em>è¿™æ¼”ç¤ºäº†ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨åŸºäºå†…å®¹è€Œéä½ç½®çš„é€‰æ‹©å™¨</em></p>';
                html += '</div>';
                
                resultsDiv.innerHTML = html;
                
                // æ¢å¤åŸå§‹ç»“æ„
                setTimeout(() => {
                    form.removeChild(newFieldset);
                }, 3000);
            }, 100);
        }
    </script>
</body>
</html>