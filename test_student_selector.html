<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生选择器测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        
        .student-selection {
            margin: 10px 0;
            padding: 10px;
            background: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .student-selection label {
            font-weight: bold;
            color: #333;
            white-space: nowrap;
        }
        
        .student-selection select {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 13px;
            min-width: 200px;
        }
        
        .student-status {
            font-size: 12px;
            color: #666;
            font-style: italic;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .student-status.loading {
            color: #007cba;
            font-weight: 500;
        }
        
        .student-status.success {
            color: #28a745;
        }
        
        .student-status.error {
            color: #dc3545;
            font-weight: 500;
        }
        
        .student-status.selected {
            color: #28a745;
            font-weight: 500;
        }
        
        .retry-btn {
            padding: 2px 8px;
            font-size: 11px;
            border-radius: 3px;
            background: #6c757d;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>学生选择器测试页面</h1>
    
    <div class="test-section">
        <h2>API测试</h2>
        <button onclick="testAPI()">测试API端点</button>
        <div id="api-result" class="log" style="margin-top: 10px; display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>学生选择器</h2>
        <div class="student-selection">
            <label for="current-student-select"><strong>当前学生:</strong></label>
            <select id="current-student-select" onchange="switchCurrentStudent(this.value)">
                <option value="">-- 加载中... --</option>
            </select>
            <span id="student-status" class="student-status">请选择学生以显示个性化词汇标记</span>
        </div>
        
        <button onclick="loadStudentData()">重新加载学生数据</button>
    </div>
    
    <div class="test-section">
        <h2>调试日志</h2>
        <button onclick="clearLog()">清空日志</button>
        <div id="debug-log" class="log"></div>
    </div>

    <script>
        let currentStudent = null;
        
        // 日志函数
        function log(message) {
            const logElement = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('debug-log').textContent = '';
        }
        
        // 测试API端点
        async function testAPI() {
            const resultElement = document.getElementById('api-result');
            resultElement.style.display = 'block';
            resultElement.textContent = '正在测试API...';
            
            try {
                const response = await fetch('/accounts/api/students/for_select/', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const responseText = await response.text();
                let result = `状态码: ${response.status} ${response.statusText}\n`;
                result += `响应头: ${JSON.stringify(Object.fromEntries(response.headers), null, 2)}\n`;
                result += `响应内容: ${responseText}`;
                
                resultElement.textContent = result;
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        log(`API测试成功，获取到 ${Array.isArray(data) ? data.length : 0} 条数据`);
                    } catch (e) {
                        log(`API响应解析失败: ${e.message}`);
                    }
                } else {
                    log(`API测试失败: ${response.status} ${response.statusText}`);
                }
                
            } catch (error) {
                resultElement.textContent = `请求失败: ${error.message}`;
                log(`API请求异常: ${error.message}`);
            }
        }
        
        // 加载学生数据
        async function loadStudentData() {
            const selectElement = document.getElementById('current-student-select');
            const statusElement = document.getElementById('student-status');
            
            try {
                // 显示加载状态
                selectElement.innerHTML = '<option value="">-- 加载中... --</option>';
                selectElement.disabled = true;
                statusElement.textContent = '正在加载学生数据...';
                statusElement.className = 'student-status loading';
                
                log('开始加载学生数据...');
                
                const response = await fetch('/accounts/api/students/for_select/', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                log(`API响应状态: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const students = await response.json();
                    log(`获取到学生数据: ${JSON.stringify(students, null, 2)}`);
                    
                    if (Array.isArray(students) && students.length > 0) {
                        populateStudentSelect(students);
                        statusElement.textContent = '请选择学生以显示个性化词汇标记';
                        statusElement.className = 'student-status';
                    } else {
                        log('学生数据为空或格式不正确');
                        showNoStudentsMessage();
                    }
                } else {
                    const errorText = await response.text();
                    log(`加载学生数据失败: ${response.status} ${response.statusText}`);
                    log(`错误详情: ${errorText}`);
                    showStudentLoadError();
                }
            } catch (error) {
                log(`加载学生数据出错: ${error.message}`);
                showStudentLoadError();
            } finally {
                // 确保选择器被启用
                selectElement.disabled = false;
            }
        }
        
        // 填充学生选择器
        function populateStudentSelect(students) {
            const select = document.getElementById('current-student-select');
            const statusElement = document.getElementById('student-status');
            
            // 清空现有选项
            select.innerHTML = '<option value="">-- 选择学生 --</option>';
            
            // 添加学生选项
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.display_name || `${student.real_name || student.username} (${student.username})`;
                option.dataset.englishLevel = student.english_level || '';
                option.dataset.gradeLevel = student.grade_level || '';
                select.appendChild(option);
            });
            
            // 启用选择器
            select.disabled = false;
            
            // 更新状态信息
            statusElement.textContent = `已加载 ${students.length} 名学生，请选择学生以显示个性化词汇标记`;
            statusElement.className = 'student-status success';
            
            log(`学生数据加载完成，共 ${students.length} 名学生`);
        }
        
        // 显示学生数据加载错误
        function showStudentLoadError() {
            const select = document.getElementById('current-student-select');
            const statusElement = document.getElementById('student-status');
            
            select.innerHTML = '<option value="">-- 加载失败，请刷新页面 --</option>';
            select.disabled = false;
            
            statusElement.textContent = '学生数据加载失败，请检查网络连接或刷新页面重试';
            statusElement.className = 'student-status error';
            
            // 添加重试按钮
            const retryBtn = document.createElement('button');
            retryBtn.textContent = '重试';
            retryBtn.className = 'retry-btn';
            retryBtn.style.marginLeft = '10px';
            retryBtn.onclick = function() {
                this.remove();
                loadStudentData();
            };
            statusElement.appendChild(retryBtn);
        }
        
        // 显示无学生数据消息
        function showNoStudentsMessage() {
            const select = document.getElementById('current-student-select');
            const statusElement = document.getElementById('student-status');
            
            select.innerHTML = '<option value="">-- 暂无学生数据 --</option>';
            select.disabled = true;
            
            statusElement.textContent = '系统中暂无学生用户，请联系管理员添加学生账户';
            statusElement.className = 'student-status warning';
        }
        
        // 切换当前学生
        function switchCurrentStudent(studentId) {
            log(`切换学生: ${studentId}`);
            
            currentStudent = studentId;
            const statusElement = document.getElementById('student-status');
            const selectElement = document.getElementById('current-student-select');
            
            if (studentId && studentId !== '') {
                const selectedOption = selectElement.querySelector(`option[value="${studentId}"]`);
                const studentName = selectedOption ? selectedOption.textContent : '未知学生';
                const englishLevel = selectedOption ? selectedOption.dataset.englishLevel : '';
                const gradeLevel = selectedOption ? selectedOption.dataset.gradeLevel : '';
                
                // 更新状态显示
                let statusText = `当前学生: ${studentName}`;
                if (englishLevel || gradeLevel) {
                    const levelInfo = [];
                    if (gradeLevel) levelInfo.push(`${gradeLevel}年级`);
                    if (englishLevel) levelInfo.push(`英语水平: ${englishLevel}`);
                    statusText += ` (${levelInfo.join(', ')})`;
                }
                
                statusElement.textContent = statusText;
                statusElement.className = 'student-status selected';
                
                log(`已切换到学生: ${studentName} (ID: ${studentId})`);
            } else {
                // 未选择学生
                statusElement.textContent = '请选择学生以显示个性化词汇标记';
                statusElement.className = 'student-status';
                log('已取消学生选择');
            }
        }
        
        // 页面加载完成后自动加载学生数据
        document.addEventListener('DOMContentLoaded', function() {
            log('页面加载完成，开始初始化...');
            loadStudentData();
        });
    </script>
</body>
</html>