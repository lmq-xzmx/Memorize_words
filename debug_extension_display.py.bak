#!/usr/bin/env python
"""
è°ƒè¯•å¢é¡¹æ˜¾ç¤ºé—®é¢˜

ä»æˆªå›¾çœ‹åˆ°æœ‰äº›ç”¨æˆ·æ˜¾ç¤ºäº†ä¸åº”è¯¥æ˜¾ç¤ºçš„å¢é¡¹ï¼Œéœ€è¦æ£€æŸ¥æ˜¾ç¤ºé€»è¾‘
"""

import os
import sys
import django

# è®¾ç½®Djangoç¯å¢ƒ
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'english_learning_platform.settings')
django.setup()

from apps.accounts.models import CustomUser, UserExtensionData, RoleExtension, UserRole
from apps.accounts.admin import StudentUserAdmin, CustomUserAdmin
from django.contrib import admin
from django.utils.html import strip_tags


def check_specific_users():
    """æ£€æŸ¥æˆªå›¾ä¸­æ˜¾ç¤ºæœ‰é—®é¢˜çš„ç‰¹å®šç”¨æˆ·"""
    print("ğŸ” æ£€æŸ¥æˆªå›¾ä¸­æ˜¾ç¤ºæœ‰é—®é¢˜çš„ç‰¹å®šç”¨æˆ·...")
    print("=" * 60)
    
    # ä»æˆªå›¾ä¸­çœ‹åˆ°çš„æœ‰é—®é¢˜çš„ç”¨æˆ·
    problem_users = [
        'AnonymousUser',
        'jiazhang1', 
        'admin333',
        'lmq277',
        'testlogin',
        'whh'
    ]
    
    for username in problem_users:
        try:
            user = CustomUser.objects.get(username=username)
            print(f"\nğŸ‘¤ ç”¨æˆ·: {user.username} ({user.real_name or 'æ— å§“å'})")
            print(f"  ğŸ·ï¸  ç”¨æˆ·è§’è‰²: {user.role} ({user.get_role_display()})")
            
            # æ£€æŸ¥è¯¥ç”¨æˆ·çš„æ‰€æœ‰å¢é¡¹æ•°æ®
            user_extensions = UserExtensionData.objects.filter(user=user).select_related('role_extension')
            print(f"  ğŸ“Š å¢é¡¹æ•°æ®æ•°é‡: {user_extensions.count()}")
            
            for ext_data in user_extensions:
                print(f"    - {ext_data.role_extension.field_label}: {ext_data.field_value}")
                print(f"      å¢é¡¹è§’è‰²: {ext_data.role_extension.role}")
                if user.role != ext_data.role_extension.role:
                    print(f"      âŒ è§’è‰²ä¸åŒ¹é…ï¼ç”¨æˆ·è§’è‰²: {user.role}, å¢é¡¹è§’è‰²: {ext_data.role_extension.role}")
                else:
                    print(f"      âœ… è§’è‰²åŒ¹é…")
            
            # æµ‹è¯•adminæ˜¾ç¤ºæ–¹æ³•
            admin_instance = StudentUserAdmin(CustomUser, admin.site)
            display_result = admin_instance.get_extension_summary(user)
            display_text = strip_tags(display_result)
            print(f"  ğŸ–¥ï¸  Adminæ˜¾ç¤ºç»“æœ: {display_text}")
            
        except CustomUser.DoesNotExist:
            print(f"âŒ ç”¨æˆ· {username} ä¸å­˜åœ¨")


def check_all_users_with_extensions():
    """æ£€æŸ¥æ‰€æœ‰æœ‰å¢é¡¹æ•°æ®çš„ç”¨æˆ·"""
    print("\nğŸ” æ£€æŸ¥æ‰€æœ‰æœ‰å¢é¡¹æ•°æ®çš„ç”¨æˆ·...")
    print("=" * 50)
    
    # è·å–æ‰€æœ‰æœ‰å¢é¡¹æ•°æ®çš„ç”¨æˆ·
    users_with_extensions = CustomUser.objects.filter(
        userextensiondata__isnull=False
    ).distinct().order_by('username')
    
    print(f"ğŸ“Š æ‰¾åˆ° {users_with_extensions.count()} ä¸ªæœ‰å¢é¡¹æ•°æ®çš„ç”¨æˆ·")
    
    for user in users_with_extensions:
        print(f"\nğŸ‘¤ {user.username} ({user.get_role_display()})")
        
        # è·å–è¯¥ç”¨æˆ·çš„å¢é¡¹æ•°æ®
        extensions = UserExtensionData.objects.filter(user=user).select_related('role_extension')
        
        for ext in extensions:
            role_match = "âœ…" if user.role == ext.role_extension.role else "âŒ"
            print(f"  {role_match} {ext.role_extension.field_label}: {ext.field_value} (å¢é¡¹è§’è‰²: {ext.role_extension.role})")


def check_extension_summary_logic():
    """æ£€æŸ¥get_extension_summaryæ–¹æ³•çš„é€»è¾‘"""
    print("\nğŸ” æ£€æŸ¥get_extension_summaryæ–¹æ³•çš„é€»è¾‘...")
    print("=" * 50)
    
    # æµ‹è¯•å‡ ä¸ªç‰¹å®šç”¨æˆ·
    test_users = ['AnonymousUser', 'student1', 'test_teacher_obj']
    
    for username in test_users:
        try:
            user = CustomUser.objects.get(username=username)
            print(f"\nğŸ‘¤ æµ‹è¯•ç”¨æˆ·: {user.username} (è§’è‰²: {user.role})")
            
            # ç›´æ¥æŸ¥è¯¢è¯¥ç”¨æˆ·çš„å¢é¡¹æ•°æ®
            extensions = UserExtensionData.objects.filter(user=user).select_related('role_extension')
            print(f"  ğŸ“Š ç›´æ¥æŸ¥è¯¢ç»“æœ: {extensions.count()} æ¡å¢é¡¹æ•°æ®")
            
            for ext in extensions:
                print(f"    - {ext.role_extension.field_label}: {ext.field_value}")
            
            # ä½¿ç”¨adminæ–¹æ³•
            admin_instance = StudentUserAdmin(CustomUser, admin.site)
            
            # æ¨¡æ‹Ÿadminæ–¹æ³•çš„æŸ¥è¯¢
            admin_extensions = UserExtensionData.objects.filter(user=user).select_related('role_extension')
            print(f"  ğŸ–¥ï¸  AdminæŸ¥è¯¢ç»“æœ: {admin_extensions.count()} æ¡å¢é¡¹æ•°æ®")
            
            # è·å–æ˜¾ç¤ºç»“æœ
            display_result = admin_instance.get_extension_summary(user)
            display_text = strip_tags(display_result)
            print(f"  ğŸ“º æ˜¾ç¤ºç»“æœ: {display_text}")
            
        except CustomUser.DoesNotExist:
            print(f"âŒ ç”¨æˆ· {username} ä¸å­˜åœ¨")


def check_role_extension_configs():
    """æ£€æŸ¥è§’è‰²å¢é¡¹é…ç½®"""
    print("\nğŸ” æ£€æŸ¥è§’è‰²å¢é¡¹é…ç½®...")
    print("=" * 40)
    
    all_extensions = RoleExtension.objects.filter(is_active=True).order_by('role', 'field_name')
    
    role_groups = {}
    for ext in all_extensions:
        if ext.role not in role_groups:
            role_groups[ext.role] = []
        role_groups[ext.role].append(ext)
    
    for role, extensions in role_groups.items():
        role_display = dict(UserRole.choices).get(role, role)
        print(f"\nğŸ“‹ {role_display} ({role}) è§’è‰²å¢é¡¹é…ç½®:")
        for ext in extensions:
            data_count = UserExtensionData.objects.filter(role_extension=ext).count()
            print(f"  - {ext.field_label} ({ext.field_name}): {data_count} æ¡æ•°æ®")


def find_cross_role_data():
    """æŸ¥æ‰¾è·¨è§’è‰²çš„å¢é¡¹æ•°æ®"""
    print("\nğŸ” æŸ¥æ‰¾è·¨è§’è‰²çš„å¢é¡¹æ•°æ®...")
    print("=" * 40)
    
    # æŸ¥æ‰¾ç”¨æˆ·è§’è‰²ä¸å¢é¡¹è§’è‰²ä¸åŒ¹é…çš„æ•°æ®
    mismatched_query = """
    SELECT u.username, u.role as user_role, re.role as extension_role, 
           re.field_label, ued.field_value
    FROM accounts_userextensiondata ued
    JOIN accounts_customuser u ON ued.user_id = u.id
    JOIN accounts_roleextension re ON ued.role_extension_id = re.id
    WHERE u.role != re.role
    """
    
    from django.db import connection
    with connection.cursor() as cursor:
        cursor.execute(mismatched_query)
        results = cursor.fetchall()
    
    if results:
        print(f"âŒ å‘ç° {len(results)} æ¡è·¨è§’è‰²çš„å¢é¡¹æ•°æ®:")
        for row in results:
            username, user_role, ext_role, field_label, field_value = row
            print(f"  - {username}: ç”¨æˆ·è§’è‰²({user_role}) vs å¢é¡¹è§’è‰²({ext_role}) - {field_label}: {field_value}")
    else:
        print("âœ… æ²¡æœ‰å‘ç°è·¨è§’è‰²çš„å¢é¡¹æ•°æ®")
    
    return results


def main():
    """ä¸»å‡½æ•°"""
    print("ğŸš€ å¼€å§‹è°ƒè¯•å¢é¡¹æ˜¾ç¤ºé—®é¢˜...")
    print("=" * 70)
    
    try:
        # 1. æ£€æŸ¥ç‰¹å®šæœ‰é—®é¢˜çš„ç”¨æˆ·
        check_specific_users()
        
        # 2. æ£€æŸ¥æ‰€æœ‰æœ‰å¢é¡¹æ•°æ®çš„ç”¨æˆ·
        check_all_users_with_extensions()
        
        # 3. æ£€æŸ¥æ˜¾ç¤ºé€»è¾‘
        check_extension_summary_logic()
        
        # 4. æ£€æŸ¥è§’è‰²å¢é¡¹é…ç½®
        check_role_extension_configs()
        
        # 5. æŸ¥æ‰¾è·¨è§’è‰²æ•°æ®
        mismatched_data = find_cross_role_data()
        
        if mismatched_data:
            print(f"\nâš ï¸  å‘ç°é—®é¢˜ï¼éœ€è¦ä¿®å¤è·¨è§’è‰²çš„å¢é¡¹æ•°æ®")
            return False
        else:
            print(f"\nğŸ‰ æ•°æ®æ£€æŸ¥å®Œæˆï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾é—®é¢˜")
            print(f"ğŸ’¡ å¦‚æœç•Œé¢ä»æ˜¾ç¤ºå¼‚å¸¸ï¼Œå¯èƒ½æ˜¯ç¼“å­˜æˆ–å‰ç«¯æ˜¾ç¤ºé—®é¢˜")
            return True
        
    except Exception as e:
        print(f"âŒ è°ƒè¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
        return False


if __name__ == '__main__':
    success = main()
    sys.exit(0 if success else 1)