{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify accounts_extras %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
&rsaquo; <a href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
&rsaquo; <a href="{% url opts|admin_urlname:'change' user_obj.pk|admin_urlquote %}">{{ user_obj|truncatewords:"18" }}</a>
&rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<div class="module aligned">
    <h2>用户信息</h2>
    <div class="form-row">
        <div><strong>用户名:</strong> {{ user_obj.username }}</div>
        <div><strong>真实姓名:</strong> {{ user_obj.real_name|default:"未设置" }}</div>
        <div><strong>角色:</strong> {{ user_obj.get_role_display }}</div>
        <div><strong>邮箱:</strong> {{ user_obj.email|default:"未设置" }}</div>
    </div>
</div>

<form method="post" id="extension-form">
    {% csrf_token %}
    
    <div class="module aligned">
        <h2>角色增项信息</h2>
        
        {% if role_extensions %}
            {% for extension in role_extensions %}
                <div class="form-row">
                    <div>
                        <label for="extension_{{ extension.pk }}">
                            {{ extension.field_label }}
                            {% if extension.is_required %}<span class="required">*</span>{% endif %}
                        </label>
                        
                        {% if extension.field_type == 'choice' %}
                            <select name="extension_{{ extension.pk }}" id="extension_{{ extension.pk }}" 
                                    {% if extension.is_required %}required{% endif %}>
                                <option value="">请选择...</option>
                                {% for choice_value, choice_label in extension.get_choices_list %}
                                    <option value="{{ choice_value }}" 
                                            {% if user_extensions|get_item:extension.pk == choice_value %}selected{% endif %}>
                                        {{ choice_label }}
                                    </option>
                                {% endfor %}
                            </select>
                        {% elif extension.field_type == 'textarea' %}
                            <textarea name="extension_{{ extension.pk }}" id="extension_{{ extension.pk }}" 
                                      rows="4" cols="40" {% if extension.is_required %}required{% endif %}>{{ user_extensions|get_item:extension.pk|default:"" }}</textarea>
                        {% elif extension.field_type == 'boolean' %}
                            <input type="checkbox" name="extension_{{ extension.pk }}" id="extension_{{ extension.pk }}" 
                                   value="true" {% if user_extensions|get_item:extension.pk == 'true' %}checked{% endif %}>
                        {% elif extension.field_type == 'date' %}
                            <input type="date" name="extension_{{ extension.pk }}" id="extension_{{ extension.pk }}" 
                                   value="{{ user_extensions|get_item:extension.pk|default:"" }}" 
                                   {% if extension.is_required %}required{% endif %}>
                        {% elif extension.field_type == 'email' %}
                            <input type="email" name="extension_{{ extension.pk }}" id="extension_{{ extension.pk }}" 
                                   value="{{ user_extensions|get_item:extension.pk|default:"" }}" 
                                   {% if extension.is_required %}required{% endif %}>
                        {% elif extension.field_type == 'url' %}
                            <input type="url" name="extension_{{ extension.pk }}" id="extension_{{ extension.pk }}" 
                                   value="{{ user_extensions|get_item:extension.pk|default:"" }}" 
                                   {% if extension.is_required %}required{% endif %}>
                        {% elif extension.field_type == 'number' %}
                            <input type="number" name="extension_{{ extension.pk }}" id="extension_{{ extension.pk }}" 
                                   value="{{ user_extensions|get_item:extension.pk|default:"" }}" 
                                   {% if extension.is_required %}required{% endif %}>
                        {% elif extension.field_type == 'phone' %}
                            <input type="tel" name="extension_{{ extension.pk }}" id="extension_{{ extension.pk }}" 
                                   value="{{ user_extensions|get_item:extension.pk|default:"" }}" 
                                   {% if extension.is_required %}required{% endif %}>
                        {% else %}
                            <input type="text" name="extension_{{ extension.pk }}" id="extension_{{ extension.pk }}" 
                                   value="{{ user_extensions|get_item:extension.pk|default:"" }}" 
                                   {% if extension.is_required %}required{% endif %}>
                        {% endif %}
                        
                        {% if extension.help_text %}
                            <p class="help">{{ extension.help_text }}</p>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>该角色暂无增项配置。</p>
        {% endif %}
    </div>
    
    <div class="submit-row">
        <input type="submit" value="保存" class="default" name="_save">
        <p class="deletelink-box">
            <a href="{% url opts|admin_urlname:'changelist' %}" class="deletelink">取消</a>
        </p>
    </div>
</form>

<script>
// 添加一些基本的表单验证和用户体验改进
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('extension-form');
    
    // 为必填字段添加样式
    const requiredFields = form.querySelectorAll('[required]');
    requiredFields.forEach(field => {
        field.style.borderColor = '#ddd';
        field.addEventListener('invalid', function() {
            this.style.borderColor = '#dc3545';
        });
        field.addEventListener('input', function() {
            if (this.checkValidity()) {
                this.style.borderColor = '#28a745';
            } else {
                this.style.borderColor = '#dc3545';
            }
        });
    });
});
</script>

<style>
.form-row {
    margin-bottom: 15px;
}

.form-row label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
}

.form-row input, .form-row select, .form-row textarea {
    width: 100%;
    max-width: 400px;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.form-row input[type="checkbox"] {
    width: auto;
}

.help {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
    margin-bottom: 0;
}

.required {
    color: #dc3545;
}

.module h2 {
    background: #f8f9fa;
    padding: 10px 15px;
    margin: 0 0 15px 0;
    border-left: 4px solid #007cba;
    font-size: 16px;
}

.module {
    margin-bottom: 20px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.module .form-row {
    padding: 0 15px;
}

.module .form-row:last-child {
    padding-bottom: 15px;
}
</style>
{% endblock %}