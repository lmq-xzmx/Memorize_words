{% extends "admin/accounts/role_hierarchy/base.html" %}
{% load i18n %}

{% block hierarchy_content %}
<div class="header-section">
    <h1>{{ role_level.role_name }} - ç”¨æˆ·åˆ—è¡¨</h1>
    <p>ç®¡ç† {{ role_level.role_name }} è§’è‰²ä¸‹çš„æ‰€æœ‰ç”¨æˆ·åŠå…¶å¢é¡¹ä¿¡æ¯</p>
</div>

<!-- è§’è‰²ä¿¡æ¯å¡ç‰‡ -->
<div class="stats-cards">
    <div class="stats-card">
        <h3>ç”¨æˆ·æ€»æ•°</h3>
        <div class="number">{{ role_users.paginator.count }}</div>
        <p>è¯¥è§’è‰²ä¸‹çš„æ´»è·ƒç”¨æˆ·</p>
    </div>
    <div class="stats-card">
        <h3>å¢é¡¹é…ç½®</h3>
        <div class="number">{{ role_extensions.count }}</div>
        <p>å¯ç”¨çš„å¢é¡¹å­—æ®µ</p>
    </div>
    <div class="stats-card">
        <h3>è§’è‰²ä»£ç </h3>
        <div class="number" style="font-size: 24px;">{{ role_level.role }}</div>
        <p>ç³»ç»Ÿå†…éƒ¨æ ‡è¯†</p>
    </div>
</div>

<!-- æœç´¢æ¡† -->
<div class="search-box">
    <form method="get" style="display: flex; align-items: center; gap: 10px;">
        <input type="text" name="search" value="{{ search_query }}" 
               placeholder="æœç´¢ç”¨æˆ·åã€çœŸå®å§“åæˆ–é‚®ç®±..." />
        <button type="submit" class="btn btn-primary">ğŸ” æœç´¢</button>
        {% if search_query %}
        <a href="{% url 'accounts:role_users_list' role_level.id %}" class="btn btn-secondary">æ¸…é™¤</a>
        {% endif %}
    </form>
</div>

<!-- å¢é¡¹é…ç½®ä¿¡æ¯ -->
{% if role_extensions %}
<div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
    <h3 style="margin: 0 0 10px 0; color: #333;">å¯ç”¨å¢é¡¹å­—æ®µ</h3>
    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
        {% for ext in role_extensions %}
        <span style="background: #f8f9fa; padding: 4px 8px; border-radius: 4px; font-size: 12px; border: 1px solid #ddd;">
            {{ ext.field_label }} ({{ ext.get_field_type_display }})
        </span>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- ç”¨æˆ·åˆ—è¡¨ -->
{% if role_users %}
<table class="user-table">
    <thead>
        <tr>
            <th>ç”¨æˆ·å</th>
            <th>çœŸå®å§“å</th>
            <th>é‚®ç®±</th>
            <th>å¢é¡¹æ•°é‡</th>
            <th>åŠ å…¥æ—¶é—´</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
        </tr>
    </thead>
    <tbody>
        {% for role_user in role_users %}
        <tr>
            <td>
                <strong>{{ role_user.user.username }}</strong>
                {% if role_user.notes %}
                <br><small style="color: #666;">{{ role_user.notes|truncatechars:50 }}</small>
                {% endif %}
            </td>
            <td>{{ role_user.user.real_name|default:"æœªè®¾ç½®" }}</td>
            <td>{{ role_user.user.email|default:"æœªè®¾ç½®" }}</td>
            <td>
                {% if role_user.extension_count > 0 %}
                <span style="color: #007cba; font-weight: bold;">
                    ğŸ“‹ {{ role_user.extension_count }} é¡¹
                </span>
                {% else %}
                <span style="color: #666;">æ— å¢é¡¹</span>
                {% endif %}
            </td>
            <td>{{ role_user.joined_at|date:"Y-m-d H:i" }}</td>
            <td>
                {% if role_user.is_active %}
                <span style="color: #28a745; font-weight: bold;">âœ… æ´»è·ƒ</span>
                {% else %}
                <span style="color: #dc3545;">âŒ ç¦ç”¨</span>
                {% endif %}
            </td>
            <td>
                <a href="{% url 'accounts:user_extensions_detail' role_user.id %}" 
                   class="btn btn-primary" style="font-size: 12px; padding: 4px 8px;">
                    ğŸ“ ç®¡ç†å¢é¡¹
                </a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- åˆ†é¡µ -->
{% if role_users.has_other_pages %}
<div class="pagination">
    {% if role_users.has_previous %}
        <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">&laquo; é¦–é¡µ</a>
        <a href="?page={{ role_users.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">ä¸Šä¸€é¡µ</a>
    {% endif %}
    
    <span class="current">
        ç¬¬ {{ role_users.number }} é¡µï¼Œå…± {{ role_users.paginator.num_pages }} é¡µ
    </span>
    
    {% if role_users.has_next %}
        <a href="?page={{ role_users.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">ä¸‹ä¸€é¡µ</a>
        <a href="?page={{ role_users.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">æœ«é¡µ &raquo;</a>
    {% endif %}
</div>
{% endif %}

{% else %}
<div style="text-align: center; padding: 40px; color: #666; background: white; border: 1px solid #ddd; border-radius: 8px;">
    <h3>æš‚æ— ç”¨æˆ·æ•°æ®</h3>
    {% if search_query %}
    <p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é… "{{ search_query }}" çš„ç”¨æˆ·</p>
    <a href="{% url 'accounts:role_users_list' role_level.id %}" class="btn btn-primary">æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·</a>
    {% else %}
    <p>è¯¥è§’è‰²ä¸‹æš‚æ— æ´»è·ƒç”¨æˆ·</p>
    {% endif %}
</div>
{% endif %}

<!-- æ‰¹é‡æ“ä½œåŒºåŸŸ -->
{% if role_users and role_extensions %}
<div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-top: 20px;">
    <h3 style="margin: 0 0 15px 0;">æ‰¹é‡æ“ä½œ</h3>
    <form method="post" action="{% url 'accounts:batch_update_extensions' %}">
        {% csrf_token %}
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
            <div>
                <label>é€‰æ‹©å¢é¡¹å­—æ®µ:</label>
                <select name="extension_id" required>
                    <option value="">è¯·é€‰æ‹©...</option>
                    {% for ext in role_extensions %}
                    <option value="{{ ext.id }}">{{ ext.field_label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>è®¾ç½®å€¼:</label>
                <input type="text" name="field_value" required placeholder="è¾“å…¥è¦è®¾ç½®çš„å€¼">
            </div>
            <div>
                <label>å½±å“ç”¨æˆ·:</label>
                <select name="target_users" onchange="updateUserSelection(this.value)">
                    <option value="all">æ‰€æœ‰ç”¨æˆ· ({{ role_users.paginator.count }})</option>
                    <option value="no_extension">æ— å¢é¡¹ç”¨æˆ·</option>
                    <option value="has_extension">æœ‰å¢é¡¹ç”¨æˆ·</option>
                </select>
            </div>
            <div>
                <button type="submit" class="btn btn-success" 
                        onclick="return confirm('ç¡®å®šè¦æ‰¹é‡æ›´æ–°é€‰ä¸­ç”¨æˆ·çš„å¢é¡¹ä¿¡æ¯å—ï¼Ÿ')">
                    ğŸ”„ æ‰¹é‡æ›´æ–°
                </button>
            </div>
        </div>
        
        <!-- éšè—å­—æ®µï¼Œç”¨äºä¼ é€’ç”¨æˆ·ID -->
        <div id="userIdInputs">
            {% for role_user in role_users %}
            <input type="hidden" name="role_user_ids" value="{{ role_user.id }}">
            {% endfor %}
        </div>
    </form>
</div>
{% endif %}

<script>
function updateUserSelection(target) {
    // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„ç”¨æˆ·é€‰æ‹©é€»è¾‘
    // ç›®å‰ç®€åŒ–å¤„ç†ï¼Œå®é™…åº”ç”¨ä¸­å¯ä»¥é€šè¿‡AJAXåŠ¨æ€æ›´æ–°ç”¨æˆ·åˆ—è¡¨
}
</script>
{% endblock %}