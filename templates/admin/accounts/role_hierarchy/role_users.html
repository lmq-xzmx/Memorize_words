{% extends "admin/accounts/role_hierarchy/base.html" %}
{% load i18n %}

{% block hierarchy_content %}
<div class="header-section">
    <h1>{{ role_level.role_name }} - 用户列表</h1>
    <p>管理 {{ role_level.role_name }} 角色下的所有用户及其增项信息</p>
</div>

<!-- 角色信息卡片 -->
<div class="stats-cards">
    <div class="stats-card">
        <h3>用户总数</h3>
        <div class="number">{{ role_users.paginator.count }}</div>
        <p>该角色下的活跃用户</p>
    </div>
    <div class="stats-card">
        <h3>增项配置</h3>
        <div class="number">{{ role_extensions.count }}</div>
        <p>可用的增项字段</p>
    </div>
    <div class="stats-card">
        <h3>角色代码</h3>
        <div class="number" style="font-size: 24px;">{{ role_level.role }}</div>
        <p>系统内部标识</p>
    </div>
</div>

<!-- 搜索框 -->
<div class="search-box">
    <form method="get" style="display: flex; align-items: center; gap: 10px;">
        <input type="text" name="search" value="{{ search_query }}" 
               placeholder="搜索用户名、真实姓名或邮箱..." />
        <button type="submit" class="btn btn-primary">🔍 搜索</button>
        {% if search_query %}
        <a href="{% url 'accounts:role_users_list' role_level.id %}" class="btn btn-secondary">清除</a>
        {% endif %}
    </form>
</div>

<!-- 增项配置信息 -->
{% if role_extensions %}
<div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
    <h3 style="margin: 0 0 10px 0; color: #333;">可用增项字段</h3>
    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
        {% for ext in role_extensions %}
        <span style="background: #f8f9fa; padding: 4px 8px; border-radius: 4px; font-size: 12px; border: 1px solid #ddd;">
            {{ ext.field_label }} ({{ ext.get_field_type_display }})
        </span>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- 用户列表 -->
{% if role_users %}
<table class="user-table">
    <thead>
        <tr>
            <th>用户名</th>
            <th>真实姓名</th>
            <th>邮箱</th>
            <th>增项数量</th>
            <th>加入时间</th>
            <th>状态</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        {% for role_user in role_users %}
        <tr>
            <td>
                <strong>{{ role_user.user.username }}</strong>
                {% if role_user.notes %}
                <br><small style="color: #666;">{{ role_user.notes|truncatechars:50 }}</small>
                {% endif %}
            </td>
            <td>{{ role_user.user.real_name|default:"未设置" }}</td>
            <td>{{ role_user.user.email|default:"未设置" }}</td>
            <td>
                {% if role_user.extension_count > 0 %}
                <span style="color: #007cba; font-weight: bold;">
                    📋 {{ role_user.extension_count }} 项
                </span>
                {% else %}
                <span style="color: #666;">无增项</span>
                {% endif %}
            </td>
            <td>{{ role_user.joined_at|date:"Y-m-d H:i" }}</td>
            <td>
                {% if role_user.is_active %}
                <span style="color: #28a745; font-weight: bold;">✅ 活跃</span>
                {% else %}
                <span style="color: #dc3545;">❌ 禁用</span>
                {% endif %}
            </td>
            <td>
                <a href="{% url 'accounts:user_extensions_detail' role_user.id %}" 
                   class="btn btn-primary" style="font-size: 12px; padding: 4px 8px;">
                    📝 管理增项
                </a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- 分页 -->
{% if role_users.has_other_pages %}
<div class="pagination">
    {% if role_users.has_previous %}
        <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">&laquo; 首页</a>
        <a href="?page={{ role_users.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">上一页</a>
    {% endif %}
    
    <span class="current">
        第 {{ role_users.number }} 页，共 {{ role_users.paginator.num_pages }} 页
    </span>
    
    {% if role_users.has_next %}
        <a href="?page={{ role_users.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">下一页</a>
        <a href="?page={{ role_users.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">末页 &raquo;</a>
    {% endif %}
</div>
{% endif %}

{% else %}
<div style="text-align: center; padding: 40px; color: #666; background: white; border: 1px solid #ddd; border-radius: 8px;">
    <h3>暂无用户数据</h3>
    {% if search_query %}
    <p>没有找到匹配 "{{ search_query }}" 的用户</p>
    <a href="{% url 'accounts:role_users_list' role_level.id %}" class="btn btn-primary">查看所有用户</a>
    {% else %}
    <p>该角色下暂无活跃用户</p>
    {% endif %}
</div>
{% endif %}

<!-- 批量操作区域 -->
{% if role_users and role_extensions %}
<div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-top: 20px;">
    <h3 style="margin: 0 0 15px 0;">批量操作</h3>
    <form method="post" action="{% url 'accounts:batch_update_extensions' %}">
        {% csrf_token %}
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
            <div>
                <label>选择增项字段:</label>
                <select name="extension_id" required>
                    <option value="">请选择...</option>
                    {% for ext in role_extensions %}
                    <option value="{{ ext.id }}">{{ ext.field_label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>设置值:</label>
                <input type="text" name="field_value" required placeholder="输入要设置的值">
            </div>
            <div>
                <label>影响用户:</label>
                <select name="target_users" onchange="updateUserSelection(this.value)">
                    <option value="all">所有用户 ({{ role_users.paginator.count }})</option>
                    <option value="no_extension">无增项用户</option>
                    <option value="has_extension">有增项用户</option>
                </select>
            </div>
            <div>
                <button type="submit" class="btn btn-success" 
                        onclick="return confirm('确定要批量更新选中用户的增项信息吗？')">
                    🔄 批量更新
                </button>
            </div>
        </div>
        
        <!-- 隐藏字段，用于传递用户ID -->
        <div id="userIdInputs">
            {% for role_user in role_users %}
            <input type="hidden" name="role_user_ids" value="{{ role_user.id }}">
            {% endfor %}
        </div>
    </form>
</div>
{% endif %}

<script>
function updateUserSelection(target) {
    // 这里可以添加更复杂的用户选择逻辑
    // 目前简化处理，实际应用中可以通过AJAX动态更新用户列表
}
</script>
{% endblock %}