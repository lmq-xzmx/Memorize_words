{% extends "admin/accounts/role_hierarchy/base.html" %}
{% load i18n role_hierarchy_extras %}

{% block hierarchy_content %}
<div class="header-section">
    <h1>{{ role_user.user.username }} - å¢é¡¹ç®¡ç†</h1>
    <p>ç®¡ç†ç”¨æˆ·åœ¨ {{ role_user.role_level.role_name }} è§’è‰²ä¸‹çš„å¢é¡¹ä¿¡æ¯</p>
</div>

<!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
<div class="stats-cards">
    <div class="stats-card">
        <h3>ç”¨æˆ·ä¿¡æ¯</h3>
        <div style="text-align: left;">
            <p><strong>ç”¨æˆ·å:</strong> {{ role_user.user.username }}</p>
            <p><strong>çœŸå®å§“å:</strong> {{ role_user.user.real_name|default:"æœªè®¾ç½®" }}</p>
            <p><strong>é‚®ç®±:</strong> {{ role_user.user.email|default:"æœªè®¾ç½®" }}</p>
        </div>
    </div>
    <div class="stats-card">
        <h3>è§’è‰²ä¿¡æ¯</h3>
        <div style="text-align: left;">
            <p><strong>è§’è‰²:</strong> {{ role_user.role_level.role_name }}</p>
            <p><strong>è§’è‰²ä»£ç :</strong> {{ role_user.role_level.role }}</p>
            <p><strong>åŠ å…¥æ—¶é—´:</strong> {{ role_user.joined_at|date:"Y-m-d" }}</p>
        </div>
    </div>
    <div class="stats-card">
        <h3>å¢é¡¹ç»Ÿè®¡</h3>
        <div class="number">{{ user_extensions.count }}</div>
        <p>å·²é…ç½® / {{ role_extensions.count }} å¯ç”¨</p>
    </div>
</div>

<!-- å¢é¡¹è¡¨å• -->
<div class="extension-form">
    <h3 style="margin: 0 0 20px 0; color: #333; border-bottom: 2px solid #007cba; padding-bottom: 10px;">
        å¢é¡¹ä¿¡æ¯é…ç½®
    </h3>
    
    <form method="post" action="{% url 'accounts:update_user_extensions' role_user.id %}">
        {% csrf_token %}
        
        {% for role_ext in role_extensions %}
        <div class="form-group">
            <label for="extension_{{ role_ext.id }}">
                {{ role_ext.field_label }}
                {% if role_ext.is_required %}
                <span style="color: #dc3545;">*</span>
                {% endif %}
            </label>
            
            {% if role_ext.field_type == 'choice' %}
                <select name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}"
                        {% if role_ext.is_required %}required{% endif %}>
                    <option value="">è¯·é€‰æ‹©...</option>
                    {% for choice_value, choice_label in role_ext.get_choices_list %}
                    {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                    <option value="{{ choice_value }}" 
                            {% if user_ext and user_ext.field_value == choice_value %}selected{% endif %}>
                        {{ choice_label }}
                    </option>
                    {% endwith %}
                    {% endfor %}
                </select>
            {% elif role_ext.field_type == 'textarea' %}
                {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                <textarea name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}" 
                          rows="4" {% if role_ext.is_required %}required{% endif %}>{% if user_ext and user_ext.field_value %}{{ user_ext.field_value }}{% endif %}</textarea>
                {% endwith %}
            {% elif role_ext.field_type == 'boolean' %}
                {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                <select name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}">
                    <option value="">è¯·é€‰æ‹©...</option>
                    <option value="true" {% if user_ext and user_ext.field_value == 'true' %}selected{% endif %}>æ˜¯</option>
                    <option value="false" {% if user_ext and user_ext.field_value == 'false' %}selected{% endif %}>å¦</option>
                </select>
                {% endwith %}
            {% elif role_ext.field_type == 'date' %}
                {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                <input type="date" name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}"
                       value="{% if user_ext %}{{ user_ext.field_value }}{% endif %}"
                       {% if role_ext.is_required %}required{% endif %}>
                {% endwith %}
            {% elif role_ext.field_type == 'email' %}
                {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                <input type="email" name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}"
                       value="{% if user_ext %}{{ user_ext.field_value }}{% endif %}"
                       {% if role_ext.is_required %}required{% endif %}>
                {% endwith %}
            {% elif role_ext.field_type == 'url' %}
                {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                <input type="url" name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}"
                       value="{% if user_ext %}{{ user_ext.field_value }}{% endif %}"
                       {% if role_ext.is_required %}required{% endif %}>
                {% endwith %}
            {% elif role_ext.field_type == 'number' %}
                {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                <input type="number" name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}"
                       value="{% if user_ext %}{{ user_ext.field_value }}{% endif %}"
                       {% if role_ext.is_required %}required{% endif %}>
                {% endwith %}
            {% elif role_ext.field_type == 'phone' %}
                {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                <input type="tel" name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}"
                       value="{% if user_ext %}{{ user_ext.field_value }}{% endif %}"
                       {% if role_ext.is_required %}required{% endif %}>
                {% endwith %}
            {% else %}
                {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                <input type="text" name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}"
                       value="{% if user_ext %}{{ user_ext.field_value }}{% endif %}"
                       {% if role_ext.is_required %}required{% endif %}>
                {% endwith %}
            {% endif %}
            
            {% if role_ext.help_text %}
            <div class="help-text">{{ role_ext.help_text }}</div>
            {% endif %}
            
            <!-- æ˜¾ç¤ºå½“å‰å€¼å’Œæ›´æ–°æ—¶é—´ -->
            {% with user_ext=extension_data|get_extension_data:role_ext.id %}
            {% if user_ext %}
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                å½“å‰å€¼: <strong>{{ user_ext.field_value }}</strong>
                | æ›´æ–°æ—¶é—´: {{ user_ext.updated_at|date:"Y-m-d H:i" }}
                {% if user_ext.created_by %}
                | æ›´æ–°è€…: {{ user_ext.created_by.username }}
                {% endif %}
            </div>
            {% endif %}
            {% endwith %}
        </div>
        {% empty %}
        <div style="text-align: center; padding: 40px; color: #666;">
            <h4>è¯¥è§’è‰²æš‚æ— å¯é…ç½®çš„å¢é¡¹å­—æ®µ</h4>
            <p>è¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ å¢é¡¹é…ç½®</p>
        </div>
        {% endfor %}
        
        {% if role_extensions %}
        <div style="text-align: right; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
            <button type="submit" class="btn btn-success" style="font-size: 16px; padding: 10px 20px;">
                ğŸ’¾ ä¿å­˜å¢é¡¹ä¿¡æ¯
            </button>
            <a href="{% url 'accounts:role_users_list' role_user.role_level.id %}" 
               class="btn btn-secondary" style="font-size: 16px; padding: 10px 20px;">
                â†©ï¸ è¿”å›ç”¨æˆ·åˆ—è¡¨
            </a>
        </div>
        {% endif %}
    </form>
</div>

<!-- å¢é¡¹å†å²è®°å½• -->
{% if user_extensions %}
<div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-top: 20px;">
    <h3 style="margin: 0 0 15px 0; color: #333;">å¢é¡¹å†å²è®°å½•</h3>
    <table class="user-table">
        <thead>
            <tr>
                <th>å­—æ®µåç§°</th>
                <th>å½“å‰å€¼</th>
                <th>å­—æ®µç±»å‹</th>
                <th>åˆ›å»ºæ—¶é—´</th>
                <th>æ›´æ–°æ—¶é—´</th>
                <th>æ“ä½œè€…</th>
            </tr>
        </thead>
        <tbody>
            {% for ext in user_extensions %}
            <tr>
                <td><strong>{{ ext.role_extension.field_label }}</strong></td>
                <td>
                    <span style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px;">
                        {{ ext.get_display_value|truncatechars:50 }}
                    </span>
                </td>
                <td>{{ ext.role_extension.get_field_type_display }}</td>
                <td>{{ ext.created_at|date:"Y-m-d H:i" }}</td>
                <td>{{ ext.updated_at|date:"Y-m-d H:i" }}</td>
                <td>{{ ext.created_by.username|default:"ç³»ç»Ÿ" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- ç”¨æˆ·å¤‡æ³¨ -->
{% if role_user.notes %}
<div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-top: 20px;">
    <h4 style="margin: 0 0 10px 0; color: #856404;">ğŸ“ ç”¨æˆ·å¤‡æ³¨</h4>
    <p style="margin: 0; color: #856404;">{{ role_user.notes }}</p>
</div>
{% endif %}

<script>
// è¡¨å•éªŒè¯å’Œç”¨æˆ·ä½“éªŒæ”¹è¿›
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const requiredFields = form.querySelectorAll('[required]');
    
    // ä¸ºå¿…å¡«å­—æ®µæ·»åŠ æ ·å¼
    requiredFields.forEach(field => {
        field.addEventListener('invalid', function() {
            this.style.borderColor = '#dc3545';
        });
        
        field.addEventListener('input', function() {
            if (this.checkValidity()) {
                this.style.borderColor = '#28a745';
            } else {
                this.style.borderColor = '#dc3545';
            }
        });
    });
    
    // è¡¨å•æäº¤ç¡®è®¤
    form.addEventListener('submit', function(e) {
        const changedFields = [];
        const formData = new FormData(form);
        
        // æ£€æŸ¥å“ªäº›å­—æ®µè¢«ä¿®æ”¹äº†
        for (let [name, value] of formData.entries()) {
            if (name.startsWith('extension_') && value.trim()) {
                const fieldLabel = document.querySelector(`label[for="${name}"]`).textContent.trim();
                changedFields.push(fieldLabel);
            }
        }
        
        if (changedFields.length > 0) {
            const message = `ç¡®å®šè¦æ›´æ–°ä»¥ä¸‹å­—æ®µå—ï¼Ÿ\n\n${changedFields.join('\n')}`;
            if (!confirm(message)) {
                e.preventDefault();
            }
        }
    });
});
</script>
{% endblock %}