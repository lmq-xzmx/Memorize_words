{% extends "admin/accounts/role_hierarchy/base.html" %}
{% load i18n role_hierarchy_extras %}

{% block hierarchy_content %}
<div class="header-section">
    <h1>{{ role_user.user.username }} - 增项管理</h1>
    <p>管理用户在 {{ role_user.role_level.role_name }} 角色下的增项信息</p>
</div>

<!-- 用户信息卡片 -->
<div class="stats-cards">
    <div class="stats-card">
        <h3>用户信息</h3>
        <div style="text-align: left;">
            <p><strong>用户名:</strong> {{ role_user.user.username }}</p>
            <p><strong>真实姓名:</strong> {{ role_user.user.real_name|default:"未设置" }}</p>
            <p><strong>邮箱:</strong> {{ role_user.user.email|default:"未设置" }}</p>
        </div>
    </div>
    <div class="stats-card">
        <h3>角色信息</h3>
        <div style="text-align: left;">
            <p><strong>角色:</strong> {{ role_user.role_level.role_name }}</p>
            <p><strong>角色代码:</strong> {{ role_user.role_level.role }}</p>
            <p><strong>加入时间:</strong> {{ role_user.joined_at|date:"Y-m-d" }}</p>
        </div>
    </div>
    <div class="stats-card">
        <h3>增项统计</h3>
        <div class="number">{{ user_extensions.count }}</div>
        <p>已配置 / {{ role_extensions.count }} 可用</p>
    </div>
</div>

<!-- 增项表单 -->
<div class="extension-form">
    <h3 style="margin: 0 0 20px 0; color: #333; border-bottom: 2px solid #007cba; padding-bottom: 10px;">
        增项信息配置
    </h3>
    
    <form method="post" action="{% url 'accounts:update_user_extensions' role_user.id %}">
        {% csrf_token %}
        
        {% for role_ext in role_extensions %}
        <div class="form-group">
            <label for="extension_{{ role_ext.id }}">
                {{ role_ext.field_label }}
                {% if role_ext.is_required %}
                <span style="color: #dc3545;">*</span>
                {% endif %}
            </label>
            
            {% if role_ext.field_type == 'choice' %}
                <select name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}"
                        {% if role_ext.is_required %}required{% endif %}>
                    <option value="">请选择...</option>
                    {% for choice_value, choice_label in role_ext.get_choices_list %}
                    {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                    <option value="{{ choice_value }}" 
                            {% if user_ext and user_ext.field_value == choice_value %}selected{% endif %}>
                        {{ choice_label }}
                    </option>
                    {% endwith %}
                    {% endfor %}
                </select>
            {% elif role_ext.field_type == 'textarea' %}
                {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                <textarea name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}" 
                          rows="4" {% if role_ext.is_required %}required{% endif %}>{% if user_ext and user_ext.field_value %}{{ user_ext.field_value }}{% endif %}</textarea>
                {% endwith %}
            {% elif role_ext.field_type == 'boolean' %}
                {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                <select name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}">
                    <option value="">请选择...</option>
                    <option value="true" {% if user_ext and user_ext.field_value == 'true' %}selected{% endif %}>是</option>
                    <option value="false" {% if user_ext and user_ext.field_value == 'false' %}selected{% endif %}>否</option>
                </select>
                {% endwith %}
            {% elif role_ext.field_type == 'date' %}
                {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                <input type="date" name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}"
                       value="{% if user_ext %}{{ user_ext.field_value }}{% endif %}"
                       {% if role_ext.is_required %}required{% endif %}>
                {% endwith %}
            {% elif role_ext.field_type == 'email' %}
                {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                <input type="email" name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}"
                       value="{% if user_ext %}{{ user_ext.field_value }}{% endif %}"
                       {% if role_ext.is_required %}required{% endif %}>
                {% endwith %}
            {% elif role_ext.field_type == 'url' %}
                {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                <input type="url" name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}"
                       value="{% if user_ext %}{{ user_ext.field_value }}{% endif %}"
                       {% if role_ext.is_required %}required{% endif %}>
                {% endwith %}
            {% elif role_ext.field_type == 'number' %}
                {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                <input type="number" name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}"
                       value="{% if user_ext %}{{ user_ext.field_value }}{% endif %}"
                       {% if role_ext.is_required %}required{% endif %}>
                {% endwith %}
            {% elif role_ext.field_type == 'phone' %}
                {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                <input type="tel" name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}"
                       value="{% if user_ext %}{{ user_ext.field_value }}{% endif %}"
                       {% if role_ext.is_required %}required{% endif %}>
                {% endwith %}
            {% else %}
                {% with user_ext=extension_data|get_extension_data:role_ext.id %}
                <input type="text" name="extension_{{ role_ext.id }}" id="extension_{{ role_ext.id }}"
                       value="{% if user_ext %}{{ user_ext.field_value }}{% endif %}"
                       {% if role_ext.is_required %}required{% endif %}>
                {% endwith %}
            {% endif %}
            
            {% if role_ext.help_text %}
            <div class="help-text">{{ role_ext.help_text }}</div>
            {% endif %}
            
            <!-- 显示当前值和更新时间 -->
            {% with user_ext=extension_data|get_extension_data:role_ext.id %}
            {% if user_ext %}
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                当前值: <strong>{{ user_ext.field_value }}</strong>
                | 更新时间: {{ user_ext.updated_at|date:"Y-m-d H:i" }}
                {% if user_ext.created_by %}
                | 更新者: {{ user_ext.created_by.username }}
                {% endif %}
            </div>
            {% endif %}
            {% endwith %}
        </div>
        {% empty %}
        <div style="text-align: center; padding: 40px; color: #666;">
            <h4>该角色暂无可配置的增项字段</h4>
            <p>请联系管理员添加增项配置</p>
        </div>
        {% endfor %}
        
        {% if role_extensions %}
        <div style="text-align: right; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
            <button type="submit" class="btn btn-success" style="font-size: 16px; padding: 10px 20px;">
                💾 保存增项信息
            </button>
            <a href="{% url 'accounts:role_users_list' role_user.role_level.id %}" 
               class="btn btn-secondary" style="font-size: 16px; padding: 10px 20px;">
                ↩️ 返回用户列表
            </a>
        </div>
        {% endif %}
    </form>
</div>

<!-- 增项历史记录 -->
{% if user_extensions %}
<div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-top: 20px;">
    <h3 style="margin: 0 0 15px 0; color: #333;">增项历史记录</h3>
    <table class="user-table">
        <thead>
            <tr>
                <th>字段名称</th>
                <th>当前值</th>
                <th>字段类型</th>
                <th>创建时间</th>
                <th>更新时间</th>
                <th>操作者</th>
            </tr>
        </thead>
        <tbody>
            {% for ext in user_extensions %}
            <tr>
                <td><strong>{{ ext.role_extension.field_label }}</strong></td>
                <td>
                    <span style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px;">
                        {{ ext.get_display_value|truncatechars:50 }}
                    </span>
                </td>
                <td>{{ ext.role_extension.get_field_type_display }}</td>
                <td>{{ ext.created_at|date:"Y-m-d H:i" }}</td>
                <td>{{ ext.updated_at|date:"Y-m-d H:i" }}</td>
                <td>{{ ext.created_by.username|default:"系统" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- 用户备注 -->
{% if role_user.notes %}
<div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-top: 20px;">
    <h4 style="margin: 0 0 10px 0; color: #856404;">📝 用户备注</h4>
    <p style="margin: 0; color: #856404;">{{ role_user.notes }}</p>
</div>
{% endif %}

<script>
// 表单验证和用户体验改进
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const requiredFields = form.querySelectorAll('[required]');
    
    // 为必填字段添加样式
    requiredFields.forEach(field => {
        field.addEventListener('invalid', function() {
            this.style.borderColor = '#dc3545';
        });
        
        field.addEventListener('input', function() {
            if (this.checkValidity()) {
                this.style.borderColor = '#28a745';
            } else {
                this.style.borderColor = '#dc3545';
            }
        });
    });
    
    // 表单提交确认
    form.addEventListener('submit', function(e) {
        const changedFields = [];
        const formData = new FormData(form);
        
        // 检查哪些字段被修改了
        for (let [name, value] of formData.entries()) {
            if (name.startsWith('extension_') && value.trim()) {
                const fieldLabel = document.querySelector(`label[for="${name}"]`).textContent.trim();
                changedFields.push(fieldLabel);
            }
        }
        
        if (changedFields.length > 0) {
            const message = `确定要更新以下字段吗？\n\n${changedFields.join('\n')}`;
            if (!confirm(message)) {
                e.preventDefault();
            }
        }
    });
});
</script>
{% endblock %}