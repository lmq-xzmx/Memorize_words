{% extends "admin/accounts/role_hierarchy/base.html" %}
{% load i18n %}

{% block hierarchy_content %}
<div class="header-section">
    <h1>{{ title }}</h1>
    <p>管理系统中所有角色及其用户的增项信息</p>
</div>

<!-- 统计卡片 -->
<div class="stats-cards">
    <div class="stats-card">
        <h3>角色总数</h3>
        <div class="number">{{ total_roles }}</div>
        <p>系统中的角色类型数量</p>
    </div>
    <div class="stats-card">
        <h3>用户总数</h3>
        <div class="number">{{ total_users }}</div>
        <p>所有角色下的活跃用户</p>
    </div>
    <div class="stats-card">
        <h3>增项总数</h3>
        <div class="number">{{ total_extensions }}</div>
        <p>所有用户的增项数据</p>
    </div>
</div>

<!-- 操作按钮 -->
<div style="margin-bottom: 20px; text-align: right;">
    <a href="{% url 'accounts:sync_role_data' %}" class="btn btn-success" 
       onclick="return confirm('确定要同步所有角色数据吗？这可能需要一些时间。')">
        🔄 同步角色数据
    </a>
</div>

<!-- 角色列表 -->
<div class="role-grid">
    {% for role_level in role_levels %}
    <div class="role-card">
        <h3>
            {{ role_level.role_name }}
            {% if not role_level.is_active %}
                <span style="color: #dc3545; font-size: 12px;">(已禁用)</span>
            {% endif %}
        </h3>
        
        <div class="role-info">
            <span style="background: #e3f2fd; color: #1976d2;">
                👥 {{ role_level.user_count }} 个用户
            </span>
            <span style="background: #e8f5e8; color: #2e7d32;">
                📋 {{ role_level.extension_count }} 项增项
            </span>
        </div>
        
        {% if role_level.description %}
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            {{ role_level.description }}
        </p>
        {% endif %}
        
        <div class="actions">
            <a href="{% url 'accounts:role_users_list' role_level.id %}" class="btn btn-primary">
                👥 查看用户 ({{ role_level.user_count }})
            </a>
            {% if role_level.user_count > 0 %}
            <button onclick="loadRoleStats('{{ role_level.id }}')" class="btn btn-secondary">
                📊 统计信息
            </button>
            {% endif %}
        </div>
    </div>
    {% empty %}
    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
        <h3>暂无角色数据</h3>
        <p>请点击"同步角色数据"按钮来初始化系统数据</p>
    </div>
    {% endfor %}
</div>

<!-- 统计信息模态框 -->
<div id="statsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
        <h3 id="statsTitle">角色统计信息</h3>
        <div id="statsContent">
            <p>加载中...</p>
        </div>
        <div style="text-align: right; margin-top: 20px;">
            <button onclick="closeStatsModal()" class="btn btn-secondary">关闭</button>
        </div>
    </div>
</div>

<script>
function loadRoleStats(roleLevelId) {
    document.getElementById('statsModal').style.display = 'block';
    document.getElementById('statsContent').innerHTML = '<p>加载中...</p>';
    
    fetch('/accounts/role-hierarchy/api/role/' + roleLevelId + '/stats/')
        .then(response => response.json())
        .then(data => {
            let content = `
                <div style="margin-bottom: 20px;">
                    <h4>${data.role_name}</h4>
                    <p><strong>用户总数:</strong> ${data.total_users}</p>
                    <p><strong>增项总数:</strong> ${data.total_extensions}</p>
                </div>
            `;
            
            if (Object.keys(data.extension_stats).length > 0) {
                content += '<h4>增项分布:</h4><ul>';
                for (const [fieldLabel, count] of Object.entries(data.extension_stats)) {
                    content += `<li>${fieldLabel}: ${count} 个用户</li>`;
                }
                content += '</ul>';
            } else {
                content += '<p>暂无增项数据</p>';
            }
            
            document.getElementById('statsContent').innerHTML = content;
        })
        .catch(error => {
            document.getElementById('statsContent').innerHTML = '<p style="color: red;">加载失败，请重试</p>';
        });
}

function closeStatsModal() {
    document.getElementById('statsModal').style.display = 'none';
}

// 点击模态框外部关闭
document.getElementById('statsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeStatsModal();
    }
});
</script>
{% endblock %}