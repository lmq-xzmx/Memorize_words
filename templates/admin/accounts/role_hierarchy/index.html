{% extends "admin/accounts/role_hierarchy/base.html" %}
{% load i18n %}

{% block hierarchy_content %}
<div class="header-section">
    <h1>{{ title }}</h1>
    <p>ç®¡ç†ç³»ç»Ÿä¸­æ‰€æœ‰è§’è‰²åŠå…¶ç”¨æˆ·çš„å¢é¡¹ä¿¡æ¯</p>
</div>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="stats-cards">
    <div class="stats-card">
        <h3>è§’è‰²æ€»æ•°</h3>
        <div class="number">{{ total_roles }}</div>
        <p>ç³»ç»Ÿä¸­çš„è§’è‰²ç±»å‹æ•°é‡</p>
    </div>
    <div class="stats-card">
        <h3>ç”¨æˆ·æ€»æ•°</h3>
        <div class="number">{{ total_users }}</div>
        <p>æ‰€æœ‰è§’è‰²ä¸‹çš„æ´»è·ƒç”¨æˆ·</p>
    </div>
    <div class="stats-card">
        <h3>å¢é¡¹æ€»æ•°</h3>
        <div class="number">{{ total_extensions }}</div>
        <p>æ‰€æœ‰ç”¨æˆ·çš„å¢é¡¹æ•°æ®</p>
    </div>
</div>

<!-- æ“ä½œæŒ‰é’® -->
<div style="margin-bottom: 20px; text-align: right;">
    <a href="{% url 'accounts:sync_role_data' %}" class="btn btn-success" 
       onclick="return confirm('ç¡®å®šè¦åŒæ­¥æ‰€æœ‰è§’è‰²æ•°æ®å—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚')">
        ğŸ”„ åŒæ­¥è§’è‰²æ•°æ®
    </a>
</div>

<!-- è§’è‰²åˆ—è¡¨ -->
<div class="role-grid">
    {% for role_level in role_levels %}
    <div class="role-card">
        <h3>
            {{ role_level.role_name }}
            {% if not role_level.is_active %}
                <span style="color: #dc3545; font-size: 12px;">(å·²ç¦ç”¨)</span>
            {% endif %}
        </h3>
        
        <div class="role-info">
            <span style="background: #e3f2fd; color: #1976d2;">
                ğŸ‘¥ {{ role_level.user_count }} ä¸ªç”¨æˆ·
            </span>
            <span style="background: #e8f5e8; color: #2e7d32;">
                ğŸ“‹ {{ role_level.extension_count }} é¡¹å¢é¡¹
            </span>
        </div>
        
        {% if role_level.description %}
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            {{ role_level.description }}
        </p>
        {% endif %}
        
        <div class="actions">
            <a href="{% url 'accounts:role_users_list' role_level.id %}" class="btn btn-primary">
                ğŸ‘¥ æŸ¥çœ‹ç”¨æˆ· ({{ role_level.user_count }})
            </a>
            {% if role_level.user_count > 0 %}
            <button onclick="loadRoleStats('{{ role_level.id }}')" class="btn btn-secondary">
                ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
            </button>
            {% endif %}
        </div>
    </div>
    {% empty %}
    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
        <h3>æš‚æ— è§’è‰²æ•°æ®</h3>
        <p>è¯·ç‚¹å‡»"åŒæ­¥è§’è‰²æ•°æ®"æŒ‰é’®æ¥åˆå§‹åŒ–ç³»ç»Ÿæ•°æ®</p>
    </div>
    {% endfor %}
</div>

<!-- ç»Ÿè®¡ä¿¡æ¯æ¨¡æ€æ¡† -->
<div id="statsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
        <h3 id="statsTitle">è§’è‰²ç»Ÿè®¡ä¿¡æ¯</h3>
        <div id="statsContent">
            <p>åŠ è½½ä¸­...</p>
        </div>
        <div style="text-align: right; margin-top: 20px;">
            <button onclick="closeStatsModal()" class="btn btn-secondary">å…³é—­</button>
        </div>
    </div>
</div>

<script>
function loadRoleStats(roleLevelId) {
    document.getElementById('statsModal').style.display = 'block';
    document.getElementById('statsContent').innerHTML = '<p>åŠ è½½ä¸­...</p>';
    
    fetch('/accounts/role-hierarchy/api/role/' + roleLevelId + '/stats/')
        .then(response => response.json())
        .then(data => {
            let content = `
                <div style="margin-bottom: 20px;">
                    <h4>${data.role_name}</h4>
                    <p><strong>ç”¨æˆ·æ€»æ•°:</strong> ${data.total_users}</p>
                    <p><strong>å¢é¡¹æ€»æ•°:</strong> ${data.total_extensions}</p>
                </div>
            `;
            
            if (Object.keys(data.extension_stats).length > 0) {
                content += '<h4>å¢é¡¹åˆ†å¸ƒ:</h4><ul>';
                for (const [fieldLabel, count] of Object.entries(data.extension_stats)) {
                    content += `<li>${fieldLabel}: ${count} ä¸ªç”¨æˆ·</li>`;
                }
                content += '</ul>';
            } else {
                content += '<p>æš‚æ— å¢é¡¹æ•°æ®</p>';
            }
            
            document.getElementById('statsContent').innerHTML = content;
        })
        .catch(error => {
            document.getElementById('statsContent').innerHTML = '<p style="color: red;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
        });
}

function closeStatsModal() {
    document.getElementById('statsModal').style.display = 'none';
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
document.getElementById('statsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeStatsModal();
    }
});
</script>
{% endblock %}