{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block title %}{% trans '批量导入' %} | {{ opts.verbose_name_plural }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/forms.css' %}">
<style>
.batch-import-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

.import-section {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.import-section h3 {
    margin-top: 0;
    color: #495057;
    border-bottom: 2px solid #007cba;
    padding-bottom: 10px;
}

.form-row {
    margin-bottom: 15px;
}

.form-row label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
}

.form-row input, .form-row select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
}

.help-text {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

.csv-template {
    background: #e9ecef;
    padding: 15px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    overflow-x: auto;
    white-space: pre;
}

.submit-row {
    text-align: right;
    padding-top: 20px;
    border-top: 1px solid #dee2e6;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    margin-left: 10px;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background: #007cba;
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn:hover {
    opacity: 0.9;
}

.field-list {
    list-style: none;
    padding: 0;
    margin: 10px 0;
}

.field-list li {
    padding: 5px 0;
    border-bottom: 1px solid #eee;
}

.field-required {
    color: #dc3545;
    font-weight: bold;
}

.field-optional {
    color: #28a745;
}

.warning-box {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 4px;
    padding: 15px;
    margin: 15px 0;
    color: #856404;
}

.info-box {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 4px;
    padding: 15px;
    margin: 15px 0;
    color: #0c5460;
}

/* Django消息样式 */
.messagelist {
    margin: 0 0 20px;
    padding: 0;
    list-style: none;
}

.messagelist li {
    display: block;
    margin: 0 0 10px;
    padding: 10px 15px;
    border-radius: 4px;
    font-size: 13px;
}

.messagelist .success {
    background: #dfd;
    border: 1px solid #6c6;
    color: #060;
}

.messagelist .error {
    background: #fdd;
    border: 1px solid #c66;
    color: #600;
}

.messagelist .warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

.messagelist .info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
}
</style>
{% endblock %}

{% block content %}
<div id="content-start">
    <!-- Django消息显示 -->
    {% if messages %}
        <ul class="messagelist">
            {% for message in messages %}
                <li class="{{ message.tags }}">
                    {{ message|capfirst }}
                </li>
            {% endfor %}
        </ul>
    {% endif %}
    
    <div class="batch-import-container">
        <h1>{% trans '批量导入' %} {{ opts.verbose_name_plural }}</h1>
        
        <form method="post" enctype="multipart/form-data" id="batch-import-form">
            {% csrf_token %}
            
            <!-- 文件上传 -->
            <div class="import-section">
                <h3>{% trans '文件上传' %}</h3>
                
                <div class="form-row">
                    <label for="id_csv_file">{% trans 'CSV文件' %}:</label>
                    <input type="file" name="csv_file" id="id_csv_file" accept=".csv" required>
                    <div class="help-text">{% trans '请选择包含要导入数据的CSV文件（UTF-8编码）' %}</div>
                </div>
            </div>
            
            <!-- 导入设置 -->
            <div class="import-section">
                <h3>{% trans '导入设置' %}</h3>
                
                <div class="form-row">
                    <label for="id_import_source_name">{% trans '导入来源名称' %}:</label>
                    <input type="text" name="import_source_name" id="id_import_source_name" placeholder="{% trans '例如：译林版三年级上册' %}">
                    <div class="help-text">{% trans '为本次导入指定一个来源名称，便于后续追踪和管理（可选）' %}</div>
                </div>
            </div>
            
            <!-- CSV格式说明 -->
            <div class="import-section">
                <h3>{% trans 'CSV格式要求' %}</h3>
                
                <div class="info-box">
                    <strong>{% trans '文件编码：' %}</strong>UTF-8<br>
                    <strong>{% trans '分隔符：' %}</strong>逗号(,)<br>
                    <strong>{% trans '第一行：' %}</strong>必须为列标题
                </div>
                
                <h4>{% trans '字段说明' %}</h4>
                <ul class="field-list">
                    {% block field_descriptions %}
                    <!-- 子模板将重写此块 -->
                    {% endblock %}
                </ul>
                
                <h4>{% trans 'CSV模板示例' %}</h4>
                <div class="csv-template">{% block csv_template %}
<!-- 子模板将重写此块 -->
{% endblock %}</div>
                
                <div class="warning-box">
                    <strong>⚠️ 重要提示：</strong>
                    <ul>
                        <li><strong>name字段不能为空</strong> - 每行必须有词汇表名称</li>
                        <li>如果某个字段为空，请留空但保留逗号分隔符</li>
                        <li>避免在字段中使用多余的空格</li>
                        <li>建议使用UTF-8编码保存CSV文件</li>
                    </ul>
                </div>
                
                <div class="warning-box">
                    <strong>{% trans '注意事项：' %}</strong><br>
                    {% block import_notes %}
                    • {% trans '请确保CSV文件使用UTF-8编码保存' %}<br>
                    • {% trans '日期格式请使用 YYYY-MM-DD' %}<br>
                    • {% trans '布尔值请使用 true/false 或 1/0' %}<br>
                    • {% trans '如果字段包含逗号，请用双引号包围' %}
                    {% endblock %}
                </div>
            </div>
            
            <!-- 提交按钮 -->
            <div class="submit-row">
                <a href="../" class="btn btn-secondary">{% trans '取消' %}</a>
                <button type="submit" class="btn btn-primary" id="submit-btn">{% trans '开始导入' %}</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('batch-import-form');
    const submitBtn = document.getElementById('submit-btn');
    
    form.addEventListener('submit', function(e) {
        submitBtn.disabled = true;
        submitBtn.textContent = '{% trans "处理中..." %}';
    });
    
    // 文件选择验证
    const fileInput = document.getElementById('id_csv_file');
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && !file.name.toLowerCase().endsWith('.csv')) {
            alert('{% trans "请选择CSV文件" %}');
            e.target.value = '';
        }
    });
});
</script>
{% endblock %}