{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label='words' %}">单词工厂</a>
&rsaquo; <a href="{% url 'admin:words_word_changelist' %}">单词管理</a>
&rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<form method="post">
{% csrf_token %}

<div class="form-row">
    <div>
        <label for="word_set">选择单词集:</label>
        <select name="word_set" id="word_set">
            <option value="">---------</option>
            {% for word_set in word_sets %}
            <option value="{{ word_set.id }}" {% if new_wordset_id and word_set.id|stringformat:"s" == new_wordset_id %}selected{% endif %}>
                {{ word_set.name }} ({{ word_set.word_count }} 个单词)
            </option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="form-row">
    <div>
        <label>
            <input type="checkbox" id="create_new_wordset" name="create_new_wordset"> 
            创建新单词集
        </label>
    </div>
</div>

<div class="form-row" id="new_wordset_row" style="display: none;">
    <div>
        <label for="new_wordset_name">新单词集名称:</label>
        <input type="text" name="new_wordset_name" id="new_wordset_name" maxlength="100" placeholder="输入新单词集的名称">
        <p class="help">创建一个新的单词集来存放选中的单词</p>
    </div>
</div>

<div class="form-row">
    <div>
        <h3>将要添加的单词 ({{ queryset.count }} 个):</h3>
        <ul>
        {% for word in queryset %}
            <li>{{ word.word }} - {{ word.definition|truncatechars:50 }}</li>
        {% endfor %}
        </ul>
    </div>
</div>

{% for obj in queryset %}
<input type="hidden" name="{{ action_checkbox_name }}" value="{{ obj.pk }}" />
{% endfor %}

<div class="submit-row">
    <input type="submit" name="apply" value="添加到单词集" class="default" />
    <a href="{% url 'admin:words_word_changelist' %}" class="button cancel-link">取消</a>
</div>

</form>

<style>
.form-row {
    margin-bottom: 20px;
}
.form-row label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}
.form-row select, .form-row input[type="text"] {
    width: 300px;
    padding: 5px;
}
.form-row input[type="checkbox"] {
    margin-right: 8px;
}
.help {
    margin-top: 5px;
    font-size: 12px;
    color: #666;
    font-style: italic;
}
.submit-row {
    margin-top: 20px;
    padding: 10px 0;
    border-top: 1px solid #ddd;
}
.cancel-link {
    margin-left: 10px;
    text-decoration: none;
    color: #666;
}
.error {
    color: #dc3545;
    font-size: 12px;
    margin-top: 5px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const createNewCheckbox = document.getElementById('create_new_wordset');
    const newWordsetRow = document.getElementById('new_wordset_row');
    const wordSetSelect = document.getElementById('word_set');
    const newWordsetNameInput = document.getElementById('new_wordset_name');
    const form = document.querySelector('form');
    
    // 切换新单词集输入框显示
    createNewCheckbox.addEventListener('change', function() {
        if (this.checked) {
            newWordsetRow.style.display = 'block';
            wordSetSelect.disabled = true;
            wordSetSelect.value = '';
            newWordsetNameInput.focus();
        } else {
            newWordsetRow.style.display = 'none';
            wordSetSelect.disabled = false;
            newWordsetNameInput.value = '';
        }
    });
    
    // 表单验证
    form.addEventListener('submit', function(e) {
        const createNew = createNewCheckbox.checked;
        const selectedWordSet = wordSetSelect.value;
        const newWordsetName = newWordsetNameInput.value.trim();
        
        // 清除之前的错误信息
        const existingErrors = document.querySelectorAll('.error');
        existingErrors.forEach(error => error.remove());
        
        if (createNew) {
            if (!newWordsetName) {
                e.preventDefault();
                showError(newWordsetNameInput, '请输入新单词集的名称');
                return;
            }
        } else {
            if (!selectedWordSet) {
                e.preventDefault();
                showError(wordSetSelect, '请选择一个单词集或创建新的单词集');
                return;
            }
        }
    });
    
    function showError(element, message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = message;
        element.parentNode.appendChild(errorDiv);
    }
});
</script>
{% endblock %}