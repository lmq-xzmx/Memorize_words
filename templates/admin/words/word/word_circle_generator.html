{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}单词环生成器{% endblock %}

{% block extrahead %}
<style>
    .word-circle-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .control-panel {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .word-input-section, .image-gallery-section, .layout-style-section, .word-style-section {
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #f9f9f9;
    }
    
    .word-input-section h3, .image-gallery-section h3, .layout-style-section h3, .word-style-section h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #007cba;
        padding-bottom: 10px;
    }
    
    .word-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin: 15px 0;
    }
    
    .word-item {
        padding: 8px 12px;
        background: #007cba;
        color: white;
        border-radius: 4px;
        text-align: center;
        font-size: 14px;
        position: relative;
    }
    
    .word-item .remove-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .image-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 4px;
        background: white;
    }
    
    .gallery-item {
        border: 2px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 5px;
    }
    
    .gallery-item:hover {
        border-color: #007cba;
        transform: scale(1.05);
    }
    
    .gallery-item.selected {
        border-color: #28a745;
        background: #e8f5e8;
    }
    
    .gallery-item img {
        width: 100%;
        height: 80px;
        object-fit: cover;
        border-radius: 2px;
    }
    
    .preview-section {
        text-align: center;
        margin: 30px 0;
    }
    
    .word-circle-preview {
        position: relative;
        width: 500px;
        height: 500px;
        margin: 0 auto;
        border: 2px dashed #ddd;
        border-radius: 50%;
        background: #fafafa;
        transition: all 0.3s ease;
    }
    
    .word-circle-preview.layout-rectangle {
        border-radius: 20px;
        width: 600px;
        height: 400px;
    }
    
    .word-circle-preview.layout-grid {
        border-radius: 10px;
        width: 550px;
        height: 450px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
    }
    
    .word-circle-preview.layout-spiral {
        border-radius: 50%;
        width: 500px;
        height: 500px;
    }
    
    .center-image {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #007cba;
        background: white;
    }
    
    .word-position {
        position: absolute;
        padding: 8px 12px;
        background: rgba(0, 124, 186, 0.9);
        color: white;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
        cursor: move;
        user-select: none;
        transform: translate(-50%, -50%);
        transition: all 0.3s ease;
        border: 2px solid transparent;
        text-align: center;
        min-width: 80px;
        line-height: 1.2;
    }
    
    .word-position .word-text {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 2px;
    }
    
    .word-position .word-phonetic {
        font-size: 10px;
        opacity: 0.8;
        margin-bottom: 1px;
    }
    
    .word-position .word-meaning {
        font-size: 10px;
        opacity: 0.9;
    }
    
    .color-picker-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px 0;
    }
    
    .color-picker {
        width: 40px;
        height: 30px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .image-style-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin: 15px 0;
    }
    
    .image-style-btn {
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        background: #f9f9f9;
        cursor: pointer;
        text-align: center;
        font-size: 12px;
        transition: all 0.3s ease;
    }
    
    .image-style-btn:hover {
        border-color: #007cba;
        background: #e8f4f8;
    }
    
    .image-style-btn.active {
        border-color: #28a745;
        background: #e8f5e8;
        color: #28a745;
    }
    
    .center-image.style-original {
        border: none;
        border-radius: 0;
        filter: none;
        box-shadow: none;
        object-fit: cover;
    }
    
    .center-image.style-no-effect {
        border: none;
        filter: none;
        box-shadow: none;
    }
    
    .center-image.style-no-circle {
        border-radius: 0;
        border: 2px solid #007cba;
    }
    
    .center-image.style-blur {
        position: relative;
        border: 3px solid #007cba;
    }
    
    .center-image.style-blur::after {
        content: '';
        position: absolute;
        top: -8px;
        left: -8px;
        right: -8px;
        bottom: -8px;
        border-radius: 50%;
        border: 5px solid rgba(0, 124, 186, 0.3);
        filter: blur(3px);
        z-index: -1;
    }
    
    .center-image.style-no-border {
        border: none;
    }
    
    .center-image.style-shadow {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .center-image.style-gradient {
        border: 5px solid;
        border-image: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4) 1;
    }
    
    .word-position:hover {
        background: rgba(0, 124, 186, 1);
        border-color: #fff;
        transform: translate(-50%, -50%) scale(1.1);
    }
    
    .word-position.dragging {
        z-index: 1000;
        transform: translate(-50%, -50%) scale(1.2);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .action-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 30px;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary {
        background: #007cba;
        color: white;
    }
    
    .btn-primary:hover {
        background: #005a87;
        transform: translateY(-2px);
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #1e7e34;
        transform: translateY(-2px);
    }
    
    .btn-warning {
        background: #ffc107;
        color: #212529;
    }
    
    .btn-warning:hover {
        background: #e0a800;
        transform: translateY(-2px);
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #545b62;
        transform: translateY(-2px);
    }
    
    .input-group {
        display: flex;
        margin-bottom: 15px;
    }
    
    .input-group input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px 0 0 4px;
        font-size: 14px;
    }
    
    .input-group button {
        padding: 10px 15px;
        background: #007cba;
        color: white;
        border: 1px solid #007cba;
        border-radius: 0 4px 4px 0;
        cursor: pointer;
        font-size: 14px;
    }
    
    .input-group button:hover {
        background: #005a87;
    }
    
    .status-message {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        text-align: center;
    }
    
    .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .status-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .layout-style-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .layout-btn {
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        text-align: center;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .layout-btn:hover {
        border-color: #007cba;
        background: #f0f8ff;
    }
    
    .layout-btn.active {
        border-color: #007cba;
        background: #007cba;
        color: white;
    }
    
    .layout-preview {
        width: 60px;
        height: 40px;
        margin: 0 auto 5px;
        border: 1px solid #ccc;
        position: relative;
    }
    
    .layout-preview.circle {
        border-radius: 50%;
        width: 40px;
        height: 40px;
    }
    
    .layout-preview.rectangle {
        border-radius: 8px;
    }
    
    .layout-preview.grid {
        border-radius: 4px;
        display: flex;
        flex-wrap: wrap;
    }
    
    .layout-preview.spiral {
        border-radius: 50%;
        width: 40px;
        height: 40px;
    }
    
    .layout-preview::after {
        content: '';
        position: absolute;
        width: 4px;
        height: 4px;
        background: #007cba;
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    
    .word-position.grid-layout {
        position: static;
        margin: 5px;
        transform: none;
        display: inline-block;
    }
    
    .center-image.rectangle-layout {
        border-radius: 15px;
        width: 120px;
        height: 120px;
    }
    
    .center-image.grid-layout {
        position: static;
        width: 100px;
        height: 100px;
        margin: 10px;
        border-radius: 10px;
    }
    
    .layout-params {
        margin-top: 15px;
        padding: 15px;
        background: #f0f8ff;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
    }
    
    .param-group {
        margin-bottom: 12px;
    }
    
    .param-group label {
        display: inline-block;
        width: 80px;
        font-size: 12px;
        color: #555;
        margin-right: 8px;
    }
    
    .param-group input[type="range"] {
        width: 120px;
        margin-right: 8px;
        vertical-align: middle;
    }
    
    .param-group span {
        font-size: 12px;
        color: #007cba;
        font-weight: bold;
        min-width: 50px;
        display: inline-block;
    }
    
    .param-group br {
        margin-bottom: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="word-circle-container">
    
    <div class="control-panel">
        <!-- 单词输入区域 -->
        <div class="word-input-section">
            <h3>单词管理</h3>
            <div class="input-group">
                <input type="text" id="wordInput" placeholder="输入单词..." maxlength="20">
                <button onclick="addWord()">添加</button>
            </div>
            
            <div class="word-list" id="wordList">
                <!-- 默认单词将通过JavaScript加载 -->
            </div>
            
            <div style="margin-top: 15px;">
                <button class="btn btn-warning" onclick="resetWords()">重置为默认单词</button>
            </div>
        </div>
        
        <!-- 图片选择区域 -->
        <div class="image-gallery-section">
            <h3>中心图片选择</h3>
            <div class="image-gallery" id="imageGallery">
                <!-- 图片将通过JavaScript加载 -->
            </div>
        </div>
        
        <!-- 布局样式选择区域 -->
        <div class="layout-style-section">
            <h3>布局样式</h3>
            <div class="layout-style-buttons">
                <div class="layout-btn active" onclick="selectLayout('circle')" data-layout="circle">
                    <div class="layout-preview circle"></div>
                    <div>圆形布局</div>
                </div>
                <div class="layout-btn" onclick="selectLayout('rectangle')" data-layout="rectangle">
                    <div class="layout-preview rectangle"></div>
                    <div>矩形卡片</div>
                </div>
                <div class="layout-btn" onclick="selectLayout('grid')" data-layout="grid">
                    <div class="layout-preview grid"></div>
                    <div>网格布局</div>
                </div>
                <div class="layout-btn" onclick="selectLayout('spiral')" data-layout="spiral">
                    <div class="layout-preview spiral"></div>
                    <div>螺旋布局</div>
                </div>
            </div>
            
            <!-- 布局参数控制 -->
            <div class="layout-params" id="layoutParams">
                <h4 style="margin: 15px 0 10px 0; font-size: 14px; color: #666;">布局参数</h4>
                
                <!-- 圆形布局参数 -->
                <div class="param-group" id="circleParams" style="display: block;">
                    <label>半径大小:</label>
                    <input type="range" id="circleRadius" min="120" max="220" value="180" oninput="updateLayoutParams()">
                    <span id="circleRadiusValue">180px</span>
                </div>
                
                <!-- 矩形布局参数 -->
                <div class="param-group" id="rectangleParams" style="display: none;">
                    <label>宽度:</label>
                    <input type="range" id="rectWidth" min="400" max="800" value="600" oninput="updateLayoutParams()">
                    <span id="rectWidthValue">600px</span>
                    <br>
                    <label>高度:</label>
                    <input type="range" id="rectHeight" min="300" max="600" value="400" oninput="updateLayoutParams()">
                    <span id="rectHeightValue">400px</span>
                    <br>
                    <label>圆角:</label>
                    <input type="range" id="rectRadius" min="10" max="50" value="20" oninput="updateLayoutParams()">
                    <span id="rectRadiusValue">20px</span>
                </div>
                
                <!-- 网格布局参数 -->
                <div class="param-group" id="gridParams" style="display: none;">
                    <label>列数:</label>
                    <input type="range" id="gridCols" min="3" max="8" value="5" oninput="updateLayoutParams()">
                    <span id="gridColsValue">5列</span>
                    <br>
                    <label>间距:</label>
                    <input type="range" id="gridGap" min="10" max="30" value="15" oninput="updateLayoutParams()">
                    <span id="gridGapValue">15px</span>
                </div>
                
                <!-- 螺旋布局参数 -->
                <div class="param-group" id="spiralParams" style="display: none;">
                    <label>螺旋圈数:</label>
                    <input type="range" id="spiralTurns" min="2" max="8" value="3" oninput="updateLayoutParams()">
                    <span id="spiralTurnsValue">3圈</span>
                    <br>
                    <label>最大半径:</label>
                    <input type="range" id="spiralMaxRadius" min="150" max="250" value="200" oninput="updateLayoutParams()">
                    <span id="spiralMaxRadiusValue">200px</span>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="applyCurrentLayout()">应用当前样式</button>
            </div>
        </div>
        
        <!-- 单词样式控制区域 -->
        <div class="word-style-section">
            <h3>单词样式</h3>
            
            <!-- 背景色选择 -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">背景色设置:</label>
                <div class="color-picker-container">
                    <input type="color" id="wordBgColor" class="color-picker" value="#007cba" onchange="updateWordStyle()">
                    <span>选择背景色</span>
                </div>
                <div style="margin-top: 8px;">
                    <label style="font-size: 12px;">透明度:</label>
                    <input type="range" id="wordBgOpacity" min="0.3" max="1" step="0.1" value="0.9" oninput="updateWordStyle()" style="width: 100px; margin: 0 8px;">
                    <span id="wordBgOpacityValue" style="font-size: 12px;">90%</span>
                </div>
            </div>
            
            <!-- 文字颜色选择 -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">文字颜色:</label>
                <div class="color-picker-container">
                    <input type="color" id="wordTextColor" class="color-picker" value="#ffffff" onchange="updateWordStyle()">
                    <span>选择文字颜色</span>
                </div>
            </div>
            
            <!-- 文字显示选项 -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">显示内容:</label>
                <div style="font-size: 12px;">
                    <label><input type="checkbox" id="showPhonetic" checked onchange="updateWordStyle()"> 显示音标</label><br>
                    <label><input type="checkbox" id="showMeaning" checked onchange="updateWordStyle()"> 显示释义</label>
                </div>
            </div>
            
            <!-- 中心图片边缘样式 -->
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">图片边缘样式:</label>
                <div class="image-style-options">
                    <div class="image-style-btn active" onclick="selectImageStyle('default')" data-style="default">
                        默认边框
                    </div>
                    <div class="image-style-btn" onclick="selectImageStyle('original')" data-style="original">
                        使用原图
                    </div>
                    <div class="image-style-btn" onclick="selectImageStyle('no-effect')" data-style="no-effect">
                        无效果
                    </div>
                    <div class="image-style-btn" onclick="selectImageStyle('no-circle')" data-style="no-circle">
                        去掉圆形
                    </div>
                    <div class="image-style-btn" onclick="selectImageStyle('blur')" data-style="blur">
                        模糊边框
                    </div>
                    <div class="image-style-btn" onclick="selectImageStyle('no-border')" data-style="no-border">
                        无边框
                    </div>
                    <div class="image-style-btn" onclick="selectImageStyle('shadow')" data-style="shadow">
                        阴影效果
                    </div>
                    <div class="image-style-btn" onclick="selectImageStyle('gradient')" data-style="gradient">
                        渐变边框
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 预览区域 -->
    <div class="preview-section">
        <h3>单词环预览</h3>
        <div class="word-circle-preview" id="wordCirclePreview">
            <img id="centerImage" class="center-image" src="" alt="中心图片" style="display: none;">
            <!-- 单词位置将通过JavaScript动态生成 -->
        </div>
    </div>
    
    <!-- 操作按钮 -->
    <div class="action-buttons">
        <button class="btn btn-primary" onclick="generateWordCircle()">生成单词环</button>
        <button class="btn btn-success" onclick="saveWordCircle()">保存配置</button>
        <button class="btn btn-warning" onclick="resetWordCircle()">重置</button>
        <button class="btn btn-secondary" onclick="exportWordCircle()">导出图片</button>
    </div>
    
    <!-- 状态消息 -->
    <div id="statusMessage" class="status-message" style="display: none;"></div>
</div>

<script>
// 全局变量
let currentWords = [];
let selectedImage = '';
let wordPositions = [];
let isDragging = false;
let dragElement = null;
let dragOffset = { x: 0, y: 0 };
let currentLayout = 'circle'; // 当前布局样式
let currentImageStyle = 'default'; // 当前图片样式

// 布局参数
let layoutParams = {
    circle: { radius: 180 },
    rectangle: { width: 600, height: 400, borderRadius: 20 },
    grid: { cols: 5, gap: 15 },
    spiral: { turns: 3, maxRadius: 200 }
};

// 单词样式参数
let wordStyleParams = {
    backgroundColor: '#007cba',
    backgroundOpacity: 0.9,
    textColor: '#ffffff',
    showPhonetic: true,
    showMeaning: true
};

// 图片样式状态跟踪
let imageStyleStates = {
    'no-circle': false // 跟踪去掉圆形按钮的状态
};

// 默认单词列表（包含音标和释义）
const defaultWordsData = {
    'apple': { phonetic: '/ˈæpl/', meaning: '苹果' },
    'book': { phonetic: '/bʊk/', meaning: '书' },
    'cat': { phonetic: '/kæt/', meaning: '猫' },
    'dog': { phonetic: '/dɔːɡ/', meaning: '狗' },
    'elephant': { phonetic: '/ˈelɪfənt/', meaning: '大象' },
    'flower': { phonetic: '/ˈflaʊər/', meaning: '花' },
    'guitar': { phonetic: '/ɡɪˈtɑːr/', meaning: '吉他' },
    'house': { phonetic: '/haʊs/', meaning: '房子' },
    'ice': { phonetic: '/aɪs/', meaning: '冰' },
    'jump': { phonetic: '/dʒʌmp/', meaning: '跳跃' },
    'kite': { phonetic: '/kaɪt/', meaning: '风筝' },
    'lion': { phonetic: '/ˈlaɪən/', meaning: '狮子' },
    'moon': { phonetic: '/muːn/', meaning: '月亮' },
    'nest': { phonetic: '/nest/', meaning: '巢' },
    'ocean': { phonetic: '/ˈoʊʃən/', meaning: '海洋' }
};

// 默认单词列表
const defaultWords = Object.keys(defaultWordsData);

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    loadDefaultWords();
    loadImageGallery();
    setupEventListeners();
});

// 加载默认单词
function loadDefaultWords() {
    currentWords = [...defaultWords];
    renderWordList();
}

// 渲染单词列表
function renderWordList() {
    const wordList = document.getElementById('wordList');
    wordList.innerHTML = '';
    
    currentWords.forEach((word, index) => {
        const wordItem = document.createElement('div');
        wordItem.className = 'word-item';
        wordItem.innerHTML = `
            ${word}
            <button class="remove-btn" onclick="removeWord(${index})" title="删除单词">×</button>
        `;
        wordList.appendChild(wordItem);
    });
}

// 添加单词
function addWord() {
    const input = document.getElementById('wordInput');
    const word = input.value.trim().toLowerCase();
    
    if (!word) {
        showMessage('请输入单词', 'error');
        return;
    }
    
    if (currentWords.includes(word)) {
        showMessage('单词已存在', 'error');
        return;
    }
    
    if (currentWords.length >= 20) {
        showMessage('最多只能添加20个单词', 'error');
        return;
    }
    
    // 如果单词不在默认数据中，添加基本信息
    if (!defaultWordsData[word]) {
        defaultWordsData[word] = {
            phonetic: `/${word}/`, // 简单的音标格式
            meaning: '自定义单词' // 默认释义
        };
    }
    
    currentWords.push(word);
    input.value = '';
    renderWordList();
    showMessage(`已添加单词: ${word}`, 'success');
}

// 删除单词
function removeWord(index) {
    const word = currentWords[index];
    currentWords.splice(index, 1);
    renderWordList();
    showMessage(`已删除单词: ${word}`, 'info');
}

// 重置为默认单词
function resetWords() {
    currentWords = [...defaultWords];
    renderWordList();
    showMessage('已重置为默认单词', 'info');
}

// 加载图片库
function loadImageGallery() {
    const gallery = document.getElementById('imageGallery');
    let images = [];
    
    try {
        const imagesJson = '{{ gallery_images|escapejs }}';
        if (imagesJson && imagesJson.trim() !== '') {
            images = JSON.parse(imagesJson);
        }
    } catch (e) {
        console.error('解析图片数据失败:', e);
        images = [];
    }
    
    gallery.innerHTML = '';
    
    if (images && images.length > 0) {
        images.forEach(image => {
            const item = document.createElement('div');
            item.className = 'gallery-item';
            item.onclick = () => selectImage(image.url, item);
            
            item.innerHTML = `
                <img src="${image.url}" alt="${image.filename}" title="${image.filename}">
                <div style="font-size: 12px; text-align: center; margin-top: 5px;">${image.filename}</div>
            `;
            
            gallery.appendChild(item);
        });
    } else {
        gallery.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">暂无图片，请在 static/images/word_circle_gallery/ 目录下添加图片文件</div>';
    }
}

// 选择图片
function selectImage(imageUrl, element) {
    // 移除之前的选中状态
    document.querySelectorAll('.gallery-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // 设置新的选中状态
    element.classList.add('selected');
    selectedImage = imageUrl;
    
    // 更新中心图片
    const centerImage = document.getElementById('centerImage');
    centerImage.src = imageUrl;
    centerImage.style.display = 'block';
    
    // 应用当前图片样式
    applyImageStyle(centerImage, currentImageStyle);
    
    showMessage('已选择中心图片', 'success');
}

// 选择布局样式
function selectLayout(layout) {
    // 移除之前的选中状态
    document.querySelectorAll('.layout-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // 设置新的选中状态
    document.querySelector(`[data-layout="${layout}"]`).classList.add('active');
    currentLayout = layout;
    
    // 切换参数面板显示
    document.querySelectorAll('.param-group').forEach(group => {
        group.style.display = 'none';
    });
    document.getElementById(`${layout}Params`).style.display = 'block';
    
    showMessage(`已选择${getLayoutName(layout)}`, 'info');
}

// 更新布局参数
function updateLayoutParams() {
    const layout = currentLayout;
    
    if (layout === 'circle') {
        const radius = document.getElementById('circleRadius').value;
        layoutParams.circle.radius = parseInt(radius);
        document.getElementById('circleRadiusValue').textContent = radius + 'px';
    } else if (layout === 'rectangle') {
        const width = document.getElementById('rectWidth').value;
        const height = document.getElementById('rectHeight').value;
        const borderRadius = document.getElementById('rectRadius').value;
        
        layoutParams.rectangle.width = parseInt(width);
        layoutParams.rectangle.height = parseInt(height);
        layoutParams.rectangle.borderRadius = parseInt(borderRadius);
        
        document.getElementById('rectWidthValue').textContent = width + 'px';
        document.getElementById('rectHeightValue').textContent = height + 'px';
        document.getElementById('rectRadiusValue').textContent = borderRadius + 'px';
    } else if (layout === 'grid') {
        const cols = document.getElementById('gridCols').value;
        const gap = document.getElementById('gridGap').value;
        
        layoutParams.grid.cols = parseInt(cols);
        layoutParams.grid.gap = parseInt(gap);
        
        document.getElementById('gridColsValue').textContent = cols + '列';
        document.getElementById('gridGapValue').textContent = gap + 'px';
    } else if (layout === 'spiral') {
        const turns = document.getElementById('spiralTurns').value;
        const maxRadius = document.getElementById('spiralMaxRadius').value;
        
        layoutParams.spiral.turns = parseInt(turns);
        layoutParams.spiral.maxRadius = parseInt(maxRadius);
        
        document.getElementById('spiralTurnsValue').textContent = turns + '圈';
        document.getElementById('spiralMaxRadiusValue').textContent = maxRadius + 'px';
    }
}

// 获取布局名称
function getLayoutName(layout) {
    const names = {
        'circle': '圆形布局',
        'rectangle': '矩形卡片',
        'grid': '网格布局',
        'spiral': '螺旋布局'
    };
    return names[layout] || '未知布局';
}

// 应用当前布局样式
function applyCurrentLayout() {
    if (currentWords.length === 0) {
        showMessage('请先添加单词', 'error');
        return;
    }
    
    if (!selectedImage) {
        showMessage('请先选择中心图片', 'error');
        return;
    }
    
    generateWordCircleWithLayout(currentLayout);
}

// 生成单词环（兼容旧版本）
function generateWordCircle() {
    generateWordCircleWithLayout(currentLayout);
}

// 根据布局样式生成单词环
function generateWordCircleWithLayout(layout) {
    if (currentWords.length === 0) {
        showMessage('请先添加单词', 'error');
        return;
    }
    
    if (!selectedImage) {
        showMessage('请先选择中心图片', 'error');
        return;
    }
    
    const preview = document.getElementById('wordCirclePreview');
    const centerImage = document.getElementById('centerImage');
    
    // 清除现有的单词位置和样式
    document.querySelectorAll('.word-position').forEach(el => el.remove());
    preview.className = 'word-circle-preview';
    centerImage.className = 'center-image';
    
    // 重置预览区域样式为默认值
    preview.style.width = '500px';
    preview.style.height = '500px';
    preview.style.borderRadius = '50%';
    preview.style.gridTemplateColumns = '';
    preview.style.gap = '';
    
    wordPositions = [];
    
    // 根据布局类型生成
    switch (layout) {
        case 'circle':
            generateCircleLayout(preview, centerImage);
            break;
        case 'rectangle':
            generateRectangleLayout(preview, centerImage);
            break;
        case 'grid':
            generateGridLayout(preview, centerImage);
            break;
        case 'spiral':
            generateSpiralLayout(preview, centerImage);
            break;
        default:
            generateCircleLayout(preview, centerImage);
    }
    
    showMessage(`已生成${getLayoutName(layout)}，包含 ${currentWords.length} 个单词`, 'success');
}

// 圆形布局
function generateCircleLayout(preview, centerImage) {
    preview.classList.add('layout-circle');
    const centerX = 250;
    const centerY = 250;
    const radius = layoutParams.circle.radius;
    
    currentWords.forEach((word, index) => {
        const angle = (index * 360 / currentWords.length) * Math.PI / 180;
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        
        createWordElement(word, index, x, y, preview);
    });
}

// 矩形卡片布局
function generateRectangleLayout(preview, centerImage) {
    preview.classList.add('layout-rectangle');
    centerImage.classList.add('rectangle-layout');
    
    const width = layoutParams.rectangle.width;
    const height = layoutParams.rectangle.height;
    const borderRadius = layoutParams.rectangle.borderRadius;
    
    // 动态调整预览区域大小和样式
    preview.style.width = width + 'px';
    preview.style.height = height + 'px';
    preview.style.borderRadius = borderRadius + 'px';
    
    const centerX = width / 2;
    const centerY = height / 2;
    const margin = 60;
    
    // 计算周边位置
    const perimeter = 2 * (width - 2 * margin) + 2 * (height - 2 * margin);
    const spacing = perimeter / currentWords.length;
    
    currentWords.forEach((word, index) => {
        const distance = index * spacing;
        let x, y;
        
        if (distance < width - 2 * margin) {
            // 顶边
            x = margin + distance;
            y = margin;
        } else if (distance < width - 2 * margin + height - 2 * margin) {
            // 右边
            x = width - margin;
            y = margin + (distance - (width - 2 * margin));
        } else if (distance < 2 * (width - 2 * margin) + height - 2 * margin) {
            // 底边
            x = width - margin - (distance - (width - 2 * margin + height - 2 * margin));
            y = height - margin;
        } else {
            // 左边
            x = margin;
            y = height - margin - (distance - (2 * (width - 2 * margin) + height - 2 * margin));
        }
        
        createWordElement(word, index, x, y, preview);
    });
}

// 网格布局
function generateGridLayout(preview, centerImage) {
    preview.classList.add('layout-grid');
    centerImage.classList.add('grid-layout');
    
    const cols = layoutParams.grid.cols;
    const gap = layoutParams.grid.gap;
    
    // 动态调整网格样式
    preview.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    preview.style.gap = gap + 'px';
    
    // 网格布局中，单词和图片都作为flex项目
    const centerImageClone = centerImage.cloneNode(true);
    centerImageClone.style.position = 'static';
    centerImageClone.style.transform = 'none';
    preview.appendChild(centerImageClone);
    
    currentWords.forEach((word, index) => {
        const wordElement = document.createElement('div');
        wordElement.className = 'word-position grid-layout';
        wordElement.dataset.index = index;
        
        // 设置背景色
        const bgColor = wordStyleParams.backgroundColor;
        const opacity = wordStyleParams.backgroundOpacity;
        const rgb = hexToRgb(bgColor);
        wordElement.style.background = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${opacity})`;
        
        // 构建单词内容
        let content = `<div class="word-text">${word}</div>`;
        
        if (defaultWordsData[word]) {
            if (wordStyleParams.showPhonetic) {
                content += `<div class="word-phonetic">${defaultWordsData[word].phonetic}</div>`;
            }
            if (wordStyleParams.showMeaning) {
                content += `<div class="word-meaning">${defaultWordsData[word].meaning}</div>`;
            }
        }
        
        wordElement.innerHTML = content;
        
        setupDragEvents(wordElement);
        preview.appendChild(wordElement);
        
        wordPositions.push({ word, x: 0, y: 0, index });
    });
}

// 螺旋布局
function generateSpiralLayout(preview, centerImage) {
    preview.classList.add('layout-spiral');
    const centerX = 250;
    const centerY = 250;
    const maxRadius = layoutParams.spiral.maxRadius;
    const turns = layoutParams.spiral.turns;
    
    currentWords.forEach((word, index) => {
        const t = index / currentWords.length;
        const angle = t * turns * 2 * Math.PI; // 使用参数控制螺旋圈数
        const radius = t * maxRadius;
        
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        
        createWordElement(word, index, x, y, preview);
    });
}

// 创建单词元素
function createWordElement(word, index, x, y, preview) {
    const wordElement = document.createElement('div');
    wordElement.className = 'word-position';
    wordElement.style.left = x + 'px';
    wordElement.style.top = y + 'px';
    wordElement.dataset.index = index;
    
    // 设置背景色
    const bgColor = wordStyleParams.backgroundColor;
    const opacity = wordStyleParams.backgroundOpacity;
    const rgb = hexToRgb(bgColor);
    wordElement.style.background = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${opacity})`;
    
    // 设置文字颜色
    wordElement.style.color = wordStyleParams.textColor;
    
    // 构建单词内容
    let content = `<div class="word-text">${word}</div>`;
    
    if (defaultWordsData[word]) {
        if (wordStyleParams.showPhonetic) {
            content += `<div class="word-phonetic">${defaultWordsData[word].phonetic}</div>`;
        }
        if (wordStyleParams.showMeaning) {
            content += `<div class="word-meaning">${defaultWordsData[word].meaning}</div>`;
        }
    }
    
    wordElement.innerHTML = content;
    
    setupDragEvents(wordElement);
    preview.appendChild(wordElement);
    
    wordPositions.push({ word, x, y, angle: Math.atan2(y - 250, x - 250) });
}

// 颜色转换函数
function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

// 更新单词样式
function updateWordStyle() {
    // 更新样式参数
    wordStyleParams.backgroundColor = document.getElementById('wordBgColor').value;
    wordStyleParams.backgroundOpacity = parseFloat(document.getElementById('wordBgOpacity').value);
    wordStyleParams.textColor = document.getElementById('wordTextColor').value;
    wordStyleParams.showPhonetic = document.getElementById('showPhonetic').checked;
    wordStyleParams.showMeaning = document.getElementById('showMeaning').checked;
    
    // 更新透明度显示
    document.getElementById('wordBgOpacityValue').textContent = Math.round(wordStyleParams.backgroundOpacity * 100) + '%';
    
    // 重新生成单词环以应用新样式
    if (currentWords.length > 0 && selectedImage) {
        generateWordCircleWithLayout(currentLayout);
    }
}

// 选择图片样式
function selectImageStyle(style) {
    // 特殊处理去掉圆形按钮的切换逻辑
    if (style === 'no-circle') {
        if (currentImageStyle === 'no-circle') {
            // 如果当前已经是去掉圆形状态，则恢复为默认状态
            style = 'default';
            imageStyleStates['no-circle'] = false;
        } else {
            // 切换到去掉圆形状态
            imageStyleStates['no-circle'] = true;
        }
    }
    
    // 移除之前的选中状态
    document.querySelectorAll('.image-style-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // 设置新的选中状态
    document.querySelector(`[data-style="${style}"]`).classList.add('active');
    currentImageStyle = style;
    
    // 应用样式到中心图片
    const centerImage = document.getElementById('centerImage');
    if (centerImage && centerImage.style.display !== 'none') {
        applyImageStyle(centerImage, style);
    }
    
    showMessage(`已选择${getImageStyleName(style)}`, 'info');
}

// 应用图片样式
function applyImageStyle(imageElement, style) {
    // 清除所有样式类
    imageElement.classList.remove('style-blur', 'style-no-border', 'style-shadow', 'style-gradient', 'style-no-effect', 'style-no-circle', 'style-original');
    
    // 应用新样式
    if (style !== 'default') {
        imageElement.classList.add(`style-${style}`);
    }
}

// 获取图片样式名称
function getImageStyleName(style) {
    const names = {
        'default': '默认边框',
        'original': '使用原图',
        'no-effect': '无效果',
        'no-circle': '去掉圆形',
        'blur': '模糊边框',
        'no-border': '无边框',
        'shadow': '阴影效果',
        'gradient': '渐变边框'
    };
    return names[style] || '未知样式';
}

// 设置拖拽事件
function setupDragEvents(element) {
    element.addEventListener('mousedown', startDrag);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', endDrag);
}

// 开始拖拽
function startDrag(e) {
    isDragging = true;
    dragElement = e.target;
    dragElement.classList.add('dragging');
    
    const rect = dragElement.getBoundingClientRect();
    const previewRect = document.getElementById('wordCirclePreview').getBoundingClientRect();
    
    dragOffset.x = e.clientX - rect.left - rect.width / 2;
    dragOffset.y = e.clientY - rect.top - rect.height / 2;
    
    e.preventDefault();
}

// 拖拽中
function drag(e) {
    if (!isDragging || !dragElement) return;
    
    const previewRect = document.getElementById('wordCirclePreview').getBoundingClientRect();
    const elementRect = dragElement.getBoundingClientRect();
    
    let x = e.clientX - previewRect.left - dragOffset.x;
    let y = e.clientY - previewRect.top - dragOffset.y;
    
    // 边界限制 - 确保单词不会超出预览区域
    const elementWidth = elementRect.width;
    const elementHeight = elementRect.height;
    const previewWidth = previewRect.width;
    const previewHeight = previewRect.height;
    
    // 限制X坐标
    if (x < 0) x = 0;
    if (x + elementWidth > previewWidth) x = previewWidth - elementWidth;
    
    // 限制Y坐标
    if (y < 0) y = 0;
    if (y + elementHeight > previewHeight) y = previewHeight - elementHeight;
    
    dragElement.style.left = x + 'px';
    dragElement.style.top = y + 'px';
    
    // 更新位置数据
    const index = parseInt(dragElement.dataset.index);
    if (wordPositions[index]) {
        wordPositions[index].x = x;
        wordPositions[index].y = y;
    }
}

// 结束拖拽
function endDrag(e) {
    if (dragElement) {
        dragElement.classList.remove('dragging');
        dragElement = null;
    }
    isDragging = false;
}

// 设置事件监听器
function setupEventListeners() {
    // 回车键添加单词
    document.getElementById('wordInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            addWord();
        }
    });
}

// 保存单词环配置
function saveWordCircle() {
    if (currentWords.length === 0 || !selectedImage) {
        showMessage('请先生成单词环', 'error');
        return;
    }
    
    const config = {
        words: currentWords,
        image: selectedImage,
        positions: wordPositions
    };
    
    // 发送到后端保存
    fetch('{% url "admin:words_word_circle_generator" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('单词环配置已保存', 'success');
        } else {
            showMessage('保存失败: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showMessage('保存失败: ' + error.message, 'error');
    });
}

// 重置单词环
function resetWordCircle() {
    document.querySelectorAll('.word-position').forEach(el => el.remove());
    document.getElementById('centerImage').style.display = 'none';
    selectedImage = '';
    wordPositions = [];
    
    // 移除图片选中状态
    document.querySelectorAll('.gallery-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    showMessage('已重置单词环', 'info');
}

// 导出图片
function exportWordCircle() {
    if (currentWords.length === 0 || !selectedImage) {
        showMessage('请先生成单词环', 'error');
        return;
    }
    
    showMessage('正在生成图片...', 'info');
    
    // 使用html2canvas导出图片
    const previewElement = document.getElementById('wordCirclePreview');
    
    // 动态加载html2canvas库
    if (typeof html2canvas === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        script.onload = function() {
            performExport(previewElement);
        };
        script.onerror = function() {
            showMessage('导出库加载失败，请检查网络连接', 'error');
        };
        document.head.appendChild(script);
    } else {
        performExport(previewElement);
    }
}

// 执行导出
function performExport(element) {
    html2canvas(element, {
        backgroundColor: '#ffffff',
        scale: 2, // 提高清晰度
        useCORS: true,
        allowTaint: true,
        logging: false
    }).then(canvas => {
        // 创建下载链接
        const link = document.createElement('a');
        link.download = `单词环_${new Date().getTime()}.png`;
        link.href = canvas.toDataURL('image/png');
        
        // 触发下载
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showMessage('图片导出成功！', 'success');
    }).catch(error => {
        console.error('导出失败:', error);
        showMessage('导出失败: ' + error.message, 'error');
    });
}

// 显示消息
function showMessage(message, type) {
    const messageEl = document.getElementById('statusMessage');
    messageEl.textContent = message;
    messageEl.className = `status-message status-${type}`;
    messageEl.style.display = 'block';
    
    setTimeout(() => {
        messageEl.style.display = 'none';
    }, 3000);
}
</script>

<!-- CSRF Token -->
{% csrf_token %}
{% endblock %}