{% extends "admin/words/base_change_list.html" %}
{% load i18n admin_urls static %}

{% block batch-import-text %}批量导入单词{% endblock %}

{% block extra-tools %}
    <li>
        <a href="{% url 'admin:words_word_word_circle_generator' %}" class="addlink">
            {% trans '单词圆圈生成器' %}
        </a>
    </li>
{% endblock %}

{% block extrajs %}
    {{ block.super }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 移除重复的h1元素
            var h1Elements = document.querySelectorAll('#content h1');
            if (h1Elements.length >= 2) {
                h1Elements[1].remove();
            }
            
            // 增强批量操作功能
            var changelistForm = document.getElementById('changelist-form');
            if (changelistForm) {
                // 为批量操作添加提示信息
                var actionsDiv = document.querySelector('.actions');
                if (actionsDiv && !actionsDiv.querySelector('.help')) {
                    var helpText = document.createElement('p');
                    helpText.className = 'help';
                    helpText.style.color = '#666';
                    helpText.style.marginTop = '5px';
                    helpText.style.fontSize = '12px';
                    helpText.innerHTML = '批量操作步骤：1. 勾选单词 → 2. 选择操作 → 3. 点击"执行"按钮';
                    actionsDiv.appendChild(helpText);
                    
                    // 修改Go按钮文本
                    var goButton = actionsDiv.querySelector('button[name="index"]');
                    if (goButton) {
                        goButton.textContent = '执行';
                    }
                }
                
                // 表单提交验证
                changelistForm.addEventListener('submit', function(e) {
                    var actionSelect = document.querySelector('select[name="action"]');
                    var selectedCheckboxes = document.querySelectorAll('input[name="_selected_action"]:checked');
                    
                    if (actionSelect && (!actionSelect.value || actionSelect.value === '' || actionSelect.value === '---------')) {
                        e.preventDefault();
                        alert('请先选择要执行的操作！');
                        return false;
                    }
                    
                    if (selectedCheckboxes.length === 0) {
                        e.preventDefault();
                        alert('请先选择要操作的单词！');
                        return false;
                    }
                });
            }
            
            // 处理变体操作的函数
            window.handleVariantAction = function(selectElement, wordId) {
                var action = selectElement.value;
                if (!action) return;
                
                var confirmMessage = '';
                if (action === 'delete') {
                    confirmMessage = '确定要删除这个单词记录吗？此操作不可撤销。';
                } else if (action === 'keep_as_variant') {
                    confirmMessage = '确定要将此单词保留为新版本（变体）吗？';
                }
                
                if (confirmMessage && !confirm(confirmMessage)) {
                    selectElement.value = ''; // 重置选择
                    return;
                }
                
                // 发送AJAX请求
                var formData = new FormData();
                formData.append('word_id', wordId);
                formData.append('action', action);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                fetch('{% url "admin:words_word_handle_variant_action" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        // 刷新页面以显示更新后的状态
                        window.location.reload();
                    } else {
                        alert('操作失败：' + data.error);
                        selectElement.value = ''; // 重置选择
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('操作失败，请稍后重试。');
                    selectElement.value = ''; // 重置选择
                });
            };
        });
    </script>
{% endblock %}