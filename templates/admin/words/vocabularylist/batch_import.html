{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{% trans 'Batch Import' %} | {{ title }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/forms.css' %}">
<style>
.batch-import-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.import-section {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.import-section h3 {
    margin-top: 0;
    color: #495057;
    border-bottom: 2px solid #007cba;
    padding-bottom: 10px;
}

.form-row {
    margin-bottom: 15px;
}

.form-row label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
}

.form-row input, .form-row select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
}

.help-text {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

.csv-template {
    background: #e9ecef;
    padding: 15px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    overflow-x: auto;
}

.submit-row {
    text-align: right;
    padding-top: 20px;
    border-top: 1px solid #dee2e6;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    margin-left: 10px;
}

.btn-primary {
    background: #007cba;
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn:hover {
    opacity: 0.9;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
    display: none;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #007cba, #0056b3);
    width: 0%;
    transition: width 0.3s ease;
}
</style>
{% endblock %}

{% block content %}
<div id="content-start">
    <div class="batch-import-container">
        <h1>{% trans 'Batch Import Words to Vocabulary List' %}</h1>
        
        <form method="post" enctype="multipart/form-data" id="batch-import-form">
            {% csrf_token %}
            
            <!-- 基本设置 -->
            <div class="import-section">
                <h3>{% trans 'Basic Settings' %}</h3>
                
                <div class="form-row">
                    <label for="id_vocabulary_list">{% trans 'Target Vocabulary List' %}:</label>
                    <select name="vocabulary_list" id="id_vocabulary_list" required>
                        <option value="">{% trans 'Select vocabulary list' %}</option>
                        {% for vocab_list in vocabulary_lists %}
                        <option value="{{ vocab_list.id }}">{{ vocab_list.name }} ({{ vocab_list.words.count }} words)</option>
                        {% endfor %}
                    </select>
                    <div class="help-text">{% trans 'Choose the vocabulary list to import words into' %}</div>
                </div>
                
                <div class="form-row">
                    <label for="id_csv_file">{% trans 'CSV File' %}:</label>
                    <input type="file" name="csv_file" id="id_csv_file" accept=".csv" required>
                    <div class="help-text">{% trans 'Select a CSV file containing words to import' %}</div>
                </div>
            </div>
            
            <!-- 高级选项 -->
            <div class="import-section">
                <h3>{% trans 'Advanced Options' %}</h3>
                
                <div class="form-row">
                    <label>
                        <input type="checkbox" name="enable_versioning" value="on" checked>
                        {% trans 'Enable Version Management' %}
                    </label>
                    <div class="help-text">{% trans 'Create versions for duplicate words instead of overwriting' %}</div>
                </div>
                
                <div class="form-row">
                    <label for="id_conflict_resolution">{% trans 'Conflict Resolution' %}:</label>
                    <select name="conflict_resolution" id="id_conflict_resolution">
                        <option value="create_version">{% trans 'Create Version' %}</option>
                        <option value="update">{% trans 'Update Existing' %}</option>
                        <option value="skip">{% trans 'Skip Duplicates' %}</option>
                    </select>
                    <div class="help-text">{% trans 'How to handle duplicate words' %}</div>
                </div>
                
                <div class="form-row">
                    <label for="id_batch_size">{% trans 'Batch Size' %}:</label>
                    <input type="number" name="batch_size" id="id_batch_size" value="100" min="10" max="1000">
                    <div class="help-text">{% trans 'Number of words to process at once (10-1000)' %}</div>
                </div>
            </div>
            
            <!-- CSV格式说明 -->
            <div class="import-section">
                <h3>{% trans 'CSV Format Requirements' %}</h3>
                <p>{% trans 'Your CSV file should contain the following columns:' %}</p>
                <div class="csv-template">
word,phonetic,definition,part_of_speech,example,note,textbook_version,grade,book_volume,unit
hello,/həˈloʊ/,"used as a greeting",interjection,"Hello, how are you?","Common greeting","人教版","1","上册","Unit 1"
world,/wɜːrld/,"the earth and all its countries",noun,"Welcome to the world","Basic vocabulary","人教版","1","上册","Unit 1"
                </div>
                <p><strong>{% trans 'Required columns:' %}</strong> word</p>
                <p><strong>{% trans 'Optional columns:' %}</strong> phonetic, definition, part_of_speech, example, note, textbook_version, grade, book_volume, unit</p>
            </div>
            
            <!-- 进度条 -->
            <div class="progress-bar" id="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            
            <!-- 提交按钮 -->
            <div class="submit-row">
                <button type="button" class="btn btn-secondary" onclick="history.back()">{% trans 'Cancel' %}</button>
                <button type="submit" class="btn btn-primary" id="submit-btn">{% trans 'Start Import' %}</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('batch-import-form');
    const submitBtn = document.getElementById('submit-btn');
    const progressBar = document.getElementById('progress-bar');
    const progressFill = document.getElementById('progress-fill');
    
    form.addEventListener('submit', function(e) {
        // 显示进度条
        progressBar.style.display = 'block';
        submitBtn.disabled = true;
        submitBtn.textContent = '{% trans "Processing..." %}';
        
        // 模拟进度更新
        let progress = 0;
        const interval = setInterval(function() {
            progress += Math.random() * 10;
            if (progress > 90) progress = 90;
            progressFill.style.width = progress + '%';
        }, 200);
        
        // 表单提交后清理
        setTimeout(function() {
            clearInterval(interval);
            progressFill.style.width = '100%';
        }, 3000);
    });
    
    // 文件选择验证
    const fileInput = document.getElementById('id_csv_file');
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && !file.name.toLowerCase().endsWith('.csv')) {
            alert('{% trans "Please select a CSV file" %}');
            e.target.value = '';
        }
    });
});
</script>
{% endblock %}