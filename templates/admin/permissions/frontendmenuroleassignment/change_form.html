{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    <!-- 前端菜单选择器组件 -->
    <script src="{% static 'admin/js/components/FrontendMenuSelector.js' %}"></script>
    <script src="{% static 'admin/js/components/FrontendMenuSelectorConfig.js' %}"></script>
    <script src="{% static 'admin/js/components/FrontendMenuSelectorFactory.js' %}"></script>
    
    <!-- 前端菜单集成脚本 -->
    <script src="{% static 'admin/js/frontend_menu_integration.js' %}"></script>
    
    <!-- 页面特定样式 -->
    <style>
        .menu-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .menu-preview p {
            margin: 5px 0;
        }
        
        .menu-preview strong {
            color: #495057;
        }
        
        #preview-menu {
            margin-left: 10px;
        }
        
        .bulk-assignment-controls {
            margin: 15px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }
        
        .form-row .menu-selector {
            min-height: 120px;
        }
        
        .loading-indicator {
            display: none;
            margin-left: 10px;
            color: #6c757d;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 5px;
        }
        
        .success-message {
            color: #28a745;
            font-size: 0.875em;
            margin-top: 5px;
        }
    </style>
{% endblock %}

{% block submit_buttons_bottom %}
    {{ block.super }}
    
    <!-- 添加额外的操作按钮 -->
    <div class="submit-row">
        {% if original %}
            <button type="button" id="duplicate-assignment" class="btn btn-secondary">
                复制分配
            </button>
        {% endif %}
        
        <button type="button" id="validate-assignment" class="btn btn-info">
            验证分配
        </button>
    </div>
    
    <script>
        (function($) {
            'use strict';
            
            $(document).ready(function() {
                // 复制分配功能
                $('#duplicate-assignment').on('click', function() {
                    if (confirm('确定要复制当前分配设置吗？')) {
                        duplicateAssignment();
                    }
                });
                
                // 验证分配功能
                $('#validate-assignment').on('click', function() {
                    validateAssignment();
                });
            });
            
            // 复制分配
            function duplicateAssignment() {
                const currentRole = $('#id_role').val();
                const currentMenu = $('#id_menu').val();
                
                if (!currentRole || !currentMenu) {
                    alert('请先选择角色和菜单');
                    return;
                }
                
                // 跳转到新增页面并预填数据
                const addUrl = '{% url "admin:permissions_frontendmenuroleassignment_add" %}';
                const params = new URLSearchParams({
                    'role': currentRole,
                    'menu': currentMenu
                });
                
                window.location.href = `${addUrl}?${params.toString()}`;
            }
            
            // 验证分配
            function validateAssignment() {
                const role = $('#id_role').val();
                const menu = $('#id_menu').val();
                
                if (!role || !menu) {
                    alert('请先选择角色和菜单');
                    return;
                }
                
                // 显示加载指示器
                const loadingHtml = '<span class="loading-indicator">验证中...</span>';
                $('#validate-assignment').after(loadingHtml);
                
                $.ajax({
                    url: '{% url "admin:permissions_frontendmenuroleassignment_changelist" %}validate-assignment/',
                    type: 'POST',
                    data: {
                        'role': role,
                        'menu': menu,
                        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                    },
                    success: function(response) {
                        $('.loading-indicator').remove();
                        
                        if (response.success) {
                            showMessage('验证通过：分配设置有效', 'success');
                        } else {
                            showMessage('验证失败：' + response.error, 'error');
                        }
                    },
                    error: function() {
                        $('.loading-indicator').remove();
                        showMessage('验证请求失败', 'error');
                    }
                });
            }
            
            // 显示消息
            function showMessage(message, type) {
                const messageClass = type === 'success' ? 'success-message' : 'error-message';
                const messageHtml = `<div class="${messageClass}">${message}</div>`;
                
                // 移除之前的消息
                $('.success-message, .error-message').remove();
                
                // 添加新消息
                $('#validate-assignment').after(messageHtml);
                
                // 3秒后自动移除
                setTimeout(function() {
                    $(`.${messageClass}`).fadeOut(function() {
                        $(this).remove();
                    });
                }, 3000);
            }
            
        })(django.jQuery || jQuery);
    </script>
{% endblock %}