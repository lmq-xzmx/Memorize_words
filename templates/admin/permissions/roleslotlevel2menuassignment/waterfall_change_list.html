{% extends "admin/change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block title %}è§’è‰²æ§½ä½äºŒçº§èœå•åˆ†é…ç®¡ç† - ç€‘å¸ƒæµé…ç½®{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
/* ä¸»å®¹å™¨å¸ƒå±€ */
.main-container {
    display: flex;
    gap: 20px;
    padding: 20px;
    background: #f8f9fa;
}

/* è§’è‰²åŒºåŸŸ */
.roles-section {
    flex: 1;
}

.roles-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
}

/* è§’è‰²å¡ç‰‡æ ·å¼ */
.role-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 20px;
    transition: all 0.3s ease;
}

.role-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.role-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e9ecef;
}

.role-name {
    font-size: 18px;
    font-weight: 600;
    color: #495057;
    margin: 0;
}

.role-badge {
    background: #007bff;
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

/* ä¸€çº§èœå•å®¹å™¨ */
#level1-menus-container {
    padding: 0;
    margin: 0;
}

.level1-menu-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f1f3f4;
}

.level1-menu-item:last-child {
    border-bottom: none;
}

.menu-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.menu-icon {
    width: 20px;
    height: 20px;
    color: #6c757d;
}

.menu-name {
    font-weight: 500;
    color: #495057;
}

.config-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.config-btn:hover {
    background: #218838;
    transform: scale(1.05);
}

/* é…ç½®ä¾§è¾¹æ  */
.config-sidebar {
    width: 400px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 20px;
    position: sticky;
    top: 20px;
    height: fit-content;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    display: none;
}

.config-sidebar.active {
    display: block;
}

.sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e9ecef;
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #6c757d;
}

/* å­¦ç”Ÿæ§½ä½4æ•°æ®æ˜¾ç¤ºåŒºåŸŸ */
.student-slot4-data {
    background: #e3f2fd;
    border: 1px solid #2196f3;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.student-slot4-data h4 {
    color: #1976d2;
    margin: 0 0 10px 0;
    font-size: 16px;
}

.student-slot4-menus {
    list-style: none;
    padding: 0;
    margin: 0;
}

.student-slot4-menus li {
    padding: 5px 0;
    border-bottom: 1px solid #bbdefb;
}

.student-slot4-menus li:last-child {
    border-bottom: none;
}

.refresh-btn {
    background: #2196f3;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    margin-top: 10px;
}

.refresh-btn:hover {
    background: #1976d2;
}

.alert-container {
    margin-bottom: 20px;
}

.alert {
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 10px;
}

.alert-info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
}

.alert-success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.alert-warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

/* åŒåˆ—é€‰æ‹©å™¨æ ·å¼ */
.menu-selector {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.selector-section {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
}

.selector-section h4 {
    margin: 0 0 15px 0;
    color: #495057;
    font-size: 16px;
    font-weight: 600;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 8px;
}

.selector-list {
    width: 100%;
    height: 200px;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    background: white;
    font-size: 14px;
    padding: 5px;
}

.selector-list option {
    padding: 8px 12px;
    border-bottom: 1px solid #f1f3f4;
}

.selector-list option:hover {
    background-color: #f8f9fa;
}

.selector-buttons {
    margin-top: 10px;
    display: flex;
    gap: 8px;
    justify-content: center;
}

.selector-buttons .btn {
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    cursor: pointer;
    transition: all 0.2s ease;
}

.selector-buttons .btn-primary {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.selector-buttons .btn-primary:hover {
    background: #0056b3;
    border-color: #0056b3;
}

.selector-buttons .btn-secondary {
    background: #6c757d;
    color: white;
    border-color: #6c757d;
}

.selector-buttons .btn-secondary:hover {
    background: #545b62;
    border-color: #545b62;
}

.menu-item span {
    flex: 1;
    color: #495057;
    font-weight: 500;
}

.move-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;
    transition: all 0.2s ease;
    min-width: 30px;
}

.move-btn:hover {
    background: #0056b3;
    transform: scale(1.1);
}

.action-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    padding-top: 15px;
    border-top: 1px solid #dee2e6;
}

.action-buttons .btn {
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
    border: 1px solid transparent;
}

.action-buttons .btn-success {
    background: #28a745;
    color: white;
    border-color: #28a745;
}

.action-buttons .btn-success:hover {
    background: #218838;
    border-color: #1e7e34;
}

.action-buttons .btn-secondary {
    background: #6c757d;
    color: white;
    border-color: #6c757d;
}

.action-buttons .btn-secondary:hover {
    background: #545b62;
    border-color: #545b62;
}
</style>
{% endblock %}

{% block content %}
<div class="alert-container" id="alert-container"></div>

<div class="main-container">
    <div class="roles-section">
        <!-- Student Slot 4 æ•°æ®æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="student-slot4-data" id="student-slot4-data">
            <h4>ğŸ¯ Student è§’è‰² Slot 4 ä¸€çº§ç›®å½•æ•°æ®</h4>
            <ul class="student-slot4-menus" id="student-slot4-menus">
                <li>æ­£åœ¨åŠ è½½æ•°æ®...</li>
            </ul>
            <button class="refresh-btn" onclick="loadStudentSlot4Data()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        </div>
        
        <div class="roles-container" id="roles-container">
        <!-- è§’è‰²å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>

<div class="level1-menus-section">
    <h2 id="level1-menus-title">è¯·å…ˆé€‰æ‹©å·¦ä¾§è§’è‰²</h2>
    <div id="level1-menus-container">
        <div class="text-muted">ç‚¹å‡»å·¦ä¾§è§’è‰²å¡ç‰‡æŸ¥çœ‹å¯¹åº”çš„ä¸€çº§èœå•åˆ†é…</div>
    </div>
</div>
    
    <div class="config-sidebar" id="config-sidebar">
        <div class="sidebar-header">
            <h3>é…ç½®äºŒçº§èœå•</h3>
            <button class="close-btn" onclick="closeSidebar()">&times;</button>
        </div>
        <div id="sidebar-content">
            <!-- ä¾§è¾¹æ å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
let currentRole = null;
let currentLevel1MenuId = null;
let currentAssignmentId = null;

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadRoles();
    loadStudentSlot4Data();
});

// åŠ è½½Studentè§’è‰²Slot4æ•°æ®
function loadStudentSlot4Data() {
    fetch('/admin/permissions/roleslotlevel2menuassignment/get-student-slot4-data/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayStudentSlot4Data(data.data);
            } else {
                showAlert('è·å–Student Slot4æ•°æ®å¤±è´¥: ' + data.error, 'warning');
            }
        })
        .catch(error => {
            console.error('Error loading student slot4 data:', error);
            showAlert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è·å–Student Slot4æ•°æ®', 'warning');
        });
}

// æ˜¾ç¤ºStudentè§’è‰²Slot4æ•°æ®
function displayStudentSlot4Data(data) {
    const container = document.getElementById('student-slot4-menus');
    
    if (data.level1_menus && data.level1_menus.length > 0) {
        container.innerHTML = data.level1_menus.map(menu => 
            `<li><i class="${menu.icon || 'fas fa-folder'}"></i> ${menu.name} (${menu.key})</li>`
        ).join('');
    } else {
        container.innerHTML = '<li>æš‚æ— æ•°æ®</li>';
    }
    
    showAlert(`âœ… Student Slot4æ•°æ®å·²æ›´æ–°ï¼Œå…± ${data.total_count} ä¸ªä¸€çº§èœå•`, 'success');
}

// åŠ è½½æ‰€æœ‰è§’è‰²æ•°æ®
function loadRoles() {
    fetch('/admin/permissions/roleslotlevel2menuassignment/get-roles/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayRoles(data.roles);
            } else {
                showAlert('åŠ è½½è§’è‰²æ•°æ®å¤±è´¥: ' + data.error, 'warning');
            }
        })
        .catch(error => {
            console.error('Error loading roles:', error);
            showAlert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½è§’è‰²æ•°æ®', 'warning');
        });
}

// æ˜¾ç¤ºè§’è‰²åˆ—è¡¨
function displayRoles(roles) {
    const container = document.getElementById('roles-container');
    container.innerHTML = '';
    
    roles.forEach(role => {
        const roleCard = document.createElement('div');
        roleCard.className = 'role-card';
        roleCard.dataset.role = role.role;
        roleCard.innerHTML = `
            <div class="role-header">
                <h3 class="role-name">${role.role_display}</h3>
                <span class="role-badge">${role.level1_assignments.length} ä¸ªä¸€çº§èœå•</span>
            </div>
        `;
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        roleCard.addEventListener('click', () => {
            // ç§»é™¤å…¶ä»–è§’è‰²çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.role-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // æ·»åŠ å½“å‰è§’è‰²çš„é€‰ä¸­çŠ¶æ€
            roleCard.classList.add('selected');
            
            // æ˜¾ç¤ºå¯¹åº”çš„ä¸€çº§èœå•
            displayLevel1Menus(role);
        });
        
        container.appendChild(roleCard);
    });
}

// æ˜¾ç¤ºä¸€çº§èœå•åˆ—è¡¨
function displayLevel1Menus(role) {
    const container = document.getElementById('level1-menus-container');
    const title = document.getElementById('level1-menus-title');
    
    title.textContent = `${role.role_display} - ä¸€çº§èœå•åˆ†é…`;
    
    if (role.level1_assignments && role.level1_assignments.length > 0) {
        container.innerHTML = role.level1_assignments.map(menu => `
            <div class="level1-menu-item">
                <div class="menu-info">
                    <i class="menu-icon ${menu.icon || 'fas fa-folder'}"></i>
                    <span class="menu-name">${menu.menu_name}</span>
                </div>
                <button class="config-btn" onclick="configureLevel2Menus('${role.role}', ${menu.menu_id}, ${menu.id}, '${menu.menu_name}')">
                    é…ç½®äºŒçº§èœå•
                </button>
            </div>
        `).join('');
    } else {
        container.innerHTML = '<div class="text-muted">è¯¥è§’è‰²æš‚æ— ä¸€çº§èœå•åˆ†é…</div>';
    }
}

// é…ç½®äºŒçº§èœå•
function configureLevel2Menus(role, level1MenuId, assignmentId, menuName) {
    currentRole = role;
    currentLevel1MenuId = level1MenuId;
    currentAssignmentId = assignmentId;
    
    // æ›´æ–°ä¾§è¾¹æ ä¿¡æ¯
    const roleInfo = document.getElementById('current-role-info');
    const menuInfo = document.getElementById('current-menu-info');
    if (roleInfo) roleInfo.textContent = role;
    if (menuInfo) menuInfo.textContent = menuName || 'æœªçŸ¥èœå•';
    
    // æ˜¾ç¤ºä¾§è¾¹æ 
    const sidebar = document.getElementById('config-sidebar');
    sidebar.classList.add('active');
    
    // è°ƒæ•´ä¸»å®¹å™¨å¸ƒå±€
    const rolesSection = document.querySelector('.roles-section');
    rolesSection.style.flex = '0 0 calc(70% - 10px)';
    
    // åŠ è½½äºŒçº§èœå•æ•°æ®
    loadLevel2Menus(assignmentId);
}

// åŠ è½½äºŒçº§èœå•æ•°æ®
function loadLevel2Menus(assignmentId) {
    const sidebarContent = document.getElementById('sidebar-content');
    sidebarContent.innerHTML = '<div>æ­£åœ¨åŠ è½½...</div>';
    
    fetch(`/admin/permissions/roleslotlevel2menuassignment/get-level2-menus/?assignment_id=${assignmentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayLevel2MenuSelector(data.available_menus, data.selected_menus);
            } else {
                sidebarContent.innerHTML = '<div class="alert alert-warning">åŠ è½½å¤±è´¥: ' + data.error + '</div>';
            }
        })
        .catch(error => {
            console.error('Error loading level2 menus:', error);
            sidebarContent.innerHTML = '<div class="alert alert-warning">ç½‘ç»œé”™è¯¯</div>';
        });
}

// æ˜¾ç¤ºäºŒçº§èœå•é€‰æ‹©å™¨
function displayLevel2MenuSelector(availableMenus, selectedMenus) {
    const sidebarContent = document.getElementById('sidebar-content');
    sidebarContent.innerHTML = `
        <div class="menu-selector">
            <div class="selector-section">
                <h4>å¯ç”¨èœå•</h4>
                <select id="available-menus" class="form-control selector-list" multiple size="10" ondblclick="moveToSelected()">
                    ${availableMenus.map(menu => `
                        <option value="${menu.id}">${menu.name}</option>
                    `).join('')}
                </select>
                <div class="selector-buttons">
                    <button onclick="moveToSelected()" class="btn btn-sm btn-primary">æ·»åŠ  â†’</button>
                    <button onclick="moveAllToSelected()" class="btn btn-sm btn-secondary">å…¨éƒ¨æ·»åŠ  â†’â†’</button>
                </div>
            </div>
            
            <div class="selector-section">
                <h4>å·²é€‰æ‹©èœå•</h4>
                <select id="selected-menus" class="form-control selector-list" multiple size="10" ondblclick="moveToAvailable()">
                    ${selectedMenus.map(menu => `
                        <option value="${menu.id}">${menu.name}</option>
                    `).join('')}
                </select>
                <div class="selector-buttons">
                    <button onclick="moveToAvailable()" class="btn btn-sm btn-primary">â† ç§»é™¤</button>
                    <button onclick="moveAllToAvailable()" class="btn btn-sm btn-secondary">â†â† å…¨éƒ¨ç§»é™¤</button>
                </div>
            </div>
            
            <div class="action-buttons">
                <button onclick="saveConfiguration()" class="btn btn-success">ä¿å­˜é…ç½®</button>
                <button onclick="closeSidebar()" class="btn btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    `;
}

// ç§»åŠ¨èœå•åˆ°å·²é€‰æ‹©
function moveToSelected() {
    console.log('moveToSelected å‡½æ•°è¢«è°ƒç”¨');
    const availableSelect = document.getElementById('available-menus');
    const selectedSelect = document.getElementById('selected-menus');
    
    if (!availableSelect || !selectedSelect) {
        console.error('æ‰¾ä¸åˆ°é€‰æ‹©å™¨å…ƒç´ ');
        return;
    }
    
    const selectedOptions = Array.from(availableSelect.selectedOptions);
    console.log('é€‰ä¸­çš„é€‰é¡¹æ•°é‡:', selectedOptions.length);
    
    selectedOptions.forEach(option => {
        selectedSelect.appendChild(option.cloneNode(true));
        option.remove();
    });
}

// ç§»åŠ¨èœå•åˆ°å¯ç”¨
function moveToAvailable() {
    console.log('moveToAvailable å‡½æ•°è¢«è°ƒç”¨');
    const availableSelect = document.getElementById('available-menus');
    const selectedSelect = document.getElementById('selected-menus');
    
    if (!availableSelect || !selectedSelect) {
        console.error('æ‰¾ä¸åˆ°é€‰æ‹©å™¨å…ƒç´ ');
        return;
    }
    
    const selectedOptions = Array.from(selectedSelect.selectedOptions);
    console.log('é€‰ä¸­çš„é€‰é¡¹æ•°é‡:', selectedOptions.length);
    
    selectedOptions.forEach(option => {
        availableSelect.appendChild(option.cloneNode(true));
        option.remove();
    });
}

// ç§»åŠ¨æ‰€æœ‰èœå•åˆ°å·²é€‰æ‹©
function moveAllToSelected() {
    console.log('moveAllToSelected å‡½æ•°è¢«è°ƒç”¨');
    const availableSelect = document.getElementById('available-menus');
    const selectedSelect = document.getElementById('selected-menus');
    
    if (!availableSelect || !selectedSelect) {
        console.error('æ‰¾ä¸åˆ°é€‰æ‹©å™¨å…ƒç´ ');
        return;
    }
    
    const allOptions = Array.from(availableSelect.options);
    console.log('ç§»åŠ¨æ‰€æœ‰é€‰é¡¹æ•°é‡:', allOptions.length);
    
    allOptions.forEach(option => {
        selectedSelect.appendChild(option.cloneNode(true));
        option.remove();
    });
}

// ç§»åŠ¨æ‰€æœ‰èœå•åˆ°å¯ç”¨
function moveAllToAvailable() {
    console.log('moveAllToAvailable å‡½æ•°è¢«è°ƒç”¨');
    const availableSelect = document.getElementById('available-menus');
    const selectedSelect = document.getElementById('selected-menus');
    
    if (!availableSelect || !selectedSelect) {
        console.error('æ‰¾ä¸åˆ°é€‰æ‹©å™¨å…ƒç´ ');
        return;
    }
    
    const allOptions = Array.from(selectedSelect.options);
    console.log('ç§»åŠ¨æ‰€æœ‰é€‰é¡¹æ•°é‡:', allOptions.length);
    
    allOptions.forEach(option => {
        availableSelect.appendChild(option.cloneNode(true));
        option.remove();
    });
}

// ä¿å­˜é…ç½®
function saveConfiguration() {
    if (!currentRole || !currentLevel1MenuId || !currentAssignmentId) {
        showAlert('ç¼ºå°‘å¿…è¦çš„é…ç½®ä¿¡æ¯', 'danger');
        return;
    }
    
    const selectedSelect = document.getElementById('selected-menus');
    
    // è·å–æ‰€æœ‰å·²é€‰æ‹©çš„èœå•ID
    const selectedMenuIds = Array.from(selectedSelect.options).map(option => option.value).filter(id => id);
    
    console.log('ä¿å­˜é…ç½®:', {
        role: currentRole,
        level1_menu_id: currentLevel1MenuId,
        assignment_id: currentAssignmentId,
        selected_menus: selectedMenuIds
    });
    
    // å‘é€AJAXè¯·æ±‚ä¿å­˜äºŒçº§èœå•é…ç½®
    fetch('{% url "admin:permissions_roleslotlevel2menuassignment_save_config" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new URLSearchParams({
            'level1_assignment': currentAssignmentId,
            'selected_menus': JSON.stringify(selectedMenuIds)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`æˆåŠŸä¸ºè§’è‰² ${currentRole} é…ç½®äºŒçº§èœå•`);
            closeSidebar();
            // åˆ·æ–°é¡µé¢æˆ–æ›´æ–°UI
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAlert(data.error || 'äºŒçº§èœå•é…ç½®å¤±è´¥', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'danger');
    });
}

// å…³é—­ä¾§è¾¹æ 
function closeSidebar() {
    const sidebar = document.getElementById('config-sidebar');
    sidebar.classList.remove('active');
    
    const rolesSection = document.querySelector('.roles-section');
    rolesSection.style.flex = '1';
    
    currentRole = null;
    currentLevel1MenuId = null;
    currentAssignmentId = null;
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showAlert(message, type = 'info') {
    const alertContainer = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `
        ${message}
        <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; cursor: pointer;">&times;</button>
    `;
    alertContainer.appendChild(alert);
    
    // 3ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        if (alert.parentElement) {
            alert.remove();
        }
    }, 3000);
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥URLå‚æ•°
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const assignmentId = urlParams.get('assignment_id');
    const role = urlParams.get('role');
    const slotPosition = urlParams.get('slot_position');
    
    if (assignmentId) {
        // è‡ªåŠ¨æ‰“å¼€ä¾§è¾¹æ å¹¶åŠ è½½äºŒçº§èœå•é…ç½®
        setTimeout(() => {
            configureLevel2Menus(role, null, assignmentId);
        }, 100);
    }
});
</script>
{% endblock %}

{% block result_list %}
<!-- éšè—é»˜è®¤çš„ç»“æœåˆ—è¡¨ -->
{% endblock %}