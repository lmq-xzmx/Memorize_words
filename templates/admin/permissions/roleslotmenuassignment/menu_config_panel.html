{% load i18n %}
<div class="menu-config-panel" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
    <h3 style="margin-top: 0; color: #495057; font-size: 18px;">ğŸ“‹ èœå•é…ç½®å·¥å…·</h3>
    
    <!-- å¿«é€Ÿé…ç½®è¡¨å• -->
    <div class="quick-config-form" style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #e9ecef;">
        <h4 style="margin-top: 0; color: #6c757d; font-size: 14px;">ğŸš€ å¿«é€Ÿé…ç½®èœå•</h4>
        <form id="quick-config-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; align-items: end;">
            {% csrf_token %}
            <div>
                <label for="role-select" style="display: block; font-size: 12px; color: #6c757d; margin-bottom: 4px;">è§’è‰²</label>
                <select id="role-select" name="role" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                    <option value="">é€‰æ‹©è§’è‰²</option>
                </select>
            </div>
            <div>
                <label for="slot-input" style="display: block; font-size: 12px; color: #6c757d; margin-bottom: 4px;">æ§½ä½</label>
                <input type="number" id="slot-input" name="slot_position" min="1" max="10" 
                       style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;" 
                       placeholder="æ§½ä½å·">
            </div>
            <div>
                <label for="menu-select" style="display: block; font-size: 12px; color: #6c757d; margin-bottom: 4px;">æ ¹èœå•</label>
                <select id="menu-select" name="root_menu" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                    <option value="">é€‰æ‹©èœå•</option>
                </select>
            </div>
            <div>
                <label for="status-select" style="display: block; font-size: 12px; color: #6c757d; margin-bottom: 4px;">çŠ¶æ€</label>
                <select id="status-select" name="menu_status" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                    <option value="active">æ¿€æ´»</option>
                    <option value="inactive">åœç”¨</option>
                    <option value="testing">æµ‹è¯•</option>
                </select>
            </div>
            <div>
                <button type="submit" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                    âœ… é…ç½®èœå•
                </button>
            </div>
        </form>
    </div>
    
    <!-- åŠŸèƒ½æŒ‰é’®ç»„ -->
    <div class="action-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button onclick="validateSlotCapacity()" 
                style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
            ğŸ” éªŒè¯æ§½ä½å®¹é‡
        </button>
        <button onclick="optimizeSlots()" 
                style="background: #ffc107; color: #212529; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
            âš¡ ä¼˜åŒ–æ§½ä½
        </button>
        <button onclick="showBatchAssign()" 
                style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
            ğŸ“¦ æ‰¹é‡åˆ†é…
        </button>
        <button onclick="refreshData()" 
                style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
            ğŸ”„ åˆ·æ–°æ•°æ®
        </button>
    </div>
    
    <!-- çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="status-display" style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 4px; font-size: 13px; display: none;">
        <div id="status-content"></div>
    </div>
</div>

<script>
// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ•°æ®
document.addEventListener('DOMContentLoaded', function() {
    loadConfigData();
    
    // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
    const quickConfigForm = document.getElementById('quick-config-form');
    if (quickConfigForm) {
        quickConfigForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitQuickConfig();
        });
    }
});

// åŠ è½½é…ç½®æ•°æ®
function loadConfigData() {
    fetch('{% url "admin:permissions_roleslotmenuassignment_configure" %}')
        .then(response => response.json())
        .then(data => {
            // å¡«å……è§’è‰²é€‰é¡¹
            const roleSelect = document.getElementById('role-select');
            roleSelect.innerHTML = '<option value="">é€‰æ‹©è§’è‰²</option>';
            data.roles.forEach(role => {
                roleSelect.innerHTML += `<option value="${role[0]}">${role[1]}</option>`;
            });
            
            // å¡«å……èœå•é€‰é¡¹
            const menuSelect = document.getElementById('menu-select');
            menuSelect.innerHTML = '<option value="">é€‰æ‹©èœå•</option>';
            data.root_menus.forEach(menu => {
                menuSelect.innerHTML += `<option value="${menu.id}">${menu.name}</option>`;
            });
        })
        .catch(error => {
            console.error('åŠ è½½é…ç½®æ•°æ®å¤±è´¥:', error);
            showStatus('åŠ è½½é…ç½®æ•°æ®å¤±è´¥', 'error');
        });
}

// æäº¤å¿«é€Ÿé…ç½®
function submitQuickConfig() {
    const form = document.getElementById('quick-config-form');
    const formData = new FormData(form);
    
    fetch('{% url "admin:permissions_roleslotmenuassignment_configure" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('èœå•é…ç½®æˆåŠŸï¼', 'success');
            form.reset();
            // åˆ·æ–°é¡µé¢åˆ—è¡¨
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showStatus('é…ç½®å¤±è´¥: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('é…ç½®å¤±è´¥:', error);
        showStatus('é…ç½®å¤±è´¥: ' + error.message, 'error');
    });
}

// éªŒè¯æ§½ä½å®¹é‡
function validateSlotCapacity() {
    fetch('{% url "admin:permissions_roleslotmenuassignment_validate" %}')
        .then(response => response.json())
        .then(data => {
            let content = '<h5>æ§½ä½å®¹é‡éªŒè¯ç»“æœ</h5>';
            content += `<p>æ€»è§’è‰²æ•°: ${data.total_roles}, è¶…å®¹é‡è§’è‰²: ${data.over_capacity_count}</p>`;
            content += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            content += '<tr style="background: #f8f9fa;"><th style="padding: 5px; border: 1px solid #dee2e6;">è§’è‰²</th><th style="padding: 5px; border: 1px solid #dee2e6;">æœ€å¤§æ§½ä½</th><th style="padding: 5px; border: 1px solid #dee2e6;">å·²ç”¨æ§½ä½</th><th style="padding: 5px; border: 1px solid #dee2e6;">åˆ©ç”¨ç‡</th></tr>';
            
            data.validation_results.forEach(result => {
                const rowStyle = result.is_over_capacity ? 'background: #f8d7da;' : '';
                content += `<tr style="${rowStyle}">`;
                content += `<td style="padding: 5px; border: 1px solid #dee2e6;">${result.role_display}</td>`;
                content += `<td style="padding: 5px; border: 1px solid #dee2e6;">${result.max_slots}</td>`;
                content += `<td style="padding: 5px; border: 1px solid #dee2e6;">${result.used_slots}</td>`;
                content += `<td style="padding: 5px; border: 1px solid #dee2e6;">${result.utilization_rate}%</td>`;
                content += '</tr>';
            });
            content += '</table>';
            
            showStatus(content, 'info');
        })
        .catch(error => {
            console.error('éªŒè¯å¤±è´¥:', error);
            showStatus('éªŒè¯å¤±è´¥: ' + error.message, 'error');
        });
}

// ä¼˜åŒ–æ§½ä½
function optimizeSlots() {
    if (!confirm('ç¡®å®šè¦ä¼˜åŒ–æ‰€æœ‰è§’è‰²çš„æ§½ä½åˆ†é…å—ï¼Ÿè¿™å°†é‡æ–°æ’åºæ§½ä½ä½ç½®ã€‚')) {
        return;
    }
    
    fetch('{% url "admin:permissions_roleslotmenuassignment_optimize" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let content = `<h5>æ§½ä½ä¼˜åŒ–å®Œæˆ</h5><p>ä¼˜åŒ–äº† ${data.optimized_count} ä¸ªæ§½ä½åˆ†é…</p>`;
            if (data.details.length > 0) {
                content += '<ul style="margin: 10px 0; padding-left: 20px;">';
                data.details.forEach(detail => {
                    content += `<li>${detail.role} - ${detail.menu_name}: æ§½ä½ ${detail.old_position} â†’ ${detail.new_position}</li>`;
                });
                content += '</ul>';
            }
            showStatus(content, 'success');
            
            // åˆ·æ–°é¡µé¢
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showStatus('ä¼˜åŒ–å¤±è´¥: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('ä¼˜åŒ–å¤±è´¥:', error);
        showStatus('ä¼˜åŒ–å¤±è´¥: ' + error.message, 'error');
    });
}

// æ˜¾ç¤ºæ‰¹é‡åˆ†é…ç•Œé¢
function showBatchAssign() {
    showStatus('<h5>æ‰¹é‡åˆ†é…åŠŸèƒ½</h5><p>æ­¤åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…...</p>', 'info');
}

// åˆ·æ–°æ•°æ®
function refreshData() {
    loadConfigData();
    showStatus('æ•°æ®å·²åˆ·æ–°', 'success');
    setTimeout(() => {
        document.getElementById('status-display').style.display = 'none';
    }, 1000);
}

// æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
function showStatus(message, type) {
    const statusDisplay = document.getElementById('status-display');
    const statusContent = document.getElementById('status-content');
    
    let bgColor = '#e9ecef';
    let textColor = '#495057';
    
    switch(type) {
        case 'success':
            bgColor = '#d4edda';
            textColor = '#155724';
            break;
        case 'error':
            bgColor = '#f8d7da';
            textColor = '#721c24';
            break;
        case 'info':
            bgColor = '#d1ecf1';
            textColor = '#0c5460';
            break;
    }
    
    statusDisplay.style.background = bgColor;
    statusDisplay.style.color = textColor;
    statusContent.innerHTML = message;
    statusDisplay.style.display = 'block';
}
</script>