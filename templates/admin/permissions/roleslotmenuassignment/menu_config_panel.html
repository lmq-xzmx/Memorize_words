{% load i18n %}
<div class="menu-config-panel" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
    <h3 style="margin-top: 0; color: #495057; font-size: 18px;">📋 菜单配置工具</h3>
    
    <!-- 快速配置表单 -->
    <div class="quick-config-form" style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #e9ecef;">
        <h4 style="margin-top: 0; color: #6c757d; font-size: 14px;">🚀 快速配置菜单</h4>
        <form id="quick-config-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; align-items: end;">
            {% csrf_token %}
            <div>
                <label for="role-select" style="display: block; font-size: 12px; color: #6c757d; margin-bottom: 4px;">角色</label>
                <select id="role-select" name="role" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                    <option value="">选择角色</option>
                </select>
            </div>
            <div>
                <label for="slot-input" style="display: block; font-size: 12px; color: #6c757d; margin-bottom: 4px;">槽位</label>
                <input type="number" id="slot-input" name="slot_position" min="1" max="10" 
                       style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;" 
                       placeholder="槽位号">
            </div>
            <div>
                <label for="menu-select" style="display: block; font-size: 12px; color: #6c757d; margin-bottom: 4px;">根菜单</label>
                <select id="menu-select" name="root_menu" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                    <option value="">选择菜单</option>
                </select>
            </div>
            <div>
                <label for="status-select" style="display: block; font-size: 12px; color: #6c757d; margin-bottom: 4px;">状态</label>
                <select id="status-select" name="menu_status" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                    <option value="active">激活</option>
                    <option value="inactive">停用</option>
                    <option value="testing">测试</option>
                </select>
            </div>
            <div>
                <button type="submit" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                    ✅ 配置菜单
                </button>
            </div>
        </form>
    </div>
    
    <!-- 功能按钮组 -->
    <div class="action-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button onclick="validateSlotCapacity()" 
                style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
            🔍 验证槽位容量
        </button>
        <button onclick="optimizeSlots()" 
                style="background: #ffc107; color: #212529; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
            ⚡ 优化槽位
        </button>
        <button onclick="showBatchAssign()" 
                style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
            📦 批量分配
        </button>
        <button onclick="refreshData()" 
                style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
            🔄 刷新数据
        </button>
    </div>
    
    <!-- 状态显示区域 -->
    <div id="status-display" style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 4px; font-size: 13px; display: none;">
        <div id="status-content"></div>
    </div>
</div>

<script>
// 页面加载时初始化数据
document.addEventListener('DOMContentLoaded', function() {
    loadConfigData();
    
    // 绑定表单提交事件
    const quickConfigForm = document.getElementById('quick-config-form');
    if (quickConfigForm) {
        quickConfigForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitQuickConfig();
        });
    }
});

// 加载配置数据
function loadConfigData() {
    fetch('{% url "admin:permissions_roleslotmenuassignment_configure" %}')
        .then(response => response.json())
        .then(data => {
            // 填充角色选项
            const roleSelect = document.getElementById('role-select');
            roleSelect.innerHTML = '<option value="">选择角色</option>';
            data.roles.forEach(role => {
                roleSelect.innerHTML += `<option value="${role[0]}">${role[1]}</option>`;
            });
            
            // 填充菜单选项
            const menuSelect = document.getElementById('menu-select');
            menuSelect.innerHTML = '<option value="">选择菜单</option>';
            data.root_menus.forEach(menu => {
                menuSelect.innerHTML += `<option value="${menu.id}">${menu.name}</option>`;
            });
        })
        .catch(error => {
            console.error('加载配置数据失败:', error);
            showStatus('加载配置数据失败', 'error');
        });
}

// 提交快速配置
function submitQuickConfig() {
    const form = document.getElementById('quick-config-form');
    const formData = new FormData(form);
    
    fetch('{% url "admin:permissions_roleslotmenuassignment_configure" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('菜单配置成功！', 'success');
            form.reset();
            // 刷新页面列表
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showStatus('配置失败: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('配置失败:', error);
        showStatus('配置失败: ' + error.message, 'error');
    });
}

// 验证槽位容量
function validateSlotCapacity() {
    fetch('{% url "admin:permissions_roleslotmenuassignment_validate" %}')
        .then(response => response.json())
        .then(data => {
            let content = '<h5>槽位容量验证结果</h5>';
            content += `<p>总角色数: ${data.total_roles}, 超容量角色: ${data.over_capacity_count}</p>`;
            content += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            content += '<tr style="background: #f8f9fa;"><th style="padding: 5px; border: 1px solid #dee2e6;">角色</th><th style="padding: 5px; border: 1px solid #dee2e6;">最大槽位</th><th style="padding: 5px; border: 1px solid #dee2e6;">已用槽位</th><th style="padding: 5px; border: 1px solid #dee2e6;">利用率</th></tr>';
            
            data.validation_results.forEach(result => {
                const rowStyle = result.is_over_capacity ? 'background: #f8d7da;' : '';
                content += `<tr style="${rowStyle}">`;
                content += `<td style="padding: 5px; border: 1px solid #dee2e6;">${result.role_display}</td>`;
                content += `<td style="padding: 5px; border: 1px solid #dee2e6;">${result.max_slots}</td>`;
                content += `<td style="padding: 5px; border: 1px solid #dee2e6;">${result.used_slots}</td>`;
                content += `<td style="padding: 5px; border: 1px solid #dee2e6;">${result.utilization_rate}%</td>`;
                content += '</tr>';
            });
            content += '</table>';
            
            showStatus(content, 'info');
        })
        .catch(error => {
            console.error('验证失败:', error);
            showStatus('验证失败: ' + error.message, 'error');
        });
}

// 优化槽位
function optimizeSlots() {
    if (!confirm('确定要优化所有角色的槽位分配吗？这将重新排序槽位位置。')) {
        return;
    }
    
    fetch('{% url "admin:permissions_roleslotmenuassignment_optimize" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let content = `<h5>槽位优化完成</h5><p>优化了 ${data.optimized_count} 个槽位分配</p>`;
            if (data.details.length > 0) {
                content += '<ul style="margin: 10px 0; padding-left: 20px;">';
                data.details.forEach(detail => {
                    content += `<li>${detail.role} - ${detail.menu_name}: 槽位 ${detail.old_position} → ${detail.new_position}</li>`;
                });
                content += '</ul>';
            }
            showStatus(content, 'success');
            
            // 刷新页面
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showStatus('优化失败: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('优化失败:', error);
        showStatus('优化失败: ' + error.message, 'error');
    });
}

// 显示批量分配界面
function showBatchAssign() {
    showStatus('<h5>批量分配功能</h5><p>此功能正在开发中，敬请期待...</p>', 'info');
}

// 刷新数据
function refreshData() {
    loadConfigData();
    showStatus('数据已刷新', 'success');
    setTimeout(() => {
        document.getElementById('status-display').style.display = 'none';
    }, 1000);
}

// 显示状态信息
function showStatus(message, type) {
    const statusDisplay = document.getElementById('status-display');
    const statusContent = document.getElementById('status-content');
    
    let bgColor = '#e9ecef';
    let textColor = '#495057';
    
    switch(type) {
        case 'success':
            bgColor = '#d4edda';
            textColor = '#155724';
            break;
        case 'error':
            bgColor = '#f8d7da';
            textColor = '#721c24';
            break;
        case 'info':
            bgColor = '#d1ecf1';
            textColor = '#0c5460';
            break;
    }
    
    statusDisplay.style.background = bgColor;
    statusDisplay.style.color = textColor;
    statusContent.innerHTML = message;
    statusDisplay.style.display = 'block';
}
</script>