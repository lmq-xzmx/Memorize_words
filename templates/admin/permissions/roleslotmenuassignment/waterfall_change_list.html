{% extends "admin/change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block title %}è§’è‰²æ§½ä½èœå•åˆ†é…ç®¡ç† - ç€‘å¸ƒæµé…ç½®{% endblock %}

{% block extrahead %}
{{ block.super }}
{% if show_update_effect %}
<div id="update-success-message" class="alert alert-success" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; animation: slideInRight 0.5s ease-out;">
    <strong>âœ… {{ update_message|default:"æ›´æ–°æˆåŠŸï¼" }}</strong>
    <button type="button" class="btn-close" onclick="this.parentElement.style.display='none'" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
</div>
<script>
// 3ç§’åè‡ªåŠ¨éšè—æ›´æ–°æç¤º
setTimeout(function() {
    const message = document.getElementById('update-success-message');
    if (message) {
        message.style.animation = 'slideOutRight 0.5s ease-in';
        setTimeout(() => message.style.display = 'none', 500);
    }
}, 3000);
</script>
{% endif %}
<style>
/* æ›´æ–°æç¤ºåŠ¨ç”» */
@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

/* æ‹‰ä¼¸å†…å®¹åŒºåŸŸè‡³æœ€å¤§å®½åº¦ */
#changelist {
    max-width: 100% !important;
    width: 100% !important;
    margin: 0 !important;
}

#content-start {
    max-width: 100% !important;
    width: 100% !important;
    margin: 0 !important;
}

/* ä¸»å®¹å™¨å¸ƒå±€ */
.main-layout {
    display: flex;
    gap: 20px;
    padding: 20px;
    background: #f8f9fa;
}

.waterfall-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    flex: 1;
    transition: all 0.3s ease;
}

.waterfall-container.with-sidebar {
    flex: 0 0 calc(70% - 10px);
}

/* å³ä¾§é…ç½®é¢æ¿ */
.config-sidebar {
    width: 30%;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 20px;
    position: sticky;
    top: 20px;
    height: fit-content;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    display: none;
    transition: all 0.3s ease;
}

.config-sidebar.active {
    display: block;
}

/* ä¾§è¾¹æ æ ·å¼ */
.sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e9ecef;
}

.sidebar-header h3 {
    margin: 0;
    color: #495057;
    font-size: 18px;
}

.close-btn {
    background: none;
    border: none;
    font-size: 18px;
    color: #6c757d;
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.close-btn:hover {
    background: #f8f9fa;
    color: #495057;
}

.config-form .form-group {
    margin-bottom: 15px;
}

.config-form label {
    display: block;
    font-weight: 500;
    margin-bottom: 5px;
    color: #495057;
}

.config-form .form-control {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}

.config-form .form-control:focus {
    outline: none;
    border-color: #80bdff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.config-form .form-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.btn-primary {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

.btn-secondary:hover {
    background: #545b62;
}

/* æ§½ä½ç‚¹å‡»æ•ˆæœ */
.slot-item {
    cursor: pointer;
}

.slot-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.slot-item.selected {
    border-color: #007bff;
    background: #e3f2fd;
}

.role-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.role-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}

.role-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px 20px;
    position: relative;
}

.role-title {
    font-size: 18px;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.role-stats {
    font-size: 12px;
    opacity: 0.9;
    margin-top: 4px;
}

.slots-container {
    padding: 20px;
}

.slot-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    margin-bottom: 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    background: #f8f9fa;
    transition: all 0.2s ease;
}

.slot-item.assigned {
    border-color: #28a745;
    background: #d4edda;
}

.slot-item.empty {
    border-color: #ffc107;
    background: #fff3cd;
    border-style: dashed;
}

.slot-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.slot-number {
    background: #6c757d;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 12px;
}

.slot-item.assigned .slot-number {
    background: #28a745;
}

.slot-item.empty .slot-number {
    background: #ffc107;
}

.menu-info {
    flex: 1;
}

.menu-name {
    font-weight: 500;
    color: #495057;
    margin: 0;
}

.menu-status {
    font-size: 12px;
    color: #6c757d;
    margin: 2px 0 0 0;
}

.slot-actions {
    display: flex;
    gap: 8px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-warning {
    background: #ffc107;
    color: #212529;
}

.btn-warning:hover {
    background: #e0a800;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.empty-slot-form {
    display: none;
    margin-top: 8px;
    padding: 12px;
    background: white;
    border-radius: 6px;
    border: 1px solid #dee2e6;
}

.form-group {
    margin-bottom: 12px;
}

.form-group label {
    display: block;
    font-weight: 500;
    margin-bottom: 4px;
    color: #495057;
}

.form-control {
    width: 100%;
    padding: 6px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}

.form-control:focus {
    outline: none;
    border-color: #80bdff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.form-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.loading {
    opacity: 0.6;
    pointer-events: none;
}

.alert {
    padding: 12px 16px;
    margin-bottom: 16px;
    border-radius: 6px;
    font-size: 14px;
}

.alert-success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.alert-danger {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.stats-summary {
    background: white;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    width: 100% !important;
    max-width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    box-sizing: border-box;
}

/* Djangoç®¡ç†ç•Œé¢é€‚é… - ç¡®ä¿åœ¨ä¸åŒæ˜¾ç¤ºæ¨¡å¼ä¸‹éƒ½èƒ½æ‹‰ä¼¸è‡³æœ€å¤§å®½åº¦ */
#changelist .stats-summary {
    width: 100% !important;
    max-width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
}

/* å½“Djangoå·¦ä¾§èœå•æ æ˜¾ç¤ºæ—¶çš„é€‚é… */
body.sidebar-enabled #changelist .stats-summary,
body:not(.sidebar-collapsed) #changelist .stats-summary {
    width: 100% !important;
    max-width: 100% !important;
}

/* å½“Djangoå·¦ä¾§èœå•æ éšè—æ—¶çš„é€‚é… */
body.sidebar-collapsed #changelist .stats-summary,
body.sidebar-disabled #changelist .stats-summary {
    width: 100% !important;
    max-width: 100% !important;
}

/* é’ˆå¯¹Djangoç®¡ç†ç•Œé¢çš„å®¹å™¨é€‚é… */
#changelist > div:first-child {
    width: 100% !important;
    max-width: 100% !important;
}

/* ç¡®ä¿åœ¨æ‰€æœ‰Djangoç®¡ç†ç•Œé¢çŠ¶æ€ä¸‹çš„å“åº”å¼é€‚é… */
@media screen and (min-width: 768px) {
    .stats-summary {
        width: 100% !important;
        max-width: 100% !important;
    }
    
    #changelist .stats-summary {
        width: 100% !important;
        max-width: 100% !important;
    }
}

/* é…ç½®ä¾§è¾¹æ æ ·å¼ä¼˜åŒ– */
#config-role {
    background-color: #f8f9fa;
    cursor: not-allowed;
}

/* å½“å‰æ ¹ç›®å½•æ˜¾ç¤ºæ ·å¼ */
.current-root-info {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 12px;
    margin-top: 8px;
}

.root-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: white;
    border-radius: 4px;
    border: 1px solid #e9ecef;
}

.root-name {
    font-weight: 500;
    color: #495057;
    flex: 1;
}

.root-status {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 12px;
    background: #6c757d;
    color: white;
    margin-left: 10px;
}

.root-status.active {
    background: #28a745;
}

.root-status.inactive {
    background: #dc3545;
}

.root-status.pending {
    background: #ffc107;
    color: #212529;
}

/* åŒåˆ—é€‰æ‹©å™¨æ ·å¼ */
.selector-container {
    display: flex;
    gap: 10px;
    align-items: stretch;
    margin-top: 10px;
}

.selector-column {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.selector-column h4 {
    margin: 0 0 8px 0;
    font-size: 12px;
    font-weight: 600;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.selector-list {
    height: 200px !important;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 4px;
    font-size: 12px;
    background: white;
}

.selector-list option {
    padding: 4px 8px;
    border-radius: 2px;
    margin-bottom: 1px;
}

.selector-list option:hover {
    background-color: #e3f2fd;
}

.selector-list option:selected {
    background-color: #2196f3 !important;
    color: white !important;
}

.selector-controls {
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 5px;
    padding: 0 5px;
}

.btn-move {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;
    color: #495057;
    transition: all 0.2s ease;
    min-width: 30px;
}

.btn-move:hover {
    background: #e9ecef;
    border-color: #adb5bd;
    color: #212529;
}

.btn-move:active {
    background: #dee2e6;
    transform: translateY(1px);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.stat-item {
    text-align: center;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 6px;
}

.stat-number {
    font-size: 24px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 4px;
}

.stat-label {
    font-size: 12px;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
</style>
{% endblock %}

{% block content %}
<div id="changelist" class="module filtered">
    <div class="results">
        <div class="stats-summary">
            <h2>è§’è‰²æ§½ä½èœå•åˆ†é…æ¦‚è§ˆ</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="total-roles">{{ total_roles }}</div>
                    <div class="stat-label">æ€»è§’è‰²æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-slots">{{ total_slots }}</div>
                    <div class="stat-label">æ€»æ§½ä½æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="assigned-slots">{{ assigned_slots }}</div>
                    <div class="stat-label">å·²åˆ†é…æ§½ä½</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="available-menus">{{ available_menus }}</div>
                    <div class="stat-label">å¯ç”¨æ ¹èœå•</div>
                </div>
            </div>
        </div>

        <div id="alert-container"></div>

        <div class="main-layout">
            <div class="waterfall-container" id="waterfall-container">
            {% for role_data in roles_with_slots %}
            <div class="role-card" data-role="{{ role_data.role_code }}">
                <div class="role-header">
                    <h3 class="role-title">
                        <span>ğŸ‘¤</span>
                        {{ role_data.role_name }}
                    </h3>
                    <div class="role-stats">
                        {{ role_data.assigned_count }}/{{ role_data.total_slots }} æ§½ä½å·²åˆ†é…
                    </div>
                </div>
                
                <div class="slots-container">
                    {% for slot in role_data.slots %}
                    <div class="slot-item {% if slot.assignment %}assigned{% else %}empty{% endif %}" 
                         data-slot="{{ slot.position }}" data-role="{{ role_data.role_code }}"
                         {% if slot.assignment %}data-menu-id="{{ slot.assignment.root_menu.id }}" data-menu-status="{{ slot.assignment.menu_status }}"{% endif %}
                         onclick="openSlotConfigFromData(this)">
                        <div class="slot-info">
                            <div class="slot-number">{{ slot.position }}</div>
                            <div class="menu-info">
                                {% if slot.assignment %}
                                    <p class="menu-name">{{ slot.assignment.root_menu.name }}</p>
                                    <p class="menu-status">
                                        çŠ¶æ€: {{ slot.assignment.get_menu_status_display }}
                                        {% if slot.assignment.is_active %}
                                            <span style="color: #28a745;">âœ“ æ¿€æ´»</span>
                                        {% else %}
                                            <span style="color: #dc3545;">âœ— æœªæ¿€æ´»</span>
                                        {% endif %}
                                    </p>
                                {% else %}
                                    <p class="menu-name">ç©ºæ§½ä½</p>
                                    <p class="menu-status">ç‚¹å‡»é…ç½®æ ¹èœå•</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="slot-actions">
                            {% if slot.assignment %}
                                <button class="btn-sm btn-primary" onclick="configureLevel2Menus('{{ role_data.role_code }}', '{{ slot.position }}', '{{ slot.assignment.id }}')">
                                    äºŒçº§èœå•
                                </button>
                                <button class="btn-sm btn-warning" onclick="editSlot('{{ role_data.role_code }}', '{{ slot.position }}')">
                                    ç¼–è¾‘
                                </button>
                                <button class="btn-sm btn-danger" onclick="removeSlot('{{ role_data.role_code }}', '{{ slot.position }}')">
                                    ç§»é™¤
                                </button>
                            {% else %}
                                <button class="btn-sm btn-primary" onclick="configureSlot('{{ role_data.role_code }}', '{{ slot.position }}')">
                                    é…ç½®
                                </button>
                            {% endif %}
                        </div>
                        
                        <!-- ç©ºæ§½ä½é…ç½®è¡¨å• -->
                        {% if not slot.assignment %}
                        <div class="empty-slot-form" id="form-{{ role_data.role_code }}-{{ slot.position }}">
                            <div class="form-group">
                                <label>é€‰æ‹©æ ¹èœå•:</label>
                                <select class="form-control" name="root_menu">
                                    <option value="">è¯·é€‰æ‹©...</option>
                                    {% for menu in available_root_menus %}
                                    <option value="{{ menu.id }}">{{ menu.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>èœå•çŠ¶æ€:</label>
                                <select class="form-control" name="menu_status">
                                    <option value="active">æ¿€æ´»</option>
                                    <option value="backup">å¤‡ç”¨</option>
                                    <option value="disabled">ç¦ç”¨</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button class="btn-sm btn-primary" onclick="saveSlotConfig('{{ role_data.role_code }}', '{{ slot.position }}')">
                                    ä¿å­˜
                                </button>
                                <button class="btn-sm btn-warning" onclick="cancelSlotConfig('{{ role_data.role_code }}', '{{ slot.position }}')">
                                    å–æ¶ˆ
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
            </div>
            
            <!-- å³ä¾§é…ç½®é¢æ¿ -->
            <div class="config-sidebar" id="config-sidebar">
                <div class="sidebar-header">
                    <h3 id="sidebar-title">æ§½ä½é…ç½®</h3>
                    <button class="close-btn" onclick="closeSidebar()">âœ•</button>
                </div>
                
                <div class="sidebar-content" id="sidebar-content">
                    <div class="config-form">
                        <div class="form-group">
                            <label>è§’è‰²:</label>
                            <input type="text" id="config-role" class="form-control" readonly disabled>
                        </div>
                        
                        <div class="form-group">
                            <label>å½“å‰æ ¹ç›®å½•:</label>
                            <div id="current-root-directory" class="current-root-info">
                                <div class="root-item" id="root-display">
                                    <span class="root-name">æœªé…ç½®</span>
                                    <span class="root-status">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>é…ç½®ä¸€çº§ç›®å½•:</label>
                            <div class="selector-container">
                                <div class="selector-column">
                                    <h4>å¯ç”¨èœå•</h4>
                                    <select id="config-menu-available" class="form-control selector-list" multiple size="10" ondblclick="moveToSelected()">
                                        <!-- åŠ¨æ€åŠ è½½æ‰€æœ‰ä¸€çº§ç›®å½• -->
                                    </select>
                                </div>
                                <div class="selector-controls">
                                    <button type="button" class="btn-move" onclick="moveToSelected()" title="æ·»åŠ åˆ°å·²é€‰æ‹©">&gt;</button>
                                    <button type="button" class="btn-move" onclick="moveToAvailable()" title="ç§»é™¤é€‰æ‹©">&lt;</button>
                                    <button type="button" class="btn-move" onclick="moveAllToSelected()" title="å…¨éƒ¨æ·»åŠ ">&gt;&gt;</button>
                                    <button type="button" class="btn-move" onclick="moveAllToAvailable()" title="å…¨éƒ¨ç§»é™¤">&lt;&lt;</button>
                                </div>
                                <div class="selector-column">
                                    <h4>å·²é€‰æ‹©èœå•</h4>
                                    <select id="config-menu-selected" class="form-control selector-list" multiple size="10">
                                        <!-- åŠ¨æ€åŠ è½½è¯¥è§’è‰²å·²è®¾å®šçš„ä¸€çº§ç›®å½• -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn-primary" onclick="saveSidebarConfig()">ä¿å­˜é…ç½®</button>
                            <button class="btn-secondary" onclick="closeSidebar()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
let isLoading = false;
let currentSlotConfig = null;

// å¼ºåˆ¶ç§»é™¤loadingçŠ¶æ€
function forceRemoveLoading() {
    document.body.classList.remove('loading');
    console.log('å¼ºåˆ¶ç§»é™¤loadingç±»');
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showAlert(message, type = 'success') {
    const container = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    container.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// é…ç½®æ§½ä½
function configureSlot(role, slotPosition) {
    const form = document.getElementById(`form-${role}-${slotPosition}`);
    form.style.display = 'block';
}

// å–æ¶ˆé…ç½®
function cancelSlotConfig(role, slotPosition) {
    const form = document.getElementById(`form-${role}-${slotPosition}`);
    form.style.display = 'none';
    // é‡ç½®è¡¨å•
    form.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
}

// ä¿å­˜æ§½ä½é…ç½®
function saveSlotConfig(role, slotPosition) {
    if (isLoading) return;
    
    const form = document.getElementById(`form-${role}-${slotPosition}`);
    const rootMenuSelect = form.querySelector('select[name="root_menu"]');
    const statusSelect = form.querySelector('select[name="menu_status"]');
    
    const rootMenuId = rootMenuSelect.value;
    const menuStatus = statusSelect.value;
    
    if (!rootMenuId) {
        showAlert('è¯·é€‰æ‹©æ ¹èœå•', 'danger');
        return;
    }
    
    isLoading = true;
    document.body.classList.add('loading');
    
    // å‘é€AJAXè¯·æ±‚
    fetch('{% url "admin:permissions_roleslotmenuassignment_configure" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new URLSearchParams({
            'role': role,
            'slot_position': slotPosition,
            'root_menu': rootMenuId,
            'menu_status': menuStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`æˆåŠŸä¸ºè§’è‰² ${role} çš„æ§½ä½ ${slotPosition} é…ç½®èœå•`);
            // åˆ·æ–°é¡µé¢æˆ–æ›´æ–°UI
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAlert(data.error || 'é…ç½®å¤±è´¥', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'danger');
    })
    .finally(() => {
        isLoading = false;
        document.body.classList.remove('loading');
    });
}

// ç¼–è¾‘æ§½ä½
function editSlot(role, slotPosition) {
    // è·³è½¬åˆ°ç¼–è¾‘é¡µé¢
    const editUrl = '{% url "admin:permissions_roleslotmenuassignment_changelist" %}' + '?role=' + role + '&slot_position=' + slotPosition;
    window.location.href = editUrl;
}

// ç§»é™¤æ§½ä½
function removeSlot(role, slotPosition) {
    if (!confirm('ç¡®å®šè¦ç§»é™¤æ­¤æ§½ä½çš„èœå•é…ç½®å—ï¼Ÿ')) {
        return;
    }
    
    if (isLoading) return;
    
    isLoading = true;
    document.body.classList.add('loading');
    
    // è¿™é‡Œéœ€è¦å®ç°ç§»é™¤é€»è¾‘çš„API
    fetch('{% url "admin:permissions_roleslotmenuassignment_remove" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new URLSearchParams({
            'role': role,
            'slot_position': slotPosition
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`æˆåŠŸç§»é™¤è§’è‰² ${role} çš„æ§½ä½ ${slotPosition} é…ç½®`);
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAlert(data.error || 'ç§»é™¤å¤±è´¥', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'danger');
    })
    .finally(() => {
        isLoading = false;
        document.body.classList.remove('loading');
    });
}

// ä»dataå±æ€§æ‰“å¼€æ§½ä½é…ç½®ä¾§è¾¹æ 
function openSlotConfigFromData(element) {
    const role = element.getAttribute('data-role');
    const slotPosition = element.getAttribute('data-slot');
    const currentMenuId = element.getAttribute('data-menu-id');
    const currentStatus = element.getAttribute('data-menu-status');
    
    openSlotConfig(role, slotPosition, currentMenuId, currentStatus);
}

// æ‰“å¼€æ§½ä½é…ç½®ä¾§è¾¹æ 
function openSlotConfig(role, slotPosition, currentMenuId, currentStatus) {
    const sidebar = document.getElementById('config-sidebar');
    const mainLayout = document.querySelector('.main-layout');
    
    // ç§»é™¤æ‰€æœ‰æ§½ä½çš„é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.slot-item.selected').forEach(item => {
        item.classList.remove('selected');
    });
    
    // æ·»åŠ å½“å‰æ§½ä½çš„é€‰ä¸­çŠ¶æ€
    const currentSlot = document.querySelector(`[data-role="${role}"][data-slot="${slotPosition}"]`);
    if (currentSlot) {
        currentSlot.classList.add('selected');
    }
    
    // è®¾ç½®å½“å‰é…ç½®ä¿¡æ¯ï¼ˆç§»é™¤æ§½ä½æ¦‚å¿µï¼‰
    currentSlotConfig = { role, slot_position: slotPosition };
    
    // å¡«å……è¡¨å•
    document.getElementById('config-role').value = role;
    
    // åŠ è½½å¹¶æ˜¾ç¤ºå½“å‰æ ¹ç›®å½•ä¿¡æ¯
    loadCurrentRootDirectory(role, slotPosition);
    
    // æ ¹æ®è§’è‰²åŠ¨æ€åŠ è½½ä¸€çº§ç›®å½•
    loadMenusByRole(role, currentMenuId);
    
    // æ˜¾ç¤ºä¾§è¾¹æ 
    mainLayout.classList.add('with-sidebar');
    sidebar.classList.add('active');
}

// å…³é—­ä¾§è¾¹æ 
function closeSidebar() {
    const sidebar = document.getElementById('config-sidebar');
    const mainLayout = document.querySelector('.main-layout');
    
    // ç§»é™¤æ‰€æœ‰æ§½ä½çš„é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.slot-item.selected').forEach(item => {
        item.classList.remove('selected');
    });
    
    // éšè—ä¾§è¾¹æ 
    mainLayout.classList.remove('with-sidebar');
    sidebar.classList.remove('active');
    
    // æ¸…ç©ºå½“å‰é…ç½®
    currentSlotConfig = null;
}

// æ ¹æ®è§’è‰²åŠ è½½ä¸€çº§ç›®å½•åˆ°åŒåˆ—é€‰æ‹©å™¨
function loadMenusByRole(role, currentMenuId) {
    const availableSelect = document.getElementById('config-menu-available');
    const selectedSelect = document.getElementById('config-menu-selected');
    
    // æ¸…ç©ºç°æœ‰é€‰é¡¹
    availableSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
    selectedSelect.innerHTML = '';
    
    // åŒæ—¶è·å–æ‰€æœ‰ä¸€çº§ç›®å½•å’Œè¯¥è§’è‰²å·²é€‰æ‹©çš„ç›®å½•
    Promise.all([
        // è·å–æ‰€æœ‰ä¸€çº§ç›®å½•
        fetch(`/admin/permissions/roleslotmenuassignment/configure-menu-by-role-slot/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        }),
        // è·å–è¯¥è§’è‰²å·²é€‰æ‹©çš„ç›®å½•
        fetch(`/admin/permissions/roleslotmenuassignment/get-selected-menus/?role=${encodeURIComponent(role)}&slot_position=${encodeURIComponent(currentSlotConfig.slot_position || '1')}&format=json`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
    ])
    .then(responses => Promise.all(responses.map(r => r.json())))
    .then(([allMenusData, selectedMenusData]) => {
        // æ¸…ç©ºé€‰é¡¹
        availableSelect.innerHTML = '';
        selectedSelect.innerHTML = '';
        
        const allMenus = allMenusData.level1_menus || [];
        const selectedMenuIds = (selectedMenusData.selected_menus || []).map(m => m.id.toString());
        
        // å¡«å……å¯ç”¨èœå•åˆ—è¡¨ï¼ˆæ’é™¤å·²é€‰æ‹©çš„ï¼‰
        allMenus.forEach(menu => {
            if (!selectedMenuIds.includes(menu.id.toString())) {
                const option = document.createElement('option');
                option.value = menu.id;
                option.textContent = menu.name;
                availableSelect.appendChild(option);
            }
        });
        
        // å¡«å……å·²é€‰æ‹©èœå•åˆ—è¡¨
        (selectedMenusData.selected_menus || []).forEach(menu => {
            const option = document.createElement('option');
            option.value = menu.id;
            option.textContent = menu.name;
            selectedSelect.appendChild(option);
        });
        
        if (allMenus.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'æš‚æ— å¯ç”¨çš„ä¸€çº§ç›®å½•';
            option.disabled = true;
            availableSelect.appendChild(option);
        }
    })
    .catch(error => {
        console.error('åŠ è½½ä¸€çº§èœå•å¤±è´¥:', error);
        availableSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</option>';
    });
}

// åŒåˆ—é€‰æ‹©å™¨æ“ä½œå‡½æ•°
function moveToSelected() {
    console.log('moveToSelected å‡½æ•°è¢«è°ƒç”¨');
    const availableSelect = document.getElementById('config-menu-available');
    const selectedSelect = document.getElementById('config-menu-selected');
    
    if (!availableSelect || !selectedSelect) {
        console.error('æ‰¾ä¸åˆ°é€‰æ‹©å™¨å…ƒç´ ');
        return;
    }
    
    const selectedOptions = Array.from(availableSelect.selectedOptions);
    console.log('é€‰ä¸­çš„é€‰é¡¹æ•°é‡:', selectedOptions.length);
    
    selectedOptions.forEach(option => {
        selectedSelect.appendChild(option.cloneNode(true));
        option.remove();
    });
}

function moveToAvailable() {
    console.log('moveToAvailable å‡½æ•°è¢«è°ƒç”¨');
    const availableSelect = document.getElementById('config-menu-available');
    const selectedSelect = document.getElementById('config-menu-selected');
    
    if (!availableSelect || !selectedSelect) {
        console.error('æ‰¾ä¸åˆ°é€‰æ‹©å™¨å…ƒç´ ');
        return;
    }
    
    const selectedOptions = Array.from(selectedSelect.selectedOptions);
    console.log('é€‰ä¸­çš„é€‰é¡¹æ•°é‡:', selectedOptions.length);
    
    selectedOptions.forEach(option => {
        availableSelect.appendChild(option.cloneNode(true));
        option.remove();
    });
}

function moveAllToSelected() {
    console.log('moveAllToSelected å‡½æ•°è¢«è°ƒç”¨');
    const availableSelect = document.getElementById('config-menu-available');
    const selectedSelect = document.getElementById('config-menu-selected');
    
    if (!availableSelect || !selectedSelect) {
        console.error('æ‰¾ä¸åˆ°é€‰æ‹©å™¨å…ƒç´ ');
        return;
    }
    
    console.log('å¯ç”¨é€‰é¡¹æ•°é‡:', availableSelect.options.length);
    
    Array.from(availableSelect.options).forEach(option => {
        if (option.value) {
            selectedSelect.appendChild(option.cloneNode(true));
        }
    });
    availableSelect.innerHTML = '';
}

function moveAllToAvailable() {
    console.log('moveAllToAvailable å‡½æ•°è¢«è°ƒç”¨');
    const availableSelect = document.getElementById('config-menu-available');
    const selectedSelect = document.getElementById('config-menu-selected');
    
    if (!availableSelect || !selectedSelect) {
        console.error('æ‰¾ä¸åˆ°é€‰æ‹©å™¨å…ƒç´ ');
        return;
    }
    
    console.log('å·²é€‰é€‰é¡¹æ•°é‡:', selectedSelect.options.length);
    
    Array.from(selectedSelect.options).forEach(option => {
        if (option.value) {
            availableSelect.appendChild(option.cloneNode(true));
        }
    });
    selectedSelect.innerHTML = '';
}

// åŠ è½½å½“å‰æ ¹ç›®å½•ä¿¡æ¯
function loadCurrentRootDirectory(role, slotPosition) {
    const rootDisplay = document.getElementById('root-display');
    const rootName = rootDisplay.querySelector('.root-name');
    const rootStatus = rootDisplay.querySelector('.root-status');
    
    // é‡ç½®æ˜¾ç¤º
    rootName.textContent = 'åŠ è½½ä¸­...';
    rootStatus.textContent = '-';
    rootStatus.className = 'root-status';
    
    // ä»å½“å‰é€‰ä¸­çš„èœå•é¡¹è·å–æ ¹ç›®å½•ä¿¡æ¯
    const selectedSlotItem = document.querySelector(`[data-role="${role}"][data-slot="${slotPosition}"]`);
    
    if (selectedSlotItem && selectedSlotItem.classList.contains('assigned')) {
        // ä»slot-itemçš„dataå±æ€§å’Œå†…å®¹ä¸­è·å–èœå•ä¿¡æ¯
        const menuNameElement = selectedSlotItem.querySelector('.menu-name');
        const menuStatusElement = selectedSlotItem.querySelector('.menu-status');
        
        if (menuNameElement && menuStatusElement) {
            rootName.textContent = menuNameElement.textContent.trim();
            
            // è§£æçŠ¶æ€ä¿¡æ¯
            const statusText = menuStatusElement.textContent;
            const isActive = statusText.includes('âœ“ æ¿€æ´»');
            
            if (isActive) {
                rootStatus.textContent = 'æ¿€æ´»';
                rootStatus.classList.add('active');
            } else {
                rootStatus.textContent = 'æœªæ¿€æ´»';
                rootStatus.classList.add('inactive');
            }
        } else {
            rootName.textContent = 'æ•°æ®è·å–å¤±è´¥';
            rootStatus.textContent = 'é”™è¯¯';
        }
    } else {
        rootName.textContent = 'æœªé…ç½®';
        rootStatus.textContent = '-';
    }
}

// ä¿å­˜ä¾§è¾¹æ é…ç½®
function saveSidebarConfig() {
    if (!currentSlotConfig || isLoading) return;
    
    const selectedSelect = document.getElementById('config-menu-selected');
    
    // è·å–æ‰€æœ‰å·²é€‰æ‹©çš„èœå•ID
    const selectedMenuIds = Array.from(selectedSelect.options).map(option => option.value).filter(id => id);
    
    isLoading = true;
    document.body.classList.add('loading');
    
    // å‘é€AJAXè¯·æ±‚ä¿å­˜è§’è‰²çš„ä¸€çº§èœå•é…ç½®
    fetch('{% url "admin:permissions_roleslotmenuassignment_configure" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new URLSearchParams({
            'role': currentSlotConfig.role,
            'slot_position': currentSlotConfig.slot_position || '1',
            'selected_level1_menus': JSON.stringify(selectedMenuIds),
            'action': 'bulk_update'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`æˆåŠŸä¸ºè§’è‰² ${currentSlotConfig.role} é…ç½®ä¸€çº§èœå•`);
            closeSidebar();
            // åˆ·æ–°é¡µé¢æˆ–æ›´æ–°UI
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAlert(data.error || 'ä¸€çº§èœå•é…ç½®å¤±è´¥', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'danger');
    })
    .finally(() => {
        isLoading = false;
        document.body.classList.remove('loading');
    });
}

// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // å¼ºåˆ¶ç§»é™¤loadingçŠ¶æ€ï¼Œç¡®ä¿æŒ‰é’®å¯ä»¥ç‚¹å‡»
    document.body.classList.remove('loading');
    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œç§»é™¤loadingçŠ¶æ€');
    
    // æ·»åŠ CSRF tokenåˆ°é¡µé¢
    if (!document.querySelector('[name=csrfmiddlewaretoken]')) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        document.body.appendChild(csrfInput);
    }
    
    // æ£€æŸ¥URLå‚æ•°ï¼Œå¦‚æœå­˜åœ¨roleå’Œslot_positionï¼Œè‡ªåŠ¨æ‰“å¼€åŒåˆ—é€‰æ‹©å™¨
    const urlParams = new URLSearchParams(window.location.search);
    const role = urlParams.get('role');
    const slotPosition = urlParams.get('slot_position');
    
    if (role && slotPosition) {
        // å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
        setTimeout(() => {
            openSlotConfig(role, parseInt(slotPosition));
        }, 100);
    }
    
    // ç‚¹å‡»ä¾§è¾¹æ å¤–éƒ¨åŒºåŸŸå…³é—­ä¾§è¾¹æ 
    document.addEventListener('click', function(e) {
        const sidebar = document.getElementById('config-sidebar');
        const mainLayout = document.querySelector('.main-layout');
        
        if (sidebar.classList.contains('active') && 
            !sidebar.contains(e.target) && 
            !e.target.closest('.slot-item')) {
            closeSidebar();
        }
    });
});

// é…ç½®äºŒçº§èœå•å‡½æ•°
function configureLevel2Menus(role, slotPosition, assignmentId) {
    // è·³è½¬åˆ°äºŒçº§èœå•åˆ†é…é¡µé¢ï¼Œä¼ é€’assignment_idå‚æ•°
    const url = `/admin/permissions/roleslotlevel2menuassignment/?assignment_id=${assignmentId}&role=${role}&slot_position=${slotPosition}`;
    window.location.href = url;
}
</script>
{% endblock %}