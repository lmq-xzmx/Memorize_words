<!-- ç®€åŒ–çš„çº§è”é€‰æ‹©å™¨ - ç§»é™¤å†—ä½™divå…ƒç´  -->
<div class="cascade-selector-container" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
    <!-- æ™ºèƒ½çº§è”é…ç½®åŒº -->
    <div class="config-section" style="background: white; border-radius: 8px; border: 1px solid #dee2e6; padding: 20px;">
        <h3 style="margin: 0 0 20px 0; color: #495057; font-size: 18px; border-bottom: 2px solid #007bff; padding-bottom: 10px;">ğŸ¯ æ™ºèƒ½çº§è”é…ç½®</h3>
        
        <form id="cascade-config-form" style="display: grid; gap: 20px;">
            {% csrf_token %}
            
            <!-- ç¬¬ä¸€çº§ï¼šè§’è‰²é€‰æ‹© -->
            <div id="role-level" class="cascade-level" style="background: #f0f8ff; border: 2px solid #007bff; border-radius: 8px; padding: 15px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="background: #007bff; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">1</span>
                    <h4 style="margin: 0; color: #007bff;">é€‰æ‹©è§’è‰²</h4>
                    <span id="current-role" style="margin-left: auto; font-size: 12px; color: #6c757d;">æœªé€‰æ‹©</span>
                </div>
                <select id="cascade-role-select" onchange="onRoleChange(this.value)" 
                        style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                    <option value="">è¯·é€‰æ‹©è§’è‰²...</option>
                </select>
                <div id="role-info" style="margin-top: 8px; font-size: 12px;"></div>
            </div>
            
            <!-- ç¬¬äºŒçº§ï¼šæ§½ä½é…ç½® -->
            <div id="slot-level" class="cascade-level" style="background: #fafbfc; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; opacity: 0.5;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="background: #6c757d; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">2</span>
                    <h4 style="margin: 0; color: #6c757d;">é…ç½®æ§½ä½</h4>
                    <span id="current-slot" style="margin-left: auto; font-size: 12px; color: #6c757d;">æœªé€‰æ‹©</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">
                    <select id="cascade-slot-select" onchange="onSlotChange(this.value)" disabled
                            style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                        <option value="">é€‰æ‹©æ§½ä½...</option>
                    </select>
                    <input id="slot-status" type="text" readonly placeholder="æ§½ä½çŠ¶æ€" 
                           style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px; background: #f8f9fa; width: 80px;">
                </div>
            </div>
            
            <!-- ç¬¬ä¸‰çº§ï¼šèœå•é€‰æ‹© -->
            <div id="menu-level" class="cascade-level" style="background: #fafbfc; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; opacity: 0.5;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="background: #6c757d; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">3</span>
                    <h4 style="margin: 0; color: #6c757d;">é€‰æ‹©èœå•</h4>
                    <span id="current-menu" style="margin-left: auto; font-size: 12px; color: #6c757d;">æœªé€‰æ‹©</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">
                    <select id="cascade-menu-select" onchange="onMenuChange(this.value)" disabled
                            style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                        <option value="">é€‰æ‹©æ ¹èœå•...</option>
                    </select>
                    <select id="cascade-status-select" disabled
                            style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px; width: 100px;">
                        <option value="active">æ¿€æ´»</option>
                        <option value="backup">å€™è¡¥</option>
                        <option value="disabled">ç¦ç”¨</option>
                    </select>
                </div>
            </div>
            
            <!-- ç¬¬å››çº§ï¼šç¡®è®¤å’Œæäº¤ -->
            <div id="submit-level" class="cascade-level" style="background: #fafbfc; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; opacity: 0.5;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="background: #6c757d; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">4</span>
                    <h4 style="margin: 0; color: #6c757d;">ç¡®è®¤æäº¤</h4>
                </div>
                <div id="config-summary" style="background: #e9ecef; color: #495057; padding: 12px; border-radius: 4px; margin-bottom: 15px; font-size: 13px;">
                    è¯·å®Œæˆä¸Šè¿°é…ç½®æ­¥éª¤...
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="cascade-submit-btn" type="submit" disabled
                            style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; flex: 1;">
                        âœ… åº”ç”¨é…ç½®
                    </button>
                    <button type="button" onclick="resetCascadeForm()"
                            style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                        ğŸ”„ é‡ç½®
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- å…¨å±€çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
<div id="global-status-display" style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 4px; font-size: 13px; display: none;">
    <div id="global-status-content"></div>
</div>

<!-- å†å²æ•°æ®æ˜¾ç¤ºåŒºåŸŸ -->
<div id="history-data-section" class="history-section" style="margin-top: 20px; background: white; border-radius: 8px; border: 1px solid #dee2e6; padding: 20px; display: none;">
    <h3 style="margin: 0 0 20px 0; color: #495057; font-size: 18px; border-bottom: 2px solid #28a745; padding-bottom: 10px;">ğŸ“‹ å†å²é…ç½®è®°å½•</h3>
    <div id="history-loading" style="text-align: center; padding: 20px; color: #6c757d; display: none;">
        <span>æ­£åœ¨åŠ è½½å†å²æ•°æ®...</span>
    </div>
    <div id="history-table-container">
        <table id="history-table" style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                    <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">è§’è‰²</th>
                    <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">æ§½ä½ä½ç½®</th>
                    <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">æ ¹èœå•</th>
                    <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">çŠ¶æ€</th>
                    <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">æ’åº</th>
                    <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">åˆ›å»ºæ—¶é—´</th>
                    <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">æ›´æ–°æ—¶é—´</th>
                </tr>
            </thead>
            <tbody id="history-table-body">
                <!-- å†å²æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </tbody>
        </table>
    </div>
    <div id="history-empty" style="text-align: center; padding: 40px; color: #6c757d; display: none;">
        <p>æš‚æ— å†å²é…ç½®è®°å½•</p>
    </div>
</div>

<script>
// çº§è”é€‰æ‹©å™¨æ•°æ®
let cascadeData = {
    roles: [],
    slots: {},
    menus: [],
    slotConfigs: [],
    currentConfig: {
        role: null,
        slot: null,
        menu: null,
        status: 'active'
    }
};

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializePage();
    
    // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
    const cascadeForm = document.getElementById('cascade-config-form');
    if (cascadeForm) {
        cascadeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitCascadeConfig();
        });
    }
});

// åˆå§‹åŒ–é¡µé¢ - ç›´æ¥ä»åç«¯è·å–çœŸå®è§’è‰²æ•°æ®
function initializePage() {
    // è·å–ç³»ç»Ÿä¸­çš„çœŸå®è§’è‰²æ•°æ®
    const configUrl = window.location.pathname + 'configure-menu-by-role-slot/';
    
    fetch(configUrl, {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('APIè¿”å›æ•°æ®:', data);
            cascadeData.roles = data.roles || [];
            cascadeData.menus = data.root_menus || [];
            cascadeData.slotConfigs = data.slot_configs || [];
            
            // å¡«å……è§’è‰²é€‰é¡¹
            populateRoleSelect();
            
            if (cascadeData.roles.length > 0) {
                showGlobalStatus(`æˆåŠŸåŠ è½½ ${cascadeData.roles.length} ä¸ªè§’è‰²å’Œ ${cascadeData.slotConfigs.length} ä¸ªæ§½ä½é…ç½®`, 'success');
                console.log('å·²åŠ è½½è§’è‰²:', cascadeData.roles);
                console.log('å·²åŠ è½½æ§½ä½é…ç½®:', cascadeData.slotConfigs);
                
                // åŠ è½½å†å²æ•°æ®
                setTimeout(() => {
                    loadHistoryData();
                }, 500);
            }
        })
        .catch(error => {
            console.error('åˆå§‹åŒ–é¡µé¢å¤±è´¥:', error);
            // å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨ç¡¬ç¼–ç çš„è§’è‰²æ•°æ®ä½œä¸ºå¤‡é€‰
            cascadeData.roles = [
                ['student', 'å­¦ç”Ÿ'],
                ['parent', 'å®¶é•¿'], 
                ['teacher', 'è‡ªç”±è€å¸ˆ'],
                ['admin', 'ç®¡ç†å‘˜'],
                ['dean', 'æ•™å¯¼ä¸»ä»»'],
                ['academic_director', 'æ•™åŠ¡ä¸»ä»»'],
                ['research_leader', 'æ•™ç ”ç»„é•¿'],
                ['project_assistant', 'é¡¹ç›®åŠ©ç†'],
                ['project_manager_assistant', 'é¡¹ç›®ç®¡ç†åŠ©ç†']
            ];
            populateRoleSelect();
            showGlobalStatus('APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è§’è‰²æ•°æ®', 'warning');
        });
}

// å¡«å……è§’è‰²é€‰æ‹©å™¨
function populateRoleSelect() {
    const roleSelect = document.getElementById('cascade-role-select');
    roleSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è§’è‰²...</option>';
    cascadeData.roles.forEach(role => {
        roleSelect.innerHTML += `<option value="${role[0]}">${role[1]}</option>`;
    });
}

// è§’è‰²é€‰æ‹©å˜åŒ–å¤„ç†
function onRoleChange(roleValue) {
    cascadeData.currentConfig.role = roleValue;
    updateCurrentStatus('role', roleValue);
    
    if (roleValue) {
        enableCascadeLevel('slot-level');
        fetchRoleSlots(roleValue);
        updateRoleInfo(roleValue);
    } else {
        disableCascadeLevel('slot-level');
        disableCascadeLevel('menu-level');
        disableCascadeLevel('submit-level');
        resetConfigSummary();
    }
}

// æ§½ä½é€‰æ‹©å˜åŒ–å¤„ç†
function onSlotChange(slotValue) {
    cascadeData.currentConfig.slot = slotValue;
    updateCurrentStatus('slot', slotValue);
    
    if (slotValue) {
        enableCascadeLevel('menu-level');
        populateMenuOptions();
        updateSlotInfo(slotValue);
    } else {
        disableCascadeLevel('menu-level');
        disableCascadeLevel('submit-level');
        resetConfigSummary();
    }
}

// èœå•é€‰æ‹©å˜åŒ–å¤„ç†
function onMenuChange(menuValue) {
    cascadeData.currentConfig.menu = menuValue;
    updateCurrentStatus('menu', menuValue);
    
    if (menuValue) {
        enableCascadeLevel('submit-level');
        updateMenuInfo(menuValue);
        updateConfigSummary();
    } else {
        disableCascadeLevel('submit-level');
        resetConfigSummary();
    }
}

// æ›´æ–°å½“å‰çŠ¶æ€æ˜¾ç¤º
function updateCurrentStatus(type, value) {
    const statusMap = {
        'role': 'current-role',
        'slot': 'current-slot', 
        'menu': 'current-menu'
    };
    
    const element = document.getElementById(statusMap[type]);
    if (element) {
        if (value) {
            if (type === 'role') {
                const role = cascadeData.roles.find(r => r[0] === value);
                element.textContent = role ? role[1] : value;
                element.style.color = '#28a745';
            } else if (type === 'slot') {
                element.textContent = `${value}å·æ§½ä½`;
                element.style.color = '#007bff';
            } else if (type === 'menu') {
                const menu = cascadeData.menus.find(m => m.id == value);
                element.textContent = menu ? menu.name : value;
                element.style.color = '#17a2b8';
            }
        } else {
            element.textContent = 'æœªé€‰æ‹©';
            element.style.color = '#6c757d';
        }
    }
}

// è·å–è§’è‰²æ§½ä½é…ç½®
function fetchRoleSlots(roleValue) {
    const slotSelect = document.getElementById('cascade-slot-select');
    slotSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
    slotSelect.disabled = true;
    
    // è°ƒç”¨APIè·å–æ§½ä½çŠ¶æ€
    fetch(`${window.location.pathname}get-slot-status/${roleValue}/`)
        .then(response => response.json())
        .then(data => {
            console.log('æ§½ä½çŠ¶æ€APIå“åº”:', data);
            
            slotSelect.innerHTML = '<option value="">é€‰æ‹©æ§½ä½...</option>';
            
            if (data.success) {
                // æ ¹æ®APIè¿”å›çš„æ§½ä½çŠ¶æ€ç”Ÿæˆé€‰é¡¹
                data.slot_status.forEach(slot => {
                    const statusText = slot.is_occupied ? 
                        ` (å·²å ç”¨: ${slot.menu_name})` : ' (å¯ç”¨)';
                    const disabled = slot.is_occupied ? 'disabled' : '';
                    
                    slotSelect.innerHTML += 
                        `<option value="${slot.position}" ${disabled}>${slot.position}å·æ§½ä½${statusText}</option>`;
                });
                
                slotSelect.disabled = false;
                console.log(`å·²ä¸ºè§’è‰² ${roleValue} åŠ è½½ ${data.total_slots} ä¸ªæ§½ä½`);
            } else {
                console.error('è·å–æ§½ä½çŠ¶æ€å¤±è´¥:', data.message);
                slotSelect.innerHTML = '<option value="">è·å–æ§½ä½å¤±è´¥</option>';
                
                // å›é€€åˆ°æœ¬åœ°é…ç½®æ•°æ®
                const roleSlotConfig = cascadeData.slotConfigs.find(config => config.role === roleValue);
                if (roleSlotConfig) {
                    slotSelect.innerHTML = '<option value="">é€‰æ‹©æ§½ä½...</option>';
                    for (let i = 1; i <= roleSlotConfig.slot_count; i++) {
                        slotSelect.innerHTML += `<option value="${i}">${i}å·æ§½ä½</option>`;
                    }
                    slotSelect.disabled = false;
                }
            }
        })
        .catch(error => {
            console.error('APIè°ƒç”¨å¤±è´¥:', error);
            slotSelect.innerHTML = '<option value="">ç½‘ç»œé”™è¯¯</option>';
            
            // å›é€€åˆ°æœ¬åœ°é…ç½®æ•°æ®
            const roleSlotConfig = cascadeData.slotConfigs.find(config => config.role === roleValue);
            if (roleSlotConfig) {
                slotSelect.innerHTML = '<option value="">é€‰æ‹©æ§½ä½...</option>';
                for (let i = 1; i <= roleSlotConfig.slot_count; i++) {
                    slotSelect.innerHTML += `<option value="${i}">${i}å·æ§½ä½</option>`;
                }
                slotSelect.disabled = false;
            }
        });
}

// å¡«å……èœå•é€‰é¡¹
function populateMenuOptions() {
    const menuSelect = document.getElementById('cascade-menu-select');
    menuSelect.innerHTML = '<option value="">é€‰æ‹©æ ¹èœå•...</option>';
    
    cascadeData.menus.forEach(menu => {
        menuSelect.innerHTML += `<option value="${menu.id}">${menu.name}</option>`;
    });
    
    menuSelect.disabled = false;
    document.getElementById('cascade-status-select').disabled = false;
}

// å¯ç”¨çº§è”çº§åˆ«
function enableCascadeLevel(levelId) {
    const level = document.getElementById(levelId);
    level.style.opacity = '1';
    level.style.background = '#f0f8ff';
    level.style.borderColor = '#007bff';
    
    const stepNumber = level.querySelector('span');
    if (stepNumber) {
        stepNumber.style.background = '#007bff';
    }
    
    const heading = level.querySelector('h4');
    if (heading) {
        heading.style.color = '#007bff';
    }
}

// ç¦ç”¨çº§è”çº§åˆ«
function disableCascadeLevel(levelId) {
    const level = document.getElementById(levelId);
    level.style.opacity = '0.5';
    level.style.background = '#fafbfc';
    level.style.borderColor = '#e9ecef';
    
    const stepNumber = level.querySelector('span');
    if (stepNumber) {
        stepNumber.style.background = '#6c757d';
    }
    
    const heading = level.querySelector('h4');
    if (heading) {
        heading.style.color = '#6c757d';
    }
    
    const inputs = level.querySelectorAll('select, input, button');
    inputs.forEach(input => {
        input.disabled = true;
        if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        } else if (input.tagName === 'INPUT') {
            input.value = '';
        }
    });
}

// æ›´æ–°è§’è‰²ä¿¡æ¯
function updateRoleInfo(roleValue) {
    const roleInfo = document.getElementById('role-info');
    const role = cascadeData.roles.find(r => r[0] === roleValue);
    if (role) {
        roleInfo.innerHTML = `<span style="color: #28a745;">âœ“ ${role[1]}</span>`;
    }
}

// æ›´æ–°æ§½ä½ä¿¡æ¯
function updateSlotInfo(slotValue) {
    const slotStatus = document.getElementById('slot-status');
    const isOccupied = Math.random() > 0.7;
    const status = isOccupied ? 'å·²å ç”¨' : 'å¯ç”¨';
    slotStatus.value = status;
}

// æ›´æ–°èœå•ä¿¡æ¯
function updateMenuInfo(menuValue) {
    // èœå•ä¿¡æ¯æ›´æ–°é€»è¾‘
}

// æ›´æ–°é…ç½®æ‘˜è¦
function updateConfigSummary() {
    const summary = document.getElementById('config-summary');
    const submitBtn = document.getElementById('cascade-submit-btn');
    
    const role = cascadeData.roles.find(r => r[0] === cascadeData.currentConfig.role);
    const menu = cascadeData.menus.find(m => m.id == cascadeData.currentConfig.menu);
    const status = document.getElementById('cascade-status-select').value;
    
    if (role && cascadeData.currentConfig.slot && menu) {
        summary.innerHTML = `
            <strong>é…ç½®æ‘˜è¦ï¼š</strong><br>
            è§’è‰²: ${role[1]} | æ§½ä½: ${cascadeData.currentConfig.slot} | èœå•: ${menu.name} | çŠ¶æ€: ${status}
        `;
        summary.style.background = '#d4edda';
        summary.style.color = '#155724';
        
        submitBtn.disabled = false;
        submitBtn.style.background = '#28a745';
    } else {
        resetConfigSummary();
    }
}

// é‡ç½®é…ç½®æ‘˜è¦
function resetConfigSummary() {
    const summary = document.getElementById('config-summary');
    const submitBtn = document.getElementById('cascade-submit-btn');
    
    summary.innerHTML = 'è¯·å®Œæˆä¸Šè¿°é…ç½®æ­¥éª¤...';
    summary.style.background = '#e9ecef';
    summary.style.color = '#495057';
    
    submitBtn.disabled = true;
    submitBtn.style.background = '#6c757d';
}

// æäº¤çº§è”é…ç½®
function submitCascadeConfig() {
    const formData = new FormData();
    formData.append('role', cascadeData.currentConfig.role);
    formData.append('slot_position', cascadeData.currentConfig.slot);
    formData.append('root_menu', cascadeData.currentConfig.menu);
    formData.append('menu_status', document.getElementById('cascade-status-select').value);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    const configUrl = window.location.pathname + 'configure-menu-by-role-slot/';
    
    fetch(configUrl, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showGlobalStatus('é…ç½®æˆåŠŸåº”ç”¨ï¼', 'success');
            resetCascadeForm();
            
            // æ˜¾ç¤ºå†å²æ•°æ®è€Œä¸æ˜¯é‡æ–°åŠ è½½é¡µé¢
            setTimeout(() => {
                loadHistoryData();
            }, 1000);
        } else {
            showGlobalStatus('é…ç½®å¤±è´¥: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('é…ç½®å¤±è´¥:', error);
        showGlobalStatus('é…ç½®å¤±è´¥: ' + error.message, 'error');
    });
}

// åŠ è½½å†å²æ•°æ®
function loadHistoryData() {
    const historySection = document.getElementById('history-data-section');
    const historyLoading = document.getElementById('history-loading');
    const historyTableContainer = document.getElementById('history-table-container');
    const historyEmpty = document.getElementById('history-empty');
    const historyTableBody = document.getElementById('history-table-body');
    
    // æ˜¾ç¤ºå†å²æ•°æ®åŒºåŸŸå’ŒåŠ è½½çŠ¶æ€
    historySection.style.display = 'block';
    historyLoading.style.display = 'block';
    historyTableContainer.style.display = 'none';
    historyEmpty.style.display = 'none';
    
    const historyUrl = window.location.pathname + 'get-assignment-history/';
    
    fetch(historyUrl, {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        historyLoading.style.display = 'none';
        
        if (data.success && data.assignments && data.assignments.length > 0) {
            // æ˜¾ç¤ºå†å²æ•°æ®è¡¨æ ¼
            historyTableContainer.style.display = 'block';
            historyEmpty.style.display = 'none';
            
            // æ¸…ç©ºè¡¨æ ¼å†…å®¹
            historyTableBody.innerHTML = '';
            
            // å¡«å……å†å²æ•°æ®
            data.assignments.forEach(assignment => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #dee2e6';
                
                const statusColor = {
                    'active': '#28a745',
                    'backup': '#ffc107', 
                    'disabled': '#6c757d'
                }[assignment.menu_status] || '#6c757d';
                
                const statusText = {
                    'active': 'æ¿€æ´»',
                    'backup': 'å€™è¡¥',
                    'disabled': 'ç¦ç”¨'
                }[assignment.menu_status] || assignment.menu_status;
                
                row.innerHTML = `
                    <td style="padding: 12px; border: 1px solid #dee2e6;">${assignment.role_display_name}</td>
                    <td style="padding: 12px; border: 1px solid #dee2e6;">${assignment.slot_position}</td>
                    <td style="padding: 12px; border: 1px solid #dee2e6;">${assignment.root_menu_name}</td>
                    <td style="padding: 12px; border: 1px solid #dee2e6;">
                        <span style="color: ${statusColor}; font-weight: bold;">${statusText}</span>
                    </td>
                    <td style="padding: 12px; border: 1px solid #dee2e6;">${assignment.sort_order}</td>
                    <td style="padding: 12px; border: 1px solid #dee2e6;">${assignment.created_at}</td>
                    <td style="padding: 12px; border: 1px solid #dee2e6;">${assignment.updated_at}</td>
                `;
                
                historyTableBody.appendChild(row);
            });
            
            showGlobalStatus(`æˆåŠŸåŠ è½½ ${data.assignments.length} æ¡å†å²é…ç½®è®°å½•`, 'success');
        } else {
            // æ˜¾ç¤ºç©ºçŠ¶æ€
            historyTableContainer.style.display = 'none';
            historyEmpty.style.display = 'block';
            showGlobalStatus('æš‚æ— å†å²é…ç½®è®°å½•', 'info');
        }
    })
    .catch(error => {
        console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', error);
        historyLoading.style.display = 'none';
        historyTableContainer.style.display = 'none';
        historyEmpty.style.display = 'block';
        showGlobalStatus('åŠ è½½å†å²æ•°æ®å¤±è´¥: ' + error.message, 'error');
    });
}

// é‡ç½®çº§è”è¡¨å•
function resetCascadeForm() {
    document.getElementById('cascade-config-form').reset();
    cascadeData.currentConfig = { role: null, slot: null, menu: null, status: 'active' };
    
    disableCascadeLevel('slot-level');
    disableCascadeLevel('menu-level');
    disableCascadeLevel('submit-level');
    
    updateCurrentStatus('role', null);
    updateCurrentStatus('slot', null);
    updateCurrentStatus('menu', null);
    
    document.getElementById('role-info').innerHTML = '';
    resetConfigSummary();
}

// æ˜¾ç¤ºå…¨å±€çŠ¶æ€ä¿¡æ¯
function showGlobalStatus(message, type) {
    const statusDisplay = document.getElementById('global-status-display');
    const statusContent = document.getElementById('global-status-content');
    
    let bgColor = '#e9ecef';
    let textColor = '#495057';
    
    switch(type) {
        case 'success':
            bgColor = '#d4edda';
            textColor = '#155724';
            break;
        case 'error':
            bgColor = '#f8d7da';
            textColor = '#721c24';
            break;
        case 'info':
            bgColor = '#d1ecf1';
            textColor = '#0c5460';
            break;
    }
    
    statusDisplay.style.background = bgColor;
    statusDisplay.style.color = textColor;
    statusContent.innerHTML = message;
    statusDisplay.style.display = 'block';
    
    if (type === 'success' || type === 'info') {
        setTimeout(() => {
            statusDisplay.style.display = 'none';
        }, 3000);
    }
}
</script>