{% extends 'base.html' %}
{% load static %}

{% block title %}学习中（看板） - 成长中心{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/progress_chart.css' %}">
<style>
.learning-dashboard {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px 0;
}

.dashboard-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}

.dashboard-header {
    text-align: center;
    color: white;
    margin-bottom: 40px;
}

.dashboard-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.dashboard-header p {
    font-size: 1.2rem;
    opacity: 0.9;
}

.goal-info-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    backdrop-filter: blur(10px);
}

.goal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.goal-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.stat-item {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    border-left: 4px solid #007bff;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #007bff;
    display: block;
}

.stat-label {
    font-size: 0.9rem;
    color: #666;
    margin-top: 5px;
}

.progress-grid-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    backdrop-filter: blur(10px);
}

.grid-title {
    text-align: center;
    font-size: 1.8rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.action-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 30px;
    flex-wrap: wrap;
}

.btn-action {
    padding: 12px 24px;
    border: none;
    border-radius: 25px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.btn-primary {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, #28a745, #1e7e34);
    color: white;
}

.btn-info {
    background: linear-gradient(135deg, #17a2b8, #117a8b);
    color: white;
}

.btn-warning {
    background: linear-gradient(135deg, #ffc107, #e0a800);
    color: white;
}

.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    color: white;
    text-decoration: none;
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 40px;
}

.spinner-border {
    display: inline-block;
    width: 3rem;
    height: 3rem;
    vertical-align: text-bottom;
    border: 0.25em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border 0.75s linear infinite;
}

@keyframes spinner-border {
    to {
        transform: rotate(360deg);
    }
}

.text-primary {
    color: #007bff !important;
}

.mt-3 {
    margin-top: 1rem !important;
}

.sr-only {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
}

.alert {
    border-radius: 15px;
    border: none;
    padding: 15px 20px;
    margin-bottom: 20px;
}

.no-goal-message {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.no-goal-message i {
    font-size: 4rem;
    color: #ddd;
    margin-bottom: 20px;
}

/* 深色主题支持 */
.dark-theme {
    background-color: #1a1a1a;
    color: #e0e0e0;
}

.dark-theme .learning-dashboard {
    background-color: #2d2d2d;
}

.dark-theme .goal-info-card {
    background: linear-gradient(135deg, #3a3a3a, #2d2d2d);
    border-color: #4a4a4a;
    color: #e0e0e0;
}

.dark-theme .progress-grid-container {
    background-color: #2d2d2d;
    border-color: #4a4a4a;
}

.dark-theme .btn-action {
    background-color: #4a4a4a;
    color: #e0e0e0;
    border-color: #5a5a5a;
}

.dark-theme .btn-action:hover {
    background-color: #5a5a5a;
    transform: translateY(-2px);
}

.dark-theme .message {
    background-color: #3a3a3a;
    border-color: #4a4a4a;
    color: #e0e0e0;
}

.dark-theme .message.success {
    background-color: #2d5a2d;
    border-color: #4a8a4a;
}

.dark-theme .message.error {
    background-color: #5a2d2d;
    border-color: #8a4a4a;
}

@media (max-width: 768px) {
    .dashboard-header h1 {
        font-size: 2rem;
    }
    
    .goal-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .action-buttons {
        flex-direction: column;
        align-items: center;
    }
    
    .btn-action {
        width: 100%;
        max-width: 250px;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="learning-dashboard">
    <div class="dashboard-container">
        <!-- 页面标题 -->
        <div class="dashboard-header">
            <h1><i class="fas fa-chart-line"></i> 学习中（看板）</h1>
            <p>九宫格学习进度展示 - 成长中心</p>
        </div>

        <!-- 消息提示 -->
        <div id="message-container"></div>

        {% if has_goal %}
        <!-- 目标信息卡片 -->
        <div class="goal-info-card">
            <div class="goal-title">
                <i class="fas fa-target"></i>
                <span id="goal-name">{{ active_goal.name }}</span>
            </div>
            <div class="goal-stats">
                <div class="stat-item">
                    <span class="stat-value" id="total-learned">0</span>
                    <div class="stat-label">已学习</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="total-target">{{ active_goal.target_words_count }}</span>
                    <div class="stat-label">目标总数</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="progress-percentage">0%</span>
                    <div class="stat-label">完成进度</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="days-remaining">-</span>
                    <div class="stat-label">剩余天数</div>
                </div>
            </div>
        </div>

        <!-- 九宫格进度展示 -->
        <div class="progress-grid-container">
            <div class="grid-title">
                <i class="fas fa-th"></i>
                九宫格进程
            </div>
            
            <!-- 加载动画 -->
            <div class="loading-spinner" id="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">加载中...</span>
                </div>
                <p class="mt-3">正在加载学习数据...</p>
            </div>

            <!-- 新的九宫格组件 -->
            <div id="progress-chart-container"></div>

            <!-- 操作按钮 -->
            <div class="action-buttons">
                <button class="btn-action btn-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                    刷新数据
                </button>
                <a href="{% url 'teaching:goals_list' %}" class="btn-action btn-info">
                    <i class="fas fa-list"></i>
                    管理目标
                </a>
                <a href="{% url 'teaching:vocabulary_management' %}" class="btn-action btn-warning">
                    <i class="fas fa-book-open"></i>
                    生词与熟词
                </a>
                <button class="btn-action btn-info" onclick="toggleTheme()">
                    <i class="fas fa-palette"></i>
                    切换主题
                </button>
                <button class="btn-action btn-success" onclick="exportReport()">
                    <i class="fas fa-download"></i>
                    导出报告
                </button>
            </div>
        </div>
        {% else %}
        <!-- 无目标提示 -->
        <div class="progress-grid-container">
            <div class="no-goal-message">
                <i class="fas fa-bullseye"></i>
                <h3>暂无激活的学习目标</h3>
                <p>请先创建并激活一个学习目标，然后返回查看学习进度。</p>
                <div class="action-buttons">
                    <button class="btn-action btn-success" onclick="createDemoData()">
                        <i class="fas fa-plus"></i>
                        创建演示数据
                    </button>
                    <button class="btn-action btn-info" onclick="toggleTheme()">
                        <i class="fas fa-palette"></i>
                        切换主题
                    </button>
                    <a href="{% url 'teaching:goals_list' %}" class="btn-action btn-primary">
                        <i class="fas fa-plus"></i>
                        创建学习目标
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ active_goal_data|json_script:"active-goal-data" }}
<script src="{% static 'js/progress_chart.js' %}"></script>
<script>
// 全局变量
const activeGoalData = JSON.parse(document.getElementById('active-goal-data').textContent);
let currentGoalId = activeGoalData ? activeGoalData.id : null;
let csrfToken = (function() {
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfInput ? csrfInput.value : '{{ csrf_token }}';
})();
let progressChart = null;

// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
    // 加载保存的主题
    loadSavedTheme();
    
    initProgressChart();
    loadProgressData();
});

// 加载保存的主题
function loadSavedTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-theme');
    }
}

// 初始化进度图表
function initProgressChart() {
    const container = document.getElementById('progress-chart-container');
    if (!container) {
        console.error('Progress chart container not found');
        return;
    }

    progressChart = new ProgressChart(container, {
        title: '学习进度',
        subtitle: '圆形扇形展示',
        animated: true,
        showTooltip: true,
        theme: 'light',
        onItemClick: function(item) {
            showItemDetails(item);
        },
        onItemHover: function(item, event) {
            // 可以添加额外的悬停效果
            console.log('Hovering over:', item.label);
        }
    });

    console.log('Progress chart initialized with circular sector layout');
}

// 加载进度数据
function loadProgressData() {
    showLoading(true);
    
    const apiUrl = currentGoalId ? '/teaching/api/progress-stats/' : '/teaching/api/demo-progress-stats/';
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderProgressGrid(data.grid_data);
                updateStats(data);
                showMessage('数据加载成功', 'success');
            } else {
                showMessage('加载失败: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('网络错误，请稍后重试', 'error');
        })
        .finally(() => {
            showLoading(false);
        });
}

// 渲染九宫格
function renderProgressGrid(gridData) {
    if (!progressChart) return;
    
    const chartData = convertGridDataToChartData(gridData);
    progressChart.updateData(chartData);
}

// 转换数据格式
function convertGridDataToChartData(gridData) {
    const positionMapping = {
        'top-center': 1,     // 掌握
        'top-right': 2,      // 遗忘
        'middle-right': 3,   // 学习中
        'bottom-right': 4,   // 测试
        'bottom-center': 5,  // 口音文本
        'bottom-left': 6,    // 口音文件
        'middle-left': 7,    // 区域化任务
        'top-left': 8        // 解决方案
    };
    
    const defaultLabels = ['掌握', '遗忘', '学习中', '测试', '口音文本', '口音文件', '区域化任务', '解决方案'];
    const chartData = [];
    
    // 转换API数据
    if (gridData && Array.isArray(gridData)) {
        gridData.forEach(item => {
            if (item && item.position !== 'center') {
                const position = positionMapping[item.position];
                if (position) {
                    chartData.push({
                        position: position,
                        category: item.category || item.label || '',
                        label: item.label || '',
                        value: parseInt(item.value || 0) || 0,
                        clickable: true
                    });
                }
            }
        });
    }
    
    // 补充缺失的位置
    for (let i = 1; i <= 8; i++) {
        if (!chartData.find(item => item.position === i)) {
            chartData.push({
                position: i,
                category: defaultLabels[i - 1],
                label: defaultLabels[i - 1],
                value: 0,
                clickable: true
            });
        }
    }
    
    return chartData.sort((a, b) => a.position - b.position);
}



// 更新统计信息
function updateStats(data) {
    if (!data) return;
    
    const elements = {
        totalLearned: document.getElementById('total-learned'),
        totalTarget: document.getElementById('total-target'),
        progressPercentage: document.getElementById('progress-percentage'),
        daysRemaining: document.getElementById('days-remaining')
    };
    
    if (elements.totalLearned) {
        elements.totalLearned.textContent = data.total_learned || 0;
    }
    
    if (elements.totalTarget) {
        elements.totalTarget.textContent = data.total_target || 0;
    }
    
    if (elements.progressPercentage) {
        const totalTarget = data.total_target || 0;
        const totalLearned = data.total_learned || 0;
        const percentage = totalTarget > 0 ? Math.round((totalLearned / totalTarget) * 100) : 0;
        elements.progressPercentage.textContent = percentage + '%';
    }
    
    if (elements.daysRemaining && data.goal && data.goal.end_date) {
        const endDate = new Date(data.goal.end_date);
        const today = new Date();
        const diffTime = endDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        elements.daysRemaining.textContent = diffDays > 0 ? diffDays + '天' : '已过期';
    }
}

// 显示项目详情
function showItemDetails(item) {
    if (item && item.value > 0) {
        alert(`${item.label || '未知项目'}: ${item.value}`);
    }
}

// 显示加载状态
function showLoading(show) {
    const spinner = document.getElementById('loading-spinner');
    const container = document.getElementById('progress-chart-container');
    
    if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
    }
    
    if (container) {
        container.style.display = show ? 'none' : 'block';
    }
    
    // 如果图表已初始化，也调用图表的加载方法
    if (progressChart) {
        if (show && progressChart.setLoading) {
            progressChart.setLoading(true);
        } else if (!show && progressChart.setLoading) {
            progressChart.setLoading(false);
        }
    }
}

// 显示消息
function showMessage(message, type = 'info') {
    if (progressChart && progressChart.showError && type === 'error') {
        progressChart.showError(message);
        return;
    }
    
    const container = document.getElementById('message-container');
    if (!container) return;
    
    const alertClass = type === 'error' ? 'alert-danger' : 
                      type === 'success' ? 'alert-success' : 'alert-info';
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    container.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// 刷新数据
function refreshData() {
    loadProgressData();
}

// 创建演示数据
function createDemoData() {
    if (!confirm('确定要创建演示数据吗？这将创建一个包含学习记录的演示目标。')) return;
    
    showLoading(true);
    
    fetch('/teaching/api/create-demo-data/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            currentGoalId = data.goal_id;
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage('创建失败: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('网络错误，请稍后重试', 'error');
    })
    .finally(() => {
        showLoading(false);
    });
}

// 导出报告
function exportReport() {
    showMessage('导出功能开发中...', 'info');
}

// 切换主题
function toggleTheme() {
    const body = document.body;
    const isDark = body.classList.contains('dark-theme');
    
    if (isDark) {
        body.classList.remove('dark-theme');
        localStorage.setItem('theme', 'light');
        showMessage('已切换到浅色主题', 'success');
    } else {
        body.classList.add('dark-theme');
        localStorage.setItem('theme', 'dark');
        showMessage('已切换到深色主题', 'success');
    }
    
    // 更新图表主题
    if (progressChart && progressChart.setTheme) {
        progressChart.setTheme(isDark ? 'light' : 'dark');
    }
}

// 获取Cookie值
function getCookie(name) {
    if (!document.cookie) return null;
    
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [cookieName, cookieValue] = cookie.trim().split('=');
        if (cookieName === name) {
            return decodeURIComponent(cookieValue);
        }
    }
    return null;
}
</script>
{% endblock %}